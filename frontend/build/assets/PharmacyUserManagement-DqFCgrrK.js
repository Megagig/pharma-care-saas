import{c as Te,j as e,aO as be,bv as De,z as Ee,r as t,d as L,I as z,t as ve,N as xe,D as W,ba as he,b4 as Oe,aP as Ce,aQ as Ae,B as o,T as x,h as v,aR as Se,L as Be,n as Me,aq as Le,p as ee,l as b,aS as ke,O as me,b5 as We,W as we,w as Re,a3 as Fe,aa as q,v as $e,Q,a4 as Ye,a5 as He,a6 as J,a7 as K,a8 as X,f as y,cb as pe,aj as Z,a1 as M,M as Ge}from"./index-louytu0d.js";import{S as Ve}from"./Search-BDaMMIPP.js";import{E as ge}from"./Edit-B2er_J4R.js";import{D as qe}from"./Delete-CTgRaLP1.js";import{M as Qe}from"./MoreVert-nhhWlZ7h.js";import{R as je}from"./Refresh-BWfz7OQR.js";import{g as Je,a as Ke,B as Xe,p as Ze,b as es,c as ss}from"./BulkOperationProgress-BOD603zp.js";import{S as se}from"./Snackbar-CN1k-M3c.js";import{T as rs,a as as,b as ts,c as fe,d as ns}from"./TableRow-D2snGkma.js";import{T as j}from"./TableCell-ZA4nZKqC.js";import"./apiClient-BTPkVfjo.js";import"./ExpandLess-BOUZH1RV.js";const ls=Te(e.jsx("path",{d:"M7.58 4.08 6.15 2.65C3.75 4.48 2.17 7.3 2.03 10.5h2c.15-2.65 1.51-4.97 3.55-6.42m12.39 6.42h2c-.15-3.2-1.73-6.02-4.12-7.85l-1.42 1.43c2.02 1.45 3.39 3.77 3.54 6.42M18 11c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2zm-6 11c.14 0 .27-.01.4-.04.65-.14 1.18-.58 1.44-1.18q.15-.36.15-.78h-4c.01 1.1.9 2 2.01 2"})),is=be.forwardRef(function(w,C){return e.jsx(De,{direction:"left",ref:C,...w})}),os=({maxNotifications:T=5,autoHideDuration:w=6e3,showInAppNotifications:C=!0})=>{const{user:c}=Ee(),D=()=>()=>{},[u,A]=t.useState([]),[E,_]=t.useState(new Set),[n,R]=t.useState(!1),[S,Y]=t.useState(0);t.useEffect(()=>{},[]),t.useEffect(()=>()=>{},[D]),t.useEffect(()=>{const r=u.filter(i=>!i.read).length;Y(r)},[u]),t.useCallback(r=>{var O;if(r.userId!==(c==null?void 0:c.id)&&!((O=r.affectedUsers)!=null&&O.includes((c==null?void 0:c.id)||"")))return;let i="",l="",m="info";switch(r.type){case"role_assigned":i="Role Assigned",l=`You have been assigned the role "${r.roleName}"`,m="success";break;case"role_revoked":i="Role Revoked",l=`Your role "${r.roleName}" has been revoked`,m="warning";break;case"permission_granted":i="Permission Granted",l=`You have been granted the permission "${r.permission}"`,m="success";break;case"permission_denied":i="Permission Revoked",l=`Your permission "${r.permission}" has been revoked`,m="error";break;case"role_updated":i="Role Updated",l=`The role "${r.roleName}" has been updated. Your permissions may have changed.`,m="info";break}k({type:"permission_change",title:i,message:l,severity:m,data:r,persistent:m==="error"})},[c==null?void 0:c.id]),t.useCallback(r=>{k({type:"role_change",title:"Role System Update",message:r.message||"Role definitions have been updated",severity:"info",data:r})},[]),t.useCallback(r=>{var i;(i=r.affectedUsers)!=null&&i.includes(c==null?void 0:c.id)&&k({type:"system_update",title:"Bulk Permission Update",message:"Your permissions have been updated as part of a bulk operation",severity:"info",data:r,persistent:!0})},[c==null?void 0:c.id]);const k=t.useCallback(r=>{const i={...r,id:`notification-${Date.now()}-${Math.random()}`,timestamp:new Date().toISOString(),read:!1};A(l=>[i,...l].slice(0,T*2)),C&&_(l=>new Set([...l,i.id])),"Notification"in window&&Notification.permission==="granted"&&new Notification(r.title,{body:r.message,icon:"/favicon.ico",tag:r.type})},[T,C]),I=t.useCallback(r=>{_(i=>{const l=new Set(i);return l.delete(r),l})},[]),P=t.useCallback(r=>{A(i=>i.map(l=>l.id===r?{...l,read:!0}:l))},[]),H=t.useCallback(()=>{A(r=>r.map(i=>({...i,read:!0})))},[]),G=t.useCallback(r=>{A(i=>i.filter(l=>l.id!==r)),I(r)},[I]),U=t.useCallback(()=>{A([]),_(new Set)},[]),g=t.useCallback(async()=>{"Notification"in window&&Notification.permission==="default"&&await Notification.requestPermission()},[]),F=r=>{switch(r){case"success":return e.jsx(Re,{color:"success"});case"warning":return e.jsx(we,{color:"warning"});case"error":return e.jsx(We,{color:"error"});case"info":return e.jsx(me,{color:"info"});default:return e.jsx(me,{})}};return e.jsxs(e.Fragment,{children:[e.jsx(L,{title:"Notifications",children:e.jsx(z,{onClick:()=>R(!0),color:"inherit",children:e.jsx(ve,{badgeContent:S,color:"error",children:S>0?e.jsx(ls,{}):e.jsx(xe,{})})})}),Array.from(E).map((r,i)=>{const l=u.find(m=>m.id===r);return l?e.jsx(se,{open:!0,autoHideDuration:l.persistent?null:w,onClose:()=>I(r),TransitionComponent:is,anchorOrigin:{vertical:"top",horizontal:"right"},sx:{mt:i*8},children:e.jsxs(W,{severity:l.severity,onClose:()=>I(r),action:e.jsx(z,{size:"small",onClick:()=>{P(r),I(r)},children:e.jsx(he,{fontSize:"small"})}),children:[e.jsx(Oe,{children:l.title}),l.message]})},r):null}),e.jsxs(Ce,{open:n,onClose:()=>R(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(Ae,{children:e.jsxs(o,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx(x,{variant:"h6",children:"Notifications"}),e.jsxs(o,{sx:{display:"flex",gap:1},children:[S>0&&e.jsx(v,{size:"small",onClick:H,children:"Mark All Read"}),e.jsx(v,{size:"small",onClick:U,color:"error",children:"Clear All"})]})]})}),e.jsx(Se,{children:u.length===0?e.jsxs(o,{sx:{textAlign:"center",py:4},children:[e.jsx(xe,{sx:{fontSize:48,color:"text.secondary",mb:2}}),e.jsx(x,{variant:"body1",color:"textSecondary",children:"No notifications"})]}):e.jsx(Be,{children:u.map(r=>e.jsxs(Me,{sx:{backgroundColor:r.read?"transparent":"action.hover",borderRadius:1,mb:1},children:[e.jsx(Le,{children:F(r.severity)}),e.jsx(ee,{primary:e.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(x,{variant:"subtitle2",children:r.title}),e.jsx(b,{label:r.type.replace("_"," "),size:"small",variant:"outlined"}),!r.read&&e.jsx(b,{label:"New",size:"small",color:"primary"})]}),secondary:e.jsxs(o,{children:[e.jsx(x,{variant:"body2",sx:{mb:.5},children:r.message}),e.jsx(x,{variant:"caption",color:"textSecondary",children:new Date(r.timestamp).toLocaleString()})]})}),e.jsx(z,{size:"small",onClick:()=>G(r.id),children:e.jsx(he,{fontSize:"small"})})]},r.id))})}),e.jsxs(ke,{children:[e.jsx(v,{onClick:g,variant:"outlined",children:"Enable Browser Notifications"}),e.jsx(v,{onClick:()=>R(!1),children:"Close"})]})]}),e.jsx(se,{open:!0,anchorOrigin:{vertical:"bottom",horizontal:"left"},children:e.jsxs(W,{severity:"warning",children:["Real-time updates"," ","disconnected"]})})]})},cs=48,ds=8,ye={PaperProps:{style:{maxHeight:cs*4.5+ds,width:250}}},As=()=>{const{hasFeature:T,canAccess:w}=Fe(),C=t.useCallback(()=>()=>{},[]),[c,D]=t.useState([]),[u,A]=t.useState([]),[E,_]=t.useState(!0),[n,R]=t.useState([]),[S,Y]=t.useState(""),[k,I]=t.useState(""),[P,H]=t.useState([]),[G,U]=t.useState(!1),[g,F]=t.useState([]),[r,i]=t.useState(null),[l,m]=t.useState(!1),[O,re]=t.useState(null),[$,ae]=t.useState(null),[te,ne]=t.useState(null),[Ie,le]=t.useState(!1),[V,ie]=t.useState({open:!1,message:"",severity:"info"}),h=t.useCallback((s,a)=>{ie({open:!0,message:s,severity:a})},[]),N=t.useCallback(async()=>{var s,a;try{_(!0);let d=!1,f=!1;try{const p=await Je({page:1,limit:100});p.success&&((s=p.data)!=null&&s.users)?(D(p.data.users),d=!0):D([])}catch(p){console.error("Error loading users:",p),D([])}try{const p=await Ke({page:1,limit:100});p.success&&((a=p.data)!=null&&a.roles)?(A(p.data.roles),f=!0):A([])}catch(p){console.error("Error loading roles:",p),A([])}d&&f?h("Data loaded successfully","success"):d&&!f?h("Users loaded, but roles failed to load","warning"):!d&&f?h("Roles loaded, but users failed to load","warning"):h("Failed to load user and role data","error")}finally{_(!1)}},[h]);t.useEffect(()=>{N()},[N]),t.useEffect(()=>{const s=C,a=C,d=C;return()=>{s(),a(),d()}},[C,te,N]);const oe=()=>{ie(s=>({...s,open:!1}))},Pe=()=>{if(Array.isArray(n)&&n.length===0){h("Please select users to assign roles","warning");return}U(!0)},_e=s=>{const a=s.target.value;F(typeof a=="string"?a.split(","):a)},Ue=async()=>{if(Array.isArray(n)&&n.length===1&&g.length>0)try{const s=n[0],a=await Ze(s,{roleIds:g});a.success&&i(a.data)}catch(s){console.error("Error previewing permissions:",s),h("Failed to preview permissions","error")}},Ne=async()=>{if(!Array.isArray(n)||n.length===0||g.length===0){h("Please select users and roles","warning");return}try{m(!0);const s=`role-assignment-${Date.now()}`;ne(s),le(!0),(await es(Array.isArray(n)?n:[],g[0])).success&&(h("Roles assigned successfully","success"),await N(),U(!1),F([]),R([]),i(null))}catch(s){console.error("Error assigning roles:",s),h("Failed to assign roles","error")}finally{m(!1)}},ze=(s,a)=>{re(s.currentTarget),ae(a)},B=()=>{re(null),ae(null)},ce=s=>{console.log("Edit user:",s),B()},de=async s=>{if(!s||!s._id){console.error("Invalid user data:",s),h("User data is not available","error"),B();return}try{const a=await ss(s._id);a.success?(console.log("User roles:",a.data),h("User roles loaded successfully","success")):h("Failed to load user roles","error")}catch(a){console.error("Error fetching user roles:",a),h("Failed to load user roles","error")}B()},ue=be.useMemo(()=>Array.isArray(c)?c.filter(s=>{if(!s||typeof s!="object")return!1;const a=!S||`${s.firstName||""} ${s.lastName||""}`.toLowerCase().includes(S.toLowerCase())||(s.email||"").toLowerCase().includes(S.toLowerCase()),d=!k||s.status===k,f=P.length===0||Array.isArray(s.assignedRoles)&&s.assignedRoles.some(p=>P.includes(p));return a&&d&&f}):[],[c,S,k,P]);return T("user_management")?E?e.jsx(o,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:400},children:e.jsx(q,{})}):e.jsxs(o,{sx:{p:3},children:[e.jsxs(o,{sx:{mb:3},children:[e.jsxs(x,{variant:"h4",gutterBottom:!0,sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx($e,{color:"primary"}),"User Management"]}),e.jsx(x,{variant:"body1",color:"textSecondary",children:"Manage user roles, permissions, and access controls with dynamic RBAC"})]}),e.jsx(Q,{sx:{p:2,mb:3},children:e.jsxs(o,{sx:{display:"flex",gap:2,alignItems:"center",flexWrap:"wrap"},children:[e.jsx(Ye,{placeholder:"Search users...",value:S,onChange:s=>Y(s.target.value),InputProps:{startAdornment:e.jsx(He,{position:"start",children:e.jsx(Ve,{})})},sx:{minWidth:250}}),e.jsxs(J,{sx:{minWidth:120},children:[e.jsx(K,{children:"Status"}),e.jsxs(X,{value:k,onChange:s=>I(s.target.value),label:"Status",children:[e.jsx(y,{value:"",children:"All"}),e.jsx(y,{value:"active",children:"Active"}),e.jsx(y,{value:"pending",children:"Pending"}),e.jsx(y,{value:"suspended",children:"Suspended"}),e.jsx(y,{value:"license_pending",children:"License Pending"})]})]}),e.jsxs(J,{sx:{minWidth:200},children:[e.jsx(K,{children:"Roles"}),e.jsx(X,{multiple:!0,value:P,onChange:s=>H(typeof s.target.value=="string"?s.target.value.split(","):s.target.value),input:e.jsx(pe,{label:"Roles"}),renderValue:s=>e.jsx(o,{sx:{display:"flex",flexWrap:"wrap",gap:.5},children:s.map(a=>{const d=u.find(f=>f._id===a);return e.jsx(b,{label:(d==null?void 0:d.displayName)||a,size:"small"},a)})}),MenuProps:ye,children:u.map(s=>e.jsxs(y,{value:s._id,children:[e.jsx(Z,{checked:P.indexOf(s._id)>-1}),e.jsx(ee,{primary:s.displayName})]},s._id))})]}),e.jsx(o,{sx:{flexGrow:1}}),e.jsx(L,{title:"Assign Roles to Selected Users",children:e.jsx("span",{children:e.jsxs(v,{variant:"contained",startIcon:e.jsx(M,{}),onClick:Pe,disabled:!Array.isArray(n)||n.length===0||!w("canManage"),children:["Assign Roles",Array.isArray(n)&&n.length>0&&e.jsx(ve,{badgeContent:n.length,color:"secondary",sx:{ml:1}})]})})}),e.jsx(v,{variant:"outlined",startIcon:e.jsx(je,{}),onClick:N,children:"Refresh"})]})}),e.jsx(Q,{sx:{height:600},children:(!Array.isArray(c)||c.length===0)&&!E?e.jsxs(o,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",height:"100%",p:3},children:[e.jsx(x,{variant:"h6",color:"textSecondary",gutterBottom:!0,children:"No users found"}),e.jsx(x,{variant:"body2",color:"textSecondary",sx:{mb:2},children:"The RBAC service may not be available or no users exist."}),e.jsx(v,{variant:"outlined",startIcon:e.jsx(je,{}),onClick:N,children:"Try Again"})]}):E||!Array.isArray(ue)||!Array.isArray(c)||!Array.isArray(u)?e.jsxs(o,{sx:{display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",height:600,p:3},children:[e.jsx(q,{}),e.jsx(x,{variant:"body2",sx:{mt:2},children:"Loading user management data..."})]}):e.jsx(rs,{component:Q,children:e.jsxs(as,{children:[e.jsx(ts,{children:e.jsxs(fe,{children:[e.jsx(j,{children:"Select"}),e.jsx(j,{children:"Name"}),e.jsx(j,{children:"Status"}),e.jsx(j,{children:"System Role"}),e.jsx(j,{children:"Dynamic Roles"}),e.jsx(j,{children:"Actions"})]})}),e.jsx(ns,{children:ue.map(s=>e.jsxs(fe,{children:[e.jsx(Z,{checked:n.indexOf(s._id)>-1,onChange:a=>{a.target.checked?R([...n,s._id]):R(n.filter(d=>d!==s._id))}}),e.jsx(j,{children:s.email||"-"}),e.jsx(j,{children:e.jsx(b,{label:s.status||"Unknown",color:s.status==="active"?"success":s.status==="pending"?"warning":s.status==="suspended"?"error":"default",size:"small",variant:"outlined"})}),e.jsx(j,{children:e.jsx(b,{label:s.systemRole||"User",size:"small",variant:"filled",color:"primary"})}),e.jsx(j,{children:Array.isArray(s.assignedRoles)&&Array.isArray(u)?e.jsxs(o,{sx:{display:"flex",gap:.5,flexWrap:"wrap"},children:[u.filter(a=>a&&a._id&&s.assignedRoles.includes(a._id)).slice(0,2).map(a=>e.jsx(b,{label:a.displayName||"Unknown Role",size:"small",variant:"outlined",color:"secondary"},a._id)),u.filter(a=>a&&a._id&&s.assignedRoles.includes(a._id)).length>2&&e.jsx(b,{label:`+${u.filter(a=>a&&a._id&&s.assignedRoles.includes(a._id)).length-2}`,size:"small",variant:"outlined",color:"default"})]}):e.jsx(x,{variant:"body2",color:"textSecondary",children:"No roles"})}),e.jsx(j,{children:e.jsxs(o,{sx:{display:"flex",gap:.5},children:[e.jsx(L,{title:"Edit User",children:e.jsx(z,{size:"small",onClick:()=>ce(s),disabled:!w("canUpdate"),children:e.jsx(ge,{fontSize:"small"})})}),e.jsx(L,{title:"Manage Roles",children:e.jsx(z,{size:"small",onClick:()=>de(s),children:e.jsx(M,{fontSize:"small"})})}),e.jsx(L,{title:"More Options",children:e.jsx(z,{size:"small",onClick:a=>ze(a,s),children:e.jsx(Qe,{fontSize:"small"})})})]})})]},s._id))})]})})}),e.jsxs(Ce,{open:G,onClose:()=>U(!1),maxWidth:"md",fullWidth:!0,children:[e.jsxs(Ae,{children:["Assign Roles to"," ",Array.isArray(n)?n.length:0," User",Array.isArray(n)&&n.length!==1?"s":""]}),e.jsx(Se,{children:e.jsxs(o,{sx:{mt:2},children:[e.jsxs(J,{fullWidth:!0,children:[e.jsx(K,{children:"Select Roles"}),e.jsx(X,{multiple:!0,value:g,onChange:_e,input:e.jsx(pe,{label:"Select Roles"}),renderValue:s=>e.jsx(o,{sx:{display:"flex",flexWrap:"wrap",gap:.5},children:s.map(a=>{const d=u.find(f=>f._id===a);return e.jsx(b,{label:(d==null?void 0:d.displayName)||a},a)})}),MenuProps:ye,children:u.map(s=>e.jsxs(y,{value:s._id,children:[e.jsx(Z,{checked:g.indexOf(s._id)>-1}),e.jsx(ee,{primary:s.displayName,secondary:s.description})]},s._id))})]}),Array.isArray(n)&&n.length===1&&g.length>0&&e.jsx(o,{sx:{mt:2},children:e.jsx(v,{variant:"outlined",onClick:Ue,startIcon:e.jsx(M,{}),children:"Preview Permissions"})}),r&&e.jsxs(o,{sx:{mt:2},children:[e.jsx(x,{variant:"h6",gutterBottom:!0,children:"Permission Changes Preview"}),r.addedPermissions.length>0&&e.jsxs(o,{sx:{mb:2},children:[e.jsxs(x,{variant:"subtitle2",color:"success.main",gutterBottom:!0,children:[e.jsx(Re,{sx:{fontSize:16,mr:.5}}),"Added Permissions (",r.addedPermissions.length,")"]}),e.jsx(o,{sx:{display:"flex",flexWrap:"wrap",gap:.5},children:r.addedPermissions.map(s=>e.jsx(b,{label:s,size:"small",color:"success",variant:"outlined"},s))})]}),r.removedPermissions.length>0&&e.jsxs(o,{sx:{mb:2},children:[e.jsxs(x,{variant:"subtitle2",color:"error.main",gutterBottom:!0,children:[e.jsx(we,{sx:{fontSize:16,mr:.5}}),"Removed Permissions (",r.removedPermissions.length,")"]}),e.jsx(o,{sx:{display:"flex",flexWrap:"wrap",gap:.5},children:r.removedPermissions.map(s=>e.jsx(b,{label:s,size:"small",color:"error",variant:"outlined"},s))})]}),r.conflicts.length>0&&e.jsxs(W,{severity:"warning",sx:{mt:2},children:[e.jsx(x,{variant:"subtitle2",gutterBottom:!0,children:"Conflicts Detected"}),e.jsx("ul",{children:r.conflicts.map((s,a)=>e.jsx("li",{children:s},a))})]})]})]})}),e.jsxs(ke,{children:[e.jsx(v,{onClick:()=>U(!1),children:"Cancel"}),e.jsx(v,{onClick:Ne,variant:"contained",disabled:g.length===0||l,startIcon:l?e.jsx(q,{size:16}):e.jsx(M,{}),children:l?"Assigning...":"Assign Roles"})]})]}),e.jsxs(Ge,{anchorEl:O,open:!!O,onClose:B,children:[e.jsxs(y,{onClick:()=>$&&ce($),children:[e.jsx(ge,{sx:{mr:1}}),"Edit User"]}),e.jsxs(y,{onClick:()=>$&&de($),children:[e.jsx(M,{sx:{mr:1}}),"Manage Roles"]}),e.jsxs(y,{onClick:B,disabled:!w("canDelete"),children:[e.jsx(qe,{sx:{mr:1}}),"Suspend User"]})]}),e.jsx(se,{open:V.open,autoHideDuration:6e3,onClose:oe,anchorOrigin:{vertical:"bottom",horizontal:"right"},children:e.jsx(W,{onClose:oe,severity:V.severity,children:V.message})}),e.jsx(os,{}),e.jsx(Xe,{open:Ie,onClose:()=>{le(!1),ne(null)},operationId:te||void 0,initialData:{type:"role_assignment",status:"in_progress",progress:{total:Array.isArray(n)?n.length:0,processed:0,successful:0,failed:0},metadata:{roleNames:u.filter(s=>g.includes(s._id)).map(s=>s.displayName),userCount:Array.isArray(n)?n.length:0}}})]}):e.jsx(o,{sx:{p:3},children:e.jsx(W,{severity:"warning",children:"You don't have permission to access User Management. Please contact your administrator."})})};export{As as default};
