import{a as d}from"./apiClient-BTPkVfjo.js";import{aO as x,r as w,j as e,aP as z,aQ as B,B as i,T as u,l as b,aR as q,x as F,w as G,b5 as E,W as C,I,aU as R,aT as W,D as S,L as T,n as O,aq as A,p as P,aS as J,h as $,O as K,v as D,a1 as Q}from"./index-louytu0d.js";import{E as L}from"./ExpandLess-BOUZH1RV.js";const se=async a=>{try{return(await d.get(`/admin/users/${a}/roles`)).data}catch(s){throw console.error("Error fetching user roles:",s),s}},te=async(a,s)=>{try{return(await d.post(`/admin/users/${a}/preview-permissions`,s)).data}catch(r){throw console.error("Error previewing permission changes:",r),r}},re=async a=>{try{const s=new URLSearchParams;return a&&Object.entries(a).forEach(([n,o])=>{o!==void 0&&s.append(n,o.toString())}),(await d.get(`/admin/users?${s}`)).data}catch(s){throw console.error("Error fetching users:",s),s}},ne=async(a,s,r)=>{try{return(await d.put(`/admin/users/${a}/role`,{roleId:s,workspaceId:r})).data}catch(n){throw console.error("Error updating user role:",n),n}},ae=async(a,s)=>{try{return(await d.post(`/admin/users/${a}/suspend`,{reason:s})).data}catch(r){throw console.error("Error suspending user:",r),r}},oe=async(a,s,r)=>{try{return(await d.post("/admin/users/bulk-assign-roles",{userIds:a,roleId:s,workspaceId:r})).data}catch(n){throw console.error("Error in bulk role assignment:",n),n}},ce=async(a,s,r)=>{try{return(await d.post("/admin/users/bulk-revoke-roles",{userIds:a,roleId:s,workspaceId:r})).data}catch(n){throw console.error("Error in bulk role revocation:",n),n}},ie=async a=>{try{const s=new URLSearchParams;return a&&Object.entries(a).forEach(([n,o])=>{o!==void 0&&s.append(n,o.toString())}),(await d.get(`/admin/roles?${s}`)).data}catch(s){throw console.error("Error fetching roles:",s),s}},le=async a=>{try{const s=new URLSearchParams;return(await d.get(`/admin/licenses/pending?${s}`)).data}catch(s){throw console.error("Error fetching pending licenses:",s),s}},de=async(a,s,r)=>{try{return(await d.post(`/admin/licenses/${a}/approve`,{expirationDate:s,notes:r})).data}catch(n){throw console.error("Error approving license:",n),n}},ue=async(a,s)=>{try{return(await d.post(`/admin/licenses/${a}/reject`,{reason:s})).data}catch(r){throw console.error("Error rejecting license:",r),r}},he=async a=>{try{const s=new URLSearchParams;return(await d.get(`/admin/analytics?${s}`)).data}catch(s){throw console.error("Error fetching system analytics:",s),s}};class V{constructor(s){this.ws=null,this.eventHandlers=new Map,this.reconnectAttempts=0,this.reconnectTimer=null,this.heartbeatTimer=null,this.isConnecting=!1,this.isManuallyDisconnected=!1,this.isDisabled=!1,this.config={url:"ws://localhost:5000/ws",reconnectInterval:5e3,maxReconnectAttempts:3,heartbeatInterval:3e4,...s}}connect(){return new Promise((s,r)=>{var n;if(((n=this.ws)==null?void 0:n.readyState)===WebSocket.OPEN){s();return}if(this.isConnecting){r(new Error("Connection already in progress"));return}this.isConnecting=!0,this.isManuallyDisconnected=!1;try{this.ws=new WebSocket(this.config.url),this.ws.onopen=()=>{console.log("WebSocket connected"),this.isConnecting=!1,this.reconnectAttempts=0,this.startHeartbeat(),s()},this.ws.onmessage=o=>{try{const t=JSON.parse(o.data);this.handleMessage(t)}catch(t){console.error("Error parsing WebSocket message:",t)}},this.ws.onclose=o=>{console.log("WebSocket disconnected:",o.code,o.reason),this.isConnecting=!1,this.stopHeartbeat(),!this.isManuallyDisconnected&&this.reconnectAttempts<this.config.maxReconnectAttempts&&o.code!==1006?this.scheduleReconnect():o.code===1006&&(console.warn("WebSocket server unavailable. Stopping reconnection attempts."),this.reconnectAttempts=this.config.maxReconnectAttempts)},this.ws.onerror=o=>{this.reconnectAttempts===0&&console.warn("WebSocket connection failed. Server may not be available."),this.isConnecting=!1,r(o)}}catch(o){this.isConnecting=!1,r(o)}})}disconnect(){this.isManuallyDisconnected=!0,this.stopHeartbeat(),this.clearReconnectTimer(),this.ws&&(this.ws.close(1e3,"Manual disconnect"),this.ws=null)}subscribe(s,r){return this.eventHandlers.has(s)||this.eventHandlers.set(s,new Set),this.eventHandlers.get(s).add(r),()=>{const n=this.eventHandlers.get(s);n&&(n.delete(r),n.size===0&&this.eventHandlers.delete(s))}}send(s){var r;if(((r=this.ws)==null?void 0:r.readyState)===WebSocket.OPEN){const n={type:"system_notification",data:null,timestamp:new Date().toISOString(),...s};this.ws.send(JSON.stringify(n))}else console.warn("WebSocket not connected, message not sent:",s)}getStatus(){var s;if(this.isConnecting)return"connecting";switch((s=this.ws)==null?void 0:s.readyState){case WebSocket.OPEN:return"connected";case WebSocket.CONNECTING:return"connecting";case WebSocket.CLOSED:case WebSocket.CLOSING:return"disconnected";default:return"error"}}handleMessage(s){const r=this.eventHandlers.get(s.type);r&&r.forEach(o=>{try{o(s)}catch(t){console.error("Error in WebSocket event handler:",t)}});const n=this.eventHandlers.get("*");n&&n.forEach(o=>{try{o(s)}catch(t){console.error("Error in global WebSocket event handler:",t)}})}scheduleReconnect(){this.clearReconnectTimer();const s=Math.min(this.config.reconnectInterval*Math.pow(2,this.reconnectAttempts),3e4);this.reconnectTimer=setTimeout(()=>{this.reconnectAttempts++,this.reconnectAttempts<=3&&console.log(`Attempting to reconnect (${this.reconnectAttempts}/${this.config.maxReconnectAttempts})`),this.connect().catch(r=>{this.reconnectAttempts<=3&&console.warn("Reconnection failed. WebSocket server may not be available.")})},s)}clearReconnectTimer(){this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null)}startHeartbeat(){this.stopHeartbeat(),this.heartbeatTimer=setInterval(()=>{var s;((s=this.ws)==null?void 0:s.readyState)===WebSocket.OPEN&&this.send({type:"system_notification",data:{type:"heartbeat"}})},this.config.heartbeatInterval)}stopHeartbeat(){this.heartbeatTimer&&(clearInterval(this.heartbeatTimer),this.heartbeatTimer=null)}}const y=new V,X=()=>{const[a,s]=x.useState("disconnected");x.useEffect(()=>{const h=()=>{s(y.getStatus())};h();const p=setInterval(h,1e3);return()=>{clearInterval(p)}},[]);const r=x.useCallback(()=>y.connect(),[]),n=x.useCallback(()=>{y.disconnect()},[]),o=x.useCallback((h,p)=>y.subscribe(h,p),[]),t=x.useCallback(h=>{y.send(h)},[]);return{status:a,connect:r,disconnect:n,subscribe:o,send:t}},pe=({open:a,onClose:s,operationId:r,initialData:n})=>{const{subscribe:o}=X(),[t,h]=w.useState(null),[p,M]=w.useState(!1),[j,H]=w.useState(!1);w.useEffect(()=>{n&&a&&h({id:r||`op-${Date.now()}`,type:"role_assignment",status:"pending",progress:{total:0,processed:0,successful:0,failed:0},startTime:new Date().toISOString(),errors:[],warnings:[],...n})},[n,r,a]),w.useEffect(()=>r?o("bulk_operation",g=>{const l=g.data;l.operationId===r&&h(f=>f?{...f,status:l.status||f.status,progress:{...f.progress,...l.progress},errors:l.errors||f.errors,warnings:l.warnings||f.warnings,endTime:l.endTime||f.endTime}:null)}):void 0,[r,o]);const _=c=>{switch(c){case"role_assignment":return"Role Assignment";case"role_revocation":return"Role Revocation";case"permission_update":return"Permission Update";case"user_update":return"User Update";default:return"Bulk Operation"}},N=c=>{switch(c){case"role_assignment":case"role_revocation":return e.jsx(D,{});case"permission_update":return e.jsx(Q,{});case"user_update":return e.jsx(D,{});default:return e.jsx(K,{})}},v=c=>{switch(c){case"completed":return"success";case"failed":return"error";case"cancelled":return"warning";case"in_progress":return"primary";default:return"default"}},k=()=>!t||t.progress.total===0?0:t.progress.processed/t.progress.total*100,U=()=>{if(!t)return"";const c=new Date(t.startTime),g=t.endTime?new Date(t.endTime):new Date,l=Math.floor((g.getTime()-c.getTime())/1e3);return l<60?`${l}s`:l<3600?`${Math.floor(l/60)}m ${l%60}s`:`${Math.floor(l/3600)}h ${Math.floor(l%3600/60)}m`},m=()=>(t==null?void 0:t.status)==="completed"||(t==null?void 0:t.status)==="failed"||(t==null?void 0:t.status)==="cancelled";return t?e.jsxs(z,{open:a,onClose:m()?s:void 0,maxWidth:"md",fullWidth:!0,disableEscapeKeyDown:!m(),children:[e.jsx(B,{children:e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:2},children:[N(t.type),e.jsxs(i,{sx:{flexGrow:1},children:[e.jsx(u,{variant:"h6",children:_(t.type)}),e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1,mt:.5},children:[e.jsx(b,{label:t.status.replace("_"," "),color:v(t.status),size:"small",variant:"outlined"}),e.jsx(u,{variant:"caption",color:"textSecondary",children:U()})]})]})]})}),e.jsx(q,{children:e.jsxs(i,{sx:{mb:3},children:[e.jsxs(i,{sx:{mb:2},children:[e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between",mb:1},children:[e.jsxs(u,{variant:"body2",children:["Progress: ",t.progress.processed," /"," ",t.progress.total]}),e.jsxs(u,{variant:"body2",children:[Math.round(k()),"%"]})]}),e.jsx(F,{variant:"determinate",value:k(),color:v(t.status),sx:{height:8,borderRadius:4}})]}),e.jsxs(i,{sx:{display:"flex",gap:2,mb:3},children:[e.jsx(b,{icon:e.jsx(G,{}),label:`${t.progress.successful} Successful`,color:"success",variant:"outlined"}),t.progress.failed>0&&e.jsx(b,{icon:e.jsx(E,{}),label:`${t.progress.failed} Failed`,color:"error",variant:"outlined"}),t.warnings.length>0&&e.jsx(b,{icon:e.jsx(C,{}),label:`${t.warnings.length} Warnings`,color:"warning",variant:"outlined"})]}),t.metadata&&e.jsxs(i,{sx:{mb:3},children:[e.jsx(u,{variant:"subtitle2",gutterBottom:!0,children:"Operation Details"}),t.metadata.roleNames&&e.jsxs(i,{sx:{mb:1},children:[e.jsx(u,{variant:"caption",color:"textSecondary",children:"Roles:"}),e.jsx(i,{sx:{display:"flex",flexWrap:"wrap",gap:.5,mt:.5},children:t.metadata.roleNames.map(c=>e.jsx(b,{label:c,size:"small",variant:"outlined"},c))})]}),t.metadata.permissions&&e.jsxs(i,{sx:{mb:1},children:[e.jsx(u,{variant:"caption",color:"textSecondary",children:"Permissions:"}),e.jsx(i,{sx:{display:"flex",flexWrap:"wrap",gap:.5,mt:.5},children:t.metadata.permissions.map(c=>e.jsx(b,{label:c,size:"small",variant:"outlined"},c))})]}),t.metadata.userCount&&e.jsxs(u,{variant:"caption",color:"textSecondary",children:["Affected Users: ",t.metadata.userCount]})]}),t.errors.length>0&&e.jsxs(i,{sx:{mb:2},children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",cursor:"pointer",mb:1},onClick:()=>M(!p),children:[e.jsx(I,{size:"small",children:p?e.jsx(L,{}):e.jsx(R,{})}),e.jsxs(u,{variant:"subtitle2",color:"error",children:["Errors (",t.errors.length,")"]})]}),e.jsx(W,{in:p,children:e.jsx(S,{severity:"error",sx:{mb:2},children:e.jsx(T,{dense:!0,children:t.errors.map((c,g)=>e.jsxs(O,{disablePadding:!0,children:[e.jsx(A,{children:e.jsx(E,{color:"error",fontSize:"small"})}),e.jsx(P,{primary:c.userName||c.userId,secondary:c.error})]},g))})})})]}),t.warnings.length>0&&e.jsxs(i,{sx:{mb:2},children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",cursor:"pointer",mb:1},onClick:()=>H(!j),children:[e.jsx(I,{size:"small",children:j?e.jsx(L,{}):e.jsx(R,{})}),e.jsxs(u,{variant:"subtitle2",color:"warning.main",children:["Warnings (",t.warnings.length,")"]})]}),e.jsx(W,{in:j,children:e.jsx(S,{severity:"warning",sx:{mb:2},children:e.jsx(T,{dense:!0,children:t.warnings.map((c,g)=>e.jsxs(O,{disablePadding:!0,children:[e.jsx(A,{children:e.jsx(C,{color:"warning",fontSize:"small"})}),e.jsx(P,{primary:c.userName||c.userId,secondary:c.message})]},g))})})})]}),m()&&e.jsxs(S,{severity:t.status==="completed"?"success":t.status==="failed"?"error":"warning",children:[t.status==="completed"&&e.jsxs(e.Fragment,{children:["Operation completed successfully!"," ",t.progress.successful," out of"," ",t.progress.total," items processed.",t.progress.failed>0&&` ${t.progress.failed} items failed.`]}),t.status==="failed"&&e.jsxs(e.Fragment,{children:["Operation failed. ",t.progress.successful," out of"," ",t.progress.total," items were processed successfully."]}),t.status==="cancelled"&&e.jsxs(e.Fragment,{children:["Operation was cancelled. ",t.progress.successful," out of ",t.progress.total," items were processed."]})]})]})}),e.jsxs(J,{children:[!m()&&e.jsx($,{onClick:()=>{console.log("Cancel operation:",t.id)},color:"error",children:"Cancel"}),e.jsx($,{onClick:s,variant:m()?"contained":"outlined",disabled:!m(),children:m()?"Close":"Running..."})]})]}):null};export{pe as B,ie as a,oe as b,se as c,le as d,he as e,de as f,re as g,ce as h,te as p,ue as r,ae as s,ne as u};
