import{c8 as ee,cd as se,u as te,aW as ae,g as re,r as f,j as e,Z as ne,w as le,q as ie,y as W,aX as oe,B as d,T as p,d as ce,I as _,h as y,a4 as de,a5 as ue,G as q,C as I,b as k,_ as B,bD as pe,N as he,t as fe,D as xe,M as z,f as S,l as me,s as ge}from"./index-louytu0d.js";import{A as P}from"./Add-DinP5QbX.js";import{S as Re}from"./Search-BDaMMIPP.js";import{F as je}from"./FilterList-BXxQXbYc.js";import{R as ye}from"./Refresh-BWfz7OQR.js";import{L as ve}from"./LocalHospital-BMwh71ta.js";import{P as Ce}from"./Person-BO7Sszq-.js";import{M as be}from"./MoreVert-nhhWlZ7h.js";import{d as C}from"./diagnosticApi-CpaUG7NC.js";import{E as we}from"./ErrorBoundary-C2-bA3VX.js";import{F as Se}from"./Fab-Td7g1Onu.js";import"./BugReport-Bln5s9ri.js";const qe=ee()(se((i,o)=>({requests:[],results:[],selectedRequest:null,selectedResult:null,filters:{search:"",patientId:"",status:void 0,dateFrom:"",dateTo:"",page:1,limit:20,sortBy:"createdAt",sortOrder:"desc"},pagination:{page:1,limit:20,total:0,pages:0,hasNext:!1,hasPrev:!1},uiState:{pollingActive:!1,pollingInterval:null,showCreateModal:!1,showResultModal:!1,activeStep:0},analytics:null,loading:{createRequest:!1,fetchRequests:!1,fetchResult:!1,approveResult:!1,fetchAnalytics:!1,polling:!1},errors:{createRequest:null,fetchRequests:null,fetchResult:null,approveResult:null,fetchAnalytics:null,polling:null},createRequest:async t=>{const{setLoading:s,setError:a,addRequestToState:r}=o();s("createRequest",!0),a("createRequest",null);try{const n=await C.createRequest(t);return n.success&&n.data?(r(n.data),i({selectedRequest:n.data}),n.data):(a("createRequest",n.message||"Failed to create request"),null)}catch(n){const l=n instanceof Error?n.message:"An unexpected error occurred";return a("createRequest",l),null}finally{s("createRequest",!1)}},fetchRequests:async t=>{var r,n,l,u,v,m;const{setLoading:s,setError:a}=o();s("fetchRequests",!0),a("fetchRequests",null);try{const x=t||o().filters,h=await C.getHistory(x);h.success&&h.data?i({requests:h.data.results||[],pagination:{page:((r=h.meta)==null?void 0:r.page)||x.page||1,limit:((n=h.meta)==null?void 0:n.limit)||x.limit||20,total:((l=h.meta)==null?void 0:l.total)||0,pages:((u=h.meta)==null?void 0:u.totalPages)||0,hasNext:((v=h.meta)==null?void 0:v.hasNext)||!1,hasPrev:((m=h.meta)==null?void 0:m.hasPrev)||!1}}):a("fetchRequests",h.message||"Failed to fetch requests")}catch(x){const h=x instanceof Error?x.message:"An unexpected error occurred";a("fetchRequests",h)}finally{s("fetchRequests",!1)}},fetchResult:async t=>{const{setLoading:s,setError:a,addResultToState:r}=o();s("fetchResult",!0),a("fetchResult",null);try{const n=await C.getResult(t);return n.success&&n.data?(o().results.find(u=>u._id===n.data._id)?o().updateResultInState(n.data._id,n.data):r(n.data),i({selectedResult:n.data}),n.data):(a("fetchResult",n.message||"Failed to fetch result"),null)}catch(n){const l=n instanceof Error?n.message:"An unexpected error occurred";return a("fetchResult",l),null}finally{s("fetchResult",!1)}},approveResult:async t=>{const{setLoading:s,setError:a,updateResultInState:r}=o();s("approveResult",!0),a("approveResult",null);try{const n=await C.approveResult(t);return n.success&&n.data?(r(t,n.data),i({selectedResult:n.data}),!0):(a("approveResult",n.message||"Failed to approve result"),!1)}catch(n){const l=n instanceof Error?n.message:"An unexpected error occurred";return a("approveResult",l),!1}finally{s("approveResult",!1)}},modifyResult:async(t,s)=>{const{setLoading:a,setError:r,updateResultInState:n}=o();a("approveResult",!0),r("approveResult",null);try{const l=await C.modifyResult(t,s);return l.success&&l.data?(n(t,l.data),i({selectedResult:l.data}),!0):(r("approveResult",l.message||"Failed to modify result"),!1)}catch(l){const u=l instanceof Error?l.message:"An unexpected error occurred";return r("approveResult",u),!1}finally{a("approveResult",!1)}},rejectResult:async(t,s)=>{const{setLoading:a,setError:r,updateResultInState:n}=o();a("approveResult",!0),r("approveResult",null);try{const l=await C.rejectResult(t,s);return l.success&&l.data?(n(t,l.data),i({selectedResult:l.data}),!0):(r("approveResult",l.message||"Failed to reject result"),!1)}catch(l){const u=l instanceof Error?l.message:"An unexpected error occurred";return r("approveResult",u),!1}finally{a("approveResult",!1)}},cancelRequest:async t=>{const{setLoading:s,setError:a,updateRequestInState:r}=o();s("createRequest",!0),a("createRequest",null);try{const n=await C.cancelRequest(t);return n.success&&n.data?(r(t,n.data),!0):(a("createRequest",n.message||"Failed to cancel request"),!1)}catch(n){const l=n instanceof Error?n.message:"An unexpected error occurred";return a("createRequest",l),!1}finally{s("createRequest",!1)}},startPolling:(t,s=5e3)=>{const{stopPolling:a,pollResult:r}=o();a();const n=setInterval(()=>{r(t)},s);i(l=>({uiState:{...l.uiState,pollingActive:!0,pollingInterval:n}}))},stopPolling:()=>{const{uiState:t}=o();t.pollingInterval&&clearInterval(t.pollingInterval),i(s=>({uiState:{...s.uiState,pollingActive:!1,pollingInterval:null}}))},pollResult:async t=>{const{setLoading:s,setError:a}=o();s("polling",!0),a("polling",null);try{const r=await C.getStatus(t);r.success&&r.data?r.data.status==="completed"?(await o().fetchResult(t),o().stopPolling()):(r.data.status==="failed"||r.data.status==="cancelled")&&o().stopPolling():a("polling",r.message||"Failed to check status")}catch(r){const n=r instanceof Error?r.message:"An unexpected error occurred";a("polling",n)}finally{s("polling",!1)}},setFilters:t=>{i(s=>Object.keys(t).some(r=>{const n=s.filters[r],l=t[r];return n===void 0&&l===void 0?!1:n===void 0||l===void 0?!0:JSON.stringify(n)!==JSON.stringify(l)})?{filters:{...s.filters,...t}}:s)},clearFilters:()=>{i({filters:{search:"",patientId:"",status:void 0,dateFrom:"",dateTo:"",page:1,limit:20,sortBy:"createdAt",sortOrder:"desc"}})},searchRequests:t=>{const{setFilters:s,fetchRequests:a}=o();s({search:t,page:1}),a()},filterByPatient:t=>{const{setFilters:s,fetchRequests:a}=o();s({patientId:t,page:1}),a()},filterByStatus:t=>{const{setFilters:s,fetchRequests:a}=o();s({status:t,page:1}),a()},setPage:t=>{const{setFilters:s,fetchRequests:a}=o();s({page:t}),a()},setLimit:t=>{const{setFilters:s,fetchRequests:a}=o();s({limit:t,page:1}),a()},selectRequest:t=>{i({selectedRequest:t})},selectResult:t=>{i({selectedResult:t})},setShowCreateModal:t=>{i(s=>({uiState:{...s.uiState,showCreateModal:t}}))},setShowResultModal:t=>{i(s=>({uiState:{...s.uiState,showResultModal:t}}))},setActiveStep:t=>{i(s=>({uiState:{...s.uiState,activeStep:t}}))},fetchAnalytics:async t=>{const{setLoading:s,setError:a}=o();s("fetchAnalytics",!0),a("fetchAnalytics",null);try{const r=await C.getAnalytics(t);r.success&&r.data?i({analytics:r.data}):a("fetchAnalytics",r.message||"Failed to fetch analytics")}catch(r){const n=r instanceof Error?r.message:"An unexpected error occurred";a("fetchAnalytics",n)}finally{s("fetchAnalytics",!1)}},addRequestToState:t=>{i(s=>({requests:[t,...s.requests],pagination:{...s.pagination,total:s.pagination.total+1}}))},updateRequestInState:(t,s)=>{i(a=>({requests:a.requests.map(r=>r._id===t?{...r,...s}:r)}))},removeRequestFromState:t=>{i(s=>({requests:s.requests.filter(a=>a._id!==t),pagination:{...s.pagination,total:Math.max(0,s.pagination.total-1)}}))},addResultToState:t=>{i(s=>({results:[t,...s.results]}))},updateResultInState:(t,s)=>{i(a=>({results:a.results.map(r=>r._id===t?{...r,...s}:r)}))},clearErrors:()=>{i({errors:{createRequest:null,fetchRequests:null,fetchResult:null,approveResult:null,fetchAnalytics:null,polling:null}})},setLoading:(t,s)=>{i(a=>({loading:{...a.loading,[t]:s}}))},setError:(t,s)=>{i(a=>({errors:{...a.errors,[t]:s}}))},getRequestsByPatient:t=>o().requests.filter(s=>s.patientId===t),getResultsByRequest:t=>o().results.filter(s=>s.requestId===t),getPendingRequests:()=>o().requests.filter(t=>t.status==="pending"||t.status==="processing"),getCompletedRequests:()=>o().requests.filter(t=>t.status==="completed"),getFilteredRequests:()=>{const{requests:t,filters:s}=o();let a=[...t];if(s.search){const r=s.search.toLowerCase();a=a.filter(n=>n.inputSnapshot.symptoms.subjective.some(l=>l.toLowerCase().includes(r))||n.inputSnapshot.symptoms.objective.some(l=>l.toLowerCase().includes(r)))}return s.patientId&&(a=a.filter(r=>r.patientId===s.patientId)),s.status&&(a=a.filter(r=>r.status===s.status)),s.dateFrom&&(a=a.filter(r=>new Date(r.createdAt)>=new Date(s.dateFrom))),s.dateTo&&(a=a.filter(r=>new Date(r.createdAt)<=new Date(s.dateTo))),s.sortBy&&a.sort((r,n)=>{const l=r[s.sortBy],u=n[s.sortBy];return l==null&&u==null?0:l==null?1:u==null?-1:s.sortOrder==="desc"?l>u?-1:l<u?1:0:l<u?-1:l>u?1:0}),a}}),{name:"diagnostic-store",partialize:i=>({selectedRequest:i.selectedRequest,selectedResult:i.selectedResult})})),Ie=({title:i,value:o,icon:t,color:s,trend:a})=>e.jsx(I,{sx:{height:"100%"},children:e.jsxs(k,{children:[e.jsxs(d,{sx:{display:"flex",alignItems:"center",mb:2},children:[e.jsx(d,{sx:{p:1,borderRadius:2,backgroundColor:`${s}.light`,color:`${s}.contrastText`,mr:2},children:t}),e.jsxs(d,{sx:{flexGrow:1},children:[e.jsx(p,{variant:"h4",sx:{fontWeight:600,mb:.5},children:o}),e.jsx(p,{variant:"body2",color:"text.secondary",children:i})]})]}),a&&e.jsxs(d,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(W,{sx:{fontSize:16,color:a.isPositive?"success.main":"error.main",transform:a.isPositive?"none":"rotate(180deg)",mr:.5}}),e.jsxs(p,{variant:"caption",sx:{color:a.isPositive?"success.main":"error.main",fontWeight:500},children:[Math.abs(a.value),"% from last week"]})]})]})}),ke=({request:i,result:o,onViewDetails:t,onQuickAction:s})=>{var h,A;const[a,r]=f.useState(null),l=[].find(g=>g._id===i.patientId),u={pending:"warning",processing:"info",completed:"success",failed:"error",cancelled:"default"}[i.status],v=g=>{r(g.currentTarget)},m=()=>{r(null)},x=g=>{s(i,g),m()};return e.jsx(I,{sx:{mb:2,"&:hover":{boxShadow:4}},children:e.jsxs(k,{children:[e.jsxs(d,{sx:{display:"flex",alignItems:"flex-start",mb:2},children:[e.jsxs(d,{sx:{flexGrow:1},children:[e.jsxs(d,{sx:{display:"flex",alignItems:"center",mb:1},children:[e.jsx(Ce,{sx:{fontSize:16,mr:1,color:"text.secondary"}}),e.jsx(p,{variant:"subtitle2",sx:{fontWeight:600},children:l?`${l.firstName} ${l.lastName}`:"Unknown Patient"}),e.jsx(me,{label:i.status,color:u,size:"small",sx:{ml:1,textTransform:"capitalize"}})]}),e.jsxs(p,{variant:"body2",color:"text.secondary",sx:{mb:1},children:[i.inputSnapshot.symptoms.subjective.slice(0,2).join(", "),i.inputSnapshot.symptoms.subjective.length>2&&"..."]}),e.jsx(p,{variant:"caption",color:"text.secondary",children:ge(new Date(i.createdAt),{addSuffix:!0})})]}),e.jsx(_,{size:"small",onClick:v,children:e.jsx(be,{})})]}),o&&e.jsxs(d,{sx:{mb:2},children:[e.jsx(p,{variant:"caption",color:"text.secondary",sx:{mb:1,display:"block"},children:"Top Diagnosis:"}),e.jsx(p,{variant:"body2",sx:{fontWeight:500},children:((h=o.diagnoses[0])==null?void 0:h.condition)||"No diagnosis available"}),o.diagnoses[0]&&e.jsxs(p,{variant:"caption",color:"text.secondary",children:["Confidence: ",Math.round(o.diagnoses[0].probability*100),"%"]})]}),e.jsxs(d,{sx:{display:"flex",gap:1},children:[e.jsx(y,{size:"small",variant:"outlined",onClick:()=>t(i),children:"View Details"}),i.status==="completed"&&((A=o==null?void 0:o.pharmacistReview)==null?void 0:A.status)===void 0&&e.jsx(y,{size:"small",variant:"contained",color:"primary",onClick:()=>x("review"),children:"Review"})]}),e.jsxs(z,{anchorEl:a,open:!!a,onClose:m,children:[e.jsx(S,{onClick:()=>x("view"),children:"View Full Details"}),i.status==="pending"&&e.jsx(S,{onClick:()=>x("cancel"),children:"Cancel Request"}),i.status==="completed"&&e.jsx(S,{onClick:()=>x("export"),children:"Export Report"})]})]})})},ze=()=>{var N,D,L;const i=te(),o=ae(i.breakpoints.down("md")),t=re(),[s,a]=f.useState(""),[r,n]=f.useState(null),[l,u]=f.useState(!1),{filters:v,setFilters:m,clearFilters:x,selectRequest:h}=qe(),A=[];f.useMemo(()=>({...v,limit:10}),[v]);const g={data:{results:[]}},V=()=>Promise.resolve(),M={data:{}},$=()=>Promise.resolve(),O=f.useCallback(()=>{V()},[]),b=((D=(N=g==null?void 0:g.data)==null?void 0:N.results)==null?void 0:D.filter(c=>c.status==="pending"||c.status==="processing"))||[],Q=f.useCallback(c=>{const j=c.target.value;a(j),j!==v.search&&m({search:j,page:1})},[m,v.search]),G=f.useCallback(async()=>{u(!0);try{await Promise.all([O(),$()])}finally{u(!1)}},[]),F=f.useCallback(()=>{t("/pharmacy/diagnostics/case/new")},[t]),E=f.useCallback(c=>{h(c),t(`/pharmacy/diagnostics/case/${c._id}`)},[h,t]),H=f.useCallback((c,j)=>{switch(j){case"view":E(c);break;case"review":t(`/pharmacy/diagnostics/case/${c._id}`);break}},[E,t]),J=f.useCallback(c=>{n(c.currentTarget)},[]),w=f.useCallback(()=>{n(null)},[]),U=f.useCallback(()=>{m({status:"pending"}),w()},[m,w]),X=f.useCallback(()=>{m({status:"completed"}),w()},[m,w]),Z=f.useCallback(()=>{x(),w()},[x,w]),T=((L=g==null?void 0:g.data)==null?void 0:L.results)||[],R=M==null?void 0:M.data,K=f.useMemo(()=>[{title:"Total Cases",value:(R==null?void 0:R.totalRequests)||0,icon:e.jsx(ne,{}),color:"primary",trend:{value:12,isPositive:!0}},{title:"Completed Today",value:(R==null?void 0:R.completedRequests)||0,icon:e.jsx(le,{}),color:"success",trend:{value:8,isPositive:!0}},{title:"Pending Review",value:b.length,icon:e.jsx(ie,{}),color:"warning"},{title:"Avg Confidence",value:R!=null&&R.averageConfidenceScore?`${Math.round(R.averageConfidenceScore*100)}%`:"0%",icon:e.jsx(W,{}),color:"secondary",trend:{value:5,isPositive:!0}}],[R,b.length]);return e.jsx(we,{children:e.jsxs(oe,{maxWidth:"xl",sx:{py:4},children:[e.jsxs(d,{sx:{mb:4},children:[e.jsxs(d,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:2},children:[e.jsxs(d,{children:[e.jsx(p,{variant:"h4",sx:{fontWeight:600,mb:1},children:"Diagnostic Dashboard"}),e.jsx(p,{variant:"body1",color:"text.secondary",children:"AI-powered diagnostic analysis and case management"})]}),e.jsxs(d,{sx:{display:"flex",gap:1},children:[e.jsx(ce,{title:"Refresh Data",children:e.jsx(_,{onClick:G,disabled:l,children:e.jsx(ye,{})})}),e.jsx(y,{variant:"contained",startIcon:e.jsx(P,{}),onClick:F,sx:{display:{xs:"none",sm:"flex"}},children:"New Case"})]})]}),e.jsxs(d,{sx:{display:"flex",gap:2,mb:3,flexWrap:"wrap"},children:[e.jsx(de,{placeholder:"Search cases...",value:s,onChange:Q,size:"small",sx:{minWidth:300,flexGrow:1},InputProps:{startAdornment:e.jsx(ue,{position:"start",children:e.jsx(Re,{})})}}),e.jsx(y,{variant:"outlined",startIcon:e.jsx(je,{}),onClick:J,children:"Filters"})]})]}),e.jsx(q,{container:!0,spacing:3,sx:{mb:4},children:K.map((c,j)=>e.jsx(q,{xs:12,sm:6,md:3,children:e.jsx(Ie,{...c})},j))}),e.jsxs(q,{container:!0,spacing:3,children:[e.jsx(q,{xs:12,md:8,children:e.jsx(I,{children:e.jsxs(k,{children:[e.jsxs(d,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:3},children:[e.jsx(p,{variant:"h6",sx:{fontWeight:600},children:"Recent Cases"}),e.jsx(y,{size:"small",onClick:()=>t("/pharmacy/diagnostics"),children:"View All"})]}),T.length>0?e.jsx(d,{children:T.map(c=>e.jsx(ke,{request:c,onViewDetails:E,onQuickAction:H},c._id))}):e.jsxs(d,{sx:{textAlign:"center",py:4},children:[e.jsx(B,{sx:{fontSize:48,color:"text.secondary",mb:2}}),e.jsx(p,{variant:"h6",color:"text.secondary",sx:{mb:1},children:"No cases yet"}),e.jsx(p,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Start your first diagnostic case to see it here"}),e.jsx(y,{variant:"contained",onClick:F,children:"Create First Case"})]})]})})}),e.jsx(q,{xs:12,md:4,children:e.jsxs(d,{sx:{display:"flex",flexDirection:"column",gap:3},children:[e.jsx(I,{children:e.jsxs(k,{children:[e.jsx(p,{variant:"h6",sx:{fontWeight:600,mb:2},children:"Quick Actions"}),e.jsxs(d,{sx:{display:"flex",flexDirection:"column",gap:1},children:[e.jsx(y,{variant:"outlined",startIcon:e.jsx(P,{}),onClick:F,fullWidth:!0,children:"New Diagnostic Case"}),e.jsx(y,{variant:"outlined",startIcon:e.jsx(B,{}),onClick:()=>t("/pharmacy/diagnostics/case/new"),fullWidth:!0,children:"Lab Orders"}),e.jsx(y,{variant:"outlined",startIcon:e.jsx(pe,{}),onClick:()=>t("/pharmacy/diagnostics"),fullWidth:!0,children:"View Analytics"}),e.jsx(y,{variant:"outlined",startIcon:e.jsx(ve,{}),onClick:()=>t("/pharmacy/diagnostics"),fullWidth:!0,children:"Referrals"})]})]})}),e.jsx(I,{children:e.jsxs(k,{children:[e.jsxs(d,{sx:{display:"flex",alignItems:"center",mb:2},children:[e.jsx(he,{sx:{mr:1}}),e.jsx(p,{variant:"h6",sx:{fontWeight:600},children:"Notifications"}),e.jsx(fe,{badgeContent:b.length,color:"error",sx:{ml:1}})]}),b.length>0?e.jsxs(d,{children:[b.slice(0,3).map(c=>{const j=A.find(Y=>Y._id===c.patientId);return e.jsx(xe,{severity:"info",sx:{mb:1},action:e.jsx(y,{size:"small",onClick:()=>E(c),children:"View"}),children:e.jsxs(p,{variant:"body2",children:[j?`${j.firstName} ${j.lastName}`:"Patient"," ","- Case ",c.status]})},c._id)}),b.length>3&&e.jsxs(p,{variant:"caption",color:"text.secondary",children:["+",b.length-3," more pending cases"]})]}):e.jsx(p,{variant:"body2",color:"text.secondary",children:"No pending notifications"})]})})]})})]}),o&&e.jsx(Se,{color:"primary","aria-label":"new case",onClick:F,sx:{position:"fixed",bottom:16,right:16},children:e.jsx(P,{})}),e.jsxs(z,{anchorEl:r,open:!!r,onClose:w,children:[e.jsx(S,{onClick:U,children:"Pending Cases"}),e.jsx(S,{onClick:X,children:"Completed Cases"}),e.jsx(S,{onClick:Z,children:"Clear Filters"})]})]})})};export{ze as default};
