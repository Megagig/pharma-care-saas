import{c as We,j as e,bm as we,a as Rs,ca as le,cb as de,bI as xs,cu as Ee,g as as,r as M,C as $,cs as ce,B as t,U as te,T as i,b as B,aa as N,S as Y,D as se,d as ee,I as O,bH as Le,h as R,a0 as he,L as me,n as je,V as Re,ar as Ne,p as fe,l as W,W as re,q as Ge,aR as Ae,aS as Ie,aT as Pe,aU as De,w as be,aP as Gs,Y as Ye,ab as Me,aX as rs,a2 as Ys,aW as ks,u as Ws,aZ as Js,R as Je,$ as Qe,aQ as hs,A as Ce,be as ke,a5 as H,ai as Zs,ak as Xs,Z as us,z as et,b3 as Fs,_ as zs,bw as st,bx as tt,K as nt,bf as _e,a7 as pe,a8 as ge,a9 as ye,f as ne,Q as Ze,bi as _,bj as Es,O as cs,a6 as Se,b8 as rt,b9 as Ls,cp as at,b7 as it,bs as lt,bt as ot,bu as ct,bJ as xe,cv as dt,cw as oe,cx as xt,cy as ht,cz as os,bh as Ss,bF as ut,bn as Ns,bo as ze,a4 as mt,cA as jt}from"./index-B_pWc9hu.js";import{A as Te}from"./ArrowBack-bh5q612l.js";import{P as He}from"./Person-YzlArB5c.js";import{L as Ke}from"./LocalHospital-BNb4THgq.js";import{E as ve}from"./Edit-DD3Q49Z-.js";import{P as pt}from"./Print-CBvnEWcO.js";import{S as gt}from"./Share-BCoXRojS.js";import{d as Os,f as yt,g as ft,h as bt,i as vt,j as Ct,k as St,l as Tt,m as wt,n as At}from"./usePatients-TJUphVTL.js";import{P as _s}from"./PlayArrow-MruisKZg.js";import{S as Ts}from"./Sync-C9idAwzJ.js";import{A as Z}from"./Add-D5-B7xRD.js";import{apiHelpers as ie}from"./api-65X4hLNz.js";import{mtrService as $s}from"./mtrService-BFzIf3Sf.js";import{f as It,N as Pt,a as Dt,b as Mt}from"./clinicalNote-Dz3Qh_Vc.js";import{E as ws}from"./ExpandLess-CfW7CJI2.js";import{A as Be}from"./AttachFile-CLMBR5Se.js";import{f as Rt}from"./format-CQst3Dr_.js";import{p as kt}from"./parseISO-CGAyFpjm.js";import{D as Wt}from"./Download-DRMVM3Bm.js";import{A as qs}from"./Autocomplete-HcpzFt3K.js";import{T as Ft,a as zt,b as Et,c as Lt,d as Nt,e as Ot,f as _t}from"./TimelineSeparator-BIIWoEeL.js";import{D as Us}from"./Delete-BIyg2wQJ.js";import{S as $e}from"./Search-C2mZoRVv.js";import{L as qe}from"./LocalizationProvider-CB6kfikn.js";import{A as Ue}from"./AdapterDateFns-RQ5vW8pD.js";import{T as ms,a as js,b as ps,c as Oe,d as gs}from"./TableRow-BGzfcKex.js";import{T as Q}from"./TableCell-DCrr5aWG.js";import{D as ys}from"./DateTimePicker-DzpmGcCV.js";import{D as Vs}from"./DatePicker-tSjwJs7r.js";import $t from"./PatientMedicationsPage-DoNZFwM1.js";import{M as As}from"./MonitorHeart-D-Nq_5B0.js";import{O as qt}from"./WifiOff-DA694lDl.js";import{u as is}from"./useResponsive-LdFh52p2.js";import{C as Ut}from"./CardActions-DtPJ3__D.js";import{R as Is}from"./Remove-CMoL-_ZM.js";import{I as Vt}from"./Image-B2lXq2kK.js";import{C as Xe}from"./CalendarToday-Dqq_i_do.js";import"./addMonths-BkvcT9-f.js";import"./useMobilePicker-CrD-8_S2.js";import"./index-BydA3A-2.js";import"./History-CBlfKycA.js";import"./MedicationSettingsPanel-DuJVXoWP.js";import"./medicationManagementService-CUmM5Vi5.js";import"./Switch-DtQ0auD3.js";import"./LineChart-DOW8HQwa.js";import"./reselect-CMjPfUWD.js";import"./BarChart-BVPxthC0.js";import"./PieChart-p46ZrMiT.js";const Bt=We(e.jsx("path",{d:"M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8zm2 11h-3v3.75c0 1.24-1.01 2.25-2.25 2.25S8.5 17.99 8.5 16.75s1.01-2.25 2.25-2.25c.46 0 .89.14 1.25.38V11h4zm-3-4V3.5L18.5 9z"})),Qt=We([e.jsx("path",{d:"M7 19c-1.1 0-2 .9-2 2h14c0-1.1-.9-2-2-2h-4v-2h3c1.1 0 2-.9 2-2h-8c-1.66 0-3-1.34-3-3 0-1.09.59-2.04 1.46-2.56C8.17 9.03 8 8.54 8 8c0-.21.04-.42.09-.62C6.28 8.13 5 9.92 5 12c0 2.76 2.24 5 5 5v2z"},"0"),e.jsx("path",{d:"M10.56 5.51C11.91 5.54 13 6.64 13 8c0 .75-.33 1.41-.85 1.87l.59 1.62.94-.34.34.94 1.88-.68-.34-.94.94-.34-2.74-7.53-.94.34-.34-.94-1.88.68.34.94-.94.35z"},"1"),e.jsx("circle",{cx:"10.5",cy:"8",r:"1.5"},"2")]),Ht=We(e.jsx("path",{d:"M12 6c1.11 0 2-.9 2-2 0-.38-.1-.73-.29-1.03L12 0l-1.71 2.97c-.19.3-.29.65-.29 1.03 0 1.1.9 2 2 2m4.6 9.99-1.07-1.07-1.08 1.07c-1.3 1.3-3.58 1.31-4.89 0l-1.07-1.07-1.09 1.07C6.75 16.64 5.88 17 4.96 17c-.73 0-1.4-.23-1.96-.61V21c0 .55.45 1 1 1h16c.55 0 1-.45 1-1v-4.61c-.56.38-1.23.61-1.96.61-.92 0-1.79-.36-2.44-1.01M18 9h-5V7h-2v2H6c-1.66 0-3 1.34-3 3v1.54c0 1.08.88 1.96 1.96 1.96.52 0 1.02-.2 1.38-.57l2.14-2.13 2.13 2.13c.74.74 2.03.74 2.77 0l2.14-2.13 2.13 2.13c.37.37.86.57 1.38.57 1.08 0 1.96-.88 1.96-1.96V12C21 10.34 19.66 9 18 9"})),Kt=We(e.jsx("path",{d:"M3 10h11v2H3zm0-2h11V6H3zm0 8h7v-2H3zm15.01-3.13.71-.71c.39-.39 1.02-.39 1.41 0l.71.71c.39.39.39 1.02 0 1.41l-.71.71zm-.71.71-5.3 5.3V21h2.12l5.3-5.3z"})),Gt=We(e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m-1 14H9V8h2zm4 0h-2V8h2z"})),Ps=We(e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2M7 13.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5m5 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5m5 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5"})),es=We(e.jsx("path",{d:"M1 21h22L12 2zm12-3h-2v-2h2zm0-4h-2v-4h2z"}));function Yt(s){return s?"data"in s&&s.data&&"results"in s.data?s.data.results:"results"in s?s.results:[]:[]}function ds(s){if(s)return typeof s=="object"&&s!==null&&"data"in s?s.data:s}const fs=(s,l)=>we({queryKey:["manualLabOrders","patient",s],queryFn:async()=>{var o,u,c;const a=await Rs.get(`/manual-lab/patient/${s}`);return((u=(o=a.data)==null?void 0:o.data)==null?void 0:u.orders)||((c=a.data)==null?void 0:c.orders)||a.data||[]},enabled:(l==null?void 0:l.enabled)!==!1&&!!s,refetchInterval:l==null?void 0:l.refetchInterval,staleTime:5*60*1e3,retry:(a,o)=>{var u,c;return((u=o==null?void 0:o.response)==null?void 0:u.status)===404||((c=o==null?void 0:o.response)==null?void 0:c.status)===403?!1:a<2}}),Jt=()=>{const s=le();return de({mutationFn:async l=>(await Rs.post("/manual-lab",l)).data,onSuccess:(l,a)=>{s.invalidateQueries({queryKey:["manualLabOrders","patient",a.patientId]}),s.setQueryData(["manualLabOrders",l.data.order.orderId],l.data.order)}})},ls={async getPatientMTRSummary(s){var l,a,o;try{return(await ie.get(`/patients/${s}/mtr/summary`)).data.data.summary}catch(u){if(console.error("Failed to get patient MTR summary:",u),((l=u==null?void 0:u.response)==null?void 0:l.status)===404||((a=u==null?void 0:u.response)==null?void 0:a.status)===403||((o=u==null?void 0:u.response)==null?void 0:o.status)===429)return{patientId:s,totalMTRSessions:0,activeMTRSessions:0,completedMTRSessions:0,hasActiveMTR:!1,mtrStatus:"none",recentMTRs:[]};try{const m=(await $s.getMTRSessionsByPatient(s)).results||[],C=m.filter(P=>P.status==="in_progress"),I=m.filter(P=>P.status==="completed"),b=m.sort((P,g)=>new Date(g.startedAt).getTime()-new Date(P.startedAt).getTime())[0];let T="none";return C.length>0?T=C.some(g=>g.isOverdue)?"overdue":"active":m.length>0&&(T="none"),{patientId:s,totalMTRSessions:m.length,activeMTRSessions:C.length,completedMTRSessions:I.length,lastMTRDate:b==null?void 0:b.startedAt,hasActiveMTR:C.length>0,mtrStatus:T,recentMTRs:m.slice(0,3)}}catch(c){return console.error("Fallback also failed:",c),{patientId:s,totalMTRSessions:0,activeMTRSessions:0,completedMTRSessions:0,hasActiveMTR:!1,mtrStatus:"none",recentMTRs:[]}}}},async getPatientDataForMTR(s){try{return(await ie.get(`/patients/${s}/mtr/data`)).data.data.patientData}catch(l){throw console.error("Failed to get patient data for MTR:",l),l}},async syncMedicationsWithMTR(s,l){try{return(await ie.post(`/patients/${s}/mtr/${l}/sync-medications`)).data.data.syncResult}catch(a){throw console.error("Failed to sync medications with MTR:",a),a}},async importPatientMedicationsToMTR(s,l,a){try{return(await ie.post(`/patients/${s}/mtr/${l}/import-medications`,{medicationIds:a})).data.data.medications}catch(o){throw console.error("Failed to import patient medications to MTR:",o),o}},async exportMTRMedicationsToPatient(s,l,a){try{return(await ie.post(`/patients/${s}/mtr/${l}/export-medications`,{medications:a})).data.data.medications}catch(o){throw console.error("Failed to export MTR medications to patient:",o),o}},async syncDTPsWithMTR(s,l){try{return(await ie.post(`/patients/${s}/mtr/${l}/sync-dtps`)).data.data.syncResult}catch(a){throw console.error("Failed to sync DTPs with MTR:",a),a}},async createPatientDTPFromMTR(s,l){try{return(await ie.post(`/patients/${s}/dtps/from-mtr/${l}`)).data.data.dtp}catch(a){throw console.error("Failed to create patient DTP from MTR:",a),a}},async updatePatientMTRStatus(s,l){try{return(await ie.put(`/patients/${s}/mtr-status`,l)).data.data.patient}catch(a){throw console.error("Failed to update patient MTR status:",a),a}},async addMTRSummaryToNotes(s,l,a){try{return(await ie.post(`/patients/${s}/clinical-notes/mtr-summary`,{mtrId:l,summary:a})).data}catch(o){throw console.error("Failed to add MTR summary to notes:",o),o}},async getPatientDashboardMTRData(s){try{return(await ie.get(`/patients/${s}/dashboard/mtr`)).data.data.dashboardData}catch(l){throw console.error("Failed to get patient dashboard MTR data:",l),l}},async getBulkPatientMTRStatus(s){try{return(await ie.post("/patients/bulk/mtr-status",{patientIds:s})).data.data.patientMTRStatus}catch(l){throw console.error("Failed to get bulk patient MTR status:",l),l}},async updateBulkPatientMTRStatus(s){try{return(await ie.put("/patients/bulk/mtr-status",{updates:s})).data}catch(l){throw console.error("Failed to update bulk patient MTR status:",l),l}},async searchPatientsWithMTR(s){try{const l=new URLSearchParams;Object.entries(s).forEach(([c,m])=>{m!=null&&m!==""&&l.append(c,m.toString())});const a=l.toString(),o=`/patients/search/with-mtr${a?`?${a}`:""}`;return(await ie.get(o)).data.data}catch(l){throw console.error("Failed to search patients with MTR:",l),l}}},Zt=(s,l=!0)=>we({queryKey:["patients",s,"mtr","summary"],queryFn:()=>ls.getPatientMTRSummary(s),enabled:!!s&&l,staleTime:5*60*1e3,cacheTime:10*60*1e3,retry:(a,o)=>{var u,c,m;return((u=o==null?void 0:o.response)==null?void 0:u.status)===404||((c=o==null?void 0:o.response)==null?void 0:c.status)===403||((m=o==null?void 0:o.response)==null?void 0:m.status)===429?!1:a<2},retryDelay:a=>Math.min(1e3*2**a,3e4)}),Xt=(s,l=!0)=>we({queryKey:["patients",s,"dashboard","mtr"],queryFn:()=>ls.getPatientDashboardMTRData(s),enabled:!!s&&l,staleTime:5*60*1e3,cacheTime:10*60*1e3,retry:(a,o)=>{var u,c,m;return((u=o==null?void 0:o.response)==null?void 0:u.status)===404||((c=o==null?void 0:o.response)==null?void 0:c.status)===403||((m=o==null?void 0:o.response)==null?void 0:m.status)===429?!1:a<2},retryDelay:a=>Math.min(1e3*2**a,3e4)}),en=()=>{const s=le(),l=xs(a=>a.addNotification);return de({mutationFn:({patientId:a,mtrId:o})=>ls.syncMedicationsWithMTR(a,o),onSuccess:(a,o)=>{s.invalidateQueries({queryKey:["patients",o.patientId,"medications"]}),s.invalidateQueries({queryKey:Ee.mtr.detail(o.mtrId)}),s.invalidateQueries({queryKey:["patients",o.patientId,"mtr"]});const{syncStatus:u,conflicts:c}=a;u==="synced"?l({type:"success",title:"Medications Synchronized",message:"Patient medications have been successfully synchronized with MTR.",duration:4e3}):u==="conflicts"&&c&&l({type:"warning",title:"Synchronization Conflicts",message:`Found ${c.length} conflicts that need manual resolution.`,duration:6e3})},onError:a=>{l({type:"error",title:"Synchronization Failed",message:a.message||"Failed to synchronize medications. Please try again.",duration:5e3})}})},sn=()=>{const s=le(),l=xs(a=>a.addNotification);return de({mutationFn:({patientId:a,mtrId:o})=>ls.syncDTPsWithMTR(a,o),onSuccess:(a,o)=>{s.invalidateQueries({queryKey:["patients",o.patientId,"dtps"]}),s.invalidateQueries({queryKey:Ee.drugTherapyProblems.byReview(o.mtrId)}),s.invalidateQueries({queryKey:["patients",o.patientId,"mtr"]});const{syncStatus:u}=a;l(u==="synced"?{type:"success",title:"DTPs Synchronized",message:"Drug therapy problems have been successfully synchronized.",duration:4e3}:{type:"info",title:"DTPs Need Update",message:"Some drug therapy problems need manual review and update.",duration:5e3})},onError:a=>{l({type:"error",title:"DTP Sync Failed",message:a.message||"Failed to synchronize DTPs. Please try again.",duration:5e3})}})},tn=()=>{const s=le(),l=xs(a=>a.addNotification);return de({mutationFn:a=>$s.createMTRSession(a),onSuccess:(a,o)=>{var c;s.invalidateQueries({queryKey:Ee.mtr.lists()}),s.invalidateQueries({queryKey:Ee.mtr.byPatient(o.patientId)}),s.invalidateQueries({queryKey:Ee.mtr.active()});const u=(a==null?void 0:a.review)||((c=a==null?void 0:a.data)==null?void 0:c.review);u&&s.setQueryData(Ee.mtr.detail(u._id),a),l({type:"success",title:"MTR Session Created",message:`MTR session ${(u==null?void 0:u.reviewNumber)||""} has been successfully created.`,duration:5e3})},onError:a=>{l({type:"error",title:"Creation Failed",message:a.message||"Failed to create MTR session. Please try again.",duration:5e3})}})},Bs=({patientId:s,onStartMTR:l,onViewMTR:a})=>{const o=as(),[u,c]=M.useState(!1),[m,C]=M.useState(null),{data:I,isLoading:b,isError:T,error:P}=Xt(s,!!s&&s.length===24),g=tn(),S=en(),D=sn(),h=async d=>{var p,V,x;if(d&&(d.preventDefault(),d.stopPropagation()),g.isPending){console.log("MTR creation already in progress, ignoring click");return}try{console.log("Starting MTR for patient:",s);const A=await g.mutateAsync({patientId:s,reviewType:"initial",priority:"routine",patientConsent:!0,confidentialityAgreed:!0});console.log("MTR creation result:",A);let y=((p=A==null?void 0:A.review)==null?void 0:p._id)||((x=(V=A==null?void 0:A.data)==null?void 0:V.review)==null?void 0:x._id)||(A==null?void 0:A._id);if(!y)throw console.error("No MTR ID returned from creation:",A),console.error("Full result structure:",JSON.stringify(A,null,2)),new Error("Failed to create MTR session - no ID returned");console.log("Navigating to MTR:",y),l?l(y):(console.log("Navigating to:",`/pharmacy/medication-therapy/${y}`),setTimeout(()=>{o(`/pharmacy/medication-therapy/${y}`,{replace:!1})},100))}catch(A){console.error("Failed to start MTR:",A)}},j=d=>{a?a(d):o(`/pharmacy/medication-therapy/${d}`)},w=d=>{C(d),c(!0)},z=async()=>{if(m)try{await Promise.all([S.mutateAsync({patientId:s,mtrId:m}),D.mutateAsync({patientId:s,mtrId:m})])}catch(d){console.error("Failed to sync data:",d)}finally{c(!1),C(null)}},K=d=>{switch(d){case"completed":return e.jsx(be,{color:"success"});case"in_progress":return e.jsx(_s,{color:"primary"});case"on_hold":return e.jsx(Ge,{color:"warning"});case"cancelled":return e.jsx(re,{color:"error"});default:return e.jsx(te,{})}},F=d=>{switch(d){case"high_risk":return"error";case"urgent":return"warning";case"routine":default:return"default"}};if(b)return e.jsxs($,{children:[e.jsx(ce,{title:e.jsxs(t,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(te,{}),e.jsx(i,{variant:"h6",children:"Medication Therapy Review"})]})}),e.jsx(B,{children:e.jsx(N,{spacing:2,children:[...Array(3)].map((d,p)=>e.jsx(Y,{variant:"rectangular",height:60},p))})})]});if(T)return e.jsxs($,{children:[e.jsx(ce,{title:e.jsxs(t,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(te,{}),e.jsx(i,{variant:"h6",children:"Medication Therapy Review"})]})}),e.jsx(B,{children:e.jsxs(se,{severity:"error",children:["Failed to load MTR data: ",(P==null?void 0:P.message)||"Unknown error"]})})]});const k=I,{activeMTRs:G,recentMTRs:q,mtrSummary:L,pendingActions:U}=k||{activeMTRs:[],recentMTRs:[],mtrSummary:{totalMTRSessions:0,completedMTRSessions:0,activeMTRSessions:0},pendingActions:[]};return e.jsxs(e.Fragment,{children:[e.jsxs($,{children:[e.jsx(ce,{title:e.jsxs(t,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(te,{}),e.jsx(i,{variant:"h6",children:"Medication Therapy Review"})]}),action:e.jsxs(N,{direction:"row",spacing:1,children:[L&&L.totalMTRSessions>0&&e.jsx(ee,{title:"View MTR History",children:e.jsx(O,{size:"small",onClick:()=>o(`/patients/${s}/mtr-history`),children:e.jsx(Le,{})})}),e.jsx(R,{size:"small",variant:"contained",startIcon:e.jsx(Z,{}),onClick:d=>h(d),disabled:g.isPending,type:"button",children:"Start MTR"})]})}),e.jsx(B,{children:e.jsxs(N,{spacing:3,children:[L&&e.jsxs(t,{sx:{display:"grid",gridTemplateColumns:"repeat(4, 1fr)",gap:2},children:[e.jsxs(t,{sx:{textAlign:"center"},children:[e.jsx(i,{variant:"h4",color:"primary",children:L.totalMTRSessions}),e.jsx(i,{variant:"caption",color:"text.secondary",children:"Total Sessions"})]}),e.jsxs(t,{sx:{textAlign:"center"},children:[e.jsx(i,{variant:"h4",color:"success.main",children:L.completedMTRSessions}),e.jsx(i,{variant:"caption",color:"text.secondary",children:"Completed"})]}),e.jsxs(t,{sx:{textAlign:"center"},children:[e.jsx(i,{variant:"h4",color:"warning.main",children:L.activeMTRSessions}),e.jsx(i,{variant:"caption",color:"text.secondary",children:"Active"})]}),e.jsxs(t,{sx:{textAlign:"center"},children:[e.jsx(i,{variant:"body2",sx:{fontWeight:600},children:L.lastMTRDate?new Date(L.lastMTRDate).toLocaleDateString():"Never"}),e.jsx(i,{variant:"caption",color:"text.secondary",children:"Last MTR"})]})]}),G&&G.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(he,{}),e.jsxs(t,{children:[e.jsx(i,{variant:"subtitle2",sx:{mb:1,fontWeight:600},children:"Active MTR Sessions"}),e.jsx(me,{dense:!0,children:G.map(d=>e.jsxs(je,{sx:{border:1,borderColor:"divider",borderRadius:1,mb:1},secondaryAction:e.jsxs(N,{direction:"row",spacing:.5,children:[e.jsx(ee,{title:"Sync patient data",children:e.jsx(O,{size:"small",onClick:()=>w(d._id),children:e.jsx(Ts,{})})}),e.jsx(ee,{title:"View MTR",children:e.jsx(O,{size:"small",color:"primary",onClick:()=>j(d._id),children:e.jsx(Re,{})})})]}),children:[e.jsx(Ne,{children:K(d.status)}),e.jsx(fe,{primary:e.jsxs(t,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(i,{variant:"body2",sx:{fontWeight:500},children:d.reviewNumber}),e.jsx(W,{size:"small",label:d.priority,color:F(d.priority),variant:"outlined"}),d.isOverdue&&e.jsx(W,{size:"small",label:"Overdue",color:"error",icon:e.jsx(re,{})})]}),secondary:e.jsxs(i,{variant:"caption",color:"text.secondary",children:["Started"," ",new Date(d.startedAt).toLocaleDateString()," ","•",d.completionPercentage,"% complete"]})})]},d._id))})]})]}),U&&U.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(he,{}),e.jsxs(t,{children:[e.jsx(i,{variant:"subtitle2",sx:{mb:1,fontWeight:600},children:"Pending Actions"}),e.jsx(me,{dense:!0,children:U.slice(0,3).map((d,p)=>e.jsxs(je,{children:[e.jsx(Ne,{children:e.jsx(Ge,{color:d.priority==="high"?"error":"warning"})}),e.jsx(fe,{primary:d.description,secondary:d.dueDate&&e.jsxs(i,{variant:"caption",color:"text.secondary",children:["Due:"," ",new Date(d.dueDate).toLocaleDateString()]})})]},p))})]})]}),q&&q.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(he,{}),e.jsxs(t,{children:[e.jsx(i,{variant:"subtitle2",sx:{mb:1,fontWeight:600},children:"Recent MTR Sessions"}),e.jsx(me,{dense:!0,children:q.slice(0,3).map(d=>e.jsxs(je,{component:"div",onClick:()=>j(d._id),sx:{cursor:"pointer"},children:[e.jsx(Ne,{children:K(d.status)}),e.jsx(fe,{primary:e.jsxs(t,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(i,{variant:"body2",children:d.reviewNumber}),e.jsx(W,{size:"small",label:d.status,color:d.status==="completed"?"success":"default",variant:"outlined"})]}),secondary:e.jsxs(i,{variant:"caption",color:"text.secondary",children:[new Date(d.startedAt).toLocaleDateString(),d.completedAt&&` - ${new Date(d.completedAt).toLocaleDateString()}`]})})]},d._id))})]})]}),(!L||L.totalMTRSessions===0)&&e.jsxs(t,{sx:{textAlign:"center",py:3},children:[e.jsx(te,{sx:{fontSize:48,color:"text.secondary",mb:2}}),e.jsx(i,{variant:"h6",color:"text.secondary",sx:{mb:1},children:"No MTR Sessions"}),e.jsx(i,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Start the first medication therapy review for this patient"}),e.jsx(R,{variant:"contained",startIcon:e.jsx(Z,{}),onClick:d=>h(d),disabled:g.isPending,type:"button",children:"Start First MTR"})]})]})})]}),e.jsxs(Ae,{open:u,onClose:()=>c(!1),children:[e.jsx(Ie,{children:"Sync Patient Data with MTR"}),e.jsxs(Pe,{children:[e.jsx(i,{variant:"body2",sx:{mb:2},children:"This will synchronize the patient's medications and drug therapy problems with the selected MTR session. Any conflicts will be highlighted for manual resolution."}),e.jsx(se,{severity:"info",children:e.jsxs(i,{variant:"body2",children:["• Patient medications will be imported into the MTR session",e.jsx("br",{}),"• Existing DTPs will be linked to the MTR",e.jsx("br",{}),"• Any conflicts will require manual review"]})})]}),e.jsxs(De,{children:[e.jsx(R,{onClick:()=>c(!1),children:"Cancel"}),e.jsx(R,{variant:"contained",onClick:z,disabled:S.isPending||D.isPending,startIcon:e.jsx(Ts,{}),children:"Sync Data"})]})]})]})},Qs=({patientId:s,maxNotes:l=5,showCreateButton:a=!0,onCreateNote:o,onViewNote:u,onEditNote:c})=>{var U,d;const[m,C]=M.useState(!1),[I,b]=M.useState(new Set);Gs();const{data:T,isLoading:P,error:g,refetch:S}=It(s,{limit:m?50:l,sortBy:"createdAt",sortOrder:"desc"}),D=(T==null?void 0:T.notes)||[],h=(T==null?void 0:T.total)||0,j=p=>{const V=new Set(I);V.has(p)?V.delete(p):V.add(p),b(V)},w=p=>{try{return Rt(kt(p),"MMM dd, yyyy HH:mm")}catch{return p}},z=p=>`${p.firstName} ${p.lastName}`,K=p=>Pt.find(V=>V.value===p),F=p=>Dt.find(V=>V.value===p),k=()=>{if(o)o();else{const p=`/notes/new?patientId=${s}`;window.location.href=p}},G=p=>{u?u(p):window.location.href=`/notes/${p}`},q=p=>{c?c(p):window.location.href=`/notes/${p}/edit`},L=p=>{var y,f,n;const V=I.has(p._id),x=K(p.type),A=F(p.priority);return e.jsxs(je,{sx:{flexDirection:"column",alignItems:"stretch",border:"1px solid #e0e0e0",borderRadius:2,mb:1,"&:hover":{backgroundColor:"#f5f5f5"}},children:[e.jsxs(t,{sx:{display:"flex",alignItems:"center",width:"100%",cursor:"pointer"},onClick:()=>j(p._id),children:[e.jsxs(t,{sx:{flex:1},children:[e.jsx(i,{variant:"subtitle2",fontWeight:600,noWrap:!0,children:p.title}),e.jsxs(N,{direction:"row",spacing:1,alignItems:"center",sx:{mt:.5},children:[e.jsx(W,{label:(x==null?void 0:x.label)||p.type,size:"small",variant:"outlined",color:"primary"}),e.jsx(W,{label:(A==null?void 0:A.label)||p.priority,size:"small",sx:{backgroundColor:(A==null?void 0:A.color)||"#757575",color:"white",fontWeight:500}}),p.isConfidential&&e.jsx(W,{icon:e.jsx(Ys,{}),label:"Confidential",size:"small",color:"warning"}),p.followUpRequired&&e.jsx(ee,{title:`Follow-up: ${p.followUpDate?w(p.followUpDate):"Not scheduled"}`,children:e.jsx(Ge,{color:"warning",fontSize:"small"})}),((y=p.attachments)==null?void 0:y.length)>0&&e.jsx(ee,{title:`${p.attachments.length} attachment(s)`,children:e.jsx(Be,{color:"action",fontSize:"small"})})]}),e.jsxs(i,{variant:"caption",color:"text.secondary",children:[w(p.createdAt)," •"," ",z(p.pharmacist)]})]}),e.jsxs(t,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(O,{size:"small",onClick:r=>{r.stopPropagation(),G(p._id)},children:e.jsx(Re,{})}),e.jsx(O,{size:"small",onClick:r=>{r.stopPropagation(),q(p._id)},children:e.jsx(ve,{})}),e.jsx(O,{size:"small",children:V?e.jsx(ws,{}):e.jsx(rs,{})})]})]}),e.jsx(ks,{in:V,children:e.jsxs(t,{sx:{mt:2,pt:2,borderTop:"1px solid #e0e0e0"},children:[p.content.subjective&&e.jsxs(t,{sx:{mb:1},children:[e.jsx(i,{variant:"caption",fontWeight:600,color:"primary",children:"Subjective:"}),e.jsx(i,{variant:"body2",sx:{mt:.5},children:p.content.subjective})]}),p.content.objective&&e.jsxs(t,{sx:{mb:1},children:[e.jsx(i,{variant:"caption",fontWeight:600,color:"primary",children:"Objective:"}),e.jsx(i,{variant:"body2",sx:{mt:.5},children:p.content.objective})]}),p.content.assessment&&e.jsxs(t,{sx:{mb:1},children:[e.jsx(i,{variant:"caption",fontWeight:600,color:"primary",children:"Assessment:"}),e.jsx(i,{variant:"body2",sx:{mt:.5},children:p.content.assessment})]}),p.content.plan&&e.jsxs(t,{sx:{mb:1},children:[e.jsx(i,{variant:"caption",fontWeight:600,color:"primary",children:"Plan:"}),e.jsx(i,{variant:"body2",sx:{mt:.5},children:p.content.plan})]}),((f=p.recommendations)==null?void 0:f.length)>0&&e.jsxs(t,{sx:{mb:1},children:[e.jsx(i,{variant:"caption",fontWeight:600,color:"primary",children:"Recommendations:"}),e.jsx(me,{dense:!0,sx:{mt:.5},children:p.recommendations.map((r,v)=>e.jsx(je,{sx:{py:0,px:1},children:e.jsx(fe,{primary:r,primaryTypographyProps:{variant:"body2"}})},v))})]}),((n=p.tags)==null?void 0:n.length)>0&&e.jsx(t,{sx:{mt:1},children:e.jsx(N,{direction:"row",spacing:.5,flexWrap:"wrap",children:p.tags.map((r,v)=>e.jsx(W,{label:r,size:"small",variant:"outlined",color:"secondary"},v))})})]})})]},p._id)};return e.jsxs($,{children:[e.jsx(ce,{title:e.jsxs(t,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(Ye,{sx:{mr:1,color:"primary.main"}}),e.jsx(i,{variant:"h6",children:"Clinical Notes"}),h>0&&e.jsx(W,{label:h,size:"small",color:"primary",sx:{ml:1}})]}),action:e.jsx(t,{children:a&&e.jsx(R,{startIcon:e.jsx(Z,{}),onClick:k,variant:"contained",size:"small",children:"New Note"})})}),e.jsx(B,{sx:{pt:0},children:P?e.jsx(t,{sx:{display:"flex",justifyContent:"center",py:3},children:e.jsx(Me,{})}):g?e.jsx(se,{severity:"error",sx:{mb:2},action:e.jsx(R,{color:"inherit",size:"small",onClick:()=>S(),children:"Retry"}),children:((U=g.response)==null?void 0:U.status)===404?"Patient not found or access denied":((d=g.response)==null?void 0:d.status)===401?"Authentication required. Please log in again.":`Failed to load clinical notes: ${g.message}`}):D.length===0?e.jsxs(t,{sx:{textAlign:"center",py:4},children:[e.jsx(Ye,{sx:{fontSize:48,color:"text.secondary",mb:2}}),e.jsx(i,{variant:"body1",color:"text.secondary",sx:{mb:2},children:"No clinical notes found for this patient"}),a&&e.jsx(R,{startIcon:e.jsx(Z,{}),onClick:k,variant:"outlined",children:"Create First Note"})]}):e.jsxs(e.Fragment,{children:[e.jsx(me,{sx:{p:0},children:D.map(L)}),h>l&&e.jsxs(e.Fragment,{children:[e.jsx(he,{sx:{my:2}}),e.jsx(t,{sx:{textAlign:"center"},children:e.jsx(R,{onClick:()=>C(!m),startIcon:m?e.jsx(ws,{}):e.jsx(rs,{}),variant:"text",children:m?"Show Less":`Show All ${h} Notes`})})]}),e.jsx(t,{sx:{textAlign:"center",mt:2},children:e.jsx(R,{variant:"outlined",onClick:()=>window.open(`/notes?patientId=${s}`,"_blank"),fullWidth:!0,children:"View All Notes in Dashboard"})})]})})]})},nn=[{value:"requested",label:"Requested",color:"#2196f3"},{value:"sample_collected",label:"Sample Collected",color:"#ff9800"},{value:"result_awaited",label:"Result Awaited",color:"#9c27b0"},{value:"completed",label:"Completed",color:"#4caf50"},{value:"referred",label:"Referred",color:"#f44336"}],bs=(s,l)=>{const a=typeof s=="string"?new Date(s):s,o={year:"numeric",month:"long",day:"numeric",...l};return new Intl.DateTimeFormat("en-US",o).format(a)},rn=s=>bs(s,{year:"numeric",month:"short",day:"numeric"}),an=s=>{const l=new Date,a=typeof s=="string"?new Date(s):s,o=l.getTime()-a.getTime(),u=Math.floor(o/(1e3*60*60*24)),c=Math.floor(o/(1e3*60*60)),m=Math.floor(o/(1e3*60));return u>7?rn(s):u>=1?`${u} day${u>1?"s":""} ago`:c>=1?`${c} hour${c>1?"s":""} ago`:m>=1?`${m} minute${m>1?"s":""} ago`:"Just now"},ln=[{name:"Complete Blood Count",code:"CBC",loincCode:"58410-2",specimenType:"Blood",unit:"cells/μL",refRange:"4.5-11.0 x10³",category:"Hematology"},{name:"Basic Metabolic Panel",code:"BMP",loincCode:"51990-0",specimenType:"Blood",unit:"mmol/L",refRange:"Various",category:"Chemistry"},{name:"Lipid Panel",code:"LIPID",loincCode:"57698-3",specimenType:"Blood",unit:"mg/dL",refRange:"Various",category:"Chemistry"},{name:"Liver Function Tests",code:"LFT",loincCode:"24362-6",specimenType:"Blood",unit:"U/L",refRange:"Various",category:"Chemistry"},{name:"Thyroid Function Tests",code:"TFT",loincCode:"24348-5",specimenType:"Blood",unit:"mIU/L",refRange:"0.4-4.0",category:"Endocrinology"},{name:"Urinalysis",code:"UA",loincCode:"24357-6",specimenType:"Urine",unit:"Various",refRange:"Various",category:"Urinalysis"}],on=({patientId:s,maxOrders:l=3,onViewOrder:a,onViewResults:o,onViewAllOrders:u})=>{const c=Ws(),m=Js(c.breakpoints.down("md")),[C,I]=M.useState(!1),[b,T]=M.useState([]),[P,g]=M.useState(""),[S,D]=M.useState(!1),{data:h=[],isLoading:j,isError:w,error:z,refetch:K}=fs(s),F=Jt(),k=h.slice(0,l),G=d=>{switch(d){case"requested":return e.jsx(Ps,{color:"info"});case"sample_collected":return e.jsx(Qe,{color:"primary"});case"result_awaited":return e.jsx(Ps,{color:"warning"});case"completed":return e.jsx(be,{color:"success"});case"referred":return e.jsx(re,{color:"error"});default:return e.jsx(te,{})}},q=d=>{switch(d){case"requested":return"info";case"sample_collected":return"primary";case"result_awaited":return"warning";case"completed":return"success";case"referred":return"error";default:return"default"}},L=async()=>{if(!(b.length===0||!P.trim()||!S))try{const d={patientId:s,tests:b,indication:P.trim(),priority:"routine",consentObtained:!0};await F.mutateAsync(d),T([]),g(""),D(!1),I(!1)}catch(d){console.error("Failed to create lab order:",d)}},U=d=>{const p=`/api/manual-lab/${d}/pdf`;window.open(p,"_blank")};return j?e.jsxs($,{children:[e.jsx(ce,{title:"Lab Orders"}),e.jsx(B,{children:e.jsx(N,{spacing:2,children:[...Array(3)].map((d,p)=>e.jsx(Y,{variant:"rectangular",height:60},p))})})]}):w?e.jsxs($,{children:[e.jsx(ce,{title:"Lab Orders"}),e.jsx(B,{children:e.jsxs(se,{severity:"error",children:[e.jsxs(i,{variant:"body2",children:["Failed to load lab orders:"," ",z instanceof Error?z.message:"Unknown error"]}),e.jsx(R,{size:"small",startIcon:e.jsx(Je,{}),onClick:()=>K(),sx:{mt:1},children:"Retry"})]})})]}):e.jsxs(e.Fragment,{children:[e.jsxs($,{children:[e.jsx(ce,{title:e.jsxs(t,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Qe,{color:"primary"}),e.jsx(i,{variant:"h6",fontWeight:600,children:"Lab Orders"}),h.length>0&&e.jsx(W,{label:h.length,size:"small",color:"primary"})]}),action:e.jsxs(t,{sx:{display:"flex",gap:1},children:[e.jsx(R,{size:"small",startIcon:e.jsx(Z,{}),onClick:()=>I(!0),variant:"outlined",children:"Quick Order"}),e.jsx(O,{size:"small",onClick:()=>K(),children:e.jsx(Je,{})})]})}),e.jsx(B,{children:k.length===0?e.jsxs(t,{sx:{textAlign:"center",py:3},children:[e.jsx(Qe,{sx:{fontSize:48,color:"text.secondary",mb:2}}),e.jsx(i,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:"No lab orders yet"}),e.jsx(R,{startIcon:e.jsx(Z,{}),onClick:()=>I(!0),variant:"contained",size:"small",children:"Create First Order"})]}):e.jsxs(e.Fragment,{children:[e.jsx(me,{dense:!0,children:k.map((d,p)=>e.jsxs(hs.Fragment,{children:[e.jsxs(je,{sx:{px:0},secondaryAction:e.jsxs(t,{sx:{display:"flex",gap:.5},children:[e.jsx(ee,{title:"Download PDF",children:e.jsx(O,{size:"small",onClick:()=>U(d.orderId),children:e.jsx(Wt,{fontSize:"small"})})}),a&&e.jsx(ee,{title:"View Details",children:e.jsx(O,{size:"small",onClick:()=>a(d.orderId),children:e.jsx(Re,{fontSize:"small"})})})]}),children:[e.jsx(Ne,{children:e.jsx(Ce,{sx:{width:32,height:32,bgcolor:"primary.main"},children:G(d.status)})}),e.jsx(fe,{primary:e.jsxs(t,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(i,{variant:"body2",fontWeight:600,children:d.orderId}),e.jsx(W,{label:nn[d.status]||d.status,size:"small",color:q(d.status)})]}),secondary:e.jsxs(t,{children:[e.jsxs(i,{variant:"caption",color:"text.secondary",children:[d.tests.length," test",d.tests.length!==1?"s":""," •"," ",bs(d.createdAt)]}),e.jsx(i,{variant:"caption",display:"block",color:"text.secondary",children:d.indication.length>40?`${d.indication.substring(0,40)}...`:d.indication})]})})]}),p<k.length-1&&e.jsx(he,{})]},d.orderId))}),h.length>l&&e.jsx(t,{sx:{textAlign:"center",mt:2},children:e.jsxs(R,{size:"small",onClick:u,variant:"text",children:["View All ",h.length," Orders"]})})]})})]}),e.jsxs(Ae,{open:C,onClose:()=>I(!1),maxWidth:"md",fullWidth:!0,fullScreen:m,children:[e.jsx(Ie,{children:e.jsxs(t,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsx(i,{variant:"h6",children:"Quick Lab Order"}),e.jsx(O,{onClick:()=>I(!1),children:e.jsx(ke,{})})]})}),e.jsx(Pe,{children:e.jsxs(N,{spacing:3,sx:{mt:1},children:[e.jsx(qs,{multiple:!0,options:ln,getOptionLabel:d=>`${d.name} (${d.code})`,value:b,onChange:(d,p)=>T(p),renderInput:d=>e.jsx(H,{...d,label:"Select Tests",placeholder:"Choose lab tests...",helperText:"Select one or more tests to order"}),renderTags:(d,p)=>d.map((V,x)=>M.createElement(W,{variant:"outlined",label:`${V.name} (${V.code})`,...p({index:x}),key:V.code})),renderOption:(d,p)=>e.jsx(t,{component:"li",...d,children:e.jsxs(t,{children:[e.jsx(i,{variant:"body2",fontWeight:600,children:p.name}),e.jsxs(i,{variant:"caption",color:"text.secondary",children:["Code: ",p.code," • Specimen: ",p.specimenType," • Category: ",p.category]})]})})}),e.jsx(H,{label:"Clinical Indication",multiline:!0,rows:3,value:P,onChange:d=>g(d.target.value),placeholder:"Enter the clinical reason for ordering these tests...",helperText:"Provide the clinical indication or reason for the lab tests",required:!0}),e.jsx(Zs,{control:e.jsx(Xs,{checked:S,onChange:d=>D(d.target.checked),required:!0}),label:"Patient consent obtained for lab testing"}),b.length>0&&e.jsxs(t,{children:[e.jsxs(i,{variant:"subtitle2",gutterBottom:!0,children:["Selected Tests (",b.length,"):"]}),e.jsx(t,{sx:{display:"flex",flexWrap:"wrap",gap:1},children:b.map(d=>e.jsx(W,{label:`${d.name} (${d.code})`,size:"small",variant:"outlined",color:"primary"},d.code))})]})]})}),e.jsxs(De,{children:[e.jsx(R,{onClick:()=>I(!1),children:"Cancel"}),e.jsx(R,{onClick:L,variant:"contained",disabled:b.length===0||!P.trim()||!S||F.isPending,children:F.isPending?"Creating...":"Create Order"})]})]})]})},cn=({patientId:s,maxItems:l=10,onViewLabOrder:a,onViewClinicalNote:o,onViewMTR:u})=>{const c=Ws(),{data:m=[],isLoading:C,isError:I,refetch:b}=fs(s,{enabled:!!s}),T=M.useMemo(()=>{const h=[];return m.forEach(j=>{h.push({id:j.orderId,type:"lab_order",title:`Lab Order ${j.orderId}`,description:`${j.tests.length} test${j.tests.length!==1?"s":""} ordered: ${j.indication}`,date:j.createdAt,status:j.status,priority:j.priority,data:j}),j.status==="completed"&&j.updatedAt!==j.createdAt&&h.push({id:`${j.orderId}_results`,type:"lab_order",title:`Lab Results ${j.orderId}`,description:`Results entered for ${j.tests.length} test${j.tests.length!==1?"s":""}`,date:j.updatedAt,status:"results_entered",data:j})}),h.sort((j,w)=>new Date(w.date).getTime()-new Date(j.date).getTime()),h.slice(0,l)},[m,l]),P=h=>{switch(h.type){case"lab_order":return h.status==="results_entered"?e.jsx(te,{}):e.jsx(Qe,{});case"clinical_note":return e.jsx(te,{});case"mtr":return e.jsx(us,{});default:return e.jsx(Le,{})}},g=h=>{switch(h.type){case"lab_order":return h.status==="completed"||h.status==="results_entered"?c.palette.success.main:h.status==="result_awaited"?c.palette.warning.main:h.status==="referred"?c.palette.error.main:c.palette.primary.main;case"clinical_note":return c.palette.info.main;case"mtr":return c.palette.secondary.main;default:return c.palette.grey[500]}},S=h=>{if(!h.status)return null;let j="default",w=h.status;switch(h.status){case"completed":case"results_entered":j="success",w=h.status==="results_entered"?"Results Entered":"Completed";break;case"requested":j="info",w="Requested";break;case"sample_collected":j="primary",w="Sample Collected";break;case"result_awaited":j="warning",w="Awaiting Results";break;case"referred":j="error",w="Referred";break}return e.jsx(W,{label:w,size:"small",color:j})},D=h=>{switch(h.type){case"lab_order":a&&a(h.data.orderId);break;case"clinical_note":o&&o(h.id);break;case"mtr":u&&u(h.id);break}};return C?e.jsxs($,{children:[e.jsx(ce,{title:"Patient Timeline"}),e.jsx(B,{children:e.jsx(me,{children:[...Array(5)].map((h,j)=>e.jsxs(je,{children:[e.jsx(Ne,{children:e.jsx(Y,{variant:"circular",width:40,height:40})}),e.jsx(fe,{primary:e.jsx(Y,{variant:"text",width:"60%"}),secondary:e.jsx(Y,{variant:"text",width:"80%"})})]},j))})})]}):I?e.jsxs($,{children:[e.jsx(ce,{title:"Patient Timeline"}),e.jsx(B,{children:e.jsxs(se,{severity:"error",children:[e.jsxs(i,{variant:"body2",children:["Failed to load timeline data:"," ",I instanceof Error?I.message:"Unknown error"]}),e.jsx(R,{size:"small",startIcon:e.jsx(Je,{}),onClick:()=>b(),sx:{mt:1},children:"Retry"})]})})]}):e.jsxs($,{children:[e.jsx(ce,{title:e.jsxs(t,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Le,{color:"primary"}),e.jsx(i,{variant:"h6",fontWeight:600,children:"Patient Timeline"})]}),action:e.jsx(O,{onClick:()=>b(),children:e.jsx(Je,{})})}),e.jsx(B,{children:T.length===0?e.jsxs(t,{sx:{textAlign:"center",py:3},children:[e.jsx(Le,{sx:{fontSize:48,color:"text.secondary",mb:2}}),e.jsx(i,{variant:"body2",color:"text.secondary",children:"No recent activity"})]}):e.jsx(Ft,{children:T.map((h,j)=>e.jsxs(zt,{children:[e.jsxs(Et,{sx:{flex:.3,py:2},children:[e.jsx(i,{variant:"caption",color:"text.secondary",children:an(h.date)}),e.jsx(i,{variant:"caption",display:"block",color:"text.secondary",children:bs(h.date)})]}),e.jsxs(Lt,{children:[e.jsx(Nt,{sx:{bgcolor:g(h)},children:P(h)}),j<T.length-1&&e.jsx(Ot,{})]}),e.jsx(_t,{sx:{py:2},children:e.jsxs(t,{sx:{cursor:"pointer",p:2,borderRadius:1,border:1,borderColor:"divider","&:hover":{bgcolor:"action.hover"}},onClick:()=>D(h),children:[e.jsxs(t,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:1},children:[e.jsx(i,{variant:"subtitle2",fontWeight:600,children:h.title}),e.jsxs(t,{sx:{display:"flex",alignItems:"center",gap:1},children:[S(h),e.jsx(O,{size:"small",children:e.jsx(Re,{fontSize:"small"})})]})]}),e.jsx(i,{variant:"body2",color:"text.secondary",children:h.description}),h.priority&&h.priority!=="routine"&&e.jsx(W,{label:h.priority.toUpperCase(),size:"small",color:h.priority==="stat"?"error":"warning",sx:{mt:1}})]})})]},h.id))})})]})},dn={async getFeatureFlags(s){const l=new URLSearchParams;s!=null&&s.userId&&l.append("userId",s.userId),s!=null&&s.workplaceId&&l.append("workplaceId",s.workplaceId),s!=null&&s.environment&&l.append("environment",s.environment);const a=await fetch(`/api/feature-flags?${l}`,{credentials:"include",headers:{"Content-Type":"application/json"}});if(!a.ok)throw new Error("Failed to fetch feature flags");return a.json()},async updateFeatureFlag(s,l){const a=await fetch(`/api/feature-flags/${s}`,{method:"PATCH",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)});if(!a.ok)throw new Error("Failed to update feature flag");return a.json()}},Ds={manual_lab_orders:!0,manual_lab_pdf_generation:!0,manual_lab_qr_scanning:!0,manual_lab_ai_interpretation:!0,manual_lab_fhir_integration:!1,manual_lab_mobile_features:!0,manual_lab_enhanced_security:!0,manual_lab_performance_optimizations:!0,manual_lab_notifications:!1,manual_lab_analytics:!0},xn=()=>{const{user:s}=et(),l=le(),[a,o]=M.useState({}),u={userId:s==null?void 0:s._id,workplaceId:s==null?void 0:s.workplaceId,environment:"production",userAgent:navigator.userAgent},{data:c,isLoading:m,error:C,refetch:I}=we({queryKey:["feature-flags",u.userId,u.workplaceId],queryFn:()=>dn.getFeatureFlags(u),enabled:!!s,staleTime:5*60*1e3,cacheTime:10*60*1e3,refetchOnWindowFocus:!1,retry:2,onSuccess:g=>{o(g.flags)},onError:g=>{console.warn("Failed to fetch feature flags, using defaults:",g);const S={};Object.entries(Ds).forEach(([D,h])=>{S[D]={key:D,name:D.replace(/_/g," ").replace(/\b\w/g,j=>j.toUpperCase()),description:`Default ${D} feature flag`,enabled:h,rolloutPercentage:h?100:0,environments:["development","staging","production"]}}),o(S)}}),b=M.useCallback(g=>{if(c!=null&&c.enabledFeatures)return c.enabledFeatures.includes(g);const S=a[g];return S?S.enabled:Ds[g]??!1},[c,a]),T=M.useCallback(()=>c!=null&&c.enabledFeatures?c.enabledFeatures:Object.entries(a).filter(([g,S])=>S.enabled).map(([g,S])=>g),[c,a]),P=M.useCallback(g=>c!=null&&c.flags?c.flags[g]:a[g],[c,a]);return M.useEffect(()=>{if(!s)return;const g=setInterval(()=>{l.invalidateQueries(["feature-flags"])},5*60*1e3);return()=>clearInterval(g)},[s,l]),M.useEffect(()=>{const g=S=>{S.key==="feature-flags-update"&&l.invalidateQueries(["feature-flags"])};return window.addEventListener("storage",g),()=>window.removeEventListener("storage",g)},[l]),{isFeatureEnabled:b,getEnabledFeatures:T,getFeatureFlag:P,isLoading:m,error:C,refetch:I}},hn=({patientId:s})=>{var k,G,q,L,U,d,p,V,x,A,y;const{patientId:l}=Fs(),a=as(),o=s||l,{isFeatureEnabled:u}=xn(),c=u("clinical_notes"),{data:m,isLoading:C,isError:I,error:b}=Os(o),{data:T,isLoading:P,isError:g}=yt(o),{data:S=[],isLoading:D}=fs(o,{enabled:!!o}),h=(k=ds(m))==null?void 0:k.patient,j=ds(T),w=j?{totalActiveMedications:((G=j.counts)==null?void 0:G.currentMedications)||0,totalActiveDTPs:(q=j.counts)!=null&&q.hasActiveDTP?1:0,totalActiveConditions:((L=j.counts)==null?void 0:L.conditions)||0,recentVisits:((U=j.counts)==null?void 0:U.visits)||0,totalInterventions:((d=j.counts)==null?void 0:d.interventions)||0,activeInterventions:((p=j.counts)==null?void 0:p.activeInterventions)||0}:{totalActiveMedications:0,totalActiveDTPs:0,totalActiveConditions:0,recentVisits:0,totalInterventions:0,activeInterventions:0};if(C||P)return e.jsxs(t,{sx:{p:3},children:[e.jsx(Y,{variant:"rectangular",width:"100%",height:200,sx:{mb:3}}),e.jsx(t,{sx:{display:"flex",flexWrap:"wrap",gap:3},children:[...Array(6)].map((f,n)=>e.jsx(t,{sx:{flex:"1 1 300px",minWidth:0},children:e.jsx(Y,{variant:"rectangular",width:"100%",height:150})},n))})]});if(I||g)return e.jsxs(t,{sx:{p:3},children:[e.jsxs(se,{severity:"error",sx:{mb:3},children:[e.jsx(i,{variant:"h6",children:"Failed to load patient data"}),e.jsx(i,{variant:"body2",children:b instanceof Error?b.message:"An unexpected error occurred."})]}),e.jsx(R,{variant:"outlined",startIcon:e.jsx(Te,{}),onClick:()=>a("/patients"),children:"Back to Patients"})]});if(!h)return e.jsxs(t,{sx:{p:3},children:[e.jsxs(se,{severity:"warning",children:[e.jsx(i,{variant:"h6",children:"Patient not found"}),e.jsx(i,{variant:"body2",children:"The requested patient could not be found."})]}),e.jsx(R,{variant:"outlined",startIcon:e.jsx(Te,{}),onClick:()=>a("/patients"),sx:{mt:2},children:"Back to Patients"})]});const z=(f,n)=>`${f[0]||""}${n[0]||""}`.toUpperCase(),K=f=>{if(!f)return null;const n=new Date,r=new Date(f);let v=n.getFullYear()-r.getFullYear();const E=n.getMonth()-r.getMonth();return(E<0||E===0&&n.getDate()<r.getDate())&&v--,v},F=f=>{if(f.age!==void 0)return`${f.age} years`;const n=K(f.dob);return n?`${n} years`:"Unknown"};return e.jsxs(t,{sx:{p:3},children:[e.jsx(t,{sx:{mb:4},children:e.jsxs(t,{sx:{display:"flex",alignItems:"center",gap:2,mb:3},children:[e.jsx(O,{onClick:()=>a("/patients"),children:e.jsx(Te,{})}),e.jsx(Ce,{sx:{width:64,height:64,bgcolor:"primary.main",fontSize:"1.5rem"},children:z(h.firstName,h.lastName)}),e.jsxs(t,{sx:{flex:1},children:[e.jsxs(i,{variant:"h4",sx:{fontWeight:600,mb:1},children:[h.firstName," ",h.lastName]}),e.jsxs(t,{sx:{display:"flex",flexWrap:"wrap",gap:2,alignItems:"center"},children:[e.jsxs(i,{variant:"body1",color:"text.secondary",children:["MRN: ",h.mrn]}),e.jsx(W,{label:`${F(h)} • ${h.gender||"Unknown"}`,size:"small",variant:"outlined"}),h.bloodGroup&&e.jsx(W,{label:h.bloodGroup,size:"small",color:"primary"}),h.genotype&&e.jsx(W,{label:h.genotype,size:"small",color:h.genotype.includes("S")?"warning":"success"})]})]}),e.jsxs(t,{sx:{display:"flex",gap:1},children:[e.jsx(O,{onClick:()=>a(`/patients/${o}/edit`),children:e.jsx(ve,{})}),e.jsx(O,{onClick:()=>window.print(),children:e.jsx(pt,{})}),e.jsx(O,{onClick:()=>{navigator.share?navigator.share({title:`Patient Profile - ${h.firstName} ${h.lastName}`,text:`Patient profile for ${h.firstName} ${h.lastName} (MRN: ${h.mrn})`,url:window.location.href}):navigator.clipboard.writeText(window.location.href)},children:e.jsx(gt,{})})]})]})}),e.jsxs(t,{sx:{display:"flex",flexWrap:"wrap",gap:3,mb:4},children:[e.jsx(t,{sx:{flex:"1 1 200px",minWidth:0},children:e.jsx($,{children:e.jsx(B,{children:e.jsxs(t,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(Ce,{sx:{bgcolor:"primary.main"},children:e.jsx(us,{})}),e.jsxs(t,{children:[e.jsx(i,{variant:"h4",sx:{fontWeight:600},children:(w==null?void 0:w.totalActiveMedications)||0}),e.jsx(i,{variant:"body2",color:"text.secondary",children:"Active Medications"})]})]})})})}),e.jsx(t,{sx:{flex:"1 1 200px",minWidth:0},children:e.jsx($,{children:e.jsx(B,{children:e.jsxs(t,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(Ce,{sx:{bgcolor:"warning.main"},children:e.jsx(re,{})}),e.jsxs(t,{children:[e.jsx(i,{variant:"h4",sx:{fontWeight:600},children:(w==null?void 0:w.totalActiveDTPs)||0}),e.jsx(i,{variant:"body2",color:"text.secondary",children:"Active DTPs"})]})]})})})}),e.jsx(t,{sx:{flex:"1 1 200px",minWidth:0},children:e.jsx($,{children:e.jsx(B,{children:e.jsxs(t,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(Ce,{sx:{bgcolor:"info.main"},children:e.jsx(zs,{})}),e.jsxs(t,{children:[e.jsx(i,{variant:"h4",sx:{fontWeight:600},children:(w==null?void 0:w.totalActiveConditions)||0}),e.jsx(i,{variant:"body2",color:"text.secondary",children:"Conditions"})]})]})})})}),e.jsx(t,{sx:{flex:"1 1 200px",minWidth:0},children:e.jsx($,{children:e.jsx(B,{children:e.jsxs(t,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(Ce,{sx:{bgcolor:"success.main"},children:e.jsx(Ge,{})}),e.jsxs(t,{children:[e.jsx(i,{variant:"h4",sx:{fontWeight:600},children:(w==null?void 0:w.recentVisits)||0}),e.jsx(i,{variant:"body2",color:"text.secondary",children:"Recent Visits"})]})]})})})}),e.jsx(t,{sx:{flex:"1 1 200px",minWidth:0},children:e.jsx($,{children:e.jsx(B,{children:e.jsxs(t,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(Ce,{sx:{bgcolor:"secondary.main"},children:e.jsx(Qe,{})}),e.jsxs(t,{children:[e.jsx(i,{variant:"h4",sx:{fontWeight:600},children:D?"...":S.length}),e.jsx(i,{variant:"body2",color:"text.secondary",children:"Lab Orders"})]})]})})})}),e.jsx(t,{sx:{flex:"1 1 200px",minWidth:0},children:e.jsx($,{children:e.jsx(B,{children:e.jsxs(t,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(Ce,{sx:{bgcolor:"info.main"},children:e.jsx(Le,{})}),e.jsxs(t,{children:[e.jsx(i,{variant:"h4",sx:{fontWeight:600},children:(w==null?void 0:w.totalInterventions)||0}),e.jsx(i,{variant:"body2",color:"text.secondary",children:"Interventions"})]})]})})})})]}),e.jsx(t,{sx:{mb:4},children:e.jsx(Bs,{patientId:o})}),c&&e.jsx(t,{sx:{mb:4},children:e.jsx(Qs,{patientId:o,maxNotes:5,showCreateButton:!0})}),e.jsx(t,{sx:{mb:4},children:e.jsx(on,{patientId:o,maxOrders:3,onViewOrder:f=>{a(`/lab-orders/${f}`)},onViewResults:f=>{a(`/lab-orders/${f}/results`)},onViewAllOrders:()=>{a(`/patients/${o}/lab-orders`)}})}),e.jsxs(t,{sx:{display:"flex",flexWrap:"wrap",gap:3,mb:4},children:[e.jsx(t,{sx:{flex:"1 1 400px",minWidth:0},children:e.jsxs($,{children:[e.jsx(ce,{title:"Patient Information",titleTypographyProps:{variant:"h6",fontWeight:600},avatar:e.jsx(He,{color:"primary"})}),e.jsx(B,{children:e.jsxs(N,{spacing:2,children:[e.jsxs(t,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(st,{color:"action"}),e.jsxs(t,{children:[e.jsx(i,{variant:"body2",color:"text.secondary",children:"Phone"}),e.jsx(i,{variant:"body1",children:h.phone||"Not provided"})]})]}),e.jsxs(t,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(tt,{color:"action"}),e.jsxs(t,{children:[e.jsx(i,{variant:"body2",color:"text.secondary",children:"Email"}),e.jsx(i,{variant:"body1",children:h.email||"Not provided"})]})]}),e.jsxs(t,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(nt,{color:"action"}),e.jsxs(t,{children:[e.jsx(i,{variant:"body2",color:"text.secondary",children:"Location"}),e.jsxs(i,{variant:"body1",children:[h.state||"Unknown",","," ",h.lga||"Unknown LGA"]})]})]}),e.jsxs(t,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(Ht,{color:"action"}),e.jsxs(t,{children:[e.jsx(i,{variant:"body2",color:"text.secondary",children:"Date of Birth"}),e.jsx(i,{variant:"body1",children:h.dob?new Date(h.dob).toLocaleDateString():"Unknown"})]})]})]})})]})}),e.jsx(t,{sx:{flex:"1 1 600px",minWidth:0},children:e.jsx(cn,{patientId:o,maxItems:5,onViewLabOrder:f=>{a(`/lab-orders/${f}`)},onViewClinicalNote:f=>{a(`/clinical-notes/${f}`)},onViewMTR:f=>{a(`/mtr/${f}`)}})})]}),e.jsxs($,{children:[e.jsx(ce,{title:"Patient Summary",titleTypographyProps:{variant:"h6",fontWeight:600},avatar:e.jsx(te,{color:"primary"})}),e.jsx(B,{children:e.jsxs(t,{sx:{display:"flex",flexWrap:"wrap",gap:2},children:[((V=j==null?void 0:j.counts)==null?void 0:V.hasActiveDTP)&&e.jsx(W,{label:"Has Active DTP",color:"warning",icon:e.jsx(re,{})}),((x=j==null?void 0:j.counts)==null?void 0:x.hasActiveInterventions)&&e.jsx(W,{label:"Active Interventions",color:"info",icon:e.jsx(Le,{})}),(w==null?void 0:w.totalActiveMedications)>0&&e.jsx(W,{label:`${w.totalActiveMedications} Active Medications`,color:"primary",variant:"outlined"}),(w==null?void 0:w.totalActiveConditions)>0&&e.jsx(W,{label:`${w.totalActiveConditions} Active Conditions`,color:"secondary",variant:"outlined"}),!((A=j==null?void 0:j.counts)!=null&&A.hasActiveDTP)&&!((y=j==null?void 0:j.counts)!=null&&y.hasActiveInterventions)&&(w==null?void 0:w.totalActiveMedications)===0&&(w==null?void 0:w.totalActiveConditions)===0&&e.jsx(i,{variant:"body2",color:"text.secondary",children:"No active clinical issues identified"})]})})]})]})},un=({patientId:s,variant:l="chip",showActions:a=!1,onStartMTR:o,onViewMTR:u})=>{const c=as(),{data:m,isLoading:C,isError:I,error:b}=Zt(s,!!s&&s.length===24),T=()=>{o?o():c(`/mtr/new?patientId=${s}`)},P=D=>{u?u(D):c(`/mtr/${D}`)},g=D=>{switch(D){case"active":return{color:"primary",icon:e.jsx(_s,{}),label:"Active MTR",description:"MTR session in progress"};case"overdue":return{color:"error",icon:e.jsx(re,{}),label:"Overdue MTR",description:"MTR session is overdue"};case"scheduled":return{color:"info",icon:e.jsx(Ge,{}),label:"Scheduled MTR",description:"MTR session scheduled"};case"none":default:return{color:"default",icon:e.jsx(te,{}),label:"No Active MTR",description:"No active MTR sessions"}}};if(C)return e.jsxs(t,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Me,{size:16}),l!=="compact"&&e.jsx(i,{variant:"caption",color:"text.secondary",children:"Loading MTR status..."})]});if(I)return e.jsx(ee,{title:`Failed to load MTR status: ${(b==null?void 0:b.message)||"Unknown error"}`,children:e.jsx(W,{size:"small",label:"MTR Status Error",color:"error",variant:"outlined"})});if(!m)return null;const S=g(m.mtrStatus);return l==="chip"?e.jsx(ee,{title:S.description,children:e.jsx(W,{size:"small",icon:S.icon,label:S.label,color:S.color,variant:m.hasActiveMTR?"filled":"outlined",onClick:m.hasActiveMTR&&m.recentMTRs[0]?()=>P(m.recentMTRs[0]._id):void 0,sx:{cursor:m.hasActiveMTR?"pointer":"default"}})}):l==="compact"?e.jsxs(t,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(ee,{title:S.description,children:e.jsx(t,{sx:{display:"flex",alignItems:"center",color:`${S.color}.main`},children:hs.cloneElement(S.icon,{fontSize:"small"})})}),a&&e.jsx(ee,{title:m.hasActiveMTR?"View MTR":"Start MTR",children:e.jsx(O,{size:"small",onClick:m.hasActiveMTR&&m.recentMTRs[0]?()=>P(m.recentMTRs[0]._id):T,children:m.hasActiveMTR?e.jsx(te,{}):e.jsx(Z,{})})})]}):e.jsx(t,{sx:{p:2,border:1,borderColor:"divider",borderRadius:1},children:e.jsxs(N,{spacing:2,children:[e.jsxs(t,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsxs(t,{sx:{display:"flex",alignItems:"center",gap:1},children:[S.icon,e.jsx(i,{variant:"subtitle2",sx:{fontWeight:600},children:"MTR Status"})]}),e.jsx(W,{size:"small",label:S.label,color:S.color,variant:m.hasActiveMTR?"filled":"outlined"})]}),e.jsxs(t,{sx:{display:"grid",gridTemplateColumns:"repeat(2, 1fr)",gap:1},children:[e.jsxs(t,{children:[e.jsx(i,{variant:"caption",color:"text.secondary",children:"Total Sessions"}),e.jsx(i,{variant:"body2",sx:{fontWeight:500},children:m.totalMTRSessions})]}),e.jsxs(t,{children:[e.jsx(i,{variant:"caption",color:"text.secondary",children:"Completed"}),e.jsx(i,{variant:"body2",sx:{fontWeight:500},children:m.completedMTRSessions})]}),e.jsxs(t,{children:[e.jsx(i,{variant:"caption",color:"text.secondary",children:"Active"}),e.jsx(i,{variant:"body2",sx:{fontWeight:500},children:m.activeMTRSessions})]}),e.jsxs(t,{children:[e.jsx(i,{variant:"caption",color:"text.secondary",children:"Last MTR"}),e.jsx(i,{variant:"body2",sx:{fontWeight:500},children:m.lastMTRDate?new Date(m.lastMTRDate).toLocaleDateString():"Never"})]})]}),m.nextScheduledMTR&&e.jsx(se,{severity:"info",sx:{py:.5},children:e.jsxs(i,{variant:"caption",children:["Next MTR scheduled for"," ",new Date(m.nextScheduledMTR).toLocaleDateString()]})}),a&&e.jsxs(N,{direction:"row",spacing:1,children:[m.hasActiveMTR&&m.recentMTRs[0]?e.jsx(W,{size:"small",label:"View Active MTR",color:"primary",icon:e.jsx(te,{}),onClick:()=>P(m.recentMTRs[0]._id),clickable:!0}):e.jsx(W,{size:"small",label:"Start New MTR",color:"primary",icon:e.jsx(Z,{}),onClick:T,clickable:!0}),m.totalMTRSessions>0&&e.jsx(W,{size:"small",label:"View History",variant:"outlined",icon:e.jsx(te,{}),onClick:()=>c(`/patients/${s}/mtr-history`),clickable:!0})]})]})})},ss=[{value:"mild",label:"Mild",color:"success"},{value:"moderate",label:"Moderate",color:"warning"},{value:"severe",label:"Severe",color:"error"}],mn=["Penicillin","Amoxicillin","Aspirin","Ibuprofen","Sulfonamides","Codeine","Morphine","Latex","Peanuts","Shellfish","Eggs","Milk","Wheat","Soy","Tree nuts","Fish","Dust mites","Pollen","Pet dander","Insect stings"],jn=({patientId:s})=>{var f;const[l,a]=M.useState(!1),[o,u]=M.useState(null),[c,m]=M.useState(""),[C,I]=M.useState("all"),{data:b,isLoading:T,isError:P,error:g}=ft(s),S=bt(),D=vt(),h=Ct(),j=((f=b==null?void 0:b.data)==null?void 0:f.results)||[],{control:w,handleSubmit:z,reset:K,formState:{errors:F,isSubmitting:k},setValue:G,watch:q}=_e({defaultValues:{substance:"",reaction:"",severity:"mild",notedAt:new Date}}),L=j.filter(n=>{const r=n.substance.toLowerCase().includes(c.toLowerCase()),v=C==="all"||n.severity===C;return r&&v}),U=n=>{n?(u(n),K({substance:n.substance,reaction:n.reaction||"",severity:n.severity||"mild",notedAt:n.notedAt?new Date(n.notedAt):new Date})):(u(null),K({substance:"",reaction:"",severity:"mild",notedAt:new Date})),a(!0)},d=()=>{a(!1),u(null),K()},p=async n=>{var r,v;try{const E={substance:n.substance.trim(),reaction:((r=n.reaction)==null?void 0:r.trim())||void 0,severity:n.severity,notedAt:(v=n.notedAt)==null?void 0:v.toISOString()};o?await D.mutateAsync({allergyId:o._id,allergyData:E}):await S.mutateAsync({patientId:s,allergyData:E}),d()}catch(E){console.error("Error saving allergy:",E)}},V=async n=>{if(window.confirm("Are you sure you want to delete this allergy? This action cannot be undone."))try{await h.mutateAsync(n)}catch(r){console.error("Error deleting allergy:",r)}},x=n=>{G("substance",n)},A=n=>{const r=ss.find(v=>v.value===n);return(r==null?void 0:r.color)||"default"},y=n=>n?new Date(n).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}):"Not specified";return T?e.jsx(t,{sx:{display:"flex",justifyContent:"center",p:3},children:e.jsx(Me,{})}):P?e.jsxs(se,{severity:"error",sx:{m:2},children:[e.jsx(i,{variant:"h6",children:"Failed to load allergies"}),e.jsx(i,{variant:"body2",children:g instanceof Error?g.message:"Unable to retrieve allergy information."})]}):e.jsx(qe,{dateAdapter:Ue,children:e.jsxs(t,{children:[e.jsxs(t,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsxs(t,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(Ke,{sx:{mr:1,color:"primary.main"}}),e.jsx(i,{variant:"h6",sx:{fontWeight:600},children:"Allergy Management"}),j.length>0&&e.jsx(W,{label:`${j.length} record${j.length>1?"s":""}`,size:"small",sx:{ml:2}})]}),e.jsx(R,{variant:"contained",startIcon:e.jsx(Z,{}),onClick:()=>U(),disabled:S.isPending||D.isPending||h.isPending,children:"Add Allergy"})]}),j.length>0&&e.jsx($,{sx:{mb:3},children:e.jsx(B,{children:e.jsxs(t,{sx:{display:"flex",gap:2,alignItems:"center",flexWrap:"wrap"},children:[e.jsx(t,{sx:{flex:1,minWidth:250},children:e.jsx(H,{fullWidth:!0,size:"small",placeholder:"Search allergies...",value:c,onChange:n=>m(n.target.value),InputProps:{startAdornment:e.jsx($e,{sx:{mr:1,opacity:.5}})}})}),e.jsx(t,{sx:{minWidth:200},children:e.jsxs(pe,{fullWidth:!0,size:"small",children:[e.jsx(ge,{children:"Severity Filter"}),e.jsxs(ye,{value:C,onChange:n=>I(n.target.value),label:"Severity Filter",children:[e.jsx(ne,{value:"all",children:"All Severities"}),ss.map(n=>e.jsx(ne,{value:n.value,children:n.label},n.value))]})]})}),e.jsx(t,{sx:{minWidth:150},children:e.jsxs(i,{variant:"body2",color:"text.secondary",children:[L.length," of ",j.length," shown"]})})]})})}),L.length===0?e.jsx($,{children:e.jsxs(B,{sx:{textAlign:"center",py:6},children:[e.jsx(Ke,{sx:{fontSize:48,color:"text.secondary",mb:2}}),e.jsx(i,{variant:"h6",color:"text.secondary",sx:{mb:1},children:c||C!=="all"?"No matching allergies found":"No allergies recorded"}),e.jsx(i,{variant:"body2",color:"text.secondary",sx:{mb:3},children:c||C!=="all"?"Try adjusting your search or filters":"Add allergies to help ensure patient safety and appropriate medication selection"}),!c&&C==="all"&&e.jsx(R,{variant:"contained",startIcon:e.jsx(Z,{}),onClick:()=>U(),children:"Add First Allergy"})]})}):e.jsx(ms,{component:Ze,children:e.jsxs(js,{children:[e.jsx(ps,{children:e.jsxs(Oe,{children:[e.jsx(Q,{children:e.jsx("strong",{children:"Substance"})}),e.jsx(Q,{children:e.jsx("strong",{children:"Reaction"})}),e.jsx(Q,{children:e.jsx("strong",{children:"Severity"})}),e.jsx(Q,{children:e.jsx("strong",{children:"Noted Date"})}),e.jsx(Q,{align:"right",children:e.jsx("strong",{children:"Actions"})})]})}),e.jsx(gs,{children:L.map(n=>{var r;return e.jsxs(Oe,{hover:!0,children:[e.jsx(Q,{children:e.jsxs(t,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(i,{variant:"body2",sx:{fontWeight:600},children:n.substance}),n.severity==="severe"&&e.jsx(re,{sx:{ml:1,color:"error.main",fontSize:20}})]})}),e.jsx(Q,{children:e.jsx(i,{variant:"body2",children:n.reaction||"—"})}),e.jsx(Q,{children:e.jsx(W,{label:((r=ss.find(v=>v.value===n.severity))==null?void 0:r.label)||"Unknown",size:"small",color:A(n.severity),variant:"outlined"})}),e.jsx(Q,{children:e.jsx(i,{variant:"body2",children:y(n.notedAt)})}),e.jsx(Q,{align:"right",children:e.jsxs(N,{direction:"row",spacing:1,justifyContent:"flex-end",children:[e.jsx(ee,{title:"Edit Allergy",children:e.jsx(O,{size:"small",onClick:()=>U(n),disabled:S.isPending||D.isPending||h.isPending,children:e.jsx(ve,{fontSize:"small"})})}),e.jsx(ee,{title:"Delete Allergy",children:e.jsx(O,{size:"small",color:"error",onClick:()=>V(n._id),disabled:S.isPending||D.isPending||h.isPending,children:e.jsx(Us,{fontSize:"small"})})})]})})]},n._id)})})]})}),e.jsxs(Ae,{open:l,onClose:d,maxWidth:"sm",fullWidth:!0,PaperProps:{sx:{borderRadius:2}},children:[e.jsxs(Ie,{children:[e.jsxs(t,{sx:{display:"flex",alignItems:"center",pr:6},children:[e.jsx(Ke,{sx:{mr:1}}),o?"Edit Allergy":"Add New Allergy"]}),e.jsx(O,{onClick:d,sx:{position:"absolute",right:8,top:8},children:e.jsx(ke,{})})]}),e.jsx(Pe,{dividers:!0,children:e.jsx("form",{onSubmit:z(p),children:e.jsxs(N,{spacing:3,children:[e.jsx(_,{name:"substance",control:w,rules:{required:"Allergy substance is required",minLength:{value:2,message:"Substance name must be at least 2 characters"},maxLength:{value:100,message:"Substance name cannot exceed 100 characters"}},render:({field:n})=>{var r;return e.jsx(H,{...n,label:"Allergy Substance",placeholder:"e.g., Penicillin, Peanuts, Latex",error:!!F.substance,helperText:(r=F.substance)==null?void 0:r.message,required:!0,fullWidth:!0})}}),e.jsxs(t,{children:[e.jsx(i,{variant:"subtitle2",sx:{mb:1,color:"text.secondary"},children:"Common Allergens (click to select):"}),e.jsx(t,{sx:{display:"flex",flexWrap:"wrap",gap:1},children:mn.slice(0,12).map(n=>e.jsx(W,{label:n,size:"small",onClick:()=>x(n),sx:{cursor:"pointer"},variant:q("substance")===n?"filled":"outlined",color:q("substance")===n?"primary":"default"},n))})]}),e.jsx(he,{}),e.jsx(_,{name:"reaction",control:w,rules:{maxLength:{value:200,message:"Reaction description cannot exceed 200 characters"}},render:({field:n})=>{var r;return e.jsx(H,{...n,label:"Reaction (Optional)",placeholder:"e.g., rash, difficulty breathing, swelling",multiline:!0,rows:2,error:!!F.reaction,helperText:((r=F.reaction)==null?void 0:r.message)||"Describe the patient's allergic reaction",fullWidth:!0})}}),e.jsxs(t,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:2},children:[e.jsx(_,{name:"severity",control:w,render:({field:n})=>e.jsxs(pe,{error:!!F.severity,fullWidth:!0,children:[e.jsx(ge,{children:"Severity"}),e.jsx(ye,{...n,label:"Severity",children:ss.map(r=>e.jsx(ne,{value:r.value,children:e.jsx(t,{sx:{display:"flex",alignItems:"center"},children:e.jsx(W,{label:r.label,size:"small",color:r.color,variant:"outlined",sx:{mr:1,minWidth:65}})})},r.value))}),F.severity&&e.jsx(Es,{children:F.severity.message})]})}),e.jsx(_,{name:"notedAt",control:w,render:({field:n})=>{var r;return e.jsx(ys,{...n,label:"Date Noted",maxDateTime:new Date,slotProps:{textField:{error:!!F.notedAt,helperText:(r=F.notedAt)==null?void 0:r.message,fullWidth:!0}}})}})]}),q("severity")==="severe"&&e.jsx(se,{severity:"warning",sx:{mt:2},children:e.jsxs(i,{variant:"body2",children:[e.jsx("strong",{children:"Severe Allergy Warning:"})," This allergy will be prominently displayed in the patient's profile and flagged during medication prescribing to ensure patient safety."]})})]})})}),e.jsxs(De,{sx:{p:3},children:[e.jsx(R,{onClick:d,disabled:k,children:"Cancel"}),e.jsx(R,{onClick:z(p),variant:"contained",disabled:k,sx:{minWidth:100},children:k?"Saving...":o?"Update":"Add Allergy"})]})]})]})})},ts=[{value:"active",label:"Active",color:"error",icon:e.jsx(re,{})},{value:"remission",label:"In Remission",color:"warning",icon:e.jsx(Gt,{})},{value:"resolved",label:"Resolved",color:"success",icon:e.jsx(be,{})}],pn=[{name:"Hypertension",snomedId:"38341003"},{name:"Diabetes mellitus",snomedId:"73211009"},{name:"Asthma",snomedId:"195967001"},{name:"Chronic obstructive pulmonary disease",snomedId:"13645005"},{name:"Malaria",snomedId:"61462000"},{name:"Typhoid fever",snomedId:"4834000"},{name:"Gastroenteritis",snomedId:"25374005"},{name:"Upper respiratory tract infection",snomedId:"54150009"},{name:"Pneumonia",snomedId:"233604007"},{name:"Urinary tract infection",snomedId:"68566005"},{name:"Hepatitis B",snomedId:"66071002"},{name:"Sickle cell disease",snomedId:"417357006"},{name:"Peptic ulcer disease",snomedId:"13200003"},{name:"Arthritis",snomedId:"3723001"},{name:"Migraine",snomedId:"37796009"},{name:"Depression",snomedId:"35489007"},{name:"Anxiety disorder",snomedId:"48694002"},{name:"Chronic kidney disease",snomedId:"709044004"},{name:"Heart failure",snomedId:"84114007"},{name:"Stroke",snomedId:"230690007"}],gn=({patientId:s})=>{const[l,a]=M.useState(!1),[o,u]=M.useState(null),[c,m]=M.useState(""),[C,I]=M.useState("all"),{data:b,isLoading:T,isError:P,error:g}=St(s),S=Tt(),D=wt(),h=At(),j=Yt(b),{control:w,handleSubmit:z,reset:K,formState:{errors:F,isSubmitting:k},setValue:G,watch:q}=_e({defaultValues:{name:"",snomedId:"",onsetDate:void 0,status:"active",notes:""}}),L=j.filter(n=>{const r=n.name.toLowerCase().includes(c.toLowerCase()),v=C==="all"||n.status===C;return r&&v}),U=n=>{n?(u(n),K({name:n.name,snomedId:n.snomedId||"",onsetDate:n.onsetDate?new Date(n.onsetDate):void 0,status:n.status,notes:n.notes||""})):(u(null),K({name:"",snomedId:"",onsetDate:void 0,status:"active",notes:""})),a(!0)},d=()=>{a(!1),u(null),K()},p=async n=>{var r,v;try{const E={name:n.name.trim(),snomedId:((r=n.snomedId)==null?void 0:r.trim())||void 0,onsetDate:n.onsetDate?n.onsetDate.toISOString():void 0,status:n.status,notes:((v=n.notes)==null?void 0:v.trim())||void 0};o?await D.mutateAsync({conditionId:o._id,conditionData:E}):await S.mutateAsync({patientId:s,conditionData:E}),d()}catch(E){console.error("Error saving condition:",E)}},V=async n=>{if(window.confirm("Are you sure you want to delete this condition? This action cannot be undone."))try{await h.mutateAsync(n)}catch(r){console.error("Error deleting condition:",r)}},x=n=>{G("name",n.name),G("snomedId",n.snomedId)},A=n=>ts.find(r=>r.value===n)||ts[0],y=n=>n?/^\d{6,18}$/.test(n):!0,f=n=>n?new Date(n).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}):"Not specified";return T?e.jsx(t,{sx:{display:"flex",justifyContent:"center",p:3},children:e.jsx(Me,{})}):P?e.jsxs(se,{severity:"error",sx:{m:2},children:[e.jsx(i,{variant:"h6",children:"Failed to load conditions"}),e.jsx(i,{variant:"body2",children:g instanceof Error?g.message:"Unable to retrieve condition information."})]}):e.jsx(qe,{dateAdapter:Ue,children:e.jsxs(t,{children:[e.jsxs(t,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsxs(t,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(He,{sx:{mr:1,color:"primary.main"}}),e.jsx(i,{variant:"h6",sx:{fontWeight:600},children:"Condition Management"}),j.length>0&&e.jsx(W,{label:`${j.length} condition${j.length>1?"s":""}`,size:"small",sx:{ml:2}})]}),e.jsx(R,{variant:"contained",startIcon:e.jsx(Z,{}),onClick:()=>U(),disabled:S.isPending||D.isPending||h.isPending,children:"Add Condition"})]}),j.length>0&&e.jsx($,{sx:{mb:3},children:e.jsx(B,{children:e.jsxs(t,{sx:{display:"flex",gap:2,alignItems:"center",flexWrap:"wrap"},children:[e.jsx(t,{sx:{flex:1,minWidth:250},children:e.jsx(H,{fullWidth:!0,size:"small",placeholder:"Search conditions...",value:c,onChange:n=>m(n.target.value),InputProps:{startAdornment:e.jsx($e,{sx:{mr:1,opacity:.5}})}})}),e.jsx(t,{sx:{minWidth:200},children:e.jsxs(pe,{fullWidth:!0,size:"small",children:[e.jsx(ge,{children:"Status Filter"}),e.jsxs(ye,{value:C,onChange:n=>I(n.target.value),label:"Status Filter",children:[e.jsx(ne,{value:"all",children:"All Statuses"}),ts.map(n=>e.jsx(ne,{value:n.value,children:e.jsxs(t,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(t,{sx:{mr:1,display:"flex",fontSize:"0.8rem"},children:n.icon}),n.label]})},n.value))]})]})}),e.jsx(t,{sx:{minWidth:150},children:e.jsxs(i,{variant:"body2",color:"text.secondary",children:[L.length," of ",j.length," shown"]})})]})})}),L.length===0?e.jsx($,{children:e.jsxs(B,{sx:{textAlign:"center",py:6},children:[e.jsx(He,{sx:{fontSize:48,color:"text.secondary",mb:2}}),e.jsx(i,{variant:"h6",color:"text.secondary",sx:{mb:1},children:c||C!=="all"?"No matching conditions found":"No conditions recorded"}),e.jsx(i,{variant:"body2",color:"text.secondary",sx:{mb:3},children:c||C!=="all"?"Try adjusting your search or filters":"Document patient conditions to maintain comprehensive medical records"}),!c&&C==="all"&&e.jsx(R,{variant:"contained",startIcon:e.jsx(Z,{}),onClick:()=>U(),children:"Add First Condition"})]})}):e.jsx(ms,{component:Ze,children:e.jsxs(js,{children:[e.jsx(ps,{children:e.jsxs(Oe,{children:[e.jsx(Q,{children:e.jsx("strong",{children:"Condition Name"})}),e.jsx(Q,{children:e.jsx("strong",{children:"SNOMED CT ID"})}),e.jsx(Q,{children:e.jsx("strong",{children:"Status"})}),e.jsx(Q,{children:e.jsx("strong",{children:"Onset Date"})}),e.jsx(Q,{children:e.jsx("strong",{children:"Notes"})}),e.jsx(Q,{align:"right",children:e.jsx("strong",{children:"Actions"})})]})}),e.jsx(gs,{children:L.map(n=>{const r=A(n.status);return e.jsxs(Oe,{hover:!0,children:[e.jsx(Q,{children:e.jsx(i,{variant:"body2",sx:{fontWeight:600},children:n.name})}),e.jsx(Q,{children:n.snomedId?e.jsxs(t,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(i,{variant:"body2",sx:{fontFamily:"monospace",mr:1},children:n.snomedId}),e.jsx(ee,{title:"SNOMED CT standardized medical terminology",children:e.jsx(cs,{sx:{fontSize:14,color:"info.main"}})})]}):e.jsx(i,{variant:"body2",color:"text.secondary",children:"—"})}),e.jsx(Q,{children:e.jsx(W,{label:r.label,size:"small",color:r.color,variant:"outlined",icon:r.icon})}),e.jsx(Q,{children:e.jsx(i,{variant:"body2",children:f(n.onsetDate)})}),e.jsx(Q,{children:e.jsx(i,{variant:"body2",sx:{maxWidth:200,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:n.notes||"—"})}),e.jsx(Q,{align:"right",children:e.jsxs(N,{direction:"row",spacing:1,justifyContent:"flex-end",children:[e.jsx(ee,{title:"Edit Condition",children:e.jsx(O,{size:"small",onClick:()=>U(n),disabled:S.isPending||D.isPending||h.isPending,children:e.jsx(ve,{fontSize:"small"})})}),e.jsx(ee,{title:"Delete Condition",children:e.jsx(O,{size:"small",color:"error",onClick:()=>V(n._id),disabled:S.isPending||D.isPending||h.isPending,children:e.jsx(Us,{fontSize:"small"})})})]})})]},n._id)})})]})}),e.jsxs(Ae,{open:l,onClose:d,maxWidth:"md",fullWidth:!0,PaperProps:{sx:{borderRadius:2}},children:[e.jsxs(Ie,{children:[e.jsxs(t,{sx:{display:"flex",alignItems:"center",pr:6},children:[e.jsx(He,{sx:{mr:1}}),o?"Edit Condition":"Add New Condition"]}),e.jsx(O,{onClick:d,sx:{position:"absolute",right:8,top:8},children:e.jsx(ke,{})})]}),e.jsx(Pe,{dividers:!0,children:e.jsx(t,{component:"form",onSubmit:z(p),children:e.jsxs(N,{spacing:3,children:[e.jsx(_,{name:"name",control:w,rules:{required:"Condition name is required",minLength:{value:2,message:"Condition name must be at least 2 characters"},maxLength:{value:100,message:"Condition name cannot exceed 100 characters"}},render:({field:n})=>e.jsx(qs,{...n,options:pn,getOptionLabel:r=>typeof r=="string"?r:r.name,freeSolo:!0,value:n.value,onChange:(r,v)=>{typeof v=="string"?n.onChange(v):v&&x(v)},renderInput:r=>{var v;return e.jsx(H,{...r,label:"Condition Name",placeholder:"e.g., Hypertension, Diabetes",error:!!F.name,helperText:(v=F.name)==null?void 0:v.message,required:!0,fullWidth:!0})},renderOption:(r,v)=>{const{key:E,...J}=r;return e.jsx("li",{...J,children:e.jsxs(t,{children:[e.jsx(i,{variant:"body2",children:v.name}),e.jsxs(i,{variant:"caption",color:"text.secondary",sx:{fontFamily:"monospace"},children:["SNOMED: ",v.snomedId]})]})},E)}})}),e.jsx(_,{name:"snomedId",control:w,rules:{validate:n=>!n||y(n)||"Invalid SNOMED CT ID format (6-18 digits)"},render:({field:n})=>{var r;return e.jsx(H,{...n,label:"SNOMED CT Identifier",placeholder:"e.g., 38341003",error:!!F.snomedId,helperText:((r=F.snomedId)==null?void 0:r.message)||"Optional: SNOMED CT standardized medical terminology code",fullWidth:!0,InputProps:{startAdornment:e.jsx(Se,{position:"start",children:e.jsx(cs,{sx:{color:"info.main"}})})}})}}),e.jsx(he,{}),e.jsxs(t,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:2},children:[e.jsx(_,{name:"status",control:w,render:({field:n})=>e.jsxs(pe,{error:!!F.status,fullWidth:!0,children:[e.jsx(ge,{children:"Status"}),e.jsx(ye,{...n,label:"Status",children:ts.map(r=>e.jsx(ne,{value:r.value,children:e.jsxs(t,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(t,{sx:{mr:1,display:"flex"},children:r.icon}),e.jsx(W,{label:r.label,size:"small",color:r.color,variant:"outlined",sx:{mr:1}})]})},r.value))}),F.status&&e.jsx(Es,{children:F.status.message})]})}),e.jsx(_,{name:"onsetDate",control:w,render:({field:n})=>{var r;return e.jsx(Vs,{...n,label:"Onset Date",maxDate:new Date,slotProps:{textField:{error:!!F.onsetDate,helperText:((r=F.onsetDate)==null?void 0:r.message)||"When condition started",fullWidth:!0}}})}})]}),e.jsx(_,{name:"notes",control:w,rules:{maxLength:{value:500,message:"Notes cannot exceed 500 characters"}},render:({field:n})=>{var r;return e.jsx(H,{...n,label:"Clinical Notes",placeholder:"Additional information about the condition...",multiline:!0,rows:3,error:!!F.notes,helperText:((r=F.notes)==null?void 0:r.message)||"Optional: Additional clinical information or observations",fullWidth:!0})}}),q("status")&&e.jsx(se,{severity:q("status")==="active"?"warning":q("status")==="resolved"?"success":"info",sx:{mt:2},children:e.jsxs(i,{variant:"body2",children:[e.jsxs("strong",{children:[A(q("status")).label," Status:"]})," ",q("status")==="active"&&"This condition is currently active and may require ongoing treatment.",q("status")==="resolved"&&"This condition has been resolved and is no longer active.",q("status")==="remission"&&"This condition is in remission - symptoms are reduced or absent but may return."]})})]})})}),e.jsxs(De,{sx:{p:3},children:[e.jsx(R,{onClick:d,disabled:k,children:"Cancel"}),e.jsx(R,{onClick:z(p),variant:"contained",disabled:k,sx:{minWidth:120},children:k?"Saving...":o?"Update":"Add Condition"})]})]})]})})},yn=({patientId:s})=>e.jsx(t,{children:e.jsx($t,{patientId:s})}),Hs=({error:s,title:l,message:a,type:o="error",retry:u,retryLabel:c="Try Again",showDetails:m=!1,onClose:C})=>{const[I,b]=hs.useState(!1);if(!s&&!a)return null;const T=()=>{switch(o){case"network":return e.jsx(qt,{});case"server":return e.jsx(it,{});case"permission":return e.jsx(at,{});case"notFound":return e.jsx($e,{});case"warning":return e.jsx(re,{});case"info":return e.jsx(cs,{});default:return e.jsx(Ls,{})}},P=()=>{switch(o){case"warning":return"warning";case"info":return"info";default:return"error"}},g=()=>{switch(o){case"network":return"Network Error";case"server":return"Server Error";case"permission":return"Access Denied";case"notFound":return"Not Found";case"warning":return"Warning";case"info":return"Information";default:return"Error"}},S=()=>{const h=typeof s=="string"?s:s==null?void 0:s.message;if(a)return a;if(h)return h;switch(o){case"network":return"Please check your internet connection and try again.";case"server":return"The server is currently unavailable. Please try again later.";case"permission":return"You do not have permission to access this resource.";case"notFound":return"The requested resource could not be found.";default:return"An unexpected error occurred."}},D=typeof s=="object"&&s?{message:s.message,stack:s.stack,name:s.name}:null;return e.jsxs(se,{severity:P(),icon:T(),onClose:C,sx:{mb:2},children:[e.jsx(rt,{children:l||g()}),e.jsx(i,{variant:"body2",sx:{mb:m||u?2:0},children:S()}),e.jsxs(N,{direction:"row",spacing:2,alignItems:"center",children:[u&&e.jsx(R,{size:"small",variant:"outlined",startIcon:e.jsx(Je,{}),onClick:u,children:c}),m&&D&&e.jsx(R,{size:"small",variant:"text",endIcon:e.jsx(rs,{sx:{transform:I?"rotate(180deg)":"rotate(0deg)",transition:"transform 0.2s"}}),onClick:()=>b(!I),children:"Details"})]}),m&&D&&e.jsx(ks,{in:I,children:e.jsx(t,{sx:{mt:2,p:2,bgcolor:"rgba(0,0,0,0.1)",borderRadius:1},children:e.jsxs(i,{variant:"body2",component:"pre",sx:{fontFamily:"monospace",fontSize:"0.75rem",overflow:"auto",maxHeight:200,whiteSpace:"pre-wrap"},children:[D.name,": ",D.message,D.stack&&`

${D.stack}`]})})})]})},Ks=({variant:s="card",count:l=1,height:a=100,animation:o="wave"})=>{const u=()=>{switch(s){case"list":return e.jsx(N,{spacing:2,children:Array.from({length:l}).map((c,m)=>e.jsxs(t,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(Y,{variant:"circular",width:40,height:40,animation:o}),e.jsxs(t,{sx:{flex:1},children:[e.jsx(Y,{variant:"text",sx:{fontSize:"1rem"},animation:o}),e.jsx(Y,{variant:"text",sx:{fontSize:"0.875rem"},width:"60%",animation:o})]})]},m))});case"table":return e.jsxs(N,{spacing:1,children:[e.jsx(Y,{variant:"rectangular",height:56,animation:o}),Array.from({length:l}).map((c,m)=>e.jsx(Y,{variant:"rectangular",height:52,animation:o},m))]});case"form":return e.jsx(N,{spacing:3,children:Array.from({length:l}).map((c,m)=>e.jsxs(t,{children:[e.jsx(Y,{variant:"text",sx:{fontSize:"0.875rem"},width:"20%",animation:o}),e.jsx(Y,{variant:"rectangular",height:56,animation:o})]},m))});case"detail":return e.jsxs(N,{spacing:3,children:[e.jsx(Y,{variant:"rectangular",height:200,animation:o}),e.jsxs(t,{sx:{display:"flex",gap:2},children:[e.jsx(Y,{variant:"circular",width:64,height:64,animation:o}),e.jsxs(N,{flex:1,spacing:1,children:[e.jsx(Y,{variant:"text",sx:{fontSize:"1.5rem"},width:"40%",animation:o}),e.jsx(Y,{variant:"text",sx:{fontSize:"1rem"},width:"60%",animation:o}),e.jsx(Y,{variant:"text",sx:{fontSize:"0.875rem"},width:"80%",animation:o})]})]}),Array.from({length:l}).map((c,m)=>e.jsxs(t,{children:[e.jsx(Y,{variant:"text",sx:{fontSize:"1rem"},width:"30%",animation:o}),e.jsx(Y,{variant:"rectangular",height:80,animation:o})]},m))]});default:return e.jsx(N,{spacing:2,children:Array.from({length:l}).map((c,m)=>e.jsx($,{children:e.jsxs(B,{children:[e.jsx(Y,{variant:"text",sx:{fontSize:"1.2rem"},animation:o}),e.jsx(Y,{variant:"text",sx:{fontSize:"1rem"},animation:o}),e.jsx(Y,{variant:"rectangular",height:typeof a=="number"?a:100,animation:o,sx:{mt:1}})]})},m))})}};return e.jsx(t,{children:u()})},fn=({loading:s=!1,error:l,children:a,loadingComponent:o,errorComponent:u,emptyComponent:c,isEmpty:m=!1,retry:C,errorProps:I,skeletonProps:b})=>s?e.jsx(e.Fragment,{children:o||e.jsx(Ks,{...b})}):l?e.jsx(e.Fragment,{children:u||e.jsx(Hs,{error:l,retry:C,showDetails:!1,...I})}):m&&c?e.jsx(e.Fragment,{children:c}):e.jsx(e.Fragment,{children:a}),bn=()=>{const[s,l]=M.useState({}),a=M.useCallback(b=>{var T;if(!b)return"unknown";if(b.code==="NETWORK_ERROR"||b.message==="Network Error")return"network";if(b.isAxiosError||b.response)switch((T=b.response)==null?void 0:T.status){case 400:case 422:return"validation";case 401:case 403:return"permission";case 404:return"notFound";case 500:case 502:case 503:case 504:return"server";default:return"unknown"}return"unknown"},[]),o=M.useCallback((b,T)=>{var g,S,D,h;if(!T){l(j=>{const{[b]:w,...z}=j;return z});return}const P={error:T instanceof Error?T:new Error(String(T)),message:((S=(g=T==null?void 0:T.response)==null?void 0:g.data)==null?void 0:S.message)||(T==null?void 0:T.message)||String(T),code:String(((h=(D=T==null?void 0:T.response)==null?void 0:D.data)==null?void 0:h.code)||(T==null?void 0:T.code)||""),type:a(T),timestamp:new Date};l(j=>({...j,[b]:P})),console.error(`Error in ${b}:`,P)},[a]),u=M.useCallback(b=>{l(T=>{const{[b]:P,...g}=T;return g})},[]),c=M.useCallback(()=>{l({})},[]),m=M.useCallback(b=>b?!!s[b]:Object.keys(s).length>0,[s]),C=M.useCallback(b=>s[b]||null,[s]),I=M.useCallback(()=>s,[s]);return{errors:s,setError:o,clearError:u,clearAllErrors:c,hasError:m,getError:C,getAllErrors:I}},vn=()=>{const[s,l]=M.useState({}),a=M.useCallback((C,I)=>{l(b=>({...b,[C]:I}))},[]),o=M.useCallback(C=>{l(I=>{const{[C]:b,...T}=I;return T})},[]),u=M.useCallback(()=>{l({})},[]),c=M.useCallback(C=>C?!!s[C]:Object.values(s).some(Boolean),[s]),m=M.useCallback(()=>Object.keys(s).filter(C=>s[C]),[s]);return{loading:s,setLoadingState:a,clearLoadingState:o,clearAllLoading:u,isLoading:c,getLoadingKeys:m}},Cn=()=>{const{setError:s,clearError:l,getError:a}=bn(),{setLoadingState:o,isLoading:u}=vn();return{executeOperation:M.useCallback(async(m,C,I={})=>{const{onSuccess:b,onError:T,clearErrorOnStart:P=!0}=I;try{P&&l(m),o(m,!0);const g=await C();return b&&b(g),g}catch(g){return s(m,g),T&&T(g),null}finally{o(m,!1)}},[s,l,o]),isLoading:u,getError:a}},Sn=({children:s,maxWidth:l="lg"})=>{const{getSpacing:a,isMobile:o}=is();return e.jsx(t,{sx:{maxWidth:l||void 0,mx:"auto",px:a(1,2,3),py:a(1,2,3),...o&&{px:1,py:1}},children:s})},Tn=({title:s,subtitle:l,actions:a,chips:o=[],children:u,collapsible:c=!1,defaultExpanded:m=!0})=>{const{isMobile:C}=is();return c&&C?e.jsxs(lt,{defaultExpanded:m,children:[e.jsx(ot,{expandIcon:e.jsx(rs,{}),children:e.jsxs(t,{sx:{flex:1,display:"flex",alignItems:"center",gap:1},children:[e.jsx(i,{variant:"h6",component:"div",children:s}),o.map((I,b)=>e.jsx(W,{label:I.label,size:"small",color:I.color,variant:"outlined"},b))]})}),e.jsxs(ct,{children:[l&&e.jsx(i,{variant:"body2",color:"text.secondary",sx:{mb:2},children:l}),u,a&&e.jsx(t,{sx:{mt:2,display:"flex",justifyContent:"flex-end",gap:1},children:a})]})]}):e.jsxs($,{children:[e.jsxs(B,{children:[e.jsxs(t,{sx:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",mb:2},children:[e.jsxs(t,{sx:{flex:1},children:[e.jsx(i,{variant:"h6",component:"div",gutterBottom:!0,children:s}),l&&e.jsx(i,{variant:"body2",color:"text.secondary",children:l}),o.length>0&&e.jsx(t,{sx:{mt:1,display:"flex",gap:.5,flexWrap:"wrap"},children:o.map((I,b)=>e.jsx(W,{label:I.label,size:"small",color:I.color,variant:"outlined"},b))})]}),a&&!C&&e.jsx(t,{sx:{display:"flex",gap:1},children:a})]}),u]}),a&&C&&e.jsx(Ut,{sx:{justifyContent:"flex-end"},children:a})]})},wn=({title:s,subtitle:l,actions:a,backButton:o})=>{const{isMobile:u,getSpacing:c}=is();return e.jsxs(t,{sx:{display:"flex",flexDirection:u?"column":"row",justifyContent:"space-between",alignItems:u?"stretch":"center",mb:c(2,3,4),gap:c(1,2,0)},children:[e.jsxs(t,{sx:{display:"flex",alignItems:"center",gap:1},children:[o,e.jsxs(t,{children:[e.jsx(i,{variant:u?"h5":"h4",component:"h1",sx:{fontWeight:600},children:s}),l&&e.jsx(i,{variant:"body2",color:"text.secondary",children:l})]})]}),a&&e.jsx(t,{sx:{display:"flex",gap:1,...u&&{justifyContent:"stretch","& > *":{flex:1}}},children:a})]})},X={all:["patient-resources"],allergies:s=>[...X.all,"allergies",s],conditions:s=>[...X.all,"conditions",s],medications:s=>[...X.all,"medications",s],assessments:s=>[...X.all,"assessments",s],dtps:s=>[...X.all,"dtps",s],carePlans:s=>[...X.all,"carePlans",s],visits:s=>[...X.all,"visits",s]},An=s=>we({queryKey:X.assessments(s),queryFn:()=>xe.getAssessments(s),enabled:!!s,staleTime:5*60*1e3}),In=()=>{const s=le();return de({mutationFn:({patientId:l,assessmentData:a})=>xe.createAssessment(l,a),onSuccess:(l,{patientId:a})=>{s.invalidateQueries({queryKey:X.assessments(a)})}})},Pn=()=>{const s=le();return de({mutationFn:({assessmentId:l,assessmentData:a})=>xe.updateAssessment(l,a),onSuccess:()=>{s.invalidateQueries({queryKey:X.all})}})},Dn=(s,l)=>we({queryKey:[...X.dtps(s),l],queryFn:()=>xe.getDTPs(s,l),enabled:!!s,staleTime:5*60*1e3}),Mn=()=>{const s=le();return de({mutationFn:({patientId:l,dtpData:a})=>xe.createDTP(l,a),onSuccess:(l,{patientId:a})=>{s.invalidateQueries({queryKey:X.dtps(a)})}})},Rn=()=>{const s=le();return de({mutationFn:({dtpId:l,dtpData:a})=>xe.updateDTP(l,a),onSuccess:()=>{s.invalidateQueries({queryKey:X.all})}})},kn=s=>we({queryKey:X.carePlans(s),queryFn:()=>xe.getCarePlans(s),enabled:!!s,staleTime:5*60*1e3}),Wn=()=>{const s=le();return de({mutationFn:({patientId:l,carePlanData:a})=>xe.createCarePlan(l,a),onSuccess:(l,{patientId:a})=>{s.invalidateQueries({queryKey:X.carePlans(a)})}})},Fn=()=>{const s=le();return de({mutationFn:({carePlanId:l,carePlanData:a})=>xe.updateCarePlan(l,a),onSuccess:()=>{s.invalidateQueries({queryKey:X.all})}})},zn=s=>we({queryKey:X.visits(s),queryFn:()=>xe.getVisits(s),enabled:!!s,staleTime:5*60*1e3}),En=()=>{const s=le();return de({mutationFn:({patientId:l,visitData:a})=>xe.createVisit(l,a),onSuccess:(l,{patientId:a})=>{s.invalidateQueries({queryKey:X.visits(a)})}})},Ln=()=>{const s=le();return de({mutationFn:({visitId:l,visitData:a})=>xe.updateVisit(l,a),onSuccess:()=>{s.invalidateQueries({queryKey:X.all})}})},Ms=[{value:"none",label:"None",color:"success"},{value:"mild",label:"Mild",color:"warning"},{value:"moderate",label:"Moderate",color:"error"},{value:"severe",label:"Severe",color:"error"}],Nn=({patientId:s})=>{var V;const[l,a]=M.useState(!1),[o,u]=M.useState(null),[c,m]=M.useState(""),C=dt(),{executeOperation:I,isLoading:b}=Cn(),{isMobile:T}=is(),{data:P,isLoading:g,isError:S,error:D}=An(s),h=In(),j=Pn(),w=((V=P==null?void 0:P.data)==null?void 0:V.results)||[],{control:z,handleSubmit:K,reset:F,formState:{errors:k}}=_e({defaultValues:{bpSys:void 0,bpDia:void 0,rr:void 0,tempC:void 0,heartSounds:"",pallor:"none",dehydration:"none",pcv:void 0,mcs:"",eucr:"",fbc:"",fbs:void 0,hba1c:void 0,recordedAt:new Date}}),G=x=>{var A,y,f,n,r,v,E,J,ae,Fe,Ve,vs,Cs;console.log("handleOpenDialog called with:",x),console.log("Current isDialogOpen state:",l),x?(u(x),F({bpSys:(A=x.vitals)==null?void 0:A.bpSys,bpDia:(y=x.vitals)==null?void 0:y.bpDia,rr:(f=x.vitals)==null?void 0:f.rr,tempC:(n=x.vitals)==null?void 0:n.tempC,heartSounds:((r=x.vitals)==null?void 0:r.heartSounds)||"",pallor:((v=x.vitals)==null?void 0:v.pallor)||"none",dehydration:((E=x.vitals)==null?void 0:E.dehydration)||"none",pcv:(J=x.labs)==null?void 0:J.pcv,mcs:((ae=x.labs)==null?void 0:ae.mcs)||"",eucr:((Fe=x.labs)==null?void 0:Fe.eucr)||"",fbc:((Ve=x.labs)==null?void 0:Ve.fbc)||"",fbs:(vs=x.labs)==null?void 0:vs.fbs,hba1c:(Cs=x.labs)==null?void 0:Cs.hba1c,recordedAt:new Date(x.recordedAt)})):(u(null),F({bpSys:void 0,bpDia:void 0,rr:void 0,tempC:void 0,heartSounds:"",pallor:"none",dehydration:"none",pcv:void 0,mcs:"",eucr:"",fbc:"",fbs:void 0,hba1c:void 0,recordedAt:new Date})),a(!0)},q=()=>{a(!1),u(null),F()},L=async x=>{var f,n,r,v;const A={vitals:{bpSys:x.bpSys?Number(x.bpSys):void 0,bpDia:x.bpDia?Number(x.bpDia):void 0,rr:x.rr?Number(x.rr):void 0,tempC:x.tempC?Number(x.tempC):void 0,heartSounds:((f=x.heartSounds)==null?void 0:f.trim())||void 0,pallor:x.pallor,dehydration:x.dehydration},labs:{pcv:x.pcv?Number(x.pcv):void 0,mcs:((n=x.mcs)==null?void 0:n.trim())||void 0,eucr:((r=x.eucr)==null?void 0:r.trim())||void 0,fbc:((v=x.fbc)==null?void 0:v.trim())||void 0,fbs:x.fbs?Number(x.fbs):void 0,hba1c:x.hba1c?Number(x.hba1c):void 0},recordedAt:x.recordedAt.toISOString()};await I(o?"updateAssessment":"createAssessment",o?()=>j.mutateAsync({assessmentId:o._id,assessmentData:A}):()=>h.mutateAsync({patientId:s,assessmentData:A}),{onSuccess:()=>{q(),o?C.updated("assessment"):C.created("assessment")},onError:E=>{C[`${o?"update":"create"}Failed`]("assessment",E instanceof Error?E:new Error("Unknown error"))}})},U=x=>new Date(x).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}),p=(()=>{let x=w;return c&&(x=x.filter(A=>U(A.recordedAt).toLowerCase().includes(c.toLowerCase()))),x})();return e.jsx(qe,{dateAdapter:Ue,children:e.jsxs(Sn,{children:[e.jsxs(fn,{loading:g,error:S?D:null,loadingComponent:e.jsx(Ks,{variant:"table",count:5,animation:"wave"}),errorComponent:e.jsx(Hs,{error:D,title:"Failed to load assessments",type:S?"server":"error",retry:()=>window.location.reload(),showDetails:!1}),emptyComponent:e.jsx(Tn,{title:"No assessments recorded",subtitle:"Start by adding the patient's clinical assessments and lab results.",children:e.jsxs(t,{sx:{textAlign:"center",py:4},children:[e.jsx(As,{sx:{fontSize:64,color:"text.secondary",mb:2}}),e.jsx(R,{variant:"contained",startIcon:e.jsx(Z,{}),onClick:()=>G(),children:"Add First Assessment"})]})}),isEmpty:!g&&!S&&w.length===0,children:[e.jsx(wn,{title:"Clinical Assessments",subtitle:`${w.length} assessment${w.length!==1?"s":""} recorded`,actions:e.jsx(oe,{action:"canCreate",children:e.jsx(R,{variant:"contained",startIcon:b("createAssessment")?e.jsx(Me,{size:16}):e.jsx(Z,{}),onClick:()=>G(),disabled:b("createAssessment")||b("updateAssessment"),fullWidth:T,children:b("createAssessment")?"Adding...":"Add Assessment"})})}),w.length>0&&e.jsx($,{children:e.jsxs(B,{children:[e.jsx(t,{sx:{mb:2},children:e.jsx(H,{size:"small",placeholder:"Search assessments...",value:c,onChange:x=>m(x.target.value),InputProps:{startAdornment:e.jsx($e,{sx:{mr:1,opacity:.5}})}})}),p.length===0?e.jsx(i,{color:"text.secondary",children:"No assessments found."}):e.jsx(N,{spacing:2,children:p.map(x=>{var A,y,f,n,r,v,E;return e.jsx($,{variant:"outlined",children:e.jsxs(B,{sx:{py:2},children:[e.jsxs(t,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsx(i,{variant:"subtitle2",children:U(x.recordedAt)}),e.jsx(t,{sx:{display:"flex",gap:1},children:e.jsx(oe,{action:"canUpdate",children:e.jsx(O,{size:"small",onClick:()=>G(x),children:e.jsx(ve,{})})})})]}),e.jsxs(t,{sx:{display:"grid",gridTemplateColumns:{xs:"1fr",md:"1fr 1fr"},gap:2},children:[e.jsxs(t,{children:[e.jsx(i,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:"Vitals"}),((A=x.vitals)==null?void 0:A.bpSys)&&((y=x.vitals)==null?void 0:y.bpDia)&&e.jsxs(i,{variant:"body2",children:["BP: ",x.vitals.bpSys,"/",x.vitals.bpDia," mmHg"]}),((f=x.vitals)==null?void 0:f.tempC)&&e.jsxs(i,{variant:"body2",children:["Temp: ",x.vitals.tempC,"°C"]}),((n=x.vitals)==null?void 0:n.rr)&&e.jsxs(i,{variant:"body2",children:["RR: ",x.vitals.rr,"/min"]})]}),e.jsxs(t,{children:[e.jsx(i,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:"Lab Results"}),((r=x.labs)==null?void 0:r.pcv)&&e.jsxs(i,{variant:"body2",children:["PCV: ",x.labs.pcv,"%"]}),((v=x.labs)==null?void 0:v.fbs)&&e.jsxs(i,{variant:"body2",children:["FBS: ",x.labs.fbs," mg/dL"]}),((E=x.labs)==null?void 0:E.hba1c)&&e.jsxs(i,{variant:"body2",children:["HbA1c: ",x.labs.hba1c,"%"]})]})]})]})},x._id)})})]})})]}),e.jsxs(Ae,{open:l,onClose:q,maxWidth:"md",fullWidth:!0,fullScreen:T,children:[e.jsx(Ie,{children:e.jsxs(t,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(As,{color:"primary"}),e.jsx(i,{variant:"h6",children:o?"Edit Assessment":"Add New Assessment"})]})}),e.jsx(Pe,{children:e.jsx("form",{onSubmit:K(L),children:e.jsxs(N,{spacing:3,sx:{mt:1},children:[e.jsx(_,{name:"recordedAt",control:z,rules:{required:"Date and time is required"},render:({field:x})=>{var A;return e.jsx(ys,{...x,label:"Date & Time *",maxDate:new Date,slotProps:{textField:{fullWidth:!0,error:!!k.recordedAt,helperText:(A=k.recordedAt)==null?void 0:A.message}}})}}),e.jsx(he,{}),e.jsxs(t,{children:[e.jsxs(i,{variant:"h6",sx:{mb:2,display:"flex",alignItems:"center",gap:1},children:[e.jsx(xt,{color:"primary"}),"Vital Signs"]}),e.jsxs(t,{sx:{display:"grid",gridTemplateColumns:{xs:"1fr",md:"1fr 1fr"},gap:2},children:[e.jsx(_,{name:"bpSys",control:z,rules:{min:{value:50,message:"Systolic BP must be at least 50"},max:{value:300,message:"Systolic BP cannot exceed 300"}},render:({field:{onChange:x,value:A,...y}})=>{var f;return e.jsx(H,{...y,value:A||"",onChange:n=>{const r=n.target.value;x(r===""?void 0:Number(r))},label:"Systolic BP",type:"number",InputProps:{endAdornment:e.jsx(Se,{position:"end",children:"mmHg"})},error:!!k.bpSys,helperText:(f=k.bpSys)==null?void 0:f.message,fullWidth:!0})}}),e.jsx(_,{name:"bpDia",control:z,rules:{min:{value:30,message:"Diastolic BP must be at least 30"},max:{value:200,message:"Diastolic BP cannot exceed 200"}},render:({field:{onChange:x,value:A,...y}})=>{var f;return e.jsx(H,{...y,value:A||"",onChange:n=>{const r=n.target.value;x(r===""?void 0:Number(r))},label:"Diastolic BP",type:"number",InputProps:{endAdornment:e.jsx(Se,{position:"end",children:"mmHg"})},error:!!k.bpDia,helperText:(f=k.bpDia)==null?void 0:f.message,fullWidth:!0})}}),e.jsx(_,{name:"tempC",control:z,rules:{min:{value:30,message:"Temperature must be at least 30°C"},max:{value:45,message:"Temperature cannot exceed 45°C"}},render:({field:{onChange:x,value:A,...y}})=>{var f;return e.jsx(H,{...y,value:A||"",onChange:n=>{const r=n.target.value;x(r===""?void 0:Number(r))},label:"Temperature",type:"number",inputProps:{step:"0.1"},InputProps:{endAdornment:e.jsx(Se,{position:"end",children:"°C"})},error:!!k.tempC,helperText:(f=k.tempC)==null?void 0:f.message,fullWidth:!0})}}),e.jsx(_,{name:"rr",control:z,rules:{min:{value:5,message:"Respiratory rate must be at least 5"},max:{value:60,message:"Respiratory rate cannot exceed 60"}},render:({field:{onChange:x,value:A,...y}})=>{var f;return e.jsx(H,{...y,value:A||"",onChange:n=>{const r=n.target.value;x(r===""?void 0:Number(r))},label:"Respiratory Rate",type:"number",InputProps:{endAdornment:e.jsx(Se,{position:"end",children:"/min"})},error:!!k.rr,helperText:(f=k.rr)==null?void 0:f.message,fullWidth:!0})}})]}),e.jsxs(t,{sx:{display:"grid",gridTemplateColumns:{xs:"1fr",md:"1fr 1fr 1fr"},gap:2,mt:2},children:[e.jsx(_,{name:"pallor",control:z,render:({field:x})=>e.jsxs(pe,{fullWidth:!0,children:[e.jsx(ge,{children:"Pallor"}),e.jsx(ye,{...x,label:"Pallor",children:Ms.map(A=>e.jsx(ne,{value:A.value,children:A.label},A.value))})]})}),e.jsx(_,{name:"dehydration",control:z,render:({field:x})=>e.jsxs(pe,{fullWidth:!0,children:[e.jsx(ge,{children:"Dehydration"}),e.jsx(ye,{...x,label:"Dehydration",children:Ms.map(A=>e.jsx(ne,{value:A.value,children:A.label},A.value))})]})}),e.jsx(_,{name:"heartSounds",control:z,render:({field:x})=>e.jsx(H,{...x,label:"Heart Sounds",placeholder:"e.g., Normal S1, S2",fullWidth:!0})})]})]}),e.jsx(he,{}),e.jsxs(t,{children:[e.jsxs(i,{variant:"h6",sx:{mb:2,display:"flex",alignItems:"center",gap:1},children:[e.jsx(Qt,{color:"primary"}),"Lab Results"]}),e.jsxs(t,{sx:{display:"grid",gridTemplateColumns:{xs:"1fr",md:"1fr 1fr"},gap:2},children:[e.jsx(_,{name:"pcv",control:z,rules:{min:{value:10,message:"PCV must be at least 10%"},max:{value:60,message:"PCV cannot exceed 60%"}},render:({field:{onChange:x,value:A,...y}})=>{var f;return e.jsx(H,{...y,value:A||"",onChange:n=>{const r=n.target.value;x(r===""?void 0:Number(r))},label:"PCV",type:"number",InputProps:{endAdornment:e.jsx(Se,{position:"end",children:"%"})},error:!!k.pcv,helperText:(f=k.pcv)==null?void 0:f.message,fullWidth:!0})}}),e.jsx(_,{name:"fbs",control:z,rules:{min:{value:30,message:"FBS must be at least 30 mg/dL"},max:{value:500,message:"FBS cannot exceed 500 mg/dL"}},render:({field:{onChange:x,value:A,...y}})=>{var f;return e.jsx(H,{...y,value:A||"",onChange:n=>{const r=n.target.value;x(r===""?void 0:Number(r))},label:"FBS",type:"number",InputProps:{endAdornment:e.jsx(Se,{position:"end",children:"mg/dL"})},error:!!k.fbs,helperText:(f=k.fbs)==null?void 0:f.message,fullWidth:!0})}}),e.jsx(_,{name:"hba1c",control:z,rules:{min:{value:3,message:"HbA1c must be at least 3%"},max:{value:15,message:"HbA1c cannot exceed 15%"}},render:({field:{onChange:x,value:A,...y}})=>{var f;return e.jsx(H,{...y,value:A||"",onChange:n=>{const r=n.target.value;x(r===""?void 0:Number(r))},label:"HbA1c",type:"number",inputProps:{step:"0.1"},InputProps:{endAdornment:e.jsx(Se,{position:"end",children:"%"})},error:!!k.hba1c,helperText:(f=k.hba1c)==null?void 0:f.message,fullWidth:!0})}}),e.jsx(_,{name:"mcs",control:z,render:({field:x})=>e.jsx(H,{...x,label:"MCS",placeholder:"e.g., No growth",fullWidth:!0})}),e.jsx(_,{name:"eucr",control:z,render:({field:x})=>e.jsx(H,{...x,label:"E/U/Cr",placeholder:"e.g., Normal",fullWidth:!0})}),e.jsx(_,{name:"fbc",control:z,render:({field:x})=>e.jsx(H,{...x,label:"FBC",placeholder:"e.g., Normal",fullWidth:!0})})]})]})]})})}),e.jsxs(De,{children:[e.jsx(R,{onClick:q,children:"Cancel"}),e.jsx(R,{onClick:K(L),variant:"contained",disabled:b("createAssessment")||b("updateAssessment"),children:o?"Update":"Add"})]})]})]})})},ns=[{value:"unnecessary",label:"Unnecessary Therapy",description:"Patient receiving drug therapy that is not needed"},{value:"wrongDrug",label:"Improper Drug Selection",description:"Wrong drug chosen for the condition or patient"},{value:"doseTooLow",label:"Sub-therapeutic Dosage",description:"Dose is too low to achieve therapeutic effect"},{value:"doseTooHigh",label:"Overdosage",description:"Dose is too high, potentially causing harm"},{value:"adverseReaction",label:"Adverse Drug Reaction",description:"Patient experiencing unwanted effects from medication"},{value:"inappropriateAdherence",label:"Non-adherence",description:"Patient not taking medication as prescribed"},{value:"needsAdditional",label:"Untreated Condition",description:"Patient has a condition requiring drug therapy but is not receiving it"}],On=({patientId:s})=>{var f;const[l,a]=M.useState(!1),[o,u]=M.useState(null),[c,m]=M.useState(""),[C,I]=M.useState("all"),{data:b,isLoading:T,isError:P,error:g}=Dn(s),S=Mn(),D=Rn(),h=((f=b==null?void 0:b.data)==null?void 0:f.results)||[],{control:j,handleSubmit:w,reset:z,formState:{errors:K,isSubmitting:F},watch:k}=_e({defaultValues:{type:"untreated_condition",description:"",status:"unresolved"}}),G=h.filter(n=>{var E;const r=((E=ns.find(J=>J.value===n.type))==null?void 0:E.label.toLowerCase().includes(c.toLowerCase()))||n.description&&n.description.toLowerCase().includes(c.toLowerCase()),v=C==="all"||n.status===C;return r&&v}),q=n=>{n?(u(n),z({type:n.type,description:n.description||"",status:n.status})):(u(null),z({type:"untreated_condition",description:"",status:"unresolved"})),a(!0)},L=()=>{a(!1),u(null),z()},U=async n=>{var r;try{const v={type:n.type,description:((r=n.description)==null?void 0:r.trim())||void 0,status:n.status};o?await D.mutateAsync({dtpId:o._id,dtpData:v}):await S.mutateAsync({patientId:s,dtpData:v}),L()}catch(v){console.error("Error saving DTP:",v)}},d=n=>ns.find(r=>r.value===n)||ns[0],p=n=>n==="resolved"?"success":"error",V=n=>{switch(n){case"overdosage":case"adverse_drug_reaction":return"error";case"drug_interaction":case"untreated_condition":return"warning";default:return"info"}},x=n=>new Date(n).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}),A=h.filter(n=>n.status==="unresolved").length,y=h.filter(n=>n.status==="resolved").length;return T?e.jsx(t,{sx:{display:"flex",justifyContent:"center",p:3},children:e.jsx(Me,{})}):P?e.jsxs(se,{severity:"error",sx:{m:2},children:[e.jsx(i,{variant:"h6",children:"Failed to load DTPs"}),e.jsx(i,{variant:"body2",children:g instanceof Error?g.message:"Unable to retrieve DTP information."})]}):e.jsx(qe,{dateAdapter:Ue,children:e.jsxs(t,{children:[e.jsxs(t,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsxs(t,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(es,{sx:{mr:1,color:"warning.main"}}),e.jsx(i,{variant:"h6",sx:{fontWeight:600},children:"Drug Therapy Problems"}),A>0&&e.jsx(W,{label:`${A} unresolved`,size:"small",color:"error",sx:{ml:2}})]}),e.jsx(oe,{action:"canCreate",children:e.jsx(R,{variant:"contained",startIcon:e.jsx(Z,{}),onClick:()=>q(),children:"Report DTP"})})]}),e.jsxs(N,{direction:"row",spacing:2,sx:{mb:3},children:[e.jsxs($,{sx:{flex:1,textAlign:"center",p:2},children:[e.jsx(Ls,{color:"error",sx:{fontSize:24,mb:1}}),e.jsx(i,{variant:"h6",children:A}),e.jsx(i,{variant:"body2",color:"text.secondary",children:"Unresolved DTPs"})]}),e.jsxs($,{sx:{flex:1,textAlign:"center",p:2},children:[e.jsx(be,{color:"success",sx:{fontSize:24,mb:1}}),e.jsx(i,{variant:"h6",children:y}),e.jsx(i,{variant:"body2",color:"text.secondary",children:"Resolved DTPs"})]}),e.jsxs($,{sx:{flex:1,textAlign:"center",p:2},children:[e.jsx(es,{color:"primary",sx:{fontSize:24,mb:1}}),e.jsx(i,{variant:"h6",children:h.length}),e.jsx(i,{variant:"body2",color:"text.secondary",children:"Total DTPs"})]})]}),h.length>0&&e.jsx($,{sx:{mb:3},children:e.jsx(B,{children:e.jsxs(t,{sx:{display:"flex",gap:2,alignItems:"center",flexWrap:"wrap"},children:[e.jsx(t,{sx:{flex:1,minWidth:250},children:e.jsx(H,{fullWidth:!0,size:"small",placeholder:"Search DTPs...",value:c,onChange:n=>m(n.target.value),InputProps:{startAdornment:e.jsx($e,{sx:{mr:1,opacity:.5}})}})}),e.jsx(t,{sx:{minWidth:200},children:e.jsxs(ht,{value:C,exclusive:!0,onChange:(n,r)=>r&&I(r),size:"small",children:[e.jsx(os,{value:"all",children:"All"}),e.jsx(os,{value:"unresolved",children:"Unresolved"}),e.jsx(os,{value:"resolved",children:"Resolved"})]})}),e.jsx(t,{sx:{minWidth:120},children:e.jsxs(i,{variant:"body2",color:"text.secondary",children:[G.length," of ",h.length," shown"]})})]})})}),G.length===0?e.jsx($,{children:e.jsxs(B,{sx:{textAlign:"center",py:6},children:[e.jsx(es,{sx:{fontSize:48,color:"text.secondary",mb:2}}),e.jsx(i,{variant:"h6",color:"text.secondary",sx:{mb:1},children:c||C!=="all"?"No matching DTPs found":"No drug therapy problems recorded"}),e.jsx(i,{variant:"body2",color:"text.secondary",sx:{mb:3},children:c||C!=="all"?"Try adjusting your search or filters":"Monitor and document drug therapy problems to optimize patient care"}),!c&&C==="all"&&e.jsx(oe,{action:"canCreate",children:e.jsx(R,{variant:"contained",startIcon:e.jsx(Z,{}),onClick:()=>q(),children:"Report First DTP"})})]})}):e.jsx(ms,{component:Ze,children:e.jsxs(js,{children:[e.jsx(ps,{children:e.jsxs(Oe,{children:[e.jsx(Q,{children:e.jsx("strong",{children:"Type"})}),e.jsx(Q,{children:e.jsx("strong",{children:"Description"})}),e.jsx(Q,{children:e.jsx("strong",{children:"Status"})}),e.jsx(Q,{children:e.jsx("strong",{children:"Reported"})}),e.jsx(Q,{align:"right",children:e.jsx("strong",{children:"Actions"})})]})}),e.jsx(gs,{children:G.map(n=>{const r=d(n.type);return e.jsxs(Oe,{hover:!0,children:[e.jsx(Q,{children:e.jsxs(t,{children:[e.jsx(i,{variant:"body2",sx:{fontWeight:600},children:r.label}),e.jsx(W,{size:"small",label:r.label,color:V(n.type),variant:"outlined",sx:{mt:.5}})]})}),e.jsx(Q,{children:e.jsx(i,{variant:"body2",children:n.description||r.description})}),e.jsx(Q,{children:e.jsx(W,{label:n.status==="resolved"?"Resolved":"Unresolved",size:"small",color:p(n.status),icon:n.status==="resolved"?e.jsx(be,{}):e.jsx(re,{})})}),e.jsx(Q,{children:e.jsx(i,{variant:"body2",children:x(n.createdAt)})}),e.jsx(Q,{align:"right",children:e.jsx(N,{direction:"row",spacing:1,justifyContent:"flex-end",children:e.jsx(oe,{action:"canUpdate",children:e.jsx(ee,{title:"Edit DTP",children:e.jsx(O,{size:"small",onClick:()=>q(n),disabled:S.isPending||D.isPending,children:e.jsx(ve,{fontSize:"small"})})})})})})]},n._id)})})]})}),e.jsxs(Ae,{open:l,onClose:L,maxWidth:"sm",fullWidth:!0,children:[e.jsxs(Ie,{children:[e.jsxs(t,{sx:{display:"flex",alignItems:"center",pr:6},children:[e.jsx(es,{sx:{mr:1}}),o?"Edit Drug Therapy Problem":"Report New DTP"]}),e.jsx(O,{onClick:L,sx:{position:"absolute",right:8,top:8},children:e.jsx(ke,{})})]}),e.jsx(Pe,{dividers:!0,children:e.jsx("form",{onSubmit:w(U),children:e.jsxs(N,{spacing:3,children:[e.jsx(_,{name:"type",control:j,rules:{required:"DTP type is required"},render:({field:n})=>e.jsxs(pe,{fullWidth:!0,error:!!K.type,children:[e.jsx(ge,{children:"DTP Type"}),e.jsx(ye,{...n,label:"DTP Type",children:ns.map(r=>e.jsx(ne,{value:r.value,children:e.jsxs(t,{children:[e.jsx(i,{variant:"body2",sx:{fontWeight:600},children:r.label}),e.jsx(i,{variant:"caption",color:"text.secondary",children:r.description})]})},r.value))})]})}),e.jsx(_,{name:"description",control:j,rules:{maxLength:{value:500,message:"Description cannot exceed 500 characters"}},render:({field:n})=>{var r;return e.jsx(H,{...n,label:"Detailed Description",placeholder:"Provide specific details about this drug therapy problem...",multiline:!0,rows:4,fullWidth:!0,error:!!K.description,helperText:((r=K.description)==null?void 0:r.message)||"Optional: Add specific details about the problem and its context"})}}),e.jsx(_,{name:"status",control:j,render:({field:n})=>e.jsxs(pe,{fullWidth:!0,children:[e.jsx(ge,{children:"Status"}),e.jsxs(ye,{...n,label:"Status",children:[e.jsx(ne,{value:"unresolved",children:e.jsxs(t,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(re,{color:"error",sx:{mr:1}}),"Unresolved - Requires attention"]})}),e.jsx(ne,{value:"resolved",children:e.jsxs(t,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(be,{color:"success",sx:{mr:1}}),"Resolved - Problem addressed"]})})]})]})}),k("type")&&e.jsx(se,{severity:V(k("type"))==="error"?"error":"info",sx:{mt:2},children:e.jsxs(i,{variant:"body2",children:[e.jsxs("strong",{children:[d(k("type")).label,":"]})," ",d(k("type")).description]})})]})})}),e.jsxs(De,{sx:{p:3},children:[e.jsx(R,{onClick:L,disabled:F,children:"Cancel"}),e.jsx(R,{onClick:w(U),variant:"contained",disabled:F,sx:{minWidth:120},children:F?"Saving...":o?"Update DTP":"Report DTP"})]})]})]})})},_n=({patientId:s})=>{var A;const[l,a]=M.useState(!1),[o,u]=M.useState(null),{data:c,isLoading:m,isError:C,error:I}=kn(s),b=Wn(),T=Fn(),P=((A=c==null?void 0:c.data)==null?void 0:A.results)||[],g=P[0],{control:S,handleSubmit:D,reset:h,formState:{errors:j,isSubmitting:w}}=_e({defaultValues:{goals:[{value:""}],objectives:[{value:""}],followUpDate:void 0,planQuality:"adequate",dtpSummary:"resolved",notes:""}}),{fields:z,append:K,remove:F}=Ss({control:S,name:"goals"}),{fields:k,append:G,remove:q}=Ss({control:S,name:"objectives"}),L=y=>{y?(u(y),h({goals:y.goals.length>0?y.goals.map(f=>({value:f})):[{value:""}],objectives:y.objectives.length>0?y.objectives.map(f=>({value:f})):[{value:""}],followUpDate:y.followUpDate?new Date(y.followUpDate):void 0,planQuality:y.planQuality,dtpSummary:y.dtpSummary,notes:y.notes||""})):(u(null),h({goals:[{value:""}],objectives:[{value:""}],followUpDate:void 0,planQuality:"adequate",dtpSummary:"resolved",notes:""})),a(!0)},U=()=>{a(!1),u(null),h()},d=async y=>{var f,n;try{const r={goals:y.goals.map(v=>v.value).filter(v=>v.trim()!==""),objectives:y.objectives.map(v=>v.value).filter(v=>v.trim()!==""),followUpDate:(f=y.followUpDate)==null?void 0:f.toISOString(),planQuality:y.planQuality,dtpSummary:y.dtpSummary,notes:((n=y.notes)==null?void 0:n.trim())||void 0};o?await T.mutateAsync({carePlanId:o._id,carePlanData:r}):await b.mutateAsync({patientId:s,carePlanData:r}),U()}catch(r){console.error("Error saving care plan:",r)}},p=y=>y==="adequate"?"success":"warning",V=y=>y==="resolved"?"success":"warning",x=y=>y?new Date(y).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}):"Not set";return m?e.jsx(t,{sx:{display:"flex",justifyContent:"center",p:3},children:e.jsx(Me,{})}):C?e.jsxs(se,{severity:"error",sx:{m:2},children:[e.jsx(i,{variant:"h6",children:"Failed to load care plans"}),e.jsx(i,{variant:"body2",children:I instanceof Error?I.message:"Unable to retrieve care plan information."})]}):e.jsx(qe,{dateAdapter:Ue,children:e.jsxs(t,{children:[e.jsxs(t,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsxs(t,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(te,{sx:{mr:1,color:"primary.main"}}),e.jsx(i,{variant:"h6",sx:{fontWeight:600},children:"Care Plan Management"}),P.length>0&&e.jsx(W,{label:`${P.length} plan${P.length>1?"s":""}`,size:"small",sx:{ml:2}})]}),e.jsx(oe,{action:"canCreate",children:e.jsx(R,{variant:"contained",startIcon:e.jsx(Z,{}),onClick:()=>L(),children:"Create Care Plan"})})]}),g?e.jsx($,{sx:{mb:3},children:e.jsxs(B,{children:[e.jsxs(t,{sx:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",mb:3},children:[e.jsx(i,{variant:"h6",sx:{fontWeight:600},children:"Current Care Plan"}),e.jsxs(N,{direction:"row",spacing:1,children:[e.jsx(W,{label:g.planQuality==="adequate"?"Adequate":"Needs Review",size:"small",color:p(g.planQuality),icon:g.planQuality==="adequate"?e.jsx(be,{}):e.jsx(re,{})}),g.dtpSummary&&e.jsx(W,{label:`DTPs ${g.dtpSummary}`,size:"small",color:V(g.dtpSummary)}),e.jsx(oe,{action:"canUpdate",children:e.jsx(O,{size:"small",onClick:()=>L(g),children:e.jsx(ve,{fontSize:"small"})})})]})]}),e.jsxs(t,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:3},children:[e.jsxs(t,{children:[e.jsxs(i,{variant:"subtitle2",sx:{mb:2,display:"flex",alignItems:"center"},children:[e.jsx(ut,{sx:{mr:1,fontSize:18}}),"Treatment Goals (",g.goals.length,")"]}),e.jsx(me,{dense:!0,children:g.goals.map((y,f)=>e.jsx(je,{sx:{px:0},children:e.jsx(fe,{primary:y,primaryTypographyProps:{variant:"body2"}})},f))})]}),e.jsxs(t,{children:[e.jsxs(i,{variant:"subtitle2",sx:{mb:2,display:"flex",alignItems:"center"},children:[e.jsx(be,{sx:{mr:1,fontSize:18}}),"Objectives (",g.objectives.length,")"]}),e.jsx(me,{dense:!0,children:g.objectives.map((y,f)=>e.jsx(je,{sx:{px:0},children:e.jsx(fe,{primary:y,primaryTypographyProps:{variant:"body2"}})},f))})]})]}),(g.notes||g.followUpDate)&&e.jsxs(e.Fragment,{children:[e.jsx(he,{sx:{my:2}}),e.jsxs(t,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:2},children:[g.followUpDate&&e.jsxs(t,{children:[e.jsx(i,{variant:"body2",color:"text.secondary",children:"Next Follow-up"}),e.jsx(i,{variant:"body2",sx:{fontWeight:600},children:x(g.followUpDate)})]}),g.notes&&e.jsxs(t,{children:[e.jsx(i,{variant:"body2",color:"text.secondary",children:"Additional Notes"}),e.jsx(i,{variant:"body2",children:g.notes})]})]})]})]})}):e.jsx($,{children:e.jsxs(B,{sx:{textAlign:"center",py:6},children:[e.jsx(te,{sx:{fontSize:48,color:"text.secondary",mb:2}}),e.jsx(i,{variant:"h6",color:"text.secondary",sx:{mb:1},children:"No care plan created"}),e.jsx(i,{variant:"body2",color:"text.secondary",sx:{mb:3},children:"Create a comprehensive care plan to guide patient treatment and track progress"}),e.jsx(oe,{action:"canCreate",children:e.jsx(R,{variant:"contained",startIcon:e.jsx(Z,{}),onClick:()=>L(),children:"Create Care Plan"})})]})}),P.length>1&&e.jsx($,{sx:{mt:3},children:e.jsxs(B,{children:[e.jsxs(i,{variant:"h6",sx:{mb:2,fontWeight:600},children:["Previous Care Plans (",P.length-1,")"]}),e.jsx(N,{spacing:2,children:P.slice(1).map(y=>e.jsx(Ze,{sx:{p:2},variant:"outlined",children:e.jsxs(t,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs(t,{children:[e.jsxs(i,{variant:"body2",sx:{fontWeight:600},children:["Care Plan - ",x(y.createdAt)]}),e.jsxs(i,{variant:"caption",color:"text.secondary",children:[y.goals.length," goals • ",y.objectives.length," ","objectives"]})]}),e.jsxs(N,{direction:"row",spacing:1,children:[e.jsx(W,{label:y.planQuality,size:"small",color:p(y.planQuality),variant:"outlined"}),e.jsx(oe,{action:"canUpdate",children:e.jsx(O,{size:"small",onClick:()=>L(y),children:e.jsx(ve,{fontSize:"small"})})})]})]})},y._id))})]})}),e.jsxs(Ae,{open:l,onClose:U,maxWidth:"md",fullWidth:!0,children:[e.jsxs(Ie,{children:[e.jsxs(t,{sx:{display:"flex",alignItems:"center",pr:6},children:[e.jsx(te,{sx:{mr:1}}),o?"Edit Care Plan":"Create Care Plan"]}),e.jsx(O,{onClick:U,sx:{position:"absolute",right:8,top:8},children:e.jsx(ke,{})})]}),e.jsx(Pe,{dividers:!0,children:e.jsx("form",{onSubmit:D(d),children:e.jsxs(N,{spacing:3,children:[e.jsxs(t,{children:[e.jsx(i,{variant:"subtitle2",sx:{mb:2},children:"Treatment Goals"}),z.map((y,f)=>e.jsxs(t,{sx:{display:"flex",gap:1,mb:1},children:[e.jsx(_,{name:`goals.${f}.value`,control:S,rules:{required:f===0?"At least one goal is required":!1,maxLength:{value:200,message:"Goal cannot exceed 200 characters"}},render:({field:n})=>{var r,v,E,J,ae;return e.jsx(H,{...n,placeholder:`Goal ${f+1}`,fullWidth:!0,size:"small",error:!!((v=(r=j.goals)==null?void 0:r[f])!=null&&v.value),helperText:(ae=(J=(E=j.goals)==null?void 0:E[f])==null?void 0:J.value)==null?void 0:ae.message})}}),z.length>1&&e.jsx(O,{size:"small",onClick:()=>F(f),color:"error",children:e.jsx(Is,{})})]},y.id)),e.jsx(R,{startIcon:e.jsx(Z,{}),onClick:()=>K({value:""}),variant:"outlined",size:"small",sx:{mt:1},children:"Add Goal"})]}),e.jsxs(t,{children:[e.jsx(i,{variant:"subtitle2",sx:{mb:2},children:"Treatment Objectives"}),k.map((y,f)=>e.jsxs(t,{sx:{display:"flex",gap:1,mb:1},children:[e.jsx(_,{name:`objectives.${f}.value`,control:S,rules:{required:f===0?"At least one objective is required":!1,maxLength:{value:200,message:"Objective cannot exceed 200 characters"}},render:({field:n})=>{var r,v,E,J,ae;return e.jsx(H,{...n,placeholder:`Objective ${f+1}`,fullWidth:!0,size:"small",error:!!((v=(r=j.objectives)==null?void 0:r[f])!=null&&v.value),helperText:(ae=(J=(E=j.objectives)==null?void 0:E[f])==null?void 0:J.value)==null?void 0:ae.message})}}),k.length>1&&e.jsx(O,{size:"small",onClick:()=>q(f),color:"error",children:e.jsx(Is,{})})]},y.id)),e.jsx(R,{startIcon:e.jsx(Z,{}),onClick:()=>G({value:""}),variant:"outlined",size:"small",sx:{mt:1},children:"Add Objective"})]}),e.jsx(he,{}),e.jsxs(t,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:2},children:[e.jsx(_,{name:"planQuality",control:S,render:({field:y})=>e.jsxs(pe,{fullWidth:!0,children:[e.jsx(ge,{children:"Plan Quality"}),e.jsxs(ye,{...y,label:"Plan Quality",children:[e.jsx(ne,{value:"adequate",children:e.jsxs(t,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(be,{color:"success",sx:{mr:1}}),"Adequate"]})}),e.jsx(ne,{value:"needsReview",children:e.jsxs(t,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(re,{color:"warning",sx:{mr:1}}),"Needs Review"]})})]})]})}),e.jsx(_,{name:"dtpSummary",control:S,render:({field:y})=>e.jsxs(pe,{fullWidth:!0,children:[e.jsx(ge,{children:"DTP Status"}),e.jsxs(ye,{...y,label:"DTP Status",children:[e.jsx(ne,{value:"resolved",children:"All DTPs Resolved"}),e.jsx(ne,{value:"unresolved",children:"DTPs Unresolved"})]})]})})]}),e.jsx(_,{name:"followUpDate",control:S,render:({field:y})=>e.jsx(Vs,{...y,label:"Next Follow-up Date",minDate:new Date,slotProps:{textField:{fullWidth:!0,helperText:"Optional: Schedule next appointment"}}})}),e.jsx(_,{name:"notes",control:S,rules:{maxLength:{value:500,message:"Notes cannot exceed 500 characters"}},render:({field:y})=>{var f;return e.jsx(H,{...y,label:"Additional Notes",placeholder:"Any additional observations or instructions...",multiline:!0,rows:3,fullWidth:!0,error:!!j.notes,helperText:((f=j.notes)==null?void 0:f.message)||"Optional clinical notes"})}})]})})}),e.jsxs(De,{sx:{p:3},children:[e.jsx(R,{onClick:U,disabled:w,children:"Cancel"}),e.jsx(R,{onClick:D(d),variant:"contained",disabled:w,sx:{minWidth:120},children:w?"Saving...":o?"Update Plan":"Create Plan"})]})]})]})})},$n=({patientId:s})=>{var n;const[l,a]=M.useState(!1),[o,u]=M.useState(null),[c,m]=M.useState(""),[C,I]=M.useState(0),[b,T]=M.useState([]),{data:P,isLoading:g,isError:S,error:D}=zn(s),h=En(),j=Ln(),w=((n=P==null?void 0:P.data)==null?void 0:n.results)||[],{control:z,handleSubmit:K,reset:F,formState:{errors:k,isSubmitting:G}}=_e({defaultValues:{date:new Date,subjective:"",objective:"",assessment:"",plan:""}}),q=w.filter(r=>r.date.toLowerCase().includes(c.toLowerCase())||Object.values(r.soap).some(v=>v&&v.toLowerCase().includes(c.toLowerCase()))),L=r=>{r?(u(r),F({date:new Date(r.date),subjective:r.soap.subjective||"",objective:r.soap.objective||"",assessment:r.soap.assessment||"",plan:r.soap.plan||""}),T(r.attachments||[])):(u(null),F({date:new Date,subjective:"",objective:"",assessment:"",plan:""}),T([])),a(!0)},U=()=>{a(!1),u(null),T([]),F()},d=async r=>{var v,E,J,ae;try{const Fe={subjective:((v=r.subjective)==null?void 0:v.trim())||void 0,objective:((E=r.objective)==null?void 0:E.trim())||void 0,assessment:((J=r.assessment)==null?void 0:J.trim())||void 0,plan:((ae=r.plan)==null?void 0:ae.trim())||void 0},Ve={date:r.date.toISOString(),soap:Fe,attachments:b};o?await j.mutateAsync({visitId:o._id,visitData:Ve}):await h.mutateAsync({patientId:s,visitData:Ve}),U()}catch(Fe){console.error("Error saving visit:",Fe)}},p=r=>{const v=r.target.files;v&&Array.from(v).forEach(E=>{const J={kind:V(E.type),url:URL.createObjectURL(E),fileName:E.name,fileSize:E.size,mimeType:E.type,uploadedAt:new Date().toISOString()};T(ae=>[...ae,J])})},V=r=>r.startsWith("image/")?"image":r.startsWith("audio/")?"audio":"other",x=r=>{switch(r){case"image":return e.jsx(Vt,{});case"audio":return e.jsx(Bt,{});case"lab":return e.jsx(Ye,{});default:return e.jsx(Be,{})}},A=r=>{if(r===0)return"0 Bytes";const v=1024,E=["Bytes","KB","MB","GB"],J=Math.floor(Math.log(r)/Math.log(v));return parseFloat((r/Math.pow(v,J)).toFixed(2))+" "+E[J]},y=r=>new Date(r).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}),f=r=>{T(v=>v.filter((E,J)=>J!==r))};return g?e.jsx(t,{sx:{display:"flex",justifyContent:"center",p:3},children:e.jsx(Me,{})}):S?e.jsxs(se,{severity:"error",sx:{m:2},children:[e.jsx(i,{variant:"h6",children:"Failed to load visits"}),e.jsx(i,{variant:"body2",children:D instanceof Error?D.message:"Unable to retrieve visit information."})]}):e.jsx(qe,{dateAdapter:Ue,children:e.jsxs(t,{children:[e.jsxs(t,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsxs(t,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(Xe,{sx:{mr:1,color:"primary.main"}}),e.jsx(i,{variant:"h6",sx:{fontWeight:600},children:"Visit Management"}),w.length>0&&e.jsx(W,{label:`${w.length} visit${w.length>1?"s":""}`,size:"small",sx:{ml:2}})]}),e.jsx(oe,{action:"canCreate",children:e.jsx(R,{variant:"contained",startIcon:e.jsx(Z,{}),onClick:()=>L(),children:"New Visit"})})]}),w.length>0&&e.jsx($,{sx:{mb:3},children:e.jsx(B,{children:e.jsx(H,{fullWidth:!0,size:"small",placeholder:"Search visits by date or notes...",value:c,onChange:r=>m(r.target.value),InputProps:{startAdornment:e.jsx($e,{sx:{mr:1,opacity:.5}})}})})}),q.length===0?e.jsx($,{children:e.jsxs(B,{sx:{textAlign:"center",py:6},children:[e.jsx(Xe,{sx:{fontSize:48,color:"text.secondary",mb:2}}),e.jsx(i,{variant:"h6",color:"text.secondary",sx:{mb:1},children:c?"No matching visits found":"No visits recorded"}),e.jsx(i,{variant:"body2",color:"text.secondary",sx:{mb:3},children:c?"Try adjusting your search terms":"Create visit records with SOAP notes to track patient encounters"}),!c&&e.jsx(oe,{action:"canCreate",children:e.jsx(R,{variant:"contained",startIcon:e.jsx(Z,{}),onClick:()=>L(),children:"Create First Visit"})})]})}):e.jsx(N,{spacing:2,children:q.map(r=>e.jsx($,{children:e.jsxs(B,{children:[e.jsxs(t,{sx:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",mb:2},children:[e.jsxs(t,{children:[e.jsx(i,{variant:"h6",sx:{fontWeight:600},children:y(r.date)}),r.attachments&&r.attachments.length>0&&e.jsx(W,{label:`${r.attachments.length} attachment${r.attachments.length>1?"s":""}`,size:"small",icon:e.jsx(Be,{}),variant:"outlined",sx:{mt:.5}})]}),e.jsxs(N,{direction:"row",spacing:1,children:[e.jsx(ee,{title:"View Visit",children:e.jsx(O,{size:"small",onClick:()=>L(r),children:e.jsx(Re,{fontSize:"small"})})}),e.jsx(oe,{action:"canUpdate",children:e.jsx(ee,{title:"Edit Visit",children:e.jsx(O,{size:"small",onClick:()=>L(r),children:e.jsx(ve,{fontSize:"small"})})})})]})]}),e.jsxs(t,{sx:{display:"grid",gridTemplateColumns:{xs:"1fr",md:"1fr 1fr"},gap:2},children:[r.soap.subjective&&e.jsxs(t,{children:[e.jsx(i,{variant:"subtitle2",color:"primary",sx:{mb:1},children:"Subjective"}),e.jsx(i,{variant:"body2",sx:{display:"-webkit-box",WebkitLineClamp:3,WebkitBoxOrient:"vertical",overflow:"hidden"},children:r.soap.subjective})]}),r.soap.objective&&e.jsxs(t,{children:[e.jsx(i,{variant:"subtitle2",color:"primary",sx:{mb:1},children:"Objective"}),e.jsx(i,{variant:"body2",sx:{display:"-webkit-box",WebkitLineClamp:3,WebkitBoxOrient:"vertical",overflow:"hidden"},children:r.soap.objective})]}),r.soap.assessment&&e.jsxs(t,{children:[e.jsx(i,{variant:"subtitle2",color:"primary",sx:{mb:1},children:"Assessment"}),e.jsx(i,{variant:"body2",sx:{display:"-webkit-box",WebkitLineClamp:3,WebkitBoxOrient:"vertical",overflow:"hidden"},children:r.soap.assessment})]}),r.soap.plan&&e.jsxs(t,{children:[e.jsx(i,{variant:"subtitle2",color:"primary",sx:{mb:1},children:"Plan"}),e.jsx(i,{variant:"body2",sx:{display:"-webkit-box",WebkitLineClamp:3,WebkitBoxOrient:"vertical",overflow:"hidden"},children:r.soap.plan})]})]})]})},r._id))}),e.jsxs(Ae,{open:l,onClose:U,maxWidth:"lg",fullWidth:!0,children:[e.jsxs(Ie,{children:[e.jsxs(t,{sx:{display:"flex",alignItems:"center",pr:6},children:[e.jsx(Xe,{sx:{mr:1}}),o?"Edit Visit":"New Patient Visit"]}),e.jsx(O,{onClick:U,sx:{position:"absolute",right:8,top:8},children:e.jsx(ke,{})})]}),e.jsx(Pe,{dividers:!0,children:e.jsx("form",{onSubmit:K(d),children:e.jsxs(N,{spacing:3,children:[e.jsx(_,{name:"date",control:z,rules:{required:"Visit date is required"},render:({field:r})=>{var v;return e.jsx(ys,{...r,label:"Visit Date & Time",maxDateTime:new Date,slotProps:{textField:{error:!!k.date,helperText:(v=k.date)==null?void 0:v.message,fullWidth:!0}}})}}),e.jsx(t,{sx:{borderBottom:1,borderColor:"divider"},children:e.jsxs(Ns,{value:C,onChange:(r,v)=>I(v),children:[e.jsx(ze,{label:"Subjective",icon:e.jsx(Mt,{})}),e.jsx(ze,{label:"Objective",icon:e.jsx(Re,{})}),e.jsx(ze,{label:"Assessment",icon:e.jsx(Ye,{})}),e.jsx(ze,{label:"Plan",icon:e.jsx(Xe,{})}),e.jsx(ze,{label:"Attachments",icon:e.jsx(Be,{})})]})}),C===0&&e.jsx(_,{name:"subjective",control:z,render:({field:r})=>e.jsx(H,{...r,label:"Subjective",placeholder:"Patient's chief complaint, history of present illness, symptoms...",multiline:!0,rows:6,fullWidth:!0,helperText:"What the patient tells you - symptoms, concerns, history"})}),C===1&&e.jsx(_,{name:"objective",control:z,render:({field:r})=>e.jsx(H,{...r,label:"Objective",placeholder:"Physical examination findings, vital signs, test results...",multiline:!0,rows:6,fullWidth:!0,helperText:"What you observe - physical exam, vital signs, lab results"})}),C===2&&e.jsx(_,{name:"assessment",control:z,render:({field:r})=>e.jsx(H,{...r,label:"Assessment",placeholder:"Clinical impression, diagnosis, differential diagnosis...",multiline:!0,rows:6,fullWidth:!0,helperText:"Your clinical judgment - diagnosis, impression, analysis"})}),C===3&&e.jsx(_,{name:"plan",control:z,render:({field:r})=>e.jsx(H,{...r,label:"Plan",placeholder:"Treatment plan, medications, follow-up instructions...",multiline:!0,rows:6,fullWidth:!0,helperText:"Treatment plan - medications, procedures, follow-up care"})}),C===4&&e.jsxs(t,{children:[e.jsxs(t,{sx:{mb:3},children:[e.jsxs(R,{variant:"outlined",component:"label",startIcon:e.jsx(Be,{}),fullWidth:!0,sx:{mb:2},children:["Upload Files",e.jsx("input",{type:"file",hidden:!0,multiple:!0,accept:"image/*,audio/*,.pdf,.doc,.docx",onChange:p})]}),e.jsx(i,{variant:"caption",color:"text.secondary",children:"Supported: Images, Audio files, PDF, Word documents"})]}),b.length>0&&e.jsxs(t,{children:[e.jsxs(i,{variant:"subtitle2",sx:{mb:2},children:["Attachments (",b.length,")"]}),e.jsx(me,{children:b.map((r,v)=>e.jsxs(je,{children:[e.jsx(Ne,{children:x(r.kind)}),e.jsx(fe,{primary:r.fileName,secondary:`${r.mimeType} • ${A(r.fileSize||0)}`}),e.jsx(O,{edge:"end",onClick:()=>f(v),color:"error",children:e.jsx(ke,{})})]},v))})]})]})]})})}),e.jsxs(De,{sx:{p:3},children:[e.jsx(R,{onClick:U,disabled:G,children:"Cancel"}),e.jsx(R,{onClick:K(d),variant:"contained",disabled:G,sx:{minWidth:120},children:G?"Saving...":o?"Update Visit":"Save Visit"})]})]})]})})};function ue({children:s,value:l,index:a,...o}){return e.jsx("div",{role:"tabpanel",hidden:l!==a,id:`patient-tabpanel-${a}`,"aria-labelledby":`patient-tab-${a}`,...o,children:l===a&&e.jsx(t,{sx:{py:0},children:s})})}function qn(s){return{id:`patient-tab-${s}`,"aria-controls":`patient-tabpanel-${s}`}}const Lr=()=>{var g;const{patientId:s}=Fs(),l=as(),[a,o]=M.useState(0);mt();const{data:u,isLoading:c,isError:m,error:C}=Os(s||""),I=(g=ds(u))==null?void 0:g.patient,b=(S,D)=>{o(D)};if(c)return e.jsxs(t,{sx:{p:3},children:[e.jsxs(N,{direction:"row",alignItems:"center",spacing:2,sx:{mb:3},children:[e.jsx(Y,{variant:"circular",width:40,height:40}),e.jsx(Y,{variant:"text",width:200,height:40})]}),e.jsx(Y,{variant:"rectangular",width:"100%",height:60,sx:{mb:3}}),e.jsx(Y,{variant:"rectangular",width:"100%",height:400})]});if(m)return e.jsxs(t,{sx:{p:3},children:[e.jsxs(N,{direction:"row",alignItems:"center",spacing:2,sx:{mb:3},children:[e.jsx(O,{onClick:()=>l("/patients"),children:e.jsx(Te,{})}),e.jsx(i,{variant:"h5",children:"Patient Management"})]}),e.jsxs(se,{severity:"error",sx:{mb:3},children:[e.jsx(i,{variant:"h6",children:"Failed to load patient"}),e.jsx(i,{variant:"body2",children:(C==null?void 0:C.message)||"An unexpected error occurred while loading patient data."})]}),e.jsx(R,{variant:"outlined",onClick:()=>l("/patients"),startIcon:e.jsx(Te,{}),children:"Back to Patients"})]});if(!I)return e.jsxs(t,{sx:{p:3},children:[e.jsxs(N,{direction:"row",alignItems:"center",spacing:2,sx:{mb:3},children:[e.jsx(O,{onClick:()=>l("/patients"),children:e.jsx(Te,{})}),e.jsx(i,{variant:"h5",children:"Patient Management"})]}),e.jsxs(se,{severity:"warning",children:[e.jsx(i,{variant:"h6",children:"Patient not found"}),e.jsx(i,{variant:"body2",children:"The requested patient could not be found."})]}),e.jsx(R,{variant:"outlined",onClick:()=>l("/patients"),startIcon:e.jsx(Te,{}),sx:{mt:2},children:"Back to Patients"})]});const T=S=>[e.jsx(jt,{}),e.jsx(Ye,{}),e.jsx(He,{}),e.jsx(Ke,{}),e.jsx(us,{}),e.jsx(zs,{}),e.jsx(re,{}),e.jsx(te,{}),e.jsx(Re,{}),e.jsx(te,{})][S],P=["Dashboard","Clinical Notes","Allergies","Conditions","Medications","Assessments","DTPs","Care Plans","Visits","MTR Sessions"];return e.jsxs(t,{sx:{minHeight:"100vh",bgcolor:"background.default"},children:[e.jsx(t,{sx:{bgcolor:"background.paper",borderBottom:1,borderColor:"divider"},children:e.jsxs(t,{sx:{p:3},children:[e.jsxs(N,{direction:"row",alignItems:"center",spacing:2,sx:{mb:3},children:[e.jsx(O,{onClick:()=>l("/patients"),sx:{bgcolor:"action.hover"},children:e.jsx(Te,{})}),e.jsxs(t,{sx:{flex:1},children:[e.jsxs(i,{variant:"h4",sx:{fontWeight:600,mb:.5},children:[I.firstName," ",I.lastName]}),e.jsxs(N,{direction:"row",alignItems:"center",spacing:2,children:[e.jsxs(i,{variant:"body2",color:"text.secondary",children:["MRN: ",I.mrn]}),I.hasActiveDTP&&e.jsx(W,{icon:e.jsx(re,{}),label:"Active DTPs",color:"warning",size:"small"}),I.genotype&&["SS","SC","CC"].includes(I.genotype)&&e.jsx(W,{icon:e.jsx(Ke,{}),label:`Sickle Cell - ${I.genotype}`,color:"error",size:"small"}),e.jsx(un,{patientId:s||"",variant:"chip",showActions:!1})]})]}),e.jsx(R,{variant:"outlined",startIcon:e.jsx(Kt,{}),onClick:()=>l(`/patients/${s}/edit`),children:"Edit Patient"})]}),e.jsx(Ze,{elevation:0,sx:{borderRadius:2},children:e.jsx(Ns,{value:a,onChange:b,variant:"scrollable",scrollButtons:"auto",sx:{"& .MuiTab-root":{minHeight:48,textTransform:"none",fontWeight:500},"& .MuiTabs-indicator":{height:3,borderRadius:1.5}},children:P.map((S,D)=>e.jsx(ze,{label:S,icon:T(D),iconPosition:"start",...qn(D),sx:{gap:1,alignItems:"center",justifyContent:"flex-start"}},S))})})]})}),e.jsxs(t,{sx:{flexGrow:1},children:[e.jsx(ue,{value:a,index:0,children:e.jsx(hn,{patientId:s})}),e.jsx(ue,{value:a,index:1,children:e.jsx(t,{sx:{p:3},children:e.jsx(Qs,{patientId:s||"",maxNotes:10,showCreateButton:!0,onCreateNote:()=>l(`/notes/new?patientId=${s}`),onViewNote:S=>l(`/notes/${S}`),onEditNote:S=>l(`/notes/${S}/edit`)})})}),e.jsx(ue,{value:a,index:2,children:e.jsx(t,{sx:{p:3},children:e.jsx(jn,{patientId:s||""})})}),e.jsx(ue,{value:a,index:3,children:e.jsx(t,{sx:{p:3},children:e.jsx(gn,{patientId:s||""})})}),e.jsx(ue,{value:a,index:4,children:e.jsx(t,{sx:{p:3},children:e.jsx(yn,{patientId:s||""})})}),e.jsx(ue,{value:a,index:5,children:e.jsx(t,{sx:{p:3},children:e.jsx(Nn,{patientId:s||""})})}),e.jsx(ue,{value:a,index:6,children:e.jsx(t,{sx:{p:3},children:e.jsx(On,{patientId:s||""})})}),e.jsx(ue,{value:a,index:7,children:e.jsx(t,{sx:{p:3},children:e.jsx(_n,{patientId:s||""})})}),e.jsx(ue,{value:a,index:8,children:e.jsx(t,{sx:{p:3},children:e.jsx($n,{patientId:s||""})})}),e.jsx(ue,{value:a,index:9,children:e.jsx(t,{sx:{p:3},children:e.jsx(Bs,{patientId:s||""})})})]})]})};export{Lr as default};
