import{c as jt,j as e,br as zr,r as p,W as Je,O as pt,b9 as St,B as n,Q as oe,D as ge,b8 as qr,l as K,T as r,L as Xe,n as De,ar as Ve,p as Ie,bs as it,bt as at,aX as Qe,bu as ot,a0 as Ct,h as N,R as Et,bv as Ee,bf as dt,aQ as Zt,C as se,b as ae,w as Le,a5 as X,a6 as xr,I as xe,be as Dt,ab as ct,A as Gt,bw as It,bx as er,K as mr,by as Br,o as Ur,aW as ar,aR as Fe,bz as $r,aS as ze,aT as qe,aa as Oe,bi as U,a7 as le,a8 as ce,a9 as de,f as L,bj as Ke,aU as Be,bn as qt,bo as $e,t as Mt,Z as Gr,bA as Hr,d as tt,_ as Nt,x as rt,bB as or,bC as lr,bD as cr,bE as Vr,ak as Wt,b5 as Qr,bh as Ht,U as Ot,bF as pr,ai as Lt,bG as Xr,bH as _t,q as dr,s as jr,y as Kr,Y as Yr,bI as Jr,$ as Zr,bJ as Vt,aV as Tr,b7 as es,bK as ts,bL as rs,bM as ss,a3 as ns,a_ as Ye,bN as is,bO as as,bP as gr,g as kr,b3 as Pr,b0 as tr,b1 as ut,b2 as ht,G as vt,S as Qt}from"./index-B_pWc9hu.js";import{H as os}from"./Home-C8eDz3RN.js";import{B as ls}from"./BugReport-CefgtFkV.js";import{L as Rr}from"./Lightbulb-Crk4gU8o.js";import{S as rr}from"./Save-DxF8g1QD.js";import{S as Rt}from"./Search-C2mZoRVv.js";import{I as fr}from"./PersonAdd-BOMx32z9.js";import{P as mt}from"./Person-YzlArB5c.js";import{E as ur}from"./ExpandLess-CfW7CJI2.js";import{b as cs,c as ds}from"./usePatients-TJUphVTL.js";import{u as Bt}from"./useResponsive-LdFh52p2.js";import{L as Ut}from"./LocalizationProvider-CB6kfikn.js";import{A as $t,i as Er,a as yr}from"./AdapterDateFns-RQ5vW8pD.js";import{Z as Nr}from"./Zoom-VLTAQnN7.js";import{D as At}from"./DatePicker-tSjwJs7r.js";import{A as Ft}from"./Autocomplete-HcpzFt3K.js";import{A as _e}from"./Add-D5-B7xRD.js";import{E as Ge}from"./Edit-DD3Q49Z-.js";import{D as xt}from"./Delete-BIyg2wQJ.js";import{F as P}from"./FixedGrid-B4UzxoGK.js";import{api as lt}from"./api-65X4hLNz.js";import{P as Wr}from"./PlayArrow-MruisKZg.js";import{S as hr}from"./StepContent-w2j1tT6L.js";import{T as vr,a as br,b as wr,c as Tt,d as Sr}from"./TableRow-BGzfcKex.js";import{T as Ce}from"./TableCell-DCrr5aWG.js";import{M as Or}from"./MonitorHeart-D-Nq_5B0.js";import{L as us}from"./LocalHospital-BNb4THgq.js";import{F as hs}from"./FilterList-BjHMpklN.js";import{S as Cr}from"./Switch-DtQ0auD3.js";import{T as xs,a as ms,b as ps,c as js,d as gs,e as fs,f as ys}from"./TimelineSeparator-BIIWoEeL.js";import{d as vs,f as wt}from"./format-CQst3Dr_.js";import{C as Dr}from"./CalendarToday-Dqq_i_do.js";import{A as bs,S as ws}from"./AccessTime-DjyPxGRb.js";import{D as Xt}from"./DateTimePicker-DzpmGcCV.js";import{a as Ss}from"./addMonths-BkvcT9-f.js";import{S as Ir}from"./Sync-C9idAwzJ.js";import{mtrService as et}from"./mtrService-BFzIf3Sf.js";import{F as sr}from"./Fab-_YJw2jg9.js";import{Q as Cs}from"./MTRContextualHelp-DXB0oMUN.js";import{A as nr}from"./ArrowBack-bh5q612l.js";import{P as Ds}from"./Print-CBvnEWcO.js";import{D as Is}from"./Download-DRMVM3Bm.js";import{L as Ms}from"./LocalPharmacy-BpoHyUxJ.js";import"./useMobilePicker-CrD-8_S2.js";import"./index-BydA3A-2.js";const As=jt(e.jsx("path",{d:"M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96M10 17l-3.5-3.5 1.41-1.41L10 14.17 15.18 9l1.41 1.41z"})),Ts=jt(e.jsx("path",{d:"M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2m0 16H8V7h11z"})),ks=jt(e.jsx("path",{d:"M9 3 5 6.99h3V14h2V6.99h3zm7 14.01V10h-2v7.01h-3L15 21l4-3.99z"})),Ps=jt(e.jsx("path",{d:"M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"})),zt=jt(e.jsx("path",{d:"M10 6 8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"})),Rs=jt(e.jsx("path",{d:"M21 4H7V2H5v20h2v-8h14l-2-5zm-6 5c0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2 2 .9 2 2"}));function Es(g,t,i){const[s,j]=zr(i==null?void 0:i.in,g,t),d=Mr(s,j),x=Math.abs(vs(s,j));s.setDate(s.getDate()-d*x);const f=+(Mr(s,j)===-d),R=d*(x-f);return R===0?0:R}function Mr(g,t){const i=g.getFullYear()-t.getFullYear()||g.getMonth()-t.getMonth()||g.getDate()-t.getDate()||g.getHours()-t.getHours()||g.getMinutes()-t.getMinutes()||g.getSeconds()-t.getSeconds()||g.getMilliseconds()-t.getMilliseconds();return i<0?-1:i>0?1:i}class Lr extends p.Component{constructor(){super(...arguments),this.state={hasError:!1,errorId:""},this.logMTRError=(t,i)=>{const s={errorId:this.state.errorId,message:t.message,name:t.name,stack:t.stack,componentStack:i.componentStack,timestamp:new Date().toISOString(),userAgent:navigator.userAgent,url:window.location.href,userId:this.getUserId()};try{console.error("MTR Error Log:",s)}catch(j){console.error("Failed to log MTR error:",j)}},this.getUserId=()=>{try{return null}catch{}return null},this.parseMTRError=t=>{try{if(t.message.includes("MTR"))return{type:"MTRError",message:t.message,severity:"medium",recovery:["Check your input data","Verify required fields are completed","Try refreshing the page"]}}catch{}return null},this.getErrorSeverity=t=>{const i=this.parseMTRError(t);return i!=null&&i.severity?i.severity:t.name==="ChunkLoadError"||t.message.includes("Loading chunk")?"low":t.name==="TypeError"||t.name==="ReferenceError"?"high":"medium"},this.getSeverityColor=t=>{switch(t){case"critical":return"error";case"high":return"error";case"medium":return"warning";case"low":return"info";default:return"warning"}},this.getSeverityIcon=t=>{switch(t){case"critical":return e.jsx(St,{});case"high":return e.jsx(St,{});case"medium":return e.jsx(Je,{});case"low":return e.jsx(pt,{});default:return e.jsx(Je,{})}},this.getRecoveryActions=t=>{const i=this.parseMTRError(t);return i!=null&&i.recovery?i.recovery:t.name==="ChunkLoadError"||t.message.includes("Loading chunk")?["Refresh the page to reload the application","Clear your browser cache","Check your internet connection"]:t.message.includes("Network")?["Check your internet connection","Try again in a few moments","Contact support if the issue persists"]:["Try refreshing the page","Go back to the previous step","Contact support if the problem continues"]},this.handleReload=()=>{window.location.reload()},this.handleReset=()=>{this.setState({hasError:!1,error:void 0,errorInfo:void 0,errorId:""})},this.handleGoHome=()=>{window.location.href="/dashboard"},this.handleReportError=()=>{var j;const t={errorId:this.state.errorId,message:(j=this.state.error)==null?void 0:j.message,timestamp:new Date().toISOString(),url:window.location.href},i=encodeURIComponent(`MTR Error Report - ${this.state.errorId}`),s=encodeURIComponent(`
Error ID: ${t.errorId}
Message: ${t.message}
Timestamp: ${t.timestamp}
URL: ${t.url}

Please describe what you were doing when this error occurred:
[Your description here]
    `);window.open(`mailto:support@pharmacare.com?subject=${i}&body=${s}`)}}static getDerivedStateFromError(t){const i=`mtr-error-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;return{hasError:!0,error:t,errorId:i}}componentDidCatch(t,i){console.error("MTR ErrorBoundary caught an error:",t,i),this.logMTRError(t,i),this.setState({error:t,errorInfo:i}),this.props.onError&&this.props.onError(t,i)}render(){var t;if(this.state.hasError){if(this.props.fallback)return this.props.fallback;const i=this.state.error,s=this.getErrorSeverity(i),j=this.getRecoveryActions(i),d=this.parseMTRError(i);return e.jsx(n,{sx:{display:"flex",alignItems:"center",justifyContent:"center",minHeight:"60vh",p:3},children:e.jsxs(oe,{sx:{p:4,maxWidth:800,width:"100%"},children:[e.jsxs(ge,{severity:this.getSeverityColor(s),icon:this.getSeverityIcon(s),sx:{mb:3},children:[e.jsx(qr,{children:e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:1},children:["MTR Module Error",e.jsx(K,{label:s.toUpperCase(),size:"small",color:this.getSeverityColor(s),variant:"outlined"})]})}),e.jsxs(r,{variant:"body2",sx:{mt:1},children:["An error occurred in the Medication Therapy Review module.",s==="low"&&" This is likely a temporary issue.",s==="medium"&&" Please try the suggested recovery actions.",s==="high"&&" This requires immediate attention.",s==="critical"&&" This is a critical error that needs urgent resolution."]})]}),e.jsxs(n,{sx:{mb:3},children:[e.jsx(r,{variant:"h6",gutterBottom:!0,children:"Error Details"}),e.jsxs(oe,{sx:{p:2,bgcolor:"grey.50"},children:[e.jsx(r,{variant:"body2",color:"error",children:i.message}),e.jsxs(r,{variant:"caption",color:"text.secondary",sx:{mt:1,display:"block"},children:["Error ID: ",this.state.errorId]})]})]}),e.jsxs(n,{sx:{mb:3},children:[e.jsxs(r,{variant:"h6",gutterBottom:!0,sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Rr,{color:"primary"}),"Suggested Actions"]}),e.jsx(Xe,{dense:!0,children:j.map((x,f)=>e.jsxs(De,{children:[e.jsx(Ve,{children:e.jsxs(r,{variant:"body2",color:"primary",fontWeight:"bold",children:[f+1,"."]})}),e.jsx(Ie,{primary:x})]},f))})]}),(d==null?void 0:d.details)&&e.jsxs(it,{sx:{mb:3},children:[e.jsx(at,{expandIcon:e.jsx(Qe,{}),children:e.jsx(r,{variant:"subtitle1",children:"MTR Validation Details"})}),e.jsx(ot,{children:e.jsx(Xe,{dense:!0,children:d.details.map((x,f)=>e.jsx(De,{children:e.jsx(Ie,{primary:x.message,secondary:x.field&&`Field: ${x.field}`})},f))})})]}),this.props.showDetails&&this.state.error&&e.jsxs(it,{sx:{mb:3},children:[e.jsx(at,{expandIcon:e.jsx(Qe,{}),children:e.jsx(r,{variant:"subtitle1",children:"Technical Details"})}),e.jsx(ot,{children:e.jsx(oe,{sx:{p:2,bgcolor:"grey.50",overflow:"auto"},children:e.jsxs(r,{variant:"body2",component:"pre",sx:{fontSize:"0.75rem",whiteSpace:"pre-wrap"},children:[this.state.error.stack,(t=this.state.errorInfo)==null?void 0:t.componentStack]})})})]}),e.jsx(Ct,{sx:{my:3}}),e.jsxs(n,{sx:{display:"flex",gap:2,justifyContent:"center",flexWrap:"wrap"},children:[e.jsx(N,{variant:"contained",onClick:this.handleReset,startIcon:e.jsx(Et,{}),children:"Try Again"}),e.jsx(N,{variant:"outlined",onClick:this.handleReload,startIcon:e.jsx(Et,{}),children:"Reload Page"}),e.jsx(N,{variant:"outlined",onClick:this.handleGoHome,startIcon:e.jsx(os,{}),children:"Go to Dashboard"}),e.jsx(N,{variant:"text",onClick:this.handleReportError,startIcon:e.jsx(ls,{}),size:"small",children:"Report Error"})]})]})})}return this.props.children}}const Ns=(g,t)=>{let i;return s=>{clearTimeout(i),i=setTimeout(()=>g(s),t)}},Ws=["Abia","Adamawa","Akwa Ibom","Anambra","Bauchi","Bayelsa","Benue","Borno","Cross River","Delta","Ebonyi","Edo","Ekiti","Enugu","FCT","Gombe","Imo","Jigawa","Kaduna","Kano","Katsina","Kebbi","Kogi","Kwara","Lagos","Nasarawa","Niger","Ogun","Ondo","Osun","Oyo","Plateau","Rivers","Sokoto","Taraba","Yobe","Zamfara"],Os=["A+","A-","B+","B-","AB+","AB-","O+","O-"],Ls=["AA","AS","SS","AC","SC","CC"],_s=["male","female","other"],Fs=["single","married","divorced","widowed"],_r=({onPatientSelect:g,selectedPatient:t,onNext:i})=>{const{isMobile:s,shouldUseCardLayout:j,getSpacing:d,getDialogMaxWidth:x}=Bt(),[f,R]=p.useState(""),[u,y]=p.useState(!1),[M,E]=p.useState([]),[w,ee]=p.useState(!0),{loading:Z,errors:$,setLoading:O,setError:z,currentReview:J,createReview:V}=Ee(),{data:S,isLoading:re,error:D}=cs(f),B=ds(),{control:I,handleSubmit:ie,watch:te,setValue:fe,formState:{errors:W},reset:Se}=dt({defaultValues:{firstName:"",lastName:"",otherNames:"",gender:void 0,maritalStatus:void 0,phone:"",email:"",address:"",state:void 0,lga:"",bloodGroup:void 0,genotype:void 0,weightKg:void 0}}),l=te("dob"),Q=te("age"),ue=p.useMemo(()=>Ns(o=>{console.log("Search query:",o)},300),[]),me=p.useCallback(o=>{ue(o)},[ue]);p.useEffect(()=>{me(f)},[f,me]),p.useEffect(()=>{if(l&&!Q){const o=new Date,v=new Date(l);let _=o.getFullYear()-v.getFullYear();const pe=o.getMonth()-v.getMonth();(pe<0||pe===0&&o.getDate()<v.getDate())&&_--,_>=0&&_<=150&&fe("age",_)}},[l,Q,fe]),p.useEffect(()=>{(()=>{try{E([])}catch(v){console.error("Failed to load recent patients:",v)}})()},[]);const Me=o=>/^\+234[789]\d{9}$/.test(o),je=o=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(o),ve=async o=>{try{O("selectPatient",!0),z("selectPatient",null);const v=[o,...M.filter(_=>_._id!==o._id)].slice(0,5);if(E(v),g(o),!J){console.log("Creating MTR review for patient:",o._id),await V(o._id),await new Promise(pe=>setTimeout(pe,500));const{currentReview:_}=Ee.getState();if(!(_!=null&&_._id))throw console.error("MTR review creation failed - no ID found after creation"),new Error("Failed to create MTR review - please try again");console.log("MTR review created successfully with ID:",_._id)}}catch(v){console.error("Error in handlePatientSelect:",v),z("selectPatient",v instanceof Error?v.message:"Failed to select patient")}finally{O("selectPatient",!1)}},Ne=async o=>{var v,_;try{O("createNewPatient",!0),z("createNewPatient",null);const pe={firstName:o.firstName,lastName:o.lastName,otherNames:o.otherNames||void 0,dob:(v=o.dob)==null?void 0:v.toISOString(),age:o.age,gender:o.gender,maritalStatus:o.maritalStatus,phone:o.phone||void 0,email:o.email||void 0,address:o.address||void 0,state:o.state,lga:o.lga||void 0,bloodGroup:o.bloodGroup,genotype:o.genotype,weightKg:o.weightKg},We=await B.mutateAsync(pe),ke=(_=We==null?void 0:We.data)==null?void 0:_.patient;ke&&(await ve(ke),y(!1),Se())}catch(pe){z("createNewPatient",pe instanceof Error?pe.message:"Failed to create patient")}finally{O("createNewPatient",!1)}},Pe=()=>{R("")};Zt.useEffect(()=>{f.length>=2&&console.log("Search Query Debug:",{query:f,isLoading:re,error:D,rawResults:S})},[f,re,D,S]);const be=p.useMemo(()=>{var o,v,_,pe;return S&&console.log("Processing search results:",{hasData:!!S.data,hasResults:!!((o=S==null?void 0:S.data)!=null&&o.results),resultsLength:((_=(v=S==null?void 0:S.data)==null?void 0:v.results)==null?void 0:_.length)||0,searchResultsKeys:Object.keys(S||{})}),((pe=S==null?void 0:S.data)==null?void 0:pe.results)||[]},[S]),ne=f.length>=2&&be.length>0,Te=f.length>=2&&be.length===0&&!re;return e.jsx(Ut,{dateAdapter:$t,children:e.jsxs(n,{sx:{p:d(1,2,3)},children:[e.jsxs(n,{sx:{mb:d(2,3,4)},children:[e.jsx(r,{variant:s?"h6":"h5",sx:{fontWeight:600,mb:1},children:"Patient Selection"}),e.jsx(r,{variant:"body2",color:"text.secondary",children:"Search for an existing patient or create a new patient record to begin the MTR process"})]}),($.selectPatient||$.createNewPatient||D)&&e.jsx(ge,{severity:"error",sx:{mb:3},children:$.selectPatient||$.createNewPatient||"Search failed. Please try again."}),t&&e.jsx(Nr,{in:!0,children:e.jsx(se,{sx:{mb:d(2,3,3),bgcolor:"success.50",border:1,borderColor:"success.200",borderRadius:s?2:1},children:e.jsx(ae,{sx:{p:d(2,2,3)},children:e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:2,flexDirection:s?"column":"row",textAlign:s?"center":"left"},children:[e.jsx(Le,{color:"success",sx:{fontSize:s?32:24}}),e.jsxs(n,{sx:{flexGrow:1},children:[e.jsx(r,{variant:s?"subtitle1":"h6",color:"success.main",children:"Selected Patient"}),e.jsxs(r,{variant:s?"body2":"body1",sx:{fontWeight:500},children:[t.firstName," ",t.lastName,t.otherNames&&` ${t.otherNames}`]}),e.jsxs(r,{variant:"body2",color:"text.secondary",children:["MRN: ",t.mrn," • Age:"," ",t.age||"N/A",t.phone&&` • ${t.phone}`]})]}),i&&e.jsx(N,{variant:"contained",color:"success",onClick:async()=>{t&&(g(t),await new Promise(o=>setTimeout(o,100))),i()},sx:{minWidth:s?"100%":120,mt:s?2:0},size:s?"large":"medium",children:"Continue"})]})})})}),e.jsx(se,{sx:{mb:d(2,3,3),borderRadius:s?2:1},children:e.jsxs(ae,{sx:{p:d(2,2,3)},children:[e.jsx(r,{variant:s?"subtitle1":"h6",sx:{mb:d(1,2,2)},children:"Search Patients"}),e.jsxs(n,{sx:{display:"flex",gap:d(1,2,2),mb:d(1,2,2),flexDirection:s?"column":"row"},children:[e.jsx(X,{fullWidth:!0,placeholder:"Search by name, MRN, or phone number...",value:f,onChange:o=>R(o.target.value),size:"medium",InputProps:{startAdornment:e.jsx(xr,{position:"start",children:e.jsx(Rt,{color:"action"})}),endAdornment:f&&e.jsx(xr,{position:"end",children:e.jsx(xe,{size:"small",onClick:Pe,edge:"end",children:e.jsx(Dt,{})})})},sx:{"& .MuiOutlinedInput-root":{borderRadius:s?2:1}}}),e.jsx(N,{variant:"outlined",startIcon:e.jsx(fr,{}),onClick:()=>y(!0),sx:{minWidth:s?"100%":140,borderRadius:s?2:1},size:s?"large":"medium",children:"New Patient"})]}),re&&e.jsx(n,{sx:{display:"flex",justifyContent:"center",py:3},children:e.jsx(ct,{size:24})}),ne&&e.jsx(oe,{variant:"outlined",sx:{maxHeight:s?300:400,overflow:"auto",borderRadius:s?2:1},children:j?e.jsx(n,{sx:{p:1},children:be.map(o=>e.jsx(se,{sx:{mb:1,cursor:"pointer","&:hover":{bgcolor:"action.hover"},borderRadius:2},onClick:()=>ve(o),children:e.jsx(ae,{sx:{p:2,"&:last-child":{pb:2}},children:e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2},children:[e.jsx(Gt,{sx:{bgcolor:"primary.main"},children:e.jsx(mt,{})}),e.jsxs(n,{sx:{flex:1},children:[e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:1,mb:.5},children:[e.jsxs(r,{variant:"subtitle2",sx:{fontWeight:600},children:[o.firstName," ",o.lastName,o.otherNames&&` ${o.otherNames}`]}),o.hasActiveDTP&&e.jsx(K,{label:"Active DTP",size:"small",color:"warning",icon:e.jsx(Je,{})})]}),e.jsxs(r,{variant:"body2",color:"text.secondary",sx:{mb:1},children:["MRN: ",o.mrn," • Age: ",o.age||"N/A",o.gender&&` • ${o.gender.charAt(0).toUpperCase()+o.gender.slice(1)}`]}),o.phone&&e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:.5,mb:.5},children:[e.jsx(It,{sx:{fontSize:16,color:"text.secondary"}}),e.jsx(r,{variant:"caption",color:"text.secondary",children:o.phone})]}),o.email&&e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:.5,mb:.5},children:[e.jsx(er,{sx:{fontSize:16,color:"text.secondary"}}),e.jsx(r,{variant:"caption",color:"text.secondary",children:o.email})]}),o.address&&e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(mr,{sx:{fontSize:16,color:"text.secondary"}}),e.jsx(r,{variant:"caption",color:"text.secondary",children:o.address})]})]})]})})},o._id))}):e.jsx(Xe,{children:be.map((o,v)=>e.jsxs(Zt.Fragment,{children:[e.jsxs(Br,{onClick:()=>ve(o),disabled:Z.selectPatient,children:[e.jsx(Ur,{children:e.jsx(Gt,{children:e.jsx(mt,{})})}),e.jsx(Ie,{primary:e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsxs(r,{variant:"subtitle1",sx:{fontWeight:500},children:[o.firstName," ",o.lastName,o.otherNames&&` ${o.otherNames}`]}),o.hasActiveDTP&&e.jsx(K,{label:"Active DTP",size:"small",color:"warning",icon:e.jsx(Je,{})})]}),secondary:e.jsxs(n,{sx:{mt:.5},children:[e.jsxs(r,{variant:"body2",color:"text.secondary",children:["MRN: ",o.mrn," • Age:"," ",o.age||"N/A",o.gender&&` • ${o.gender.charAt(0).toUpperCase()+o.gender.slice(1)}`]}),o.phone&&e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:.5,mt:.5},children:[e.jsx(It,{sx:{fontSize:14}}),e.jsx(r,{variant:"caption",children:o.phone})]}),o.email&&e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(er,{sx:{fontSize:14}}),e.jsx(r,{variant:"caption",children:o.email})]}),o.address&&e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(mr,{sx:{fontSize:14}}),e.jsx(r,{variant:"caption",children:o.address})]})]})})]}),v<be.length-1&&e.jsx(Ct,{})]},o._id))})}),Te&&e.jsxs(ge,{severity:"info",sx:{mt:2},children:['No patients found matching "',f,'". Try a different search term or create a new patient.']})]})}),M.length>0&&!t&&e.jsx(se,{sx:{borderRadius:s?2:1},children:e.jsxs(ae,{sx:{p:d(2,2,3)},children:[e.jsxs(n,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:d(1,2,2)},children:[e.jsx(r,{variant:s?"subtitle1":"h6",children:"Recent Patients"}),s&&e.jsx(xe,{size:"small",onClick:()=>ee(!w),children:w?e.jsx(ur,{}):e.jsx(Qe,{})})]}),e.jsx(ar,{in:!s||w,children:e.jsx(n,{sx:{display:"flex",flexWrap:"wrap",gap:2},children:M.map(o=>e.jsx(n,{sx:{width:"100%"},children:e.jsxs(oe,{variant:"outlined",sx:{p:d(1.5,2,2),cursor:"pointer","&:hover":{bgcolor:"action.hover"},transition:"all 0.2s",borderRadius:s?2:1,"&:active":s?{transform:"scale(0.98)",bgcolor:"action.selected"}:{}},onClick:()=>ve(o),children:[e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:1,mb:1},children:[e.jsx(Gt,{sx:{width:32,height:32},children:e.jsx(mt,{})}),e.jsxs(r,{variant:"subtitle2",sx:{fontWeight:500},children:[o.firstName," ",o.lastName]})]}),e.jsxs(r,{variant:"caption",color:"text.secondary",children:["MRN: ",o.mrn]}),o.phone&&e.jsx(r,{variant:"caption",color:"text.secondary",sx:{display:"block"},children:o.phone})]})},o._id))})})]})}),e.jsxs(Fe,{open:u,onClose:()=>y(!1),maxWidth:x("xs","sm","md"),fullWidth:!0,fullScreen:s,TransitionComponent:s?$r:void 0,slotProps:{transition:s?{direction:"up"}:void 0},children:[e.jsx(ze,{children:e.jsxs(n,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsx(r,{variant:"h6",children:"Create New Patient"}),e.jsx(xe,{onClick:()=>y(!1),children:e.jsx(Dt,{})})]})}),e.jsxs("form",{onSubmit:ie(Ne),children:[e.jsx(qe,{children:e.jsxs(Oe,{children:[e.jsx(r,{variant:"subtitle1",sx:{fontWeight:600,mt:1},children:"Basic Information"}),e.jsxs(n,{sx:{display:"flex",flexWrap:"wrap",gap:2},children:[e.jsx(n,{sx:{width:"100%"},children:e.jsx(U,{name:"firstName",control:I,rules:{required:"First name is required"},render:({field:o})=>{var v;return e.jsx(X,{...o,fullWidth:!0,label:"First Name",error:!!W.firstName,helperText:(v=W.firstName)==null?void 0:v.message,required:!0})}})}),e.jsx(n,{sx:{width:"100%"},children:e.jsx(U,{name:"lastName",control:I,rules:{required:"Last name is required"},render:({field:o})=>{var v;return e.jsx(X,{...o,fullWidth:!0,label:"Last Name",error:!!W.lastName,helperText:(v=W.lastName)==null?void 0:v.message,required:!0})}})}),e.jsx(n,{sx:{width:"100%"},children:e.jsx(U,{name:"otherNames",control:I,render:({field:o})=>e.jsx(X,{...o,fullWidth:!0,label:"Other Names",helperText:"Middle names or other names (optional)"})})}),e.jsx(n,{sx:{width:"100%"},children:e.jsx(U,{name:"dob",control:I,render:({field:o})=>{var v;return e.jsx(At,{...o,label:"Date of Birth",maxDate:new Date,slotProps:{textField:{fullWidth:!0,error:!!W.dob,helperText:(v=W.dob)==null?void 0:v.message}}})}})}),e.jsx(n,{sx:{width:"100%"},children:e.jsx(U,{name:"age",control:I,rules:{min:{value:0,message:"Age must be positive"},max:{value:150,message:"Age must be realistic"}},render:({field:o})=>{var v;return e.jsx(X,{...o,fullWidth:!0,type:"number",label:"Age (years)",error:!!W.age,helperText:((v=W.age)==null?void 0:v.message)||"Auto-calculated from DOB"})}})}),e.jsx(n,{sx:{width:"100%"},children:e.jsx(U,{name:"gender",control:I,render:({field:o})=>e.jsxs(le,{fullWidth:!0,error:!!W.gender,children:[e.jsx(ce,{children:"Gender"}),e.jsx(de,{...o,label:"Gender",value:o.value||"",children:_s.map(v=>e.jsx(L,{value:v,children:v.charAt(0).toUpperCase()+v.slice(1)},v))}),W.gender&&e.jsx(Ke,{children:W.gender.message})]})})}),e.jsx(n,{sx:{width:"100%"},children:e.jsx(U,{name:"maritalStatus",control:I,render:({field:o})=>e.jsxs(le,{fullWidth:!0,error:!!W.maritalStatus,children:[e.jsx(ce,{children:"Marital Status"}),e.jsx(de,{...o,label:"Marital Status",value:o.value||"",children:Fs.map(v=>e.jsx(L,{value:v,children:v.charAt(0).toUpperCase()+v.slice(1)},v))}),W.maritalStatus&&e.jsx(Ke,{children:W.maritalStatus.message})]})})})]}),e.jsx(r,{variant:"subtitle1",sx:{fontWeight:600,mt:2},children:"Contact Information"}),e.jsxs(n,{sx:{display:"flex",flexWrap:"wrap",gap:2},children:[e.jsx(n,{sx:{width:"100%"},children:e.jsx(U,{name:"phone",control:I,rules:{validate:o=>!o||Me(o)||"Enter valid Nigerian phone (+234XXXXXXXXX)"},render:({field:o})=>{var v;return e.jsx(X,{...o,fullWidth:!0,label:"Phone Number",placeholder:"+234812345678",error:!!W.phone,helperText:((v=W.phone)==null?void 0:v.message)||"Nigerian format: +234XXXXXXXXX"})}})}),e.jsx(n,{sx:{width:"100%"},children:e.jsx(U,{name:"email",control:I,rules:{validate:o=>!o||je(o)||"Enter a valid email address"},render:({field:o})=>{var v;return e.jsx(X,{...o,fullWidth:!0,type:"email",label:"Email Address",error:!!W.email,helperText:(v=W.email)==null?void 0:v.message})}})}),e.jsx(n,{sx:{width:"100%"},children:e.jsx(U,{name:"address",control:I,render:({field:o})=>e.jsx(X,{...o,fullWidth:!0,label:"Address",multiline:!0,rows:2,helperText:"Street address or residential area"})})}),e.jsx(n,{sx:{width:"100%"},children:e.jsx(U,{name:"state",control:I,render:({field:o})=>e.jsx(Ft,{...o,options:Ws,value:o.value||null,onChange:(v,_)=>o.onChange(_),renderInput:v=>{var _;return e.jsx(X,{...v,label:"State",error:!!W.state,helperText:(_=W.state)==null?void 0:_.message})}})})}),e.jsx(n,{sx:{width:"100%"},children:e.jsx(U,{name:"lga",control:I,render:({field:o})=>e.jsx(X,{...o,fullWidth:!0,label:"Local Government Area",helperText:"LGA within the selected state"})})})]}),e.jsx(r,{variant:"subtitle1",sx:{fontWeight:600,mt:2},children:"Medical Information"}),e.jsxs(n,{sx:{display:"flex",flexWrap:"wrap",gap:2},children:[e.jsx(n,{sx:{width:"100%"},children:e.jsx(U,{name:"bloodGroup",control:I,render:({field:o})=>e.jsxs(le,{fullWidth:!0,error:!!W.bloodGroup,children:[e.jsx(ce,{children:"Blood Group"}),e.jsx(de,{...o,label:"Blood Group",value:o.value||"",children:Os.map(v=>e.jsx(L,{value:v,children:v},v))}),W.bloodGroup&&e.jsx(Ke,{children:W.bloodGroup.message})]})})}),e.jsx(n,{sx:{width:"100%"},children:e.jsx(U,{name:"genotype",control:I,render:({field:o})=>e.jsxs(le,{fullWidth:!0,error:!!W.genotype,children:[e.jsx(ce,{children:"Genotype"}),e.jsx(de,{...o,label:"Genotype",value:o.value||"",children:Ls.map(v=>e.jsx(L,{value:v,children:e.jsxs(n,{sx:{display:"flex",alignItems:"center"},children:[v,v.includes("S")&&e.jsx(K,{label:"Sickle Cell",size:"small",color:"warning",sx:{ml:1,fontSize:"0.7rem"}})]})},v))}),W.genotype&&e.jsx(Ke,{children:W.genotype.message})]})})}),e.jsx(n,{sx:{width:"100%"},children:e.jsx(U,{name:"weightKg",control:I,rules:{min:{value:.5,message:"Weight must be positive"},max:{value:500,message:"Weight must be realistic"}},render:({field:o})=>{var v;return e.jsx(X,{...o,fullWidth:!0,type:"number",label:"Weight (kg)",error:!!W.weightKg,helperText:(v=W.weightKg)==null?void 0:v.message,inputProps:{step:.1,min:.5,max:500}})}})})]}),e.jsx(ge,{severity:"info",children:e.jsxs(r,{variant:"body2",children:[e.jsx("strong",{children:"Medical Information:"})," Blood group and genotype are important for emergency situations and medication compatibility. Weight is used for dosage calculations."]})})]})}),e.jsxs(Be,{sx:{p:3},children:[e.jsx(N,{onClick:()=>y(!1),children:"Cancel"}),e.jsx(N,{type:"submit",variant:"contained",disabled:Z.createNewPatient,startIcon:Z.createNewPatient?e.jsx(ct,{size:16}):e.jsx(fr,{}),children:Z.createNewPatient?"Creating...":"Create Patient"})]})]})]})]})})};class zs{async getMedications(t){const i=new URLSearchParams;return t!=null&&t.patientId&&i.append("patientId",t.patientId),t!=null&&t.page&&i.append("page",t.page.toString()),t!=null&&t.limit&&i.append("limit",t.limit.toString()),t!=null&&t.status&&i.append("status",t.status),t!=null&&t.search&&i.append("search",t.search),(await lt.get(`/medications?${i.toString()}`)).data}async getMedication(t){return(await lt.get(`/medications/${t}`)).data}async createMedication(t){return(await lt.post("/medications",t)).data}async updateMedication(t,i){return(await lt.put(`/medications/${t}`,i)).data}async deleteMedication(t){return(await lt.delete(`/medications/${t}`)).data}async getMedicationsByPatient(t){return(await lt.get(`/medications/patient/${t}`)).data}async updateMedicationStatus(t,i){return(await lt.patch(`/medications/${t}/status`,{status:i})).data}}const qs=new zs,Bs=(g,t={})=>{const{threshold:i=50,velocityThreshold:s=.3,timeThreshold:j=300,preventScroll:d=!1}=t,x=p.useRef(null),f=p.useRef(null),R=p.useCallback(M=>{if(M.touches.length===1){const E=M.touches[0];x.current={x:E.clientX,y:E.clientY,timestamp:Date.now()}}},[]),u=p.useCallback(M=>{d&&x.current&&M.preventDefault()},[d]),y=p.useCallback(M=>{if(!x.current||M.changedTouches.length!==1){x.current=null;return}const E=M.changedTouches[0],w={x:E.clientX,y:E.clientY,timestamp:Date.now()},ee=w.x-x.current.x,Z=w.y-x.current.y,$=w.timestamp-x.current.timestamp,O=Math.sqrt(ee*ee+Z*Z),z=O/$;if(O>=i&&z>=s&&$<=j){let J=null;Math.abs(ee)>Math.abs(Z)?J=ee>0?"right":"left":J=Z>0?"down":"up",g({direction:J,distance:O,velocity:z,duration:$})}x.current=null},[g,i,s,j]);return p.useEffect(()=>{const M=f.current;if(M)return M.addEventListener("touchstart",R,{passive:!1}),M.addEventListener("touchmove",u,{passive:!1}),M.addEventListener("touchend",y,{passive:!1}),()=>{M.removeEventListener("touchstart",R),M.removeEventListener("touchmove",u),M.removeEventListener("touchend",y)}},[R,u,y]),f},Us=(g,t={})=>{const{delay:i=500,moveThreshold:s=10}=t,j=p.useRef(null),d=p.useRef(null),x=p.useRef(null),f=p.useCallback(y=>{const M="touches"in y?y.touches[0]:y;d.current={x:M.clientX,y:M.clientY},j.current=setTimeout(()=>{g()},i)},[g,i]),R=p.useCallback(y=>{if(!d.current||!j.current)return;const M="touches"in y?y.touches[0]:y;Math.sqrt(Math.pow(M.clientX-d.current.x,2)+Math.pow(M.clientY-d.current.y,2))>s&&(clearTimeout(j.current),j.current=null)},[s]),u=p.useCallback(()=>{j.current&&(clearTimeout(j.current),j.current=null),d.current=null},[]);return p.useEffect(()=>{const y=x.current;if(y)return y.addEventListener("touchstart",f,{passive:!1}),y.addEventListener("touchmove",R,{passive:!1}),y.addEventListener("touchend",u,{passive:!1}),y.addEventListener("touchcancel",u,{passive:!1}),y.addEventListener("mousedown",f),y.addEventListener("mousemove",R),y.addEventListener("mouseup",u),y.addEventListener("mouseleave",u),()=>{y.removeEventListener("touchstart",f),y.removeEventListener("touchmove",R),y.removeEventListener("touchend",u),y.removeEventListener("touchcancel",u),y.removeEventListener("mousedown",f),y.removeEventListener("mousemove",R),y.removeEventListener("mouseup",u),y.removeEventListener("mouseleave",u)}},[f,R,u]),x};class $s{constructor(){this.dbName="ClinicalInterventionsDB",this.dbVersion=1,this.db=null,this.initDB()}async initDB(){return new Promise((t,i)=>{const s=indexedDB.open(this.dbName,this.dbVersion);s.onerror=()=>{console.error("Failed to open IndexedDB:",s.error),i(s.error)},s.onsuccess=()=>{this.db=s.result,console.log("IndexedDB initialized successfully"),t()},s.onupgradeneeded=j=>{const d=j.target.result;d.objectStoreNames.contains("offlineInterventions")||d.createObjectStore("offlineInterventions",{keyPath:"id"}),d.objectStoreNames.contains("offlineCache")||d.createObjectStore("offlineCache",{keyPath:"key"}),d.objectStoreNames.contains("formDrafts")||d.createObjectStore("formDrafts",{keyPath:"id"}),console.log("IndexedDB object stores created")}})}async ensureDB(){return this.db||await this.initDB(),this.db}async storeOfflineIntervention(t,i,s="create"){const j=await this.ensureDB(),d=`offline_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,x={id:d,data:t,authToken:i,timestamp:Date.now(),type:s};return new Promise((f,R)=>{const M=j.transaction(["offlineInterventions"],"readwrite").objectStore("offlineInterventions").add(x);M.onsuccess=()=>{console.log("Offline intervention stored:",d),f(d)},M.onerror=()=>{console.error("Failed to store offline intervention:",M.error),R(M.error)}})}async getOfflineInterventions(){const t=await this.ensureDB();return new Promise((i,s)=>{const x=t.transaction(["offlineInterventions"],"readonly").objectStore("offlineInterventions").getAll();x.onsuccess=()=>i(x.result),x.onerror=()=>s(x.error)})}async removeOfflineIntervention(t){const i=await this.ensureDB();return new Promise((s,j)=>{const f=i.transaction(["offlineInterventions"],"readwrite").objectStore("offlineInterventions").delete(t);f.onsuccess=()=>{console.log("Offline intervention removed:",t),s()},f.onerror=()=>j(f.error)})}async cacheData(t,i){const s=await this.ensureDB(),j={key:t,data:i,timestamp:Date.now()};return new Promise((d,x)=>{const u=s.transaction(["offlineCache"],"readwrite").objectStore("offlineCache").put(j);u.onsuccess=()=>{console.log("Data cached:",t),d()},u.onerror=()=>x(u.error)})}async getCachedData(t,i=24*60*60*1e3){const s=await this.ensureDB();return new Promise((j,d)=>{const R=s.transaction(["offlineCache"],"readonly").objectStore("offlineCache").get(t);R.onsuccess=()=>{const u=R.result;if(!u){j(null);return}if(Date.now()-u.timestamp>i){console.log("Cached data expired:",t),j(null);return}j(u.data)},R.onerror=()=>d(R.error)})}async saveFormDraft(t,i){const s=await this.ensureDB(),j={id:t,data:i,timestamp:Date.now()};return new Promise((d,x)=>{const u=s.transaction(["formDrafts"],"readwrite").objectStore("formDrafts").put(j);u.onsuccess=()=>{console.log("Form draft saved:",t),d()},u.onerror=()=>x(u.error)})}async getFormDraft(t){const i=await this.ensureDB();return new Promise((s,j)=>{const f=i.transaction(["formDrafts"],"readonly").objectStore("formDrafts").get(t);f.onsuccess=()=>{const R=f.result;s(R?R.data:null)},f.onerror=()=>j(f.error)})}async removeFormDraft(t){const i=await this.ensureDB();return new Promise((s,j)=>{const f=i.transaction(["formDrafts"],"readwrite").objectStore("formDrafts").delete(t);f.onsuccess=()=>{console.log("Form draft removed:",t),s()},f.onerror=()=>j(f.error)})}async clearAllData(){const t=await this.ensureDB(),i=["offlineInterventions","offlineCache","formDrafts"];return new Promise((s,j)=>{const d=t.transaction(i,"readwrite");let x=0;const f=i.length;i.forEach(R=>{const y=d.objectStore(R).clear();y.onsuccess=()=>{x++,x===f&&(console.log("All offline data cleared"),s())},y.onerror=()=>j(y.error)})})}async getStorageStats(){const t=await this.ensureDB(),i={offlineInterventions:0,formDrafts:0,cacheEntries:0};return new Promise((s,j)=>{const d=t.transaction(["offlineInterventions","formDrafts","offlineCache"],"readonly");let x=0;const f=3,u=d.objectStore("offlineInterventions").count();u.onsuccess=()=>{i.offlineInterventions=u.result,x++,x===f&&s(i)};const M=d.objectStore("formDrafts").count();M.onsuccess=()=>{i.formDrafts=M.result,x++,x===f&&s(i)};const w=d.objectStore("offlineCache").count();w.onsuccess=()=>{i.cacheEntries=w.result,x++,x===f&&s(i)},d.onerror=()=>j(d.error)})}async getSyncQueue(){return new Promise((t,i)=>{if(!this.db){console.warn("Database not initialized, returning empty sync queue"),t([]);return}try{const s=this.db.transaction(["offlineInterventions"],"readonly"),d=s.objectStore("offlineInterventions").getAll();d.onsuccess=()=>t(d.result||[]),d.onerror=()=>{console.error("Error getting sync queue:",d.error),i(d.error)},s.onerror=()=>{console.error("Transaction error getting sync queue:",s.error),i(s.error)}}catch(s){console.error("Error in getSyncQueue method:",s),t([])}})}async removeSyncQueueItem(t){return new Promise((i,s)=>{if(!this.db){s(new Error("Database not initialized"));return}try{const j=this.db.transaction(["offlineInterventions"],"readwrite"),x=j.objectStore("offlineInterventions").delete(t);x.onsuccess=()=>i(),x.onerror=()=>s(x.error),j.onerror=()=>s(j.error)}catch(j){console.error("Error removing item from sync queue:",j),s(j)}})}}const Re=new $s,Gs=(g,t)=>{let i;return s=>{clearTimeout(i),i=setTimeout(()=>g(s),t)}},Hs=[{value:"prescribed",label:"Prescribed Medications",color:"primary"},{value:"otc",label:"Over-the-Counter",color:"secondary"},{value:"herbal",label:"Herbal/Traditional",color:"success"},{value:"supplement",label:"Supplements/Vitamins",color:"info"}],Vs=["Tablet","Capsule","Syrup","Suspension","Injection","Cream","Ointment","Drops","Inhaler","Patch","Suppository","Powder","Solution","Gel","Lotion"],Qs=["mg","g","mcg","ml","IU","%","units","mmol","mEq"],Xs=["Oral","Topical","Intravenous","Intramuscular","Subcutaneous","Inhalation","Rectal","Vaginal","Ophthalmic","Otic","Nasal","Sublingual","Buccal"],Ks=["Once daily","Twice daily","Three times daily","Four times daily","Every 4 hours","Every 6 hours","Every 8 hours","Every 12 hours","As needed","Weekly","Monthly","Other"],Ys=[{name:"Paracetamol",genericName:"Acetaminophen",commonStrengths:["500mg","1000mg"]},{name:"Ibuprofen",genericName:"Ibuprofen",commonStrengths:["200mg","400mg","600mg"]},{name:"Amoxicillin",genericName:"Amoxicillin",commonStrengths:["250mg","500mg","875mg"]},{name:"Metformin",genericName:"Metformin",commonStrengths:["500mg","850mg","1000mg"]},{name:"Lisinopril",genericName:"Lisinopril",commonStrengths:["5mg","10mg","20mg"]},{name:"Amlodipine",genericName:"Amlodipine",commonStrengths:["2.5mg","5mg","10mg"]},{name:"Omeprazole",genericName:"Omeprazole",commonStrengths:["20mg","40mg"]},{name:"Atorvastatin",genericName:"Atorvastatin",commonStrengths:["10mg","20mg","40mg","80mg"]}],Js=({children:g,value:t,index:i,...s})=>e.jsx("div",{role:"tabpanel",hidden:t!==i,id:`medication-tabpanel-${i}`,"aria-labelledby":`medication-tab-${i}`,...s,children:t===i&&e.jsx(n,{sx:{py:3},children:g})}),Zs=({patientId:g,onMedicationsUpdate:t,onNext:i})=>{const{isMobile:s,getSpacing:j}=Bt(),[d,x]=p.useState(0),[f,R]=p.useState(!1),[u,y]=p.useState(null),[M,E]=p.useState(""),[w,ee]=p.useState([]),[Z,$]=p.useState([]),[O,z]=p.useState(!1),[J,V]=p.useState(!1),[S,re]=p.useState(new Set),[D,B]=p.useState(!1),[I,ie]=p.useState(null),{medications:te,addMedication:fe,updateMedication:W,removeMedication:Se,importMedications:l,validateMedications:Q,loading:ue,errors:me,setLoading:Me,setError:je,selectedPatient:ve}=Ee(),Ne=p.useMemo(()=>({drugName:"",genericName:"",strength:{value:0,unit:"mg"},dosageForm:"",instructions:{dose:"",frequency:"",route:"Oral",duration:""},category:"prescribed",prescriber:{name:"",license:"",contact:""},startDate:new Date,endDate:void 0,indication:"",adherenceScore:0,notes:""}),[]),Pe=p.useMemo(()=>Ys,[]),be=p.useMemo(()=>Hs,[]),{control:ne,handleSubmit:Te,watch:o,setValue:v,formState:{errors:_},reset:pe}=dt({mode:"onChange",defaultValues:Ne}),We=o("category"),ke=p.useMemo(()=>Gs(c=>{if(c.length>=2){const C=Pe.filter(A=>A.name.toLowerCase().includes(c.toLowerCase())||A.genericName.toLowerCase().includes(c.toLowerCase()));ee(C),V(C.length===0&&c.length>=2)}else ee([]),V(!1)},300),[Pe]);p.useEffect(()=>{ke(M)},[M,ke]);const m=p.useMemo(()=>te,[te]);p.useEffect(()=>{t(m)},[m,t]),p.useEffect(()=>{(()=>{const C=[],A=new Set;te.forEach((Y,st)=>{const nt=Y.drugName.toLowerCase().trim();A.has(nt)?C.push(`Duplicate medication detected: ${Y.drugName}`):A.add(nt);const yt={paracetamol:"analgesic",acetaminophen:"analgesic",ibuprofen:"nsaid",diclofenac:"nsaid",metformin:"antidiabetic",glibenclamide:"antidiabetic"},T=yt[nt];T&&te.forEach((F,H)=>{if(st!==H){const ye=yt[F.drugName.toLowerCase().trim()];T===ye&&C.push(`Potential therapeutic duplication: ${Y.drugName} and ${F.drugName}`)}})}),$([...new Set(C)])})()},[te]);const h=(c,C)=>{x(C)},a=c=>{pe(),c&&v("category",c),y(null),z(!1),V(!1),E(""),R(!0)},b=c=>{y(c),v("drugName",c.drugName),v("genericName",c.genericName||""),v("strength",c.strength),v("dosageForm",c.dosageForm),v("instructions",c.instructions),v("category",c.category),v("prescriber",c.prescriber||{name:"",license:"",contact:""}),v("startDate",new Date(c.startDate)),c.endDate&&v("endDate",new Date(c.endDate)),v("indication",c.indication),v("adherenceScore",c.adherenceScore),v("notes",c.notes||""),z(c.isManual||!1),E(c.drugName),V(!1),R(!0)},G=c=>{window.confirm("Are you sure you want to delete this medication?")&&Se(c)},we=p.useCallback(async c=>{try{Me("saveMedication",!0),je("saveMedication",null);const C={id:(u==null?void 0:u.id)||void 0,drugName:c.drugName,genericName:c.genericName,strength:c.strength,dosageForm:c.dosageForm,category:c.category,indication:c.indication,startDate:c.startDate,endDate:c.endDate,adherenceScore:c.adherenceScore,notes:c.notes,isManual:O,instructions:{dose:c.instructions.dose,frequency:c.instructions.frequency,route:c.instructions.route,duration:c.instructions.duration||""},prescriber:c.prescriber?{name:c.prescriber.name,license:c.prescriber.license||"",contact:c.prescriber.contact||""}:void 0};u?W(u.id,C):fe(C),navigator.onLine===!1&&(await Re.saveMedication(C),await Re.autoSaveDraft("medication",C,g)),R(!1),pe(),y(null),z(!1),V(!1),E("")}catch(C){je("saveMedication",C instanceof Error?C.message:"Failed to save medication")}finally{Me("saveMedication",!1)}},[u,fe,W,g,Me,je,pe]),Ue=async()=>{try{B(!0),je("importMedications",null),await l(g);const c=await qs.getMedicationsByPatient(g);c.success&&c.data&&c.data.forEach(C=>{const A={drugName:C.name,genericName:C.name,strength:{value:parseFloat(C.dosage)||0,unit:"mg"},dosageForm:"Tablet",instructions:{dose:C.dosage,frequency:C.frequency,route:C.route,duration:C.duration},category:"prescribed",prescriber:{name:C.prescribedBy},startDate:new Date(C.startDate),endDate:C.endDate?new Date(C.endDate):void 0,indication:C.instructions,notes:`Imported from existing records. Status: ${C.status}`};fe(A)})}catch(c){je("importMedications",c instanceof Error?c.message:"Failed to import medications")}finally{B(!1)}},gt=c=>{v("drugName",c.name),v("genericName",c.genericName),E(c.name),z(!1),V(!1)},ft=()=>{z(!0),V(!1),ee([]),v("drugName",M),v("genericName","")},k=()=>{z(!1),E(""),v("drugName",""),v("genericName","")},q=c=>{const C=new Set(S);C.has(c)?C.delete(c):C.add(c),re(C)},he=c=>te.filter(C=>C.category===c),Ae=()=>Q(),Ze=()=>te.length>0&&Ae().length===0;return Bs(c=>{if(c.direction==="left"&&I)window.confirm("Delete this medication?")&&G(I),ie(null);else if(c.direction==="right"&&I){const C=te.find(A=>A.id===I);C&&b(C),ie(null)}},{threshold:100,preventScroll:!1}),Us(()=>{I&&q(I)},{delay:500}),e.jsx(Ut,{dateAdapter:$t,children:e.jsxs(n,{sx:{p:j(1,2,3)},children:[e.jsxs(n,{sx:{mb:j(2,3,4)},children:[e.jsx(r,{variant:s?"h6":"h5",sx:{fontWeight:600,mb:1},children:"Medication History Collection"}),e.jsx(r,{variant:"body2",color:"text.secondary",children:"Document all medications including prescribed, over-the-counter, herbal, and supplements"})]}),ve&&e.jsx(se,{sx:{mb:j(2,3,3),bgcolor:"info.50",border:1,borderColor:"info.200",borderRadius:s?2:1},children:e.jsxs(ae,{sx:{p:j(2,2,3)},children:[e.jsxs(r,{variant:s?"subtitle1":"h6",color:"info.main",sx:{mb:1},children:["Patient: ",ve.firstName," ",ve.lastName]}),e.jsxs(r,{variant:"body2",color:"text.secondary",children:["ID: ",ve._id]})]})}),(me.saveMedication||me.importMedications)&&e.jsx(ge,{severity:"error",sx:{mb:3},children:me.saveMedication||me.importMedications}),Z.length>0&&e.jsxs(ge,{severity:"warning",sx:{mb:3},children:[e.jsx(r,{variant:"subtitle2",sx:{mb:1},children:"Potential Issues Detected:"}),Z.map((c,C)=>e.jsxs(r,{variant:"body2",children:["• ",c]},C))]}),Ae().length>0&&e.jsxs(ge,{severity:"error",sx:{mb:3},children:[e.jsx(r,{variant:"subtitle2",sx:{mb:1},children:"Please fix the following issues:"}),Ae().map((c,C)=>e.jsxs(r,{variant:"body2",children:["• ",c]},C))]}),e.jsxs(n,{sx:{mb:j(2,3,3),display:"flex",gap:j(1,2,2),flexWrap:"wrap",flexDirection:s?"column":"row"},children:[e.jsx(N,{variant:"contained",startIcon:e.jsx(_e,{}),onClick:()=>a(),size:s?"large":"medium",fullWidth:s,children:"Add Medication"}),e.jsx(N,{variant:"outlined",startIcon:D?e.jsx(ct,{size:16}):e.jsx(ks,{}),onClick:Ue,disabled:D,size:s?"large":"medium",fullWidth:s,children:"Import from Records"}),i&&e.jsx(N,{variant:"contained",color:"success",onClick:i,disabled:!Ze(),sx:{ml:s?0:"auto",mt:s?1:0},size:s?"large":"medium",fullWidth:s,children:"Continue to Assessment"})]}),e.jsxs(se,{sx:{borderRadius:s?2:1},children:[e.jsx(n,{sx:{borderBottom:1,borderColor:"divider"},children:e.jsx(qt,{value:d,onChange:h,"aria-label":"medication categories",variant:s?"scrollable":"standard",scrollButtons:s?"auto":!1,allowScrollButtonsMobile:s,children:be.map((c,C)=>e.jsx($e,{label:e.jsx(Mt,{badgeContent:he(c.value).length,color:c.color,showZero:!0,children:e.jsx(r,{variant:s?"caption":"body2",sx:{textTransform:"none",fontSize:s?"0.75rem":"0.875rem"},children:s?c.label.split("/")[0]:c.label})}),id:`medication-tab-${C}`,"aria-controls":`medication-tabpanel-${C}`,sx:{minWidth:s?80:120,fontSize:s?"0.75rem":"0.875rem"}},c.value))})}),be.map((c,C)=>e.jsxs(Js,{value:d,index:C,children:[e.jsxs(n,{sx:{mb:2,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx(r,{variant:"h6",children:c.label}),e.jsxs(N,{variant:"outlined",size:"small",startIcon:e.jsx(_e,{}),onClick:()=>a(c.value),children:["Add ",c.label.split("/")[0]]})]}),he(c.value).length===0?e.jsxs(oe,{variant:"outlined",sx:{p:4,textAlign:"center",bgcolor:"grey.50"},children:[e.jsx(Gr,{sx:{fontSize:48,color:"grey.400",mb:2}}),e.jsxs(r,{variant:"h6",color:"text.secondary",sx:{mb:1},children:["No ",c.label," Added"]}),e.jsxs(r,{variant:"body2",color:"text.secondary",sx:{mb:2},children:['Click "Add ',c.label.split("/")[0],'" to document medications in this category']}),e.jsxs(N,{variant:"contained",startIcon:e.jsx(_e,{}),onClick:()=>a(c.value),children:["Add ",c.label.split("/")[0]]})]}):e.jsx(Xe,{children:he(c.value).map(A=>{var Y;return e.jsxs(Zt.Fragment,{children:[e.jsxs(De,{sx:{bgcolor:"background.paper",border:1,borderColor:"divider",borderRadius:1,mb:1},children:[e.jsxs(n,{sx:{flex:1},children:[e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:1,mb:1},children:[e.jsx(r,{variant:"subtitle1",sx:{fontWeight:600},children:A.drugName}),e.jsx(K,{label:A.isManual?"Manual":"Database",size:"small",color:A.isManual?"secondary":"success",variant:"outlined",icon:A.isManual?e.jsx(Ge,{}):e.jsx(Le,{})}),A.genericName&&A.genericName!==A.drugName&&e.jsx(K,{label:A.genericName,size:"small",variant:"outlined"}),e.jsx(K,{label:`${A.strength.value}${A.strength.unit}`,size:"small",color:"primary"})]}),e.jsxs(r,{variant:"body2",color:"text.secondary",children:[A.instructions.dose," •"," ",A.instructions.frequency," •"," ",A.instructions.route]}),e.jsxs(r,{variant:"body2",color:"text.secondary",children:["Indication: ",A.indication]}),((Y=A.prescriber)==null?void 0:Y.name)&&e.jsxs(r,{variant:"body2",color:"text.secondary",children:["Prescribed by: ",A.prescriber.name]})]}),e.jsx(Hr,{children:e.jsxs(n,{sx:{display:"flex",gap:1},children:[e.jsx(tt,{title:"View Details",children:e.jsx(xe,{size:"small",onClick:()=>q(A.id),children:S.has(A.id)?e.jsx(ur,{}):e.jsx(Qe,{})})}),e.jsx(tt,{title:"Edit",children:e.jsx(xe,{size:"small",onClick:()=>b(A),children:e.jsx(Ge,{})})}),e.jsx(tt,{title:"Delete",children:e.jsx(xe,{size:"small",color:"error",onClick:()=>G(A.id),children:e.jsx(xt,{})})})]})})]}),e.jsx(ar,{in:S.has(A.id),children:e.jsx(oe,{variant:"outlined",sx:{p:2,mb:1,ml:2,bgcolor:"grey.50"},children:e.jsxs(P,{container:!0,spacing:2,children:[e.jsxs(P,{item:!0,xs:12,sm:6,children:[e.jsx(r,{variant:"caption",color:"text.secondary",children:"Dosage Form"}),e.jsx(r,{variant:"body2",children:A.dosageForm})]}),e.jsxs(P,{item:!0,xs:12,sm:6,children:[e.jsx(r,{variant:"caption",color:"text.secondary",children:"Duration"}),e.jsx(r,{variant:"body2",children:A.instructions.duration||"Not specified"})]}),e.jsxs(P,{item:!0,xs:12,sm:6,children:[e.jsx(r,{variant:"caption",color:"text.secondary",children:"Start Date"}),e.jsx(r,{variant:"body2",children:new Date(A.startDate).toLocaleDateString()})]}),A.endDate&&e.jsxs(P,{item:!0,xs:12,sm:6,children:[e.jsx(r,{variant:"caption",color:"text.secondary",children:"End Date"}),e.jsx(r,{variant:"body2",children:new Date(A.endDate).toLocaleDateString()})]}),A.adherenceScore!==void 0&&e.jsxs(P,{item:!0,xs:12,sm:6,children:[e.jsx(r,{variant:"caption",color:"text.secondary",children:"Adherence Score"}),e.jsxs(r,{variant:"body2",children:[A.adherenceScore,"%"]})]}),A.notes&&e.jsxs(P,{item:!0,xs:12,children:[e.jsx(r,{variant:"caption",color:"text.secondary",children:"Notes"}),e.jsx(r,{variant:"body2",children:A.notes})]})]})})})]},A.id)})})]},c.value))]}),te.length>0&&e.jsx(se,{sx:{mt:3},children:e.jsxs(ae,{children:[e.jsx(r,{variant:"h6",sx:{mb:2},children:"Medication Summary"}),e.jsx(P,{container:!0,spacing:2,children:be.map(c=>e.jsx(P,{item:!0,xs:6,sm:3,children:e.jsxs(oe,{variant:"outlined",sx:{p:2,textAlign:"center"},children:[e.jsx(r,{variant:"h4",color:`${c.color}.main`,children:he(c.value).length}),e.jsx(r,{variant:"caption",color:"text.secondary",children:c.label})]})},c.value))}),e.jsxs(n,{sx:{mt:2,display:"flex",alignItems:"center",gap:1},children:[e.jsxs(r,{variant:"body2",color:"text.secondary",children:["Total Medications: ",te.length]}),Ze()?e.jsx(Le,{color:"success",fontSize:"small"}):e.jsx(Je,{color:"warning",fontSize:"small"})]})]})}),e.jsxs(Fe,{open:f,onClose:()=>R(!1),maxWidth:"md",fullWidth:!0,children:[e.jsx(ze,{children:e.jsxs(n,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsx(r,{variant:"h6",children:u?"Edit Medication":"Add New Medication"}),e.jsx(xe,{onClick:()=>R(!1),children:e.jsx(Dt,{})})]})}),e.jsxs(n,{component:"form",onSubmit:Te(we),children:[e.jsx(qe,{children:e.jsxs(Oe,{spacing:3,children:[e.jsx(r,{variant:"subtitle1",sx:{fontWeight:600,mt:1},children:"Drug Information"}),e.jsxs(P,{container:!0,spacing:2,children:[e.jsxs(P,{item:!0,xs:12,children:[e.jsxs(n,{sx:{mb:2,display:"flex",alignItems:"center",gap:1},children:[e.jsx(K,{label:O?"Manual Entry":"Database Search",color:O?"secondary":"primary",size:"small",icon:O?e.jsx(Ge,{}):e.jsx(Rt,{})}),O&&e.jsx(N,{size:"small",variant:"outlined",onClick:k,startIcon:e.jsx(Rt,{}),children:"Back to Search"})]}),e.jsx(U,{name:"drugName",control:ne,rules:{required:"Drug name is required"},render:({field:c})=>{var C;return e.jsx(e.Fragment,{children:O?e.jsx(X,{...c,fullWidth:!0,label:"Drug Name *",placeholder:"Enter drug name manually...",error:!!_.drugName,helperText:((C=_.drugName)==null?void 0:C.message)||"Manually entered - not from database",required:!0,InputProps:{startAdornment:e.jsx(Ge,{sx:{mr:1,color:"text.secondary"}})}}):e.jsxs(n,{children:[e.jsx(Ft,{options:w,getOptionLabel:A=>typeof A=="string"?A:A.name,value:w.find(A=>A.name===c.value)||null,renderOption:(A,Y)=>{const{key:st,...nt}=A;return e.jsx(n,{component:"li",...nt,children:e.jsxs(n,{children:[e.jsx(r,{variant:"body2",sx:{fontWeight:500},children:Y.name}),e.jsxs(r,{variant:"caption",color:"text.secondary",children:["Generic: ",Y.genericName]})]})},st)},onInputChange:(A,Y)=>{E(Y),c.onChange(Y)},onChange:(A,Y)=>{Y&&typeof Y!="string"&&gt(Y)},renderInput:A=>{var Y;return e.jsx(X,{...A,label:"Drug Name *",placeholder:"Search for medication...",error:!!_.drugName,helperText:((Y=_.drugName)==null?void 0:Y.message)||"Start typing to search our drug database",required:!0,InputProps:{...A.InputProps,startAdornment:e.jsx(Rt,{sx:{mr:1,color:"text.secondary"}})}})}}),J&&e.jsx(n,{sx:{mt:2},children:e.jsx(ge,{severity:"info",action:e.jsx(N,{color:"inherit",size:"small",onClick:ft,startIcon:e.jsx(_e,{}),children:"Add Manually"}),children:"Drug not found in database? You can add it manually."})})]})})}})]}),e.jsx(P,{item:!0,xs:12,sm:6,children:e.jsx(U,{name:"genericName",control:ne,rules:O?{required:"Generic name is recommended for manual entries"}:{},render:({field:c})=>{var C;return e.jsx(X,{...c,fullWidth:!0,label:O?"Generic Name *":"Generic Name",placeholder:O?"Enter generic/active ingredient name":"Generic or active ingredient name",helperText:((C=_.genericName)==null?void 0:C.message)||(O?"Required for manual entries - helps with drug interaction checking":"Generic or active ingredient name"),error:!!_.genericName,required:O})}})}),e.jsx(P,{item:!0,xs:12,sm:6,children:e.jsx(U,{name:"category",control:ne,rules:{required:"Category is required"},render:({field:c})=>e.jsxs(le,{fullWidth:!0,error:!!_.category,children:[e.jsx(ce,{children:"Category"}),e.jsx(de,{...c,label:"Category",children:be.map(C=>e.jsx(L,{value:C.value,children:C.label},C.value))}),_.category&&e.jsx(Ke,{children:_.category.message})]})})}),e.jsx(P,{item:!0,xs:12,sm:4,children:e.jsx(U,{name:"strength.value",control:ne,rules:{required:"Strength is required",min:{value:.001,message:"Strength must be greater than 0"}},render:({field:c})=>{var C,A,Y;return e.jsx(X,{...c,fullWidth:!0,type:"number",label:"Strength",error:!!((C=_.strength)!=null&&C.value),helperText:(Y=(A=_.strength)==null?void 0:A.value)==null?void 0:Y.message,required:!0,inputProps:{step:.001,min:0}})}})}),e.jsx(P,{item:!0,xs:12,sm:4,children:e.jsx(U,{name:"strength.unit",control:ne,rules:{required:"Unit is required"},render:({field:c})=>{var C,A;return e.jsxs(le,{fullWidth:!0,error:!!((C=_.strength)!=null&&C.unit),children:[e.jsx(ce,{children:"Unit"}),e.jsx(de,{...c,label:"Unit",children:Qs.map(Y=>e.jsx(L,{value:Y,children:Y},Y))}),((A=_.strength)==null?void 0:A.unit)&&e.jsx(Ke,{children:_.strength.unit.message})]})}})}),e.jsx(P,{item:!0,xs:12,sm:4,children:e.jsx(U,{name:"dosageForm",control:ne,rules:{required:"Dosage form is required"},render:({field:c})=>e.jsxs(le,{fullWidth:!0,error:!!_.dosageForm,children:[e.jsx(ce,{children:"Dosage Form *"}),e.jsx(de,{...c,label:"Dosage Form *",children:Vs.map(C=>e.jsx(L,{value:C,children:C},C))}),_.dosageForm&&e.jsx(Ke,{children:_.dosageForm.message}),O&&!_.dosageForm&&e.jsx(Ke,{children:"Required for manual entries - select the physical form of the medication"})]})})})]}),e.jsx(r,{variant:"subtitle1",sx:{fontWeight:600,mt:2},children:"Instructions"}),e.jsxs(P,{container:!0,spacing:2,children:[e.jsx(P,{item:!0,xs:12,sm:6,children:e.jsx(U,{name:"instructions.dose",control:ne,rules:{required:"Dose is required"},render:({field:c})=>{var C,A,Y;return e.jsx(X,{...c,fullWidth:!0,label:"Dose",placeholder:"e.g., 1 tablet, 5ml",error:!!((C=_.instructions)!=null&&C.dose),helperText:(Y=(A=_.instructions)==null?void 0:A.dose)==null?void 0:Y.message,required:!0})}})}),e.jsx(P,{item:!0,xs:12,sm:6,children:e.jsx(U,{name:"instructions.frequency",control:ne,rules:{required:"Frequency is required"},render:({field:c})=>{var C,A;return e.jsxs(le,{fullWidth:!0,error:!!((C=_.instructions)!=null&&C.frequency),children:[e.jsx(ce,{children:"Frequency"}),e.jsx(de,{...c,label:"Frequency",children:Ks.map(Y=>e.jsx(L,{value:Y,children:Y},Y))}),((A=_.instructions)==null?void 0:A.frequency)&&e.jsx(Ke,{children:_.instructions.frequency.message})]})}})}),e.jsx(P,{item:!0,xs:12,sm:6,children:e.jsx(U,{name:"instructions.route",control:ne,rules:{required:"Route is required"},render:({field:c})=>{var C,A;return e.jsxs(le,{fullWidth:!0,error:!!((C=_.instructions)!=null&&C.route),children:[e.jsx(ce,{children:"Route"}),e.jsx(de,{...c,label:"Route",children:Xs.map(Y=>e.jsx(L,{value:Y,children:Y},Y))}),((A=_.instructions)==null?void 0:A.route)&&e.jsx(Ke,{children:_.instructions.route.message})]})}})}),e.jsx(P,{item:!0,xs:12,sm:6,children:e.jsx(U,{name:"instructions.duration",control:ne,render:({field:c})=>e.jsx(X,{...c,fullWidth:!0,label:"Duration",placeholder:"e.g., 7 days, 3 months, ongoing",helperText:"How long to take the medication"})})})]}),e.jsx(r,{variant:"subtitle1",sx:{fontWeight:600,mt:2},children:"Clinical Information"}),e.jsxs(P,{container:!0,spacing:2,children:[e.jsx(P,{item:!0,xs:12,children:e.jsx(U,{name:"indication",control:ne,rules:{required:"Indication is required"},render:({field:c})=>{var C;return e.jsx(X,{...c,fullWidth:!0,label:"Indication",placeholder:"What condition is this medication treating?",error:!!_.indication,helperText:(C=_.indication)==null?void 0:C.message,required:!0})}})}),e.jsx(P,{item:!0,xs:12,sm:6,children:e.jsx(U,{name:"startDate",control:ne,rules:{required:"Start date is required"},render:({field:{onChange:c,value:C,...A}})=>{var Y;return e.jsx(At,{...A,value:C||null,onChange:st=>c(st),label:"Start Date",maxDate:new Date,slotProps:{textField:{fullWidth:!0,error:!!_.startDate,helperText:(Y=_.startDate)==null?void 0:Y.message,required:!0}}})}})}),e.jsx(P,{item:!0,xs:12,sm:6,children:e.jsx(U,{name:"endDate",control:ne,render:({field:{onChange:c,value:C,...A}})=>e.jsx(At,{...A,value:C||null,onChange:Y=>c(Y),label:"End Date (Optional)",minDate:o("startDate"),slotProps:{textField:{fullWidth:!0,helperText:"Leave blank if ongoing"}}})})}),e.jsx(P,{item:!0,xs:12,sm:6,children:e.jsx(U,{name:"adherenceScore",control:ne,render:({field:c})=>e.jsx(X,{...c,fullWidth:!0,type:"number",label:"Adherence Score (%)",placeholder:"0-100",helperText:"Patient's adherence to this medication (0-100%)",inputProps:{min:0,max:100}})})})]}),We==="prescribed"&&e.jsxs(e.Fragment,{children:[e.jsx(r,{variant:"subtitle1",sx:{fontWeight:600,mt:2},children:"Prescriber Information"}),e.jsxs(P,{container:!0,spacing:2,children:[e.jsx(P,{item:!0,xs:12,sm:6,children:e.jsx(U,{name:"prescriber.name",control:ne,render:({field:c})=>e.jsx(X,{...c,fullWidth:!0,label:"Prescriber Name",placeholder:"Dr. John Smith"})})}),e.jsx(P,{item:!0,xs:12,sm:6,children:e.jsx(U,{name:"prescriber.license",control:ne,render:({field:c})=>e.jsx(X,{...c,fullWidth:!0,label:"License Number",placeholder:"Medical license number"})})}),e.jsx(P,{item:!0,xs:12,children:e.jsx(U,{name:"prescriber.contact",control:ne,render:({field:c})=>e.jsx(X,{...c,fullWidth:!0,label:"Contact Information",placeholder:"Phone, email, or clinic address"})})})]})]}),e.jsx(r,{variant:"subtitle1",sx:{fontWeight:600,mt:2},children:"Additional Information"}),e.jsx(U,{name:"notes",control:ne,render:({field:c})=>e.jsx(X,{...c,fullWidth:!0,multiline:!0,rows:3,label:"Notes",placeholder:"Any additional notes about this medication...",helperText:"Side effects, patient concerns, special instructions, etc."})})]})}),e.jsxs(Be,{sx:{p:3},children:[e.jsx(N,{onClick:()=>R(!1),children:"Cancel"}),e.jsx(N,{type:"submit",variant:"contained",disabled:ue.saveMedication,startIcon:ue.saveMedication?e.jsx(ct,{size:16}):void 0,children:u?"Update Medication":"Add Medication"})]})]})]})]})})},en=[{value:"indication",label:"Indication",description:"Problems related to drug indication"},{value:"effectiveness",label:"Effectiveness",description:"Problems with therapeutic effectiveness"},{value:"safety",label:"Safety",description:"Safety-related drug problems"},{value:"adherence",label:"Adherence",description:"Patient adherence issues"}],tn={indication:[{value:"unnecessary",label:"Unnecessary Drug Therapy"},{value:"needsAdditional",label:"Needs Additional Drug Therapy"}],effectiveness:[{value:"wrongDrug",label:"Wrong Drug"},{value:"doseTooLow",label:"Dose Too Low"}],safety:[{value:"doseTooHigh",label:"Dose Too High"},{value:"adverseReaction",label:"Adverse Drug Reaction"},{value:"interaction",label:"Drug Interaction"},{value:"duplication",label:"Duplicate Therapy"},{value:"contraindication",label:"Contraindication"}],adherence:[{value:"inappropriateAdherence",label:"Non-adherence"},{value:"monitoring",label:"Monitoring Required"}]},Kt=[{value:"critical",label:"Critical",color:"error",description:"Immediate intervention required"},{value:"major",label:"Major",color:"warning",description:"Significant clinical impact"},{value:"moderate",label:"Moderate",color:"info",description:"Moderate clinical impact"},{value:"minor",label:"Minor",color:"success",description:"Minor clinical impact"}],rn=[{value:"definite",label:"Definite",description:"Clear causal relationship"},{value:"probable",label:"Probable",description:"Likely causal relationship"},{value:"possible",label:"Possible",description:"Possible causal relationship"},{value:"unlikely",label:"Unlikely",description:"Unlikely causal relationship"}],sn=["Cost/Financial constraints","Side effects","Complex dosing regimen","Forgetfulness","Lack of understanding","Cultural/Religious beliefs","Physical limitations","Multiple medications","Lack of perceived benefit","Poor provider communication"],nn=({medications:g,patientInfo:t,onProblemsIdentified:i})=>{const[s,j]=p.useState(0),[d,x]=p.useState([{id:"interactions",title:"Drug Interactions",description:"Check for drug-drug interactions",completed:!1,problems:[]},{id:"duplicates",title:"Duplicate Therapy",description:"Identify duplicate or redundant medications",completed:!1,problems:[]},{id:"contraindications",title:"Contraindications",description:"Check for contraindications and allergies",completed:!1,problems:[]},{id:"dosing",title:"Dosing Assessment",description:"Evaluate dosing appropriateness",completed:!1,problems:[]},{id:"adherence",title:"Adherence Assessment",description:"Assess patient adherence patterns",completed:!1,problems:[]}]),[f,R]=p.useState(!1),[u,y]=p.useState(0),[M,E]=p.useState([]),[w,ee]=p.useState(!1),[Z,$]=p.useState(null),{addProblem:O,updateProblem:z,setLoading:J,setError:V}=Ee(),{control:S,handleSubmit:re,reset:D,watch:B,formState:{errors:I,isSubmitting:ie}}=dt({defaultValues:{category:"safety",severity:"moderate",evidenceLevel:"probable",affectedMedications:[],relatedConditions:[],riskFactors:[]}}),te=B("category");p.useEffect(()=>{const m=g.map(h=>({medicationId:h.drugName,medicationName:h.drugName,adherenceScore:h.adherenceScore||8,barriers:[],notes:""}));E(m)},[g]);const fe=p.useMemo(()=>d.filter(h=>h.completed).length/d.length*100,[d]),W=p.useMemo(()=>d.reduce((m,h)=>[...m,...h.problems],[]),[d]),Se=p.useMemo(()=>{const m={critical:0,major:0,moderate:0,minor:0};return W.forEach(h=>{m[h.severity]++}),m},[W]),l=async()=>{R(!0),y(0);try{J("runAssessment",!0),y(20);const m=await ue();Q("interactions",m),y(40);const h=await me();Q("duplicates",h),y(60);const a=await Me();Q("contraindications",a),y(80);const b=await je();Q("dosing",b),y(100);const G=[...m,...h,...a,...b];i(G)}catch(m){console.error("Assessment failed:",m),V("runAssessment",m instanceof Error?m.message:"Assessment failed")}finally{R(!1),J("runAssessment",!1)}},Q=(m,h)=>{x(a=>a.map(b=>b.id===m?{...b,completed:!0,problems:h}:b))},ue=async()=>{await new Promise(h=>setTimeout(h,1e3));const m=[];for(let h=0;h<g.length;h++)for(let a=h+1;a<g.length;a++){const b=g[h],G=g[a];v(b.drugName,G.drugName)&&m.push({_id:`interaction_${h}_${a}`,workplaceId:"",patientId:(t==null?void 0:t.id)||"",category:"safety",subcategory:"Drug-Drug Interaction",type:"interaction",severity:"moderate",description:`Potential interaction between ${b.drugName} and ${G.drugName}`,clinicalSignificance:"Monitor for increased side effects or reduced efficacy",affectedMedications:[b.drugName,G.drugName],relatedConditions:[],evidenceLevel:"probable",riskFactors:["Multiple medications","Concurrent use"],status:"identified",identifiedBy:"",identifiedAt:new Date().toISOString(),createdBy:"",isDeleted:!1,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()})}return m},me=async()=>{await new Promise(a=>setTimeout(a,800));const m=[],h={};return g.forEach(a=>{const b=_(a.drugName);h[b]||(h[b]=[]),h[b].push(a)}),Object.entries(h).forEach(([a,b])=>{b.length>1&&a!=="other"&&m.push({_id:`duplicate_${a}`,workplaceId:"",patientId:(t==null?void 0:t.id)||"",category:"effectiveness",subcategory:"Duplicate Therapy",type:"duplication",severity:"minor",description:`Multiple medications from the same therapeutic class: ${a}`,clinicalSignificance:"Consider consolidating therapy or adjusting doses",affectedMedications:b.map(G=>G.drugName),relatedConditions:[],evidenceLevel:"definite",riskFactors:["Polypharmacy","Multiple prescribers"],status:"identified",identifiedBy:"",identifiedAt:new Date().toISOString(),createdBy:"",isDeleted:!1,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()})}),m},Me=async()=>{await new Promise(h=>setTimeout(h,600));const m=[];return g.forEach(h=>{var a,b;(a=t==null?void 0:t.allergies)!=null&&a.some(G=>h.drugName.toLowerCase().includes(G.toLowerCase()))&&m.push({_id:`contraindication_allergy_${h.drugName}`,workplaceId:"",patientId:(t==null?void 0:t.id)||"",category:"safety",subcategory:"Allergy Contraindication",type:"contraindication",severity:"critical",description:`Patient has documented allergy to ${h.drugName}`,clinicalSignificance:"Discontinue medication immediately to prevent allergic reaction",affectedMedications:[h.drugName],relatedConditions:(t==null?void 0:t.allergies)||[],evidenceLevel:"definite",riskFactors:["Known allergy","Previous adverse reaction"],status:"identified",identifiedBy:"",identifiedAt:new Date().toISOString(),createdBy:"",isDeleted:!1,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}),(b=t==null?void 0:t.conditions)!=null&&b.some(G=>pe(h.drugName,G))&&m.push({_id:`contraindication_condition_${h.drugName}`,workplaceId:"",patientId:(t==null?void 0:t.id)||"",category:"safety",subcategory:"Disease Contraindication",type:"contraindication",severity:"major",description:`${h.drugName} is contraindicated with patient's condition`,clinicalSignificance:"Consider alternative therapy or close monitoring",affectedMedications:[h.drugName],relatedConditions:(t==null?void 0:t.conditions)||[],evidenceLevel:"probable",riskFactors:["Comorbid conditions"],status:"identified",identifiedBy:"",identifiedAt:new Date().toISOString(),createdBy:"",isDeleted:!1,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()})}),m},je=async()=>{await new Promise(h=>setTimeout(h,700));const m=[];return g.forEach(h=>{const a=parseFloat(h.instructions.dose);isNaN(a)||(We(h.drugName,a)&&m.push({_id:`dosing_high_${h.drugName}`,workplaceId:"",patientId:(t==null?void 0:t.id)||"",category:"safety",subcategory:"High Dose",type:"doseTooHigh",severity:"major",description:`${h.drugName} dose may be too high: ${h.instructions.dose}`,clinicalSignificance:"Monitor for dose-related adverse effects",affectedMedications:[h.drugName],relatedConditions:[],evidenceLevel:"probable",riskFactors:["High dose","Patient age","Renal function"],status:"identified",identifiedBy:"",identifiedAt:new Date().toISOString(),createdBy:"",isDeleted:!1,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}),ke(h.drugName,a)&&m.push({_id:`dosing_low_${h.drugName}`,workplaceId:"",patientId:(t==null?void 0:t.id)||"",category:"effectiveness",subcategory:"Subtherapeutic Dose",type:"doseTooLow",severity:"moderate",description:`${h.drugName} dose may be too low: ${h.instructions.dose}`,clinicalSignificance:"May not achieve therapeutic effect",affectedMedications:[h.drugName],relatedConditions:[],evidenceLevel:"possible",riskFactors:["Low dose","Treatment failure"],status:"identified",identifiedBy:"",identifiedAt:new Date().toISOString(),createdBy:"",isDeleted:!1,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}))}),m},ve=()=>{const m=[];M.forEach(h=>{h.adherenceScore<7&&m.push({_id:`adherence_${h.medicationId}`,workplaceId:"",patientId:(t==null?void 0:t.id)||"",category:"adherence",subcategory:"Poor Adherence",type:"inappropriateAdherence",severity:h.adherenceScore<4?"major":"moderate",description:`Poor adherence to ${h.medicationName} (Score: ${h.adherenceScore}/10)`,clinicalSignificance:"May lead to treatment failure or disease progression",affectedMedications:[h.medicationName],relatedConditions:[],evidenceLevel:"probable",riskFactors:h.barriers,status:"identified",identifiedBy:"",identifiedAt:new Date().toISOString(),createdBy:"",isDeleted:!1,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()})}),Q("adherence",m),i([...W,...m])},Ne=m=>{m?($(m),D({category:m.category,subcategory:m.subcategory||"",type:m.type,severity:m.severity,description:m.description,clinicalSignificance:m.clinicalSignificance,affectedMedications:m.affectedMedications,relatedConditions:m.relatedConditions,evidenceLevel:m.evidenceLevel,riskFactors:m.riskFactors})):($(null),D()),ee(!0)},Pe=()=>{ee(!1),$(null),D()},be=async m=>{try{const h={_id:(Z==null?void 0:Z._id)||`manual_${Date.now()}`,workplaceId:"",patientId:(t==null?void 0:t.id)||"",...m,status:"identified",identifiedBy:"",identifiedAt:new Date().toISOString(),createdBy:"",isDeleted:!1,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};Z?z(Z._id,h):O(h),Pe()}catch(h){console.error("Error saving problem:",h)}},ne=(m,h)=>{E(a=>a.map(b=>b.medicationId===m?{...b,...h}:b))},Te=m=>{const h=Kt.find(a=>a.value===m);return(h==null?void 0:h.color)||"default"},o=m=>{switch(m){case"critical":return e.jsx(St,{color:"error"});case"major":return e.jsx(Je,{color:"warning"});case"moderate":return e.jsx(Je,{color:"info"});case"minor":return e.jsx(Le,{color:"success"});default:return e.jsx(Je,{})}},v=(m,h)=>[["warfarin","aspirin"],["metformin","contrast"],["digoxin","furosemide"]].some(([b,G])=>m.toLowerCase().includes(b)&&h.toLowerCase().includes(G)||m.toLowerCase().includes(G)&&h.toLowerCase().includes(b)),_=m=>{const h={metformin:"antidiabetic",insulin:"antidiabetic",lisinopril:"ace_inhibitor",enalapril:"ace_inhibitor",amlodipine:"calcium_channel_blocker",nifedipine:"calcium_channel_blocker",atorvastatin:"statin",simvastatin:"statin"};for(const[a,b]of Object.entries(h))if(m.toLowerCase().includes(a))return b;return"other"},pe=(m,h)=>{const a={metformin:["kidney disease","renal failure"],nsaid:["kidney disease","heart failure"],"beta-blocker":["asthma","copd"]};for(const[b,G]of Object.entries(a))if(m.toLowerCase().includes(b))return G.some(we=>h.toLowerCase().includes(we));return!1},We=(m,h)=>{const a={metformin:2e3,lisinopril:40,atorvastatin:80};for(const[b,G]of Object.entries(a))if(m.toLowerCase().includes(b))return h>G;return!1},ke=(m,h)=>{const a={metformin:500,lisinopril:2.5,atorvastatin:10};for(const[b,G]of Object.entries(a))if(m.toLowerCase().includes(b))return h<G;return!1};return g.length===0?e.jsx(se,{children:e.jsxs(ae,{sx:{textAlign:"center",py:6},children:[e.jsx(Nt,{sx:{fontSize:48,color:"text.secondary",mb:2}}),e.jsx(r,{variant:"h6",color:"text.secondary",sx:{mb:1},children:"No Medications to Assess"}),e.jsx(r,{variant:"body2",color:"text.secondary",children:"Please add medications in the previous step before running therapy assessment"})]})}):e.jsxs(n,{children:[e.jsxs(n,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsxs(n,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(Nt,{sx:{mr:1,color:"primary.main"}}),e.jsx(r,{variant:"h6",sx:{fontWeight:600},children:"Therapy Assessment"}),e.jsx(K,{label:`${g.length} medications`,size:"small",color:"primary",variant:"outlined",sx:{ml:2}})]}),e.jsxs(Oe,{direction:"row",spacing:2,children:[e.jsx(N,{variant:"outlined",startIcon:e.jsx(_e,{}),onClick:()=>Ne(),children:"Add Problem"}),e.jsx(N,{variant:"contained",startIcon:f?e.jsx(ct,{size:16}):e.jsx(Wr,{}),onClick:l,disabled:f,children:f?"Running Assessment...":"Run Assessment"})]})]}),f&&e.jsx(se,{sx:{mb:3},children:e.jsxs(ae,{children:[e.jsx(r,{variant:"subtitle2",sx:{mb:2},children:"Assessment Progress"}),e.jsx(rt,{variant:"determinate",value:u,sx:{height:8,borderRadius:4}}),e.jsxs(r,{variant:"body2",color:"text.secondary",sx:{mt:1},children:[u,"% complete"]})]})}),e.jsxs(P,{container:!0,spacing:3,sx:{mb:3},children:[e.jsx(P,{item:!0,xs:12,md:8,children:e.jsx(se,{children:e.jsxs(ae,{children:[e.jsx(r,{variant:"subtitle1",sx:{mb:2,fontWeight:600},children:"Assessment Overview"}),e.jsx(rt,{variant:"determinate",value:fe,sx:{height:8,borderRadius:4,mb:2}}),e.jsxs(r,{variant:"body2",color:"text.secondary",children:[d.filter(m=>m.completed).length," of"," ",d.length," assessments completed"]})]})})}),e.jsx(P,{item:!0,xs:12,md:4,children:e.jsx(se,{children:e.jsxs(ae,{children:[e.jsx(r,{variant:"subtitle1",sx:{mb:2,fontWeight:600},children:"Problems Identified"}),e.jsx(Oe,{spacing:1,children:Kt.map(m=>e.jsxs(n,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs(n,{sx:{display:"flex",alignItems:"center"},children:[o(m.value),e.jsx(r,{variant:"body2",sx:{ml:1},children:m.label})]}),e.jsx(K,{label:Se[m.value],size:"small",color:Te(m.value),variant:"outlined"})]},m.value))})]})})})]}),e.jsx(or,{activeStep:s,orientation:"vertical",children:d.map((m,h)=>e.jsxs(lr,{completed:m.completed,children:[e.jsx(cr,{optional:m.problems.length>0&&e.jsxs(r,{variant:"caption",color:"error",children:[m.problems.length," problem(s) found"]}),children:m.title}),e.jsxs(hr,{children:[e.jsx(r,{variant:"body2",color:"text.secondary",sx:{mb:2},children:m.description}),m.id==="adherence"&&e.jsx(se,{sx:{mb:2},children:e.jsxs(ae,{children:[e.jsx(r,{variant:"subtitle2",sx:{mb:2},children:"Adherence Assessment"}),e.jsx(Oe,{spacing:2,children:M.map(a=>e.jsxs(n,{children:[e.jsx(r,{variant:"body2",sx:{fontWeight:600,mb:1},children:a.medicationName}),e.jsxs(P,{container:!0,spacing:2,children:[e.jsxs(P,{item:!0,xs:12,sm:4,children:[e.jsx(r,{variant:"caption",color:"text.secondary",children:"Adherence Score (0-10)"}),e.jsx(Vr,{value:Number(a.adherenceScore)||0,max:10,onChange:(b,G)=>ne(a.medicationId,{adherenceScore:G||0})})]}),e.jsx(P,{item:!0,xs:12,sm:8,children:e.jsxs(le,{fullWidth:!0,size:"small",children:[e.jsx(ce,{children:"Adherence Barriers"}),e.jsx(de,{multiple:!0,value:a.barriers,onChange:b=>ne(a.medicationId,{barriers:b.target.value}),renderValue:b=>e.jsx(n,{sx:{display:"flex",flexWrap:"wrap",gap:.5},children:b.map(G=>e.jsx(K,{label:G,size:"small"},G))}),children:sn.map(b=>e.jsxs(L,{value:b,children:[e.jsx(Wt,{checked:a.barriers.includes(b)}),b]},b))})]})})]}),e.jsx(X,{fullWidth:!0,size:"small",placeholder:"Additional notes...",value:a.notes,onChange:b=>ne(a.medicationId,{notes:b.target.value}),sx:{mt:1}})]},a.medicationId))})]})}),m.problems.length>0&&e.jsx(vr,{component:oe,sx:{mb:2},children:e.jsxs(br,{size:"small",children:[e.jsx(wr,{children:e.jsxs(Tt,{children:[e.jsx(Ce,{children:"Problem"}),e.jsx(Ce,{children:"Severity"}),e.jsx(Ce,{children:"Affected Medications"}),e.jsx(Ce,{align:"right",children:"Actions"})]})}),e.jsx(Sr,{children:m.problems.map(a=>e.jsxs(Tt,{children:[e.jsxs(Ce,{children:[e.jsx(r,{variant:"body2",sx:{fontWeight:600},children:a.description}),e.jsx(r,{variant:"caption",color:"text.secondary",children:a.clinicalSignificance})]}),e.jsx(Ce,{children:e.jsx(K,{label:a.severity,size:"small",color:Te(a.severity),icon:o(a.severity)})}),e.jsx(Ce,{children:e.jsx(n,{sx:{display:"flex",flexWrap:"wrap",gap:.5},children:a.affectedMedications.map(b=>e.jsx(K,{label:b,size:"small",variant:"outlined"},b))})}),e.jsx(Ce,{align:"right",children:e.jsx(tt,{title:"Edit Problem",children:e.jsx(xe,{size:"small",onClick:()=>Ne(a),children:e.jsx(Ge,{fontSize:"small"})})})})]},a._id))})]})}),e.jsxs(n,{sx:{mb:1},children:[e.jsx(N,{variant:"contained",onClick:()=>{m.id==="adherence"&&ve(),j(a=>a+1)},sx:{mt:1,mr:1},disabled:m.id==="adherence"&&M.some(a=>a.adherenceScore===0),children:h===d.length-1?"Complete Assessment":"Continue"}),e.jsx(N,{disabled:h===0,onClick:()=>j(a=>a-1),sx:{mt:1,mr:1},children:"Back"})]})]})]},m.id))}),W.length>0&&e.jsx(se,{sx:{mt:3},children:e.jsxs(ae,{children:[e.jsxs(r,{variant:"h6",sx:{mb:2,fontWeight:600},children:["All Identified Problems (",W.length,")"]}),e.jsx(vr,{children:e.jsxs(br,{children:[e.jsx(wr,{children:e.jsxs(Tt,{children:[e.jsx(Ce,{children:"Category"}),e.jsx(Ce,{children:"Problem"}),e.jsx(Ce,{children:"Severity"}),e.jsx(Ce,{children:"Evidence"}),e.jsx(Ce,{children:"Affected Medications"}),e.jsx(Ce,{align:"right",children:"Actions"})]})}),e.jsx(Sr,{children:W.map(m=>e.jsxs(Tt,{children:[e.jsx(Ce,{children:e.jsx(K,{label:m.category,size:"small",variant:"outlined"})}),e.jsxs(Ce,{children:[e.jsx(r,{variant:"body2",sx:{fontWeight:600},children:m.description}),e.jsx(r,{variant:"caption",color:"text.secondary",children:m.clinicalSignificance})]}),e.jsx(Ce,{children:e.jsx(K,{label:m.severity,size:"small",color:Te(m.severity),icon:o(m.severity)})}),e.jsx(Ce,{children:e.jsx(r,{variant:"body2",children:m.evidenceLevel})}),e.jsx(Ce,{children:e.jsx(n,{sx:{display:"flex",flexWrap:"wrap",gap:.5},children:m.affectedMedications.map(h=>e.jsx(K,{label:h,size:"small",variant:"outlined"},h))})}),e.jsx(Ce,{align:"right",children:e.jsx(tt,{title:"Edit Problem",children:e.jsx(xe,{size:"small",onClick:()=>Ne(m),children:e.jsx(Ge,{fontSize:"small"})})})})]},m._id))})]})})]})}),e.jsxs(Fe,{open:w,onClose:Pe,maxWidth:"md",fullWidth:!0,children:[e.jsxs(ze,{children:[e.jsxs(n,{sx:{display:"flex",alignItems:"center",pr:6},children:[e.jsx(Qr,{sx:{mr:1}}),Z?"Edit Drug Therapy Problem":"Add New Problem"]}),e.jsx(xe,{onClick:Pe,sx:{position:"absolute",right:8,top:8},children:e.jsx(Dt,{})})]}),e.jsx(qe,{dividers:!0,children:e.jsx("form",{onSubmit:re(be),children:e.jsxs(P,{container:!0,spacing:3,children:[e.jsx(P,{item:!0,xs:12,sm:6,children:e.jsx(U,{name:"category",control:S,rules:{required:"Category is required"},render:({field:m})=>e.jsxs(le,{fullWidth:!0,error:!!I.category,children:[e.jsx(ce,{children:"Category"}),e.jsx(de,{...m,label:"Category",children:en.map(h=>e.jsx(L,{value:h.value,children:e.jsxs(n,{children:[e.jsx(r,{variant:"body2",sx:{fontWeight:600},children:h.label}),e.jsx(r,{variant:"caption",color:"text.secondary",children:h.description})]})},h.value))})]})})}),e.jsx(P,{item:!0,xs:12,sm:6,children:e.jsx(U,{name:"type",control:S,rules:{required:"Type is required"},render:({field:m})=>{var h;return e.jsxs(le,{fullWidth:!0,error:!!I.type,children:[e.jsx(ce,{children:"Problem Type"}),e.jsx(de,{...m,label:"Problem Type",children:te&&((h=tn[te])==null?void 0:h.map(a=>e.jsx(L,{value:a.value,children:a.label},a.value)))})]})}})}),e.jsx(P,{item:!0,xs:12,sm:6,children:e.jsx(U,{name:"severity",control:S,rules:{required:"Severity is required"},render:({field:m})=>e.jsxs(le,{fullWidth:!0,error:!!I.severity,children:[e.jsx(ce,{children:"Severity"}),e.jsx(de,{...m,label:"Severity",children:Kt.map(h=>e.jsx(L,{value:h.value,children:e.jsxs(n,{sx:{display:"flex",alignItems:"center"},children:[o(h.value),e.jsxs(n,{sx:{ml:1},children:[e.jsx(r,{variant:"body2",sx:{fontWeight:600},children:h.label}),e.jsx(r,{variant:"caption",color:"text.secondary",children:h.description})]})]})},h.value))})]})})}),e.jsx(P,{item:!0,xs:12,sm:6,children:e.jsx(U,{name:"evidenceLevel",control:S,rules:{required:"Evidence level is required"},render:({field:m})=>e.jsxs(le,{fullWidth:!0,error:!!I.evidenceLevel,children:[e.jsx(ce,{children:"Evidence Level"}),e.jsx(de,{...m,label:"Evidence Level",children:rn.map(h=>e.jsx(L,{value:h.value,children:e.jsxs(n,{children:[e.jsx(r,{variant:"body2",sx:{fontWeight:600},children:h.label}),e.jsx(r,{variant:"caption",color:"text.secondary",children:h.description})]})},h.value))})]})})}),e.jsx(P,{item:!0,xs:12,children:e.jsx(U,{name:"description",control:S,rules:{required:"Description is required",minLength:{value:10,message:"Description must be at least 10 characters"}},render:({field:m})=>{var h;return e.jsx(X,{...m,label:"Problem Description",multiline:!0,rows:3,fullWidth:!0,error:!!I.description,helperText:(h=I.description)==null?void 0:h.message})}})}),e.jsx(P,{item:!0,xs:12,children:e.jsx(U,{name:"clinicalSignificance",control:S,rules:{required:"Clinical significance is required",minLength:{value:10,message:"Clinical significance must be at least 10 characters"}},render:({field:m})=>{var h;return e.jsx(X,{...m,label:"Clinical Significance",multiline:!0,rows:2,fullWidth:!0,error:!!I.clinicalSignificance,helperText:(h=I.clinicalSignificance)==null?void 0:h.message})}})}),e.jsx(P,{item:!0,xs:12,children:e.jsx(U,{name:"affectedMedications",control:S,rules:{required:"At least one affected medication is required",validate:m=>m.length>0||"At least one medication must be selected"},render:({field:m})=>e.jsxs(le,{fullWidth:!0,error:!!I.affectedMedications,children:[e.jsx(ce,{children:"Affected Medications"}),e.jsx(de,{...m,multiple:!0,label:"Affected Medications",renderValue:h=>e.jsx(n,{sx:{display:"flex",flexWrap:"wrap",gap:.5},children:h.map(a=>e.jsx(K,{label:a,size:"small"},a))}),children:g.map(h=>e.jsxs(L,{value:h.drugName,children:[e.jsx(Wt,{checked:m.value.includes(h.drugName)}),h.drugName]},h.drugName))}),I.affectedMedications&&e.jsx(r,{variant:"caption",color:"error",sx:{mt:.5,ml:1.5},children:I.affectedMedications.message})]})})})]})})}),e.jsxs(Be,{sx:{p:3},children:[e.jsx(N,{onClick:Pe,disabled:ie,children:"Cancel"}),e.jsx(N,{onClick:re(be),variant:"contained",disabled:ie,sx:{minWidth:120},children:ie?"Saving...":Z?"Update Problem":"Add Problem"})]})]})]})},kt=({children:g,value:t,index:i,...s})=>e.jsx("div",{role:"tabpanel",hidden:t!==i,id:`plan-tabpanel-${i}`,"aria-labelledby":`plan-tab-${i}`,...s,children:t===i&&e.jsx(n,{sx:{p:3},children:g})}),ir=[{value:"discontinue",label:"Discontinue Medication",description:"Stop the medication completely",icon:e.jsx(St,{}),color:"error"},{value:"adjust_dose",label:"Adjust Dose",description:"Modify the current dosage",icon:e.jsx(Ge,{}),color:"warning"},{value:"switch_therapy",label:"Switch Therapy",description:"Change to alternative medication",icon:e.jsx(Ts,{}),color:"info"},{value:"add_therapy",label:"Add Therapy",description:"Add new medication to regimen",icon:e.jsx(_e,{}),color:"success"},{value:"monitor",label:"Monitor",description:"Continue with enhanced monitoring",icon:e.jsx(Or,{}),color:"primary"}],Fr=[{value:"high",label:"High Priority",color:"error"},{value:"medium",label:"Medium Priority",color:"warning"},{value:"low",label:"Low Priority",color:"success"}],an=["Blood Pressure","Heart Rate","Blood Glucose","HbA1c","Lipid Panel","Liver Function Tests","Kidney Function (Creatinine)","Electrolytes","Complete Blood Count","INR/PT","Drug Levels","Symptom Assessment","Adherence Check","Side Effects Monitoring","Quality of Life"],on=["Daily","Weekly","Bi-weekly","Monthly","Every 3 months","Every 6 months","Annually","As needed","Before next visit"],ln=["Medication administration instructions","Side effects to watch for","Drug-food interactions","Importance of adherence","Storage instructions","When to contact healthcare provider","Lifestyle modifications","Disease state education","Monitoring requirements","Follow-up schedule"],cn={discontinue:["Discontinue due to lack of indication","Discontinue due to adverse effects","Discontinue due to drug interaction","Discontinue due to contraindication"],adjust_dose:["Reduce dose due to side effects","Increase dose for better efficacy","Adjust dose based on kidney function","Adjust dose based on age"],switch_therapy:["Switch to more effective alternative","Switch to safer alternative","Switch to more cost-effective option","Switch due to patient preference"],add_therapy:["Add therapy for untreated condition","Add therapy for better disease control","Add therapy for drug interaction prevention","Add therapy for side effect management"],monitor:["Continue with enhanced monitoring","Monitor for therapeutic response","Monitor for adverse effects","Monitor drug levels"]},dn=({problems:g,onPlanCreated:t,onPlanUpdated:i,existingPlan:s})=>{const[j,d]=p.useState(0),[x,f]=p.useState(!1),[R,u]=p.useState(!1),[y,M]=p.useState(!1),[E,w]=p.useState(null),[ee,Z]=p.useState(null),[$,O]=p.useState(null),[z,J]=p.useState(null),{createPlan:V,updatePlan:S,loading:re}=Ee(),{control:D,handleSubmit:B,watch:I,setValue:ie,getValues:te,formState:{isDirty:fe}}=dt({defaultValues:{problems:(s==null?void 0:s.problems)||[],recommendations:(s==null?void 0:s.recommendations)||[],monitoringPlan:(s==null?void 0:s.monitoringPlan)||[],counselingPoints:(s==null?void 0:s.counselingPoints)||[],goals:(s==null?void 0:s.goals)||[],timeline:(s==null?void 0:s.timeline)||"",pharmacistNotes:(s==null?void 0:s.pharmacistNotes)||""}}),{fields:W,append:Se,remove:l,update:Q}=Ht({control:D,name:"recommendations"}),{fields:ue,append:me,remove:Me,update:je}=Ht({control:D,name:"monitoringPlan"}),{fields:ve,append:Ne,remove:Pe,update:be}=Ht({control:D,name:"goals"}),ne=I("problems"),Te=I("recommendations"),o=I("monitoringPlan"),v=I("goals"),_=p.useMemo(()=>({critical:g.filter(q=>q.severity==="critical"),major:g.filter(q=>q.severity==="major"),moderate:g.filter(q=>q.severity==="moderate"),minor:g.filter(q=>q.severity==="minor")}),[g]),pe=p.useMemo(()=>{let q=0;return ne.length>0&&q++,Te.length>0&&q++,o.length>0&&q++,te("counselingPoints").length>0&&q++,v.length>0&&q++,te("pharmacistNotes").trim()&&q++,q/6*100},[ne,Te,o,v,te]),We=(k,q)=>{d(q)},ke=async k=>{try{const q={...k};J(null),s?(await S(q),i==null||i(q)):(await V(q),t(q))}catch(q){console.error("Error saving plan:",q),J(q instanceof Error?q.message:"Failed to save plan")}},m=k=>{w(k||null),f(!0)},h=k=>{if(E){const q=W.findIndex(he=>he.id===E.type+E.medication);q>=0&&Q(q,k)}else Se(k);f(!1),w(null)},a=k=>{Z(k||null),u(!0)},b=k=>{if(ee){const q=ue.findIndex(he=>he.parameter===ee.parameter);q>=0&&je(q,k)}else me(k);u(!1),Z(null)},G=k=>{O(k||null),M(!0)},we=k=>{if($){const q=ve.findIndex(he=>he.description===$.description);q>=0&&be(q,k)}else Ne(k);M(!1),O(null)},Ue=k=>{const q=te("counselingPoints");q.includes(k)||ie("counselingPoints",[...q,k],{shouldDirty:!0})},gt=k=>{const q=te("counselingPoints");ie("counselingPoints",q.filter((he,Ae)=>Ae!==k),{shouldDirty:!0})},ft=k=>{switch(k){case"critical":return e.jsx(St,{});case"major":return e.jsx(Je,{});case"moderate":return e.jsx(pt,{});case"minor":return e.jsx(Le,{});default:return e.jsx(pt,{})}};return g.length===0?e.jsx(se,{children:e.jsxs(ae,{sx:{textAlign:"center",py:6},children:[e.jsx(Ot,{sx:{fontSize:48,color:"text.secondary",mb:2}}),e.jsx(r,{variant:"h6",color:"text.secondary",sx:{mb:1},children:"No Problems Identified"}),e.jsx(r,{variant:"body2",color:"text.secondary",children:"Please complete the therapy assessment step to identify problems before developing a plan"})]})}):e.jsx(Ut,{dateAdapter:$t,children:e.jsxs(n,{children:[e.jsxs(n,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsxs(n,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(Ot,{sx:{mr:1,color:"primary.main"}}),e.jsx(r,{variant:"h6",sx:{fontWeight:600},children:"Plan Development"}),e.jsx(K,{label:`${g.length} problems`,size:"small",color:"primary",variant:"outlined",sx:{ml:2}})]}),e.jsxs(Oe,{direction:"row",spacing:2,children:[e.jsxs(r,{variant:"body2",color:"text.secondary",children:["Plan Completeness: ",Math.round(pe),"%"]}),e.jsx(N,{variant:"contained",startIcon:re.savePlan?e.jsx(ct,{size:16}):e.jsx(rr,{}),onClick:B(ke),disabled:re.savePlan||!fe,children:s?"Update Plan":"Save Plan"})]})]}),z&&e.jsx(ge,{severity:"error",sx:{mb:3},children:z}),e.jsxs(se,{children:[e.jsx(n,{sx:{borderBottom:1,borderColor:"divider"},children:e.jsxs(qt,{value:j,onChange:We,"aria-label":"plan development tabs",children:[e.jsx($e,{label:"Problems & Recommendations"}),e.jsx($e,{label:"Monitoring Plan"}),e.jsx($e,{label:"Goals & Counseling"}),e.jsx($e,{label:"Summary & Notes"})]})}),e.jsx(kt,{value:j,index:0,children:e.jsxs(P,{container:!0,spacing:3,children:[e.jsxs(P,{item:!0,xs:12,md:6,children:[e.jsxs(r,{variant:"h6",sx:{mb:2,display:"flex",alignItems:"center"},children:[e.jsx(pr,{sx:{mr:1}}),"Identified Problems"]}),e.jsx(U,{name:"problems",control:D,render:({field:k})=>e.jsx(Oe,{spacing:2,children:Object.entries(_).map(([q,he])=>he.length>0&&e.jsxs(n,{children:[e.jsxs(r,{variant:"subtitle2",sx:{mb:1,textTransform:"capitalize"},children:[q," Problems (",he.length,")"]}),he.map(Ae=>e.jsx(Lt,{control:e.jsx(Wt,{checked:k.value.includes(Ae._id),onChange:Ze=>{Ze.target.checked?k.onChange([...k.value,Ae._id]):k.onChange(k.value.filter(c=>c!==Ae._id))}}),label:e.jsxs(n,{sx:{display:"flex",alignItems:"center"},children:[ft(Ae.severity),e.jsxs(n,{sx:{ml:1},children:[e.jsx(r,{variant:"body2",sx:{fontWeight:500},children:Ae.description}),e.jsx(r,{variant:"caption",color:"text.secondary",children:Ae.clinicalSignificance})]})]})},Ae._id))]},q))})})]}),e.jsxs(P,{item:!0,xs:12,md:6,children:[e.jsxs(n,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsxs(r,{variant:"h6",sx:{display:"flex",alignItems:"center"},children:[e.jsx(Rr,{sx:{mr:1}}),"Recommendations"]}),e.jsx(N,{variant:"outlined",size:"small",startIcon:e.jsx(_e,{}),onClick:()=>m(),children:"Add Recommendation"})]}),e.jsxs(Oe,{spacing:2,children:[W.map((k,q)=>{var he,Ae,Ze;return e.jsx(se,{variant:"outlined",children:e.jsxs(ae,{sx:{p:2},children:[e.jsxs(n,{sx:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",mb:1},children:[e.jsxs(n,{sx:{display:"flex",alignItems:"center"},children:[(he=ir.find(c=>c.value===k.type))==null?void 0:he.icon,e.jsx(r,{variant:"subtitle2",sx:{ml:1,fontWeight:600},children:(Ae=ir.find(c=>c.value===k.type))==null?void 0:Ae.label}),e.jsx(K,{label:k.priority,size:"small",color:((Ze=Fr.find(c=>c.value===k.priority))==null?void 0:Ze.color)||"default",sx:{ml:1}})]}),e.jsxs(Oe,{direction:"row",spacing:1,children:[e.jsx(xe,{size:"small",onClick:()=>m(k),children:e.jsx(Ge,{})}),e.jsx(xe,{size:"small",onClick:()=>l(q),children:e.jsx(xt,{})})]})]}),k.medication&&e.jsxs(r,{variant:"body2",color:"primary",sx:{mb:1},children:["Medication: ",k.medication]}),e.jsx(r,{variant:"body2",sx:{mb:1},children:k.rationale}),e.jsxs(r,{variant:"caption",color:"text.secondary",children:["Expected Outcome: ",k.expectedOutcome]})]})},k.id)}),W.length===0&&e.jsx(oe,{sx:{p:3,textAlign:"center",bgcolor:"grey.50"},children:e.jsx(r,{variant:"body2",color:"text.secondary",children:'No recommendations added yet. Click "Add Recommendation" to get started.'})})]})]})]})}),e.jsxs(kt,{value:j,index:1,children:[e.jsxs(n,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsxs(r,{variant:"h6",sx:{display:"flex",alignItems:"center"},children:[e.jsx(Or,{sx:{mr:1}}),"Monitoring Parameters"]}),e.jsx(N,{variant:"outlined",startIcon:e.jsx(_e,{}),onClick:()=>a(),children:"Add Parameter"})]}),e.jsxs(P,{container:!0,spacing:2,children:[ue.map((k,q)=>e.jsx(P,{item:!0,xs:12,md:6,children:e.jsx(se,{variant:"outlined",children:e.jsxs(ae,{children:[e.jsxs(n,{sx:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",mb:2},children:[e.jsx(r,{variant:"subtitle1",sx:{fontWeight:600},children:k.parameter}),e.jsxs(Oe,{direction:"row",spacing:1,children:[e.jsx(xe,{size:"small",onClick:()=>a(k),children:e.jsx(Ge,{})}),e.jsx(xe,{size:"small",onClick:()=>Me(q),children:e.jsx(xt,{})})]})]}),e.jsxs(r,{variant:"body2",color:"text.secondary",sx:{mb:1},children:["Frequency: ",k.frequency]}),k.targetValue&&e.jsxs(r,{variant:"body2",color:"text.secondary",sx:{mb:1},children:["Target: ",k.targetValue]}),k.notes&&e.jsx(r,{variant:"body2",children:k.notes})]})})},k.id)),ue.length===0&&e.jsx(P,{item:!0,xs:12,children:e.jsx(oe,{sx:{p:3,textAlign:"center",bgcolor:"grey.50"},children:e.jsx(r,{variant:"body2",color:"text.secondary",children:"No monitoring parameters defined. Add parameters to track therapy effectiveness and safety."})})})]})]}),e.jsx(kt,{value:j,index:2,children:e.jsxs(P,{container:!0,spacing:3,children:[e.jsxs(P,{item:!0,xs:12,md:6,children:[e.jsxs(n,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsxs(r,{variant:"h6",sx:{display:"flex",alignItems:"center"},children:[e.jsx(pr,{sx:{mr:1}}),"Therapy Goals"]}),e.jsx(N,{variant:"outlined",size:"small",startIcon:e.jsx(_e,{}),onClick:()=>G(),children:"Add Goal"})]}),e.jsxs(Oe,{spacing:2,children:[ve.map((k,q)=>e.jsx(se,{variant:"outlined",children:e.jsxs(ae,{sx:{p:2},children:[e.jsxs(n,{sx:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",mb:1},children:[e.jsx(r,{variant:"subtitle2",sx:{fontWeight:600,flex:1},children:k.description}),e.jsxs(Oe,{direction:"row",spacing:1,children:[e.jsx(xe,{size:"small",onClick:()=>G(k),children:e.jsx(Ge,{})}),e.jsx(xe,{size:"small",onClick:()=>Pe(q),children:e.jsx(xt,{})})]})]}),k.targetDate&&e.jsxs(r,{variant:"body2",color:"text.secondary",sx:{mb:1},children:["Target Date:"," ",new Date(k.targetDate).toLocaleDateString()]}),e.jsx(K,{label:k.achieved?"Achieved":"In Progress",size:"small",color:k.achieved?"success":"default",variant:k.achieved?"filled":"outlined"})]})},k.id)),ve.length===0&&e.jsx(oe,{sx:{p:3,textAlign:"center",bgcolor:"grey.50"},children:e.jsx(r,{variant:"body2",color:"text.secondary",children:"No therapy goals set. Define measurable goals to track treatment success."})})]})]}),e.jsxs(P,{item:!0,xs:12,md:6,children:[e.jsxs(r,{variant:"h6",sx:{mb:2,display:"flex",alignItems:"center"},children:[e.jsx(Xr,{sx:{mr:1}}),"Patient Counseling Points"]}),e.jsxs(n,{sx:{mb:2},children:[e.jsx(r,{variant:"subtitle2",sx:{mb:1},children:"Quick Add Templates:"}),e.jsx(n,{sx:{display:"flex",flexWrap:"wrap",gap:1},children:ln.map(k=>e.jsx(K,{label:k,size:"small",variant:"outlined",onClick:()=>Ue(k),sx:{cursor:"pointer"}},k))})]}),e.jsx(U,{name:"counselingPoints",control:D,render:({field:k})=>e.jsxs(Oe,{spacing:1,children:[k.value.map((q,he)=>e.jsxs(n,{sx:{display:"flex",alignItems:"center",p:1,border:1,borderColor:"divider",borderRadius:1},children:[e.jsx(r,{variant:"body2",sx:{flex:1},children:q}),e.jsx(xe,{size:"small",onClick:()=>gt(he),children:e.jsx(xt,{})})]},he)),e.jsx(X,{placeholder:"Add custom counseling point...",size:"small",onKeyPress:q=>{if(q.key==="Enter"){const he=q.target;he.value.trim()&&(Ue(he.value.trim()),he.value="")}}})]})})]})]})}),e.jsx(kt,{value:j,index:3,children:e.jsxs(P,{container:!0,spacing:3,children:[e.jsxs(P,{item:!0,xs:12,md:8,children:[e.jsx(r,{variant:"h6",sx:{mb:2},children:"Pharmacist Notes"}),e.jsx(U,{name:"pharmacistNotes",control:D,render:({field:k})=>e.jsx(X,{...k,multiline:!0,rows:8,fullWidth:!0,placeholder:"Enter detailed pharmacist notes, clinical reasoning, and additional considerations...",variant:"outlined"})}),e.jsxs(n,{sx:{mt:3},children:[e.jsx(r,{variant:"h6",sx:{mb:2},children:"Implementation Timeline"}),e.jsx(U,{name:"timeline",control:D,render:({field:k})=>e.jsx(X,{...k,multiline:!0,rows:4,fullWidth:!0,placeholder:"Describe the timeline for implementing recommendations...",variant:"outlined"})})]})]}),e.jsxs(P,{item:!0,xs:12,md:4,children:[e.jsx(r,{variant:"h6",sx:{mb:2},children:"Plan Summary"}),e.jsxs(Oe,{spacing:2,children:[e.jsx(se,{variant:"outlined",children:e.jsxs(ae,{children:[e.jsx(r,{variant:"subtitle2",sx:{mb:1},children:"Problems Addressed"}),e.jsx(r,{variant:"h4",color:"primary",children:ne.length}),e.jsxs(r,{variant:"caption",color:"text.secondary",children:["of ",g.length," identified"]})]})}),e.jsx(se,{variant:"outlined",children:e.jsxs(ae,{children:[e.jsx(r,{variant:"subtitle2",sx:{mb:1},children:"Recommendations"}),e.jsx(r,{variant:"h4",color:"primary",children:Te.length}),e.jsx(r,{variant:"caption",color:"text.secondary",children:"therapeutic interventions"})]})}),e.jsx(se,{variant:"outlined",children:e.jsxs(ae,{children:[e.jsx(r,{variant:"subtitle2",sx:{mb:1},children:"Monitoring Parameters"}),e.jsx(r,{variant:"h4",color:"primary",children:o.length}),e.jsx(r,{variant:"caption",color:"text.secondary",children:"safety & efficacy checks"})]})}),e.jsx(se,{variant:"outlined",children:e.jsxs(ae,{children:[e.jsx(r,{variant:"subtitle2",sx:{mb:1},children:"Therapy Goals"}),e.jsx(r,{variant:"h4",color:"primary",children:v.length}),e.jsx(r,{variant:"caption",color:"text.secondary",children:"measurable outcomes"})]})})]})]})]})})]}),e.jsx(un,{open:x,onClose:()=>f(!1),onSave:h,recommendation:E}),e.jsx(hn,{open:R,onClose:()=>u(!1),onSave:b,monitoring:ee}),e.jsx(xn,{open:y,onClose:()=>M(!1),onSave:we,goal:$})]})})},un=({open:g,onClose:t,onSave:i,recommendation:s})=>{var M;const{control:j,handleSubmit:d,reset:x,watch:f,formState:{errors:R}}=dt({defaultValues:s||{type:"monitor",priority:"medium",medication:"",rationale:"",expectedOutcome:""}}),u=f("type");p.useEffect(()=>{x(s||{type:"monitor",priority:"medium",medication:"",rationale:"",expectedOutcome:""})},[s,x]);const y=E=>{i(E),t()};return e.jsxs(Fe,{open:g,onClose:t,maxWidth:"md",fullWidth:!0,children:[e.jsx(ze,{children:s?"Edit Recommendation":"Add Recommendation"}),e.jsx(qe,{children:e.jsxs(P,{container:!0,spacing:2,sx:{mt:1},children:[e.jsx(P,{item:!0,xs:12,md:6,children:e.jsx(U,{name:"type",control:j,rules:{required:"Recommendation type is required"},render:({field:E})=>e.jsxs(le,{fullWidth:!0,error:!!R.type,children:[e.jsx(ce,{children:"Recommendation Type"}),e.jsx(de,{...E,label:"Recommendation Type",children:ir.map(w=>e.jsx(L,{value:w.value,children:e.jsxs(n,{sx:{display:"flex",alignItems:"center"},children:[w.icon,e.jsxs(n,{sx:{ml:1},children:[e.jsx(r,{variant:"body2",children:w.label}),e.jsx(r,{variant:"caption",color:"text.secondary",children:w.description})]})]})},w.value))})]})})}),e.jsx(P,{item:!0,xs:12,md:6,children:e.jsx(U,{name:"priority",control:j,rules:{required:"Priority is required"},render:({field:E})=>e.jsxs(le,{fullWidth:!0,error:!!R.priority,children:[e.jsx(ce,{children:"Priority"}),e.jsx(de,{...E,label:"Priority",children:Fr.map(w=>e.jsx(L,{value:w.value,children:e.jsx(K,{label:w.label,size:"small",color:w.color,sx:{mr:1}})},w.value))})]})})}),e.jsx(P,{item:!0,xs:12,children:e.jsx(U,{name:"medication",control:j,render:({field:E})=>e.jsx(X,{...E,fullWidth:!0,label:"Medication (if applicable)",placeholder:"Enter medication name..."})})}),e.jsx(P,{item:!0,xs:12,children:e.jsx(U,{name:"rationale",control:j,rules:{required:"Rationale is required"},render:({field:E})=>{var w;return e.jsx(X,{...E,fullWidth:!0,multiline:!0,rows:3,label:"Rationale",placeholder:"Explain the clinical reasoning for this recommendation...",error:!!R.rationale,helperText:(w=R.rationale)==null?void 0:w.message})}})}),e.jsxs(P,{item:!0,xs:12,children:[e.jsx(r,{variant:"subtitle2",sx:{mb:1},children:"Quick Templates:"}),e.jsx(n,{sx:{display:"flex",flexWrap:"wrap",gap:1,mb:2},children:(M=cn[u])==null?void 0:M.map(E=>e.jsx(K,{label:E,size:"small",variant:"outlined",onClick:()=>{const w=f("rationale");w.includes(E)||x({...f(),rationale:w?`${w}. ${E}`:E})},sx:{cursor:"pointer"}},E))})]}),e.jsx(P,{item:!0,xs:12,children:e.jsx(U,{name:"expectedOutcome",control:j,rules:{required:"Expected outcome is required"},render:({field:E})=>{var w;return e.jsx(X,{...E,fullWidth:!0,multiline:!0,rows:2,label:"Expected Outcome",placeholder:"Describe the expected clinical outcome...",error:!!R.expectedOutcome,helperText:(w=R.expectedOutcome)==null?void 0:w.message})}})})]})}),e.jsxs(Be,{children:[e.jsx(N,{onClick:t,children:"Cancel"}),e.jsx(N,{variant:"contained",onClick:d(y),children:"Save Recommendation"})]})]})},hn=({open:g,onClose:t,onSave:i,monitoring:s})=>{const{control:j,handleSubmit:d,reset:x,formState:{errors:f}}=dt({defaultValues:s||{parameter:"",frequency:"",targetValue:"",notes:""}});p.useEffect(()=>{x(s||{parameter:"",frequency:"",targetValue:"",notes:""})},[s,x]);const R=u=>{i(u),t()};return e.jsxs(Fe,{open:g,onClose:t,maxWidth:"sm",fullWidth:!0,children:[e.jsx(ze,{children:s?"Edit Monitoring Parameter":"Add Monitoring Parameter"}),e.jsx(qe,{children:e.jsxs(P,{container:!0,spacing:2,sx:{mt:1},children:[e.jsx(P,{item:!0,xs:12,children:e.jsx(U,{name:"parameter",control:j,rules:{required:"Parameter is required"},render:({field:u})=>e.jsx(Ft,{...u,options:an,freeSolo:!0,renderInput:y=>{var M;return e.jsx(X,{...y,label:"Monitoring Parameter",error:!!f.parameter,helperText:(M=f.parameter)==null?void 0:M.message})},onChange:(y,M)=>u.onChange(M||"")})})}),e.jsx(P,{item:!0,xs:12,children:e.jsx(U,{name:"frequency",control:j,rules:{required:"Frequency is required"},render:({field:u})=>e.jsx(Ft,{...u,options:on,freeSolo:!0,renderInput:y=>{var M;return e.jsx(X,{...y,label:"Monitoring Frequency",error:!!f.frequency,helperText:(M=f.frequency)==null?void 0:M.message})},onChange:(y,M)=>u.onChange(M||"")})})}),e.jsx(P,{item:!0,xs:12,children:e.jsx(U,{name:"targetValue",control:j,render:({field:u})=>e.jsx(X,{...u,fullWidth:!0,label:"Target Value (optional)",placeholder:"e.g., <140/90 mmHg, 7-9 mg/dL"})})}),e.jsx(P,{item:!0,xs:12,children:e.jsx(U,{name:"notes",control:j,render:({field:u})=>e.jsx(X,{...u,fullWidth:!0,multiline:!0,rows:3,label:"Notes (optional)",placeholder:"Additional monitoring instructions or considerations..."})})})]})}),e.jsxs(Be,{children:[e.jsx(N,{onClick:t,children:"Cancel"}),e.jsx(N,{variant:"contained",onClick:d(R),children:"Save Parameter"})]})]})},xn=({open:g,onClose:t,onSave:i,goal:s})=>{const{control:j,handleSubmit:d,reset:x,formState:{errors:f}}=dt({defaultValues:s||{description:"",targetDate:void 0,achieved:!1,achievedDate:void 0}});p.useEffect(()=>{x(s?{...s,targetDate:s.targetDate?s.targetDate.toString():void 0,achievedDate:s.achievedDate?s.achievedDate.toString():void 0}:{description:"",targetDate:void 0,achieved:!1,achievedDate:void 0})},[s,x]);const R=u=>{i(u),t()};return e.jsxs(Fe,{open:g,onClose:t,maxWidth:"sm",fullWidth:!0,children:[e.jsx(ze,{children:s?"Edit Therapy Goal":"Add Therapy Goal"}),e.jsx(qe,{children:e.jsxs(P,{container:!0,spacing:2,sx:{mt:1},children:[e.jsx(P,{item:!0,xs:12,children:e.jsx(U,{name:"description",control:j,rules:{required:"Goal description is required"},render:({field:u})=>{var y;return e.jsx(X,{...u,fullWidth:!0,multiline:!0,rows:3,label:"Goal Description",placeholder:"Describe the specific, measurable therapy goal...",error:!!f.description,helperText:(y=f.description)==null?void 0:y.message})}})}),e.jsx(P,{item:!0,xs:12,md:6,children:e.jsx(U,{name:"targetDate",control:j,render:({field:u})=>e.jsx(At,{label:"Target Date (optional)",value:u.value?new Date(u.value):null,onChange:y=>u.onChange(y==null?void 0:y.toISOString().split("T")[0]),slotProps:{textField:{fullWidth:!0}}})})}),e.jsx(P,{item:!0,xs:12,md:6,children:e.jsx(U,{name:"achieved",control:j,render:({field:u})=>e.jsx(Lt,{control:e.jsx(Wt,{...u,checked:u.value}),label:"Goal Achieved"})})}),e.jsx(P,{item:!0,xs:12,children:e.jsx(U,{name:"achievedDate",control:j,render:({field:u})=>e.jsx(At,{label:"Achievement Date (if achieved)",value:u.value?new Date(u.value):null,onChange:y=>u.onChange(y==null?void 0:y.toISOString().split("T")[0]),slotProps:{textField:{fullWidth:!0}}})})})]})}),e.jsxs(Be,{children:[e.jsx(N,{onClick:t,children:"Cancel"}),e.jsx(N,{variant:"contained",onClick:d(R),children:"Save Goal"})]})]})},mn={medication_change:{patient:"Based on our medication review, I recommend adjusting your [medication] dosage to improve effectiveness and reduce side effects.",prescriber:"Following MTR assessment, I recommend [specific change] for [patient name] to optimize therapy outcomes.",caregiver:"Please note the following medication changes for [patient name] and monitor for [specific effects]."},adherence_support:{patient:"Let's discuss strategies to help you take your medications as prescribed. Consider using [specific tools/methods].",prescriber:"Patient would benefit from adherence support interventions including [specific recommendations].",caregiver:"Please assist [patient name] with medication adherence using these strategies: [specific methods]."},monitoring_plan:{patient:"We need to monitor [specific parameters] to ensure your medications are working safely and effectively.",prescriber:"Recommend monitoring [parameters] at [frequency] to assess therapy response and safety.",caregiver:"Please ensure [patient name] follows up for [monitoring requirements] as scheduled."},patient_education:{patient:"Here's important information about your medications: [key points]. Please contact us if you have questions.",prescriber:"Patient has been educated on [topics]. Additional reinforcement may be beneficial.",caregiver:"Key medication education points for [patient name]: [educational content]."}};function Yt(g){const{children:t,value:i,index:s,...j}=g;return e.jsx("div",{role:"tabpanel",hidden:i!==s,id:`interventions-tabpanel-${s}`,"aria-labelledby":`interventions-tab-${s}`,...j,children:i===s&&e.jsx(n,{sx:{p:3},children:t})})}const pn=({reviewId:g,onInterventionRecorded:t})=>{const{interventions:i,currentReview:s,recordIntervention:j,updateIntervention:d,markInterventionComplete:x,loading:f,errors:R}=Ee(),[u,y]=p.useState(0),[M,E]=p.useState(!1),[w,ee]=p.useState(null),[Z,$]=p.useState(!1),[O,z]=p.useState("all"),[J,V]=p.useState("all"),[S,re]=p.useState({reviewId:g,patientId:(s==null?void 0:s.patientId)||"",type:"recommendation",category:"medication_change",description:"",rationale:"",targetAudience:"patient",communicationMethod:"verbal",documentation:"",priority:"medium",urgency:"routine",followUpRequired:!1,followUpDate:""});p.useEffect(()=>{M||(ee(null),re({reviewId:g,patientId:(s==null?void 0:s.patientId)||"",type:"recommendation",category:"medication_change",description:"",rationale:"",targetAudience:"patient",communicationMethod:"verbal",documentation:"",priority:"medium",urgency:"routine",followUpRequired:!1,followUpDate:""}))},[M,g,s==null?void 0:s.patientId]),p.useEffect(()=>{w&&re({reviewId:w._id||g,patientId:(s==null?void 0:s.patientId)||"",type:w.type,category:w.category,description:w.description,rationale:w.rationale,targetAudience:w.targetAudience,communicationMethod:w.communicationMethod,documentation:w.documentation,priority:w.priority,urgency:w.urgency,followUpRequired:w.followUpRequired,followUpDate:w.followUpDate?wt(new Date(w.followUpDate),"yyyy-MM-dd"):""})},[w,g,s==null?void 0:s.patientId]);const D=p.useMemo(()=>i.filter(l=>!(!Z&&l.outcome!=="pending"||O!=="all"&&l.type!==O||J!=="all"&&l.outcome!==J)),[i,Z,O,J]),B=p.useMemo(()=>{const l={total:i.length,pending:0,accepted:0,rejected:0,modified:0,followUpRequired:0,overdue:0};return i.forEach(Q=>{l[Q.outcome]++,Q.followUpRequired&&!Q.followUpCompleted&&l.followUpRequired++,Q.followUpDate&&Er(new Date,new Date(Q.followUpDate))&&l.overdue++}),l},[i]),I=(l,Q)=>{var ue;if(re(me=>({...me,[l]:Q})),l==="type"||l==="category"||l==="targetAudience"){const me={...S,[l]:Q},Me=(ue=mn[me.category])==null?void 0:ue[me.targetAudience];Me&&!S.description&&re(je=>({...je,[l]:Q,description:Me}))}},ie=async()=>{try{if(w)await d(w._id,S);else{await j(S);const l={...S,_id:"temp-id",workplaceId:"temp-workplace",outcome:"pending",outcomeDetails:"",followUpDate:S.followUpDate||new Date().toISOString(),followUpRequired:S.followUpRequired||!1,followUpCompleted:!1,attachments:[],pharmacistId:"current-pharmacist",performedAt:new Date().toISOString(),createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),createdBy:"current-user",updatedBy:"current-user",isDeleted:!1};t==null||t(l)}E(!1)}catch(l){console.error("Failed to save intervention:",l)}},te=async(l,Q,ue)=>{try{await x(l,Q,ue)}catch(me){console.error("Failed to complete intervention:",me)}},fe=l=>{switch(l){case"recommendation":return e.jsx(us,{});case"counseling":return e.jsx(mt,{});case"monitoring":return e.jsx(Nt,{});case"communication":return e.jsx(It,{});case"education":return e.jsx(Yr,{});default:return e.jsx(pt,{})}},W=l=>{switch(l){case"accepted":return"success";case"rejected":return"error";case"modified":return"warning";case"pending":return"info";default:return"default"}},Se=l=>{switch(l){case"immediate":return"error";case"within_24h":return"warning";case"within_week":return"info";case"routine":return"default";default:return"default"}};return e.jsxs(n,{sx:{width:"100%"},children:[e.jsxs(n,{sx:{mb:3},children:[e.jsxs(n,{sx:{display:"flex",justifyContent:"between",alignItems:"center",mb:2},children:[e.jsxs(r,{variant:"h5",component:"h2",sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(_t,{}),"Interventions Dashboard"]}),e.jsx(N,{variant:"contained",startIcon:e.jsx(_e,{}),onClick:()=>E(!0),disabled:f.recordIntervention,children:"Record Intervention"})]}),e.jsxs(n,{sx:{display:"flex",flexWrap:"wrap",gap:2,mb:2},children:[e.jsx(n,{sx:{flex:"1 1 150px",minWidth:"150px"},children:e.jsxs(oe,{sx:{p:2,textAlign:"center"},children:[e.jsx(r,{variant:"h4",color:"primary",children:B.total}),e.jsx(r,{variant:"body2",children:"Total"})]})}),e.jsx(n,{sx:{flex:"1 1 150px",minWidth:"150px"},children:e.jsxs(oe,{sx:{p:2,textAlign:"center"},children:[e.jsx(r,{variant:"h4",color:"info.main",children:B.pending}),e.jsx(r,{variant:"body2",children:"Pending"})]})}),e.jsx(n,{sx:{flex:"1 1 150px",minWidth:"150px"},children:e.jsxs(oe,{sx:{p:2,textAlign:"center"},children:[e.jsx(r,{variant:"h4",color:"success.main",children:B.accepted}),e.jsx(r,{variant:"body2",children:"Accepted"})]})}),e.jsx(n,{sx:{flex:"1 1 150px",minWidth:"150px"},children:e.jsxs(oe,{sx:{p:2,textAlign:"center"},children:[e.jsx(r,{variant:"h4",color:"warning.main",children:B.followUpRequired}),e.jsx(r,{variant:"body2",children:"Follow-up"})]})}),e.jsx(n,{sx:{flex:"1 1 150px",minWidth:"150px"},children:e.jsxs(oe,{sx:{p:2,textAlign:"center"},children:[e.jsx(r,{variant:"h4",color:"error.main",children:B.overdue}),e.jsx(r,{variant:"body2",children:"Overdue"})]})}),e.jsx(n,{sx:{flex:"1 1 150px",minWidth:"150px"},children:e.jsxs(oe,{sx:{p:2,textAlign:"center"},children:[e.jsxs(r,{variant:"h4",color:"text.secondary",children:[B.total>0?Math.round(B.accepted/B.total*100):0,"%"]}),e.jsx(r,{variant:"body2",children:"Success Rate"})]})})]}),B.total>0&&e.jsxs(n,{sx:{mb:2},children:[e.jsxs(r,{variant:"body2",sx:{mb:1},children:["Intervention Progress (",B.accepted+B.modified," of"," ",B.total," completed)"]}),e.jsx(rt,{variant:"determinate",value:(B.accepted+B.modified)/B.total*100,sx:{height:8,borderRadius:4}})]})]}),e.jsx(n,{sx:{borderBottom:1,borderColor:"divider",mb:2},children:e.jsxs(qt,{value:u,onChange:(l,Q)=>y(Q),children:[e.jsx($e,{label:e.jsx(Mt,{badgeContent:B.pending,color:"primary",children:"Timeline View"})}),e.jsx($e,{label:e.jsx(Mt,{badgeContent:B.followUpRequired,color:"warning",children:"Progress Tracking"})}),e.jsx($e,{label:"Analytics"})]})}),e.jsx(n,{sx:{mb:3},children:e.jsxs(it,{children:[e.jsx(at,{expandIcon:e.jsx(Qe,{}),children:e.jsxs(r,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(hs,{}),"Filters & Options"]})}),e.jsx(ot,{children:e.jsxs(n,{sx:{display:"flex",flexWrap:"wrap",gap:2,alignItems:"center"},children:[e.jsx(n,{sx:{flex:"1 1 200px",minWidth:"200px"},children:e.jsxs(le,{fullWidth:!0,size:"small",children:[e.jsx(ce,{children:"Type"}),e.jsxs(de,{value:O,label:"Type",onChange:l=>z(l.target.value),children:[e.jsx(L,{value:"all",children:"All Types"}),e.jsx(L,{value:"recommendation",children:"Recommendation"}),e.jsx(L,{value:"counseling",children:"Counseling"}),e.jsx(L,{value:"monitoring",children:"Monitoring"}),e.jsx(L,{value:"communication",children:"Communication"}),e.jsx(L,{value:"education",children:"Education"})]})]})}),e.jsx(n,{sx:{flex:"1 1 200px",minWidth:"200px"},children:e.jsxs(le,{fullWidth:!0,size:"small",children:[e.jsx(ce,{children:"Outcome"}),e.jsxs(de,{value:J,label:"Outcome",onChange:l=>V(l.target.value),children:[e.jsx(L,{value:"all",children:"All Outcomes"}),e.jsx(L,{value:"pending",children:"Pending"}),e.jsx(L,{value:"accepted",children:"Accepted"}),e.jsx(L,{value:"rejected",children:"Rejected"}),e.jsx(L,{value:"modified",children:"Modified"})]})]})}),e.jsx(n,{sx:{flex:"1 1 200px",minWidth:"200px"},children:e.jsx(Lt,{control:e.jsx(Cr,{checked:Z,onChange:l=>$(l.target.checked)}),label:"Show Completed"})})]})})]})}),R.recordIntervention&&e.jsx(ge,{severity:"error",sx:{mb:2},children:R.recordIntervention}),e.jsx(Yt,{value:u,index:0,children:D.length===0?e.jsxs(oe,{sx:{p:4,textAlign:"center"},children:[e.jsx(_t,{sx:{fontSize:64,color:"text.secondary",mb:2}}),e.jsx(r,{variant:"h6",color:"text.secondary",children:"No interventions recorded yet"}),e.jsx(r,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Start by recording your first intervention for this MTR session"}),e.jsx(N,{variant:"contained",startIcon:e.jsx(_e,{}),onClick:()=>E(!0),children:"Record First Intervention"})]}):e.jsx(xs,{children:D.map((l,Q)=>e.jsxs(ms,{children:[e.jsxs(ps,{sx:{m:"auto 0"},variant:"body2",color:"text.secondary",children:[wt(new Date(l.performedAt),"MMM dd, yyyy HH:mm"),e.jsx("br",{}),e.jsx(K,{size:"small",label:l.urgency,color:Se(l.urgency),sx:{mt:.5}})]}),e.jsxs(js,{children:[e.jsx(gs,{color:W(l.outcome),children:fe(l.type)}),Q<D.length-1&&e.jsx(fs,{})]}),e.jsx(ys,{sx:{py:"12px",px:2},children:e.jsx(se,{children:e.jsxs(ae,{children:[e.jsxs(n,{sx:{display:"flex",justifyContent:"between",alignItems:"flex-start",mb:1},children:[e.jsxs(n,{children:[e.jsx(r,{variant:"h6",component:"div",children:l.type.charAt(0).toUpperCase()+l.type.slice(1)}),e.jsx(r,{variant:"body2",color:"text.secondary",children:l.category.replace("_"," ").toUpperCase()})]}),e.jsxs(n,{sx:{display:"flex",gap:1},children:[e.jsx(tt,{title:"Edit Intervention",children:e.jsx(xe,{size:"small",onClick:()=>{ee(l),E(!0)},children:e.jsx(Ge,{})})}),e.jsx(K,{label:l.outcome,color:W(l.outcome),size:"small"})]})]}),e.jsx(r,{variant:"body1",sx:{mb:1},children:l.description}),e.jsxs(r,{variant:"body2",color:"text.secondary",sx:{mb:2},children:[e.jsx("strong",{children:"Rationale:"})," ",l.rationale]}),e.jsxs(n,{sx:{display:"flex",gap:1,mb:2,flexWrap:"wrap"},children:[e.jsx(K,{size:"small",icon:e.jsx(mt,{}),label:l.targetAudience,variant:"outlined"}),e.jsx(K,{size:"small",icon:l.communicationMethod==="phone"?e.jsx(It,{}):e.jsx(er,{}),label:l.communicationMethod,variant:"outlined"}),e.jsx(K,{size:"small",label:`Priority: ${l.priority}`,color:l.priority==="high"?"error":l.priority==="medium"?"warning":"default",variant:"outlined"})]}),l.followUpRequired&&e.jsx(ge,{severity:l.followUpCompleted?"success":"warning",sx:{mb:1},children:e.jsxs(r,{variant:"body2",children:["Follow-up"," ",l.followUpCompleted?"completed":"required",l.followUpDate&&` by ${wt(new Date(l.followUpDate),"MMM dd, yyyy")}`]})}),l.outcome==="pending"&&e.jsxs(n,{sx:{display:"flex",gap:1,mt:2},children:[e.jsx(N,{size:"small",variant:"contained",color:"success",onClick:()=>te(l._id,"accepted"),children:"Mark Accepted"}),e.jsx(N,{size:"small",variant:"outlined",color:"warning",onClick:()=>te(l._id,"modified"),children:"Mark Modified"}),e.jsx(N,{size:"small",variant:"outlined",color:"error",onClick:()=>te(l._id,"rejected"),children:"Mark Rejected"})]}),l.outcomeDetails&&e.jsxs(r,{variant:"body2",sx:{mt:1,p:1,bgcolor:"grey.100",borderRadius:1},children:[e.jsx("strong",{children:"Outcome Details:"})," ",l.outcomeDetails]})]})})})]},l._id))})}),e.jsx(Yt,{value:u,index:1,children:e.jsxs(n,{sx:{display:"flex",flexWrap:"wrap",gap:3},children:[e.jsx(n,{sx:{flex:"1 1 400px",minWidth:"400px"},children:e.jsx(se,{children:e.jsxs(ae,{children:[e.jsxs(r,{variant:"h6",sx:{mb:2,display:"flex",alignItems:"center",gap:1},children:[e.jsx(dr,{}),"Follow-up Required"]}),i.filter(l=>l.followUpRequired&&!l.followUpCompleted).map(l=>e.jsxs(n,{sx:{mb:2,p:2,border:1,borderColor:"divider",borderRadius:1},children:[e.jsx(r,{variant:"subtitle2",children:l.description}),e.jsxs(r,{variant:"body2",color:"text.secondary",children:["Due:"," ",l.followUpDate?wt(new Date(l.followUpDate),"MMM dd, yyyy"):"Not specified"]}),e.jsx(r,{variant:"body2",color:"text.secondary",children:l.followUpDate&&jr(new Date(l.followUpDate),{addSuffix:!0})})]},l._id))]})})}),e.jsx(n,{sx:{flex:"1 1 400px",minWidth:"400px"},children:e.jsx(se,{children:e.jsxs(ae,{children:[e.jsxs(r,{variant:"h6",sx:{mb:2,display:"flex",alignItems:"center",gap:1},children:[e.jsx(Kr,{}),"Recent Activity"]}),i.sort((l,Q)=>new Date(Q.performedAt).getTime()-new Date(l.performedAt).getTime()).slice(0,5).map(l=>e.jsxs(n,{sx:{mb:2,p:2,border:1,borderColor:"divider",borderRadius:1},children:[e.jsx(r,{variant:"subtitle2",children:l.type}),e.jsx(r,{variant:"body2",color:"text.secondary",children:jr(new Date(l.performedAt),{addSuffix:!0})}),e.jsx(K,{size:"small",label:l.outcome,color:W(l.outcome)})]},l._id))]})})})]})}),e.jsx(Yt,{value:u,index:2,children:e.jsxs(n,{sx:{display:"flex",flexWrap:"wrap",gap:3},children:[e.jsx(n,{sx:{flex:"1 1 400px",minWidth:"400px"},children:e.jsx(se,{children:e.jsxs(ae,{children:[e.jsx(r,{variant:"h6",sx:{mb:2},children:"Intervention Types"}),Object.entries(i.reduce((l,Q)=>(l[Q.type]=(l[Q.type]||0)+1,l),{})).map(([l,Q])=>e.jsxs(n,{sx:{mb:1},children:[e.jsxs(n,{sx:{display:"flex",justifyContent:"between"},children:[e.jsx(r,{variant:"body2",children:l}),e.jsx(r,{variant:"body2",children:Q})]}),e.jsx(rt,{variant:"determinate",value:Q/i.length*100,sx:{height:4,borderRadius:2}})]},l))]})})}),e.jsx(n,{sx:{flex:"1 1 400px",minWidth:"400px"},children:e.jsx(se,{children:e.jsxs(ae,{children:[e.jsx(r,{variant:"h6",sx:{mb:2},children:"Outcome Distribution"}),Object.entries(i.reduce((l,Q)=>(l[Q.outcome]=(l[Q.outcome]||0)+1,l),{})).map(([l,Q])=>e.jsxs(n,{sx:{mb:1},children:[e.jsxs(n,{sx:{display:"flex",justifyContent:"between"},children:[e.jsx(r,{variant:"body2",children:l}),e.jsx(r,{variant:"body2",children:Q})]}),e.jsx(rt,{variant:"determinate",value:Q/i.length*100,color:W(l),sx:{height:4,borderRadius:2}})]},l))]})})})]})}),e.jsxs(Fe,{open:M,onClose:()=>E(!1),maxWidth:"md",fullWidth:!0,children:[e.jsx(ze,{children:w?"Edit Intervention":"Record New Intervention"}),e.jsx(qe,{children:e.jsxs(n,{sx:{display:"flex",flexWrap:"wrap",gap:2,mt:1},children:[e.jsx(n,{sx:{flex:"1 1 250px",minWidth:"250px"},children:e.jsxs(le,{fullWidth:!0,children:[e.jsx(ce,{children:"Type"}),e.jsxs(de,{value:S.type,label:"Type",onChange:l=>I("type",l.target.value),children:[e.jsx(L,{value:"recommendation",children:"Recommendation"}),e.jsx(L,{value:"counseling",children:"Counseling"}),e.jsx(L,{value:"monitoring",children:"Monitoring"}),e.jsx(L,{value:"communication",children:"Communication"}),e.jsx(L,{value:"education",children:"Education"})]})]})}),e.jsx(n,{sx:{flex:"1 1 250px",minWidth:"250px"},children:e.jsxs(le,{fullWidth:!0,children:[e.jsx(ce,{children:"Category"}),e.jsxs(de,{value:S.category,label:"Category",onChange:l=>I("category",l.target.value),children:[e.jsx(L,{value:"medication_change",children:"Medication Change"}),e.jsx(L,{value:"adherence_support",children:"Adherence Support"}),e.jsx(L,{value:"monitoring_plan",children:"Monitoring Plan"}),e.jsx(L,{value:"patient_education",children:"Patient Education"})]})]})}),e.jsx(n,{sx:{flex:"1 1 250px",minWidth:"250px"},children:e.jsxs(le,{fullWidth:!0,children:[e.jsx(ce,{children:"Target Audience"}),e.jsxs(de,{value:S.targetAudience,label:"Target Audience",onChange:l=>I("targetAudience",l.target.value),children:[e.jsx(L,{value:"patient",children:"Patient"}),e.jsx(L,{value:"prescriber",children:"Prescriber"}),e.jsx(L,{value:"caregiver",children:"Caregiver"}),e.jsx(L,{value:"healthcare_team",children:"Healthcare Team"})]})]})}),e.jsx(n,{sx:{flex:"1 1 250px",minWidth:"250px"},children:e.jsxs(le,{fullWidth:!0,children:[e.jsx(ce,{children:"Communication Method"}),e.jsxs(de,{value:S.communicationMethod,label:"Communication Method",onChange:l=>I("communicationMethod",l.target.value),children:[e.jsx(L,{value:"verbal",children:"Verbal"}),e.jsx(L,{value:"written",children:"Written"}),e.jsx(L,{value:"phone",children:"Phone"}),e.jsx(L,{value:"email",children:"Email"}),e.jsx(L,{value:"fax",children:"Fax"}),e.jsx(L,{value:"in_person",children:"In Person"})]})]})}),e.jsx(n,{sx:{flex:"1 1 100%",width:"100%"},children:e.jsx(X,{fullWidth:!0,label:"Description",multiline:!0,rows:3,value:S.description,onChange:l=>I("description",l.target.value),placeholder:"Describe the intervention..."})}),e.jsx(n,{sx:{flex:"1 1 100%",width:"100%"},children:e.jsx(X,{fullWidth:!0,label:"Rationale",multiline:!0,rows:2,value:S.rationale,onChange:l=>I("rationale",l.target.value),placeholder:"Explain the clinical rationale..."})}),e.jsx(n,{sx:{flex:"1 1 250px",minWidth:"250px"},children:e.jsxs(le,{fullWidth:!0,children:[e.jsx(ce,{children:"Priority"}),e.jsxs(de,{value:S.priority,label:"Priority",onChange:l=>I("priority",l.target.value),children:[e.jsx(L,{value:"low",children:"Low"}),e.jsx(L,{value:"medium",children:"Medium"}),e.jsx(L,{value:"high",children:"High"})]})]})}),e.jsx(n,{sx:{flex:"1 1 250px",minWidth:"250px"},children:e.jsxs(le,{fullWidth:!0,children:[e.jsx(ce,{children:"Urgency"}),e.jsxs(de,{value:S.urgency,label:"Urgency",onChange:l=>I("urgency",l.target.value),children:[e.jsx(L,{value:"routine",children:"Routine"}),e.jsx(L,{value:"within_week",children:"Within Week"}),e.jsx(L,{value:"within_24h",children:"Within 24h"}),e.jsx(L,{value:"immediate",children:"Immediate"})]})]})}),e.jsx(n,{sx:{flex:"1 1 100%",width:"100%"},children:e.jsx(Lt,{control:e.jsx(Cr,{checked:S.followUpRequired,onChange:l=>I("followUpRequired",l.target.checked)}),label:"Follow-up Required"})}),S.followUpRequired&&e.jsx(n,{sx:{flex:"1 1 250px",minWidth:"250px"},children:e.jsx(X,{fullWidth:!0,label:"Follow-up Date",type:"date",value:S.followUpDate,onChange:l=>I("followUpDate",l.target.value),InputLabelProps:{shrink:!0}})}),e.jsx(n,{sx:{flex:"1 1 100%",width:"100%"},children:e.jsx(X,{fullWidth:!0,label:"Documentation",multiline:!0,rows:3,value:S.documentation,onChange:l=>I("documentation",l.target.value),placeholder:"Additional documentation and notes..."})})]})}),e.jsxs(Be,{children:[e.jsx(N,{onClick:()=>E(!1),children:"Cancel"}),e.jsxs(N,{onClick:ie,variant:"contained",disabled:!S.description||!S.rationale||f.recordIntervention,children:[w?"Update":"Record"," Intervention"]})]})]})]})},Pt=({children:g,value:t,index:i,...s})=>e.jsx("div",{role:"tabpanel",hidden:t!==i,id:`followup-tabpanel-${i}`,"aria-labelledby":`followup-tab-${i}`,...s,children:t===i&&e.jsx(n,{sx:{p:3},children:g})}),jn=({reviewId:g,interventions:t,onFollowUpScheduled:i,onFollowUpUpdated:s,onFollowUpCompleted:j})=>{const{followUps:d,scheduleFollowUp:x,updateFollowUp:f,completeFollowUp:R,rescheduleFollowUp:u,loading:y,errors:M}=Ee();console.log("Available interventions:",(t||[]).length);const{addNotification:w}=Jr(),[ee,Z]=p.useState(0),[$,O]=p.useState(!1),[z,J]=p.useState(null),[V,S]=p.useState(!1),[re,D]=p.useState(null),[B,I]=p.useState(!1),[ie,te]=p.useState({type:"phone_call",priority:"medium",description:"",objectives:[],scheduledDate:new Date().toISOString(),estimatedDuration:30,assignedTo:"",status:"scheduled",relatedInterventions:[]}),[fe,W]=p.useState({status:"successful",notes:"",nextActions:[],nextFollowUpDate:void 0,adherenceImproved:!1,problemsResolved:[],newProblemsIdentified:[]}),[Se,l]=p.useState({newDate:new Date().toISOString(),reason:""}),Q=d.filter(a=>a.status==="scheduled"),ue=d.filter(a=>a.status==="completed"),me=d.filter(a=>a.status==="scheduled"&&a.scheduledDate&&yr(new Date(a.scheduledDate),new Date)),Me=d.filter(a=>a.status==="scheduled"&&a.scheduledDate&&Er(new Date(a.scheduledDate),new Date)),je=(a,b)=>{a==="scheduledDate"&&b instanceof Date?te(G=>({...G,[a]:b.toISOString()})):te(G=>({...G,[a]:b}))},ve=(a,b)=>{const G=[...ie.objectives||[]];G[a]=b,te(we=>({...we,objectives:G}))},Ne=()=>{te(a=>({...a,objectives:[...a.objectives||[],""]}))},Pe=a=>{const b=[...ie.objectives||[]];b.splice(a,1),te(G=>({...G,objectives:b}))},be=async()=>{var a,b,G;try{if(!((a=ie.description)!=null&&a.trim())){w({title:"Validation Error",message:"Description is required",type:"error"});return}if(!ie.scheduledDate){w({title:"Validation Error",message:"Scheduled date is required",type:"error"});return}if(!((b=ie.assignedTo)!=null&&b.trim())){w({title:"Validation Error",message:"Assigned pharmacist is required",type:"error"});return}const we={...ie,reviewId:g,patientId:"",objectives:((G=ie.objectives)==null?void 0:G.filter(Ue=>Ue.trim()))||[],reminders:[]};z?(await f(z._id,we),s==null||s(z._id,we),w({title:"Success",message:"Follow-up updated successfully",type:"success"})):(await x(we),i==null||i(we),w({title:"Success",message:"Follow-up scheduled successfully",type:"success"})),v()}catch(we){w({title:"Error",message:we instanceof Error?we.message:"Failed to save follow-up",type:"error"})}},ne=async()=>{if(re)try{if(!fe.notes.trim()){w({title:"Validation Error",message:"Outcome notes are required",type:"error"});return}await R(re._id,fe),j==null||j(re._id,fe),w({title:"Success",message:"Follow-up completed successfully",type:"success"}),S(!1),D(null)}catch(a){w({title:"Error",message:a instanceof Error?a.message:"Failed to complete follow-up",type:"error"})}},Te=async()=>{if(re)try{if(!Se.reason.trim()){w({title:"Validation Error",message:"Reschedule reason is required",type:"error"});return}await u(re._id,Se.newDate,Se.reason),w({title:"Success",message:"Follow-up rescheduled successfully",type:"success"}),I(!1),D(null)}catch(a){w({title:"Error",message:a instanceof Error?a.message:"Failed to reschedule follow-up",type:"error"})}},o=a=>{a?(J(a),te(a)):(J(null),te({type:"phone_call",priority:"medium",description:"",objectives:[],scheduledDate:new Date().toISOString(),estimatedDuration:30,assignedTo:"",status:"scheduled",relatedInterventions:[]})),O(!0)},v=()=>{O(!1),J(null),te({})},_=a=>{D(a),W({status:"successful",notes:"",nextActions:[],nextFollowUpDate:void 0,adherenceImproved:!1,problemsResolved:[],newProblemsIdentified:[]}),S(!0)},pe=a=>{D(a),l({newDate:Ss(new Date(a.scheduledDate),1).toISOString(),reason:""}),I(!0)},We=a=>{switch(a){case"phone_call":return e.jsx(It,{});case"appointment":return e.jsx(Dr,{});case"lab_review":return e.jsx(Zr,{});case"adherence_check":return e.jsx(Ot,{});case"outcome_assessment":return e.jsx(Nt,{});default:return e.jsx(dr,{})}},ke=a=>{switch(a){case"high":return"error";case"medium":return"warning";case"low":return"info";default:return"default"}},m=a=>{switch(a){case"completed":return"success";case"missed":return"error";case"cancelled":return"default";case"rescheduled":return"warning";default:return"primary"}},h=a=>{const b=a.status==="scheduled"&&a.scheduledDate&&yr(new Date(a.scheduledDate),new Date),G=a.scheduledDate?Es(new Date(a.scheduledDate),new Date):0;return e.jsx(se,{sx:{mb:2,border:b?"2px solid #f44336":"none",backgroundColor:b?"#ffebee":"inherit"},children:e.jsxs(ae,{children:[e.jsxs(n,{display:"flex",justifyContent:"space-between",alignItems:"flex-start",mb:2,children:[e.jsxs(n,{display:"flex",alignItems:"center",gap:1,children:[We(a.type),e.jsx(r,{variant:"h6",component:"div",children:a.description}),e.jsx(K,{label:a.priority,color:ke(a.priority),size:"small"}),e.jsx(K,{label:a.status,color:m(a.status),size:"small"})]}),e.jsxs(n,{children:[a.status==="scheduled"&&e.jsxs(e.Fragment,{children:[e.jsx(tt,{title:"Complete Follow-up",children:e.jsx(xe,{onClick:()=>_(a),color:"success",size:"small",children:e.jsx(Le,{})})}),e.jsx(tt,{title:"Reschedule",children:e.jsx(xe,{onClick:()=>pe(a),color:"warning",size:"small",children:e.jsx(Et,{})})})]}),e.jsx(tt,{title:"Edit Follow-up",children:e.jsx(xe,{onClick:()=>o(a),color:"primary",size:"small",children:e.jsx(Ge,{})})})]})]}),e.jsxs(n,{sx:{display:"flex",flexDirection:{xs:"column",sm:"row"},gap:2},children:[e.jsxs(n,{sx:{flex:1},children:[e.jsxs(n,{display:"flex",alignItems:"center",gap:1,mb:1,children:[e.jsx(Dr,{fontSize:"small"}),e.jsx(r,{variant:"body2",children:a.scheduledDate?wt(new Date(a.scheduledDate),"PPP p"):"No date set"}),b&&e.jsx(K,{label:"OVERDUE",color:"error",size:"small"}),G>0&&G<=7&&e.jsx(K,{label:`${G} days`,color:"warning",size:"small"})]}),e.jsxs(n,{display:"flex",alignItems:"center",gap:1,mb:1,children:[e.jsx(bs,{fontSize:"small"}),e.jsxs(r,{variant:"body2",children:[a.estimatedDuration," minutes"]})]}),e.jsxs(n,{display:"flex",alignItems:"center",gap:1,children:[e.jsx(mt,{fontSize:"small"}),e.jsxs(r,{variant:"body2",children:["Assigned to: ",a.assignedTo]})]})]}),e.jsx(n,{sx:{flex:1},children:a.objectives&&a.objectives.length>0&&e.jsxs(n,{children:[e.jsx(r,{variant:"subtitle2",gutterBottom:!0,children:"Objectives:"}),e.jsx(Xe,{dense:!0,children:a.objectives.map((we,Ue)=>e.jsx(De,{sx:{py:0},children:e.jsx(Ie,{primary:we,primaryTypographyProps:{variant:"body2"}})},Ue))})]})})]}),a.outcome&&e.jsxs(it,{sx:{mt:2},children:[e.jsx(at,{expandIcon:e.jsx(Qe,{}),children:e.jsxs(r,{variant:"subtitle2",children:["Outcome (",a.outcome.status,")"]})}),e.jsxs(ot,{children:[e.jsx(r,{variant:"body2",paragraph:!0,children:a.outcome.notes}),a.outcome.nextActions&&a.outcome.nextActions.length>0&&e.jsxs(n,{children:[e.jsx(r,{variant:"subtitle2",gutterBottom:!0,children:"Next Actions:"}),e.jsx(Xe,{dense:!0,children:a.outcome.nextActions.map((we,Ue)=>e.jsx(De,{sx:{py:0},children:e.jsx(Ie,{primary:we,primaryTypographyProps:{variant:"body2"}})},Ue))})]})]})]})]})},a._id)};return e.jsx(Ut,{dateAdapter:$t,children:e.jsxs(n,{children:[e.jsxs(n,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3,children:[e.jsx(r,{variant:"h5",component:"h2",children:"Follow-Up Scheduler"}),e.jsx(N,{variant:"contained",startIcon:e.jsx(_e,{}),onClick:()=>o(),disabled:y.scheduleFollowUp,children:"Schedule Follow-Up"})]}),M.scheduleFollowUp&&e.jsx(ge,{severity:"error",sx:{mb:2},children:M.scheduleFollowUp}),y.scheduleFollowUp&&e.jsx(rt,{sx:{mb:2}}),e.jsxs(n,{sx:{display:"flex",flexWrap:"wrap",gap:2,mb:3},children:[e.jsx(n,{sx:{flex:"1 1 200px",minWidth:"200px"},children:e.jsxs(oe,{sx:{p:2,textAlign:"center"},children:[e.jsx(r,{variant:"h4",color:"primary",children:Q.length}),e.jsx(r,{variant:"body2",color:"text.secondary",children:"Scheduled"})]})}),e.jsx(n,{sx:{flex:"1 1 200px",minWidth:"200px"},children:e.jsxs(oe,{sx:{p:2,textAlign:"center"},children:[e.jsx(r,{variant:"h4",color:"error",children:me.length}),e.jsx(r,{variant:"body2",color:"text.secondary",children:"Overdue"})]})}),e.jsx(n,{sx:{flex:"1 1 200px",minWidth:"200px"},children:e.jsxs(oe,{sx:{p:2,textAlign:"center"},children:[e.jsx(r,{variant:"h4",color:"success",children:ue.length}),e.jsx(r,{variant:"body2",color:"text.secondary",children:"Completed"})]})}),e.jsx(n,{sx:{flex:"1 1 200px",minWidth:"200px"},children:e.jsxs(oe,{sx:{p:2,textAlign:"center"},children:[e.jsx(r,{variant:"h4",color:"warning",children:Me.length}),e.jsx(r,{variant:"body2",color:"text.secondary",children:"Upcoming"})]})})]}),e.jsx(n,{sx:{borderBottom:1,borderColor:"divider"},children:e.jsxs(qt,{value:ee,onChange:(a,b)=>Z(b),children:[e.jsx($e,{label:e.jsx(Mt,{badgeContent:me.length,color:"error",children:"Overdue"})}),e.jsx($e,{label:e.jsx(Mt,{badgeContent:Me.length,color:"primary",children:"Upcoming"})}),e.jsx($e,{label:"All Scheduled"}),e.jsx($e,{label:"Completed"})]})}),e.jsx(Pt,{value:ee,index:0,children:me.length===0?e.jsx(ge,{severity:"success",children:"No overdue follow-ups"}):me.map(h)}),e.jsx(Pt,{value:ee,index:1,children:Me.length===0?e.jsx(ge,{severity:"info",children:"No upcoming follow-ups scheduled"}):Me.map(h)}),e.jsx(Pt,{value:ee,index:2,children:Q.length===0?e.jsx(ge,{severity:"info",children:"No scheduled follow-ups"}):Q.map(h)}),e.jsx(Pt,{value:ee,index:3,children:ue.length===0?e.jsx(ge,{severity:"info",children:"No completed follow-ups"}):ue.map(h)}),e.jsxs(Fe,{open:$,onClose:v,maxWidth:"md",fullWidth:!0,children:[e.jsx(ze,{children:z?"Edit Follow-Up":"Schedule New Follow-Up"}),e.jsx(qe,{children:e.jsxs(n,{sx:{display:"flex",flexWrap:"wrap",gap:2,mt:1},children:[e.jsx(n,{sx:{flex:"1 1 300px",minWidth:"300px"},children:e.jsxs(le,{fullWidth:!0,children:[e.jsx(ce,{children:"Type"}),e.jsxs(de,{value:ie.type||"phone_call",onChange:a=>je("type",a.target.value),label:"Type",children:[e.jsx(L,{value:"phone_call",children:"Phone Call"}),e.jsx(L,{value:"appointment",children:"Appointment"}),e.jsx(L,{value:"lab_review",children:"Lab Review"}),e.jsx(L,{value:"adherence_check",children:"Adherence Check"}),e.jsx(L,{value:"outcome_assessment",children:"Outcome Assessment"})]})]})}),e.jsx(n,{sx:{flex:"1 1 300px",minWidth:"300px"},children:e.jsxs(le,{fullWidth:!0,children:[e.jsx(ce,{children:"Priority"}),e.jsxs(de,{value:ie.priority||"medium",onChange:a=>je("priority",a.target.value),label:"Priority",children:[e.jsx(L,{value:"high",children:"High"}),e.jsx(L,{value:"medium",children:"Medium"}),e.jsx(L,{value:"low",children:"Low"})]})]})}),e.jsx(n,{sx:{width:"100%"},children:e.jsx(X,{fullWidth:!0,label:"Description",value:ie.description||"",onChange:a=>je("description",a.target.value),multiline:!0,rows:2,required:!0})}),e.jsx(n,{sx:{flex:"1 1 300px",minWidth:"300px"},children:e.jsx(Xt,{label:"Scheduled Date & Time",value:ie.scheduledDate?new Date(ie.scheduledDate):new Date,onChange:a=>je("scheduledDate",a),slotProps:{textField:{fullWidth:!0,required:!0}}})}),e.jsx(n,{sx:{flex:"1 1 300px",minWidth:"300px"},children:e.jsx(X,{fullWidth:!0,label:"Estimated Duration (minutes)",type:"number",value:ie.estimatedDuration||30,onChange:a=>je("estimatedDuration",parseInt(a.target.value)),inputProps:{min:5,max:480}})}),e.jsx(n,{sx:{width:"100%"},children:e.jsx(X,{fullWidth:!0,label:"Assigned To",value:ie.assignedTo||"",onChange:a=>je("assignedTo",a.target.value),placeholder:"Pharmacist name or ID",required:!0})}),e.jsxs(n,{sx:{width:"100%"},children:[e.jsx(r,{variant:"subtitle2",gutterBottom:!0,children:"Objectives"}),(ie.objectives||[]).map((a,b)=>e.jsxs(n,{display:"flex",gap:1,mb:1,children:[e.jsx(X,{fullWidth:!0,size:"small",value:a,onChange:G=>ve(b,G.target.value),placeholder:`Objective ${b+1}`}),e.jsx(xe,{onClick:()=>Pe(b),color:"error",size:"small",children:e.jsx(xt,{})})]},b)),e.jsx(N,{startIcon:e.jsx(_e,{}),onClick:Ne,size:"small",children:"Add Objective"})]})]})}),e.jsxs(Be,{children:[e.jsx(N,{onClick:v,children:"Cancel"}),e.jsx(N,{onClick:be,variant:"contained",disabled:y.scheduleFollowUp,children:z?"Update":"Schedule"})]})]}),e.jsxs(Fe,{open:V,onClose:()=>S(!1),maxWidth:"md",fullWidth:!0,children:[e.jsx(ze,{children:"Complete Follow-Up"}),e.jsx(qe,{children:e.jsxs(n,{sx:{display:"flex",flexWrap:"wrap",gap:2,mt:1},children:[e.jsx(n,{sx:{width:"100%"},children:e.jsxs(le,{fullWidth:!0,children:[e.jsx(ce,{children:"Outcome Status"}),e.jsxs(de,{value:fe.status,onChange:a=>W(b=>({...b,status:a.target.value})),label:"Outcome Status",children:[e.jsx(L,{value:"successful",children:"Successful"}),e.jsx(L,{value:"partially_successful",children:"Partially Successful"}),e.jsx(L,{value:"unsuccessful",children:"Unsuccessful"})]})]})}),e.jsx(n,{sx:{width:"100%"},children:e.jsx(X,{fullWidth:!0,label:"Outcome Notes",value:fe.notes,onChange:a=>W(b=>({...b,notes:a.target.value})),multiline:!0,rows:4,required:!0})}),e.jsx(n,{sx:{width:"100%"},children:e.jsx(Xt,{label:"Next Follow-Up Date (Optional)",value:fe.nextFollowUpDate?new Date(fe.nextFollowUpDate):null,onChange:a=>W(b=>({...b,nextFollowUpDate:a?a.toISOString():void 0})),slotProps:{textField:{fullWidth:!0}}})})]})}),e.jsxs(Be,{children:[e.jsx(N,{onClick:()=>S(!1),children:"Cancel"}),e.jsx(N,{onClick:ne,variant:"contained",disabled:y.completeFollowUp,children:"Complete Follow-Up"})]})]}),e.jsxs(Fe,{open:B,onClose:()=>I(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(ze,{children:"Reschedule Follow-Up"}),e.jsx(qe,{children:e.jsxs(n,{sx:{display:"flex",flexWrap:"wrap",gap:2,mt:1},children:[e.jsx(n,{sx:{width:"100%"},children:e.jsx(Xt,{label:"New Date & Time",value:new Date(Se.newDate),onChange:a=>l(b=>({...b,newDate:(a||new Date).toISOString()})),slotProps:{textField:{fullWidth:!0,required:!0}}})}),e.jsx(n,{sx:{width:"100%"},children:e.jsx(X,{fullWidth:!0,label:"Reason for Rescheduling",value:Se.reason,onChange:a=>l(b=>({...b,reason:a.target.value})),multiline:!0,rows:2,required:!0})})]})}),e.jsxs(Be,{children:[e.jsx(N,{onClick:()=>I(!1),children:"Cancel"}),e.jsx(N,{onClick:Te,variant:"contained",disabled:y.rescheduleFollowUp,children:"Reschedule"})]})]})]})})};class gn{constructor(){this.isOnline=navigator.onLine,this.syncInProgress=!1,this.syncListeners=[],this.retryTimeouts=new Map,this.setupEventListeners(),this.startPeriodicSync()}setupEventListeners(){window.addEventListener("online",this.handleOnline.bind(this)),window.addEventListener("offline",this.handleOffline.bind(this))}handleOnline(){this.isOnline=!0,console.log("Connection restored, starting sync..."),this.syncAll()}handleOffline(){this.isOnline=!1,console.log("Connection lost, queuing changes for sync...")}startPeriodicSync(){setInterval(()=>{this.isOnline&&!this.syncInProgress&&this.syncAll()},5*60*1e3)}onSync(t){return this.syncListeners.push(t),()=>{const i=this.syncListeners.indexOf(t);i>-1&&this.syncListeners.splice(i,1)}}notifySyncListeners(t){this.syncListeners.forEach(i=>{try{i(t)}catch(s){console.error("Sync listener error:",s)}})}async queueCreate(t,i){await Re.addToSyncQueue({type:"create",entity:t,data:i})}async queueUpdate(t,i){await Re.addToSyncQueue({type:"update",entity:t,data:i})}async queueDelete(t,i){await Re.addToSyncQueue({type:"delete",entity:t,data:{id:i}})}async syncAll(){if(this.syncInProgress||!this.isOnline)return{success:!1,synced:0,failed:0,errors:["Sync already in progress or offline"]};this.syncInProgress=!0;const t={success:!0,synced:0,failed:0,errors:[]};try{const i=await Re.getSyncQueue();console.log(`Starting sync of ${i.length} items...`);for(const s of i)try{await this.syncItem(s),await Re.removeSyncQueueItem(s.id),t.synced++}catch(j){console.error(`Failed to sync item ${s.id}:`,j),t.failed++,t.errors.push(`${s.entity} ${s.type}: ${j instanceof Error?j.message:"Unknown error"}`),s.retryCount++,s.retryCount<3?(await Re.updateSyncQueueItem(s),this.scheduleRetry(s)):(await Re.removeSyncQueueItem(s.id),t.errors.push(`${s.entity} ${s.type}: Max retries exceeded, item removed`))}t.failed>0&&(t.success=!1),console.log(`Sync completed: ${t.synced} synced, ${t.failed} failed`)}catch(i){console.error("Sync process error:",i),t.success=!1,t.errors.push(i instanceof Error?i.message:"Unknown sync error")}finally{this.syncInProgress=!1,this.notifySyncListeners(t)}return t}async syncItem(t){switch(t.entity){case"patients":await this.syncPatient(t);break;case"medications":await this.syncMedication(t);break;case"problems":await this.syncProblem(t);break;case"therapyPlans":await this.syncTherapyPlan(t);break;case"interventions":await this.syncIntervention(t);break;case"followUps":await this.syncFollowUp(t);break;default:throw new Error(`Unknown entity type: ${t.entity}`)}}async syncPatient(t){switch(t.type){case"create":await Vt.createPatient(t.data);break;case"update":await Vt.updatePatient(t.data._id,t.data);break;case"delete":await Vt.deletePatient(t.data.id);break}}async syncMedication(t){switch(t.type){case"create":case"update":console.log("Medication sync not fully implemented - requires MTR context");break;case"delete":console.log("Medication delete sync not fully implemented");break}}async syncProblem(t){switch(t.type){case"create":await et.addProblem(t.data);break;case"update":await et.updateProblem(t.data._id,t.data);break;case"delete":await et.deleteProblem(t.data.id);break}}async syncTherapyPlan(t){switch(t.type){case"create":await et.createPlan(t.data);break;case"update":await et.updatePlan(t.data.id,t.data);break;case"delete":console.log("Therapy plan delete sync not implemented");break}}async syncIntervention(t){switch(t.type){case"create":await et.recordIntervention(t.data);break;case"update":await et.updateIntervention(t.data._id,t.data);break;case"delete":console.log("Intervention delete sync not implemented");break}}async syncFollowUp(t){switch(t.type){case"create":await et.scheduleFollowUp(t.data);break;case"update":await et.updateFollowUp(t.data._id,t.data);break;case"delete":console.log("Follow-up delete sync not implemented");break}}scheduleRetry(t){const i=this.retryTimeouts.get(t.id);i&&clearTimeout(i);const s=Math.min(1e3*Math.pow(2,t.retryCount),3e4),j=setTimeout(async()=>{if(this.isOnline&&!this.syncInProgress)try{await this.syncItem(t),await Re.removeSyncQueueItem(t.id),console.log(`Retry successful for item ${t.id}`)}catch(d){console.error(`Retry failed for item ${t.id}:`,d),t.retryCount++,t.retryCount<3?(await Re.updateSyncQueueItem(t),this.scheduleRetry(t)):await Re.removeSyncQueueItem(t.id)}this.retryTimeouts.delete(t.id)},s);this.retryTimeouts.set(t.id,j)}async forcSync(){return this.syncAll()}async getSyncStatus(){const t=await Re.getSyncQueue();return{isOnline:this.isOnline,syncInProgress:this.syncInProgress,queueLength:t.length}}async clearSyncQueue(){const t=await Re.getSyncQueue();for(const i of t)await Re.removeSyncQueueItem(i.id)}destroy(){window.removeEventListener("online",this.handleOnline.bind(this)),window.removeEventListener("offline",this.handleOffline.bind(this)),this.retryTimeouts.forEach(t=>clearTimeout(t)),this.retryTimeouts.clear()}}const Jt=new gn,fn=({position:g="top",showDetails:t=!1})=>{var z;const{isMobile:i}=Bt(),[s,j]=p.useState(navigator.onLine),[d,x]=p.useState({isOnline:!0,syncInProgress:!1,queueLength:0}),[f,R]=p.useState(!1),[u,y]=p.useState(null),[M,E]=p.useState(!1);p.useEffect(()=>{const J=()=>j(!0),V=()=>j(!1);window.addEventListener("online",J),window.addEventListener("offline",V);const S=Jt.onSync(D=>{y(D),E(!0),w()});w();const re=setInterval(w,5e3);return()=>{window.removeEventListener("online",J),window.removeEventListener("offline",V),S(),clearInterval(re)}},[]);const w=async()=>{try{const J=await Jt.getSyncStatus();x(J)}catch(J){console.error("Failed to get sync status:",J)}},ee=async()=>{try{await Jt.forcSync()}catch(J){console.error("Manual sync failed:",J)}};if(s&&d.queueLength===0&&!t)return null;const Z=()=>s?d.syncInProgress?"info":d.queueLength>0?"warning":"success":"error",$=()=>s?d.syncInProgress?"Syncing changes...":d.queueLength>0?`${d.queueLength} changes pending sync`:"All changes synced":"Offline - Changes will sync when connected",O=()=>s?d.syncInProgress?e.jsx(ct,{size:20}):d.queueLength>0?e.jsx(Ir,{}):e.jsx(As,{}):e.jsx(es,{});return e.jsxs(e.Fragment,{children:[e.jsx(Nr,{in:!0,children:e.jsxs(oe,{elevation:2,sx:{position:"fixed",[g]:i?8:16,left:i?8:16,right:i?8:"auto",zIndex:1300,borderRadius:2,overflow:"hidden"},children:[e.jsxs(ge,{severity:Z(),icon:O(),action:e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:1},children:[s&&d.queueLength>0&&e.jsx(xe,{size:"small",onClick:ee,disabled:d.syncInProgress,color:"inherit",children:e.jsx(Et,{})}),t&&e.jsx(xe,{size:"small",onClick:()=>R(!f),color:"inherit",children:f?e.jsx(ur,{}):e.jsx(Qe,{})})]}),sx:{"& .MuiAlert-message":{width:"100%"}},children:[e.jsx(r,{variant:"body2",sx:{fontWeight:500},children:$()}),e.jsx(ar,{in:f,children:e.jsxs(n,{sx:{mt:2,pt:2,borderTop:1,borderColor:"divider"},children:[e.jsx(r,{variant:"caption",color:"text.secondary",sx:{display:"block",mb:1},children:"Connection Status"}),e.jsxs(n,{sx:{display:"flex",gap:1,mb:2,flexWrap:"wrap"},children:[e.jsx(K,{size:"small",label:s?"Online":"Offline",color:s?"success":"error",variant:"outlined"}),d.queueLength>0&&e.jsx(K,{size:"small",label:`${d.queueLength} pending`,color:"warning",variant:"outlined"}),d.syncInProgress&&e.jsx(K,{size:"small",label:"Syncing",color:"info",variant:"outlined"})]}),u&&e.jsxs(n,{children:[e.jsx(r,{variant:"caption",color:"text.secondary",sx:{display:"block",mb:1},children:"Last Sync Result"}),e.jsxs(r,{variant:"body2",sx:{mb:1},children:[(u==null?void 0:u.synced)||0," synced,"," ",(u==null?void 0:u.failed)||0," failed"]}),(u==null?void 0:u.errors)&&u.errors.length>0&&e.jsxs(n,{children:[e.jsx(r,{variant:"caption",color:"error.main",children:"Errors:"}),(z=u==null?void 0:u.errors)==null?void 0:z.slice(0,3).map((J,V)=>e.jsxs(r,{variant:"caption",sx:{display:"block",color:"error.main"},children:["• ",J]},V)),(u==null?void 0:u.errors)&&u.errors.length>3&&e.jsxs(r,{variant:"caption",color:"error.main",children:["... and ",u.errors.length-3," more"]})]})]}),s&&e.jsx(N,{size:"small",variant:"outlined",startIcon:e.jsx(Ir,{}),onClick:ee,disabled:d.syncInProgress,sx:{mt:1},children:"Sync Now"})]})})]}),d.syncInProgress&&e.jsx(rt,{sx:{position:"absolute",bottom:0,left:0,right:0,height:2}})]})}),e.jsx(Tr,{open:M,autoHideDuration:4e3,onClose:()=>E(!1),anchorOrigin:{vertical:"bottom",horizontal:"center"},children:e.jsx(ge,{onClose:()=>E(!1),severity:u!=null&&u.success?"success":"error",sx:{width:"100%"},children:u!=null&&u.success?`Sync completed: ${(u==null?void 0:u.synced)||0} items synced`:`Sync failed: ${(u==null?void 0:u.failed)||0} errors`})})]})},yn=[{id:"patient-selection",title:"Patient Selection",content:"Learn how to search for and select patients for MTR. Use filters to find high-risk patients who would benefit most from medication therapy review.",category:"workflow",keywords:["patient","search","selection","filter"]},{id:"medication-history",title:"Medication History Collection",content:"Comprehensive guide to collecting medication information including prescriptions, OTC medications, herbal supplements, and vitamins.",category:"workflow",keywords:["medication","history","collection","otc","supplements"]},{id:"drug-interactions",title:"Drug Interaction Checking",content:"Understanding automated drug interaction alerts, severity levels, and how to assess clinical significance.",category:"features",keywords:["interactions","alerts","severity","clinical"]},{id:"recommendations",title:"Creating Recommendations",content:"Best practices for developing evidence-based therapy recommendations with clear rationale and monitoring plans.",category:"best-practices",keywords:["recommendations","therapy","evidence","monitoring"]},{id:"documentation",title:"Documentation Standards",content:"Guidelines for proper documentation of MTR activities, interventions, and outcomes for regulatory compliance.",category:"best-practices",keywords:["documentation","compliance","audit","standards"]},{id:"system-errors",title:"Troubleshooting System Issues",content:"Common system issues and solutions including connectivity problems, data saving issues, and performance optimization.",category:"troubleshooting",keywords:["errors","troubleshooting","system","performance"]}],bt=[{target:".mtr-dashboard",title:"Welcome to MTR Dashboard",content:"This is your main workspace for conducting medication therapy reviews. The stepper shows your progress through the 6-step MTR process.",placement:"bottom"},{target:".patient-selection",title:"Patient Selection",content:"Start by searching for and selecting a patient. Use the filters to find patients who would benefit from MTR.",placement:"right",action:"Click the search box to begin"},{target:".medication-history",title:"Medication History",content:"Collect comprehensive medication information including prescriptions, OTC drugs, and supplements.",placement:"left"},{target:".therapy-assessment",title:"Therapy Assessment",content:"Review automated alerts and identify drug-related problems. Assess clinical significance and document findings.",placement:"top"},{target:".plan-development",title:"Plan Development",content:"Create evidence-based recommendations to address identified problems. Set therapy goals and monitoring plans.",placement:"bottom"},{target:".interventions",title:"Interventions",content:"Document your actions and communications. Track outcomes and acceptance of recommendations.",placement:"right"},{target:".follow-up",title:"Follow-Up",content:"Schedule appropriate follow-up activities and monitoring to ensure continuity of care.",placement:"left"}],vn=({currentStep:g=0,onStartTour:t})=>{var V;const[i,s]=p.useState(!1),[j,d]=p.useState(!1),[x,f]=p.useState(!1),[R,u]=p.useState(""),[y,M]=p.useState("all"),[E,w]=p.useState(0),ee=yn.filter(S=>{const re=S.title.toLowerCase().includes(R.toLowerCase())||S.content.toLowerCase().includes(R.toLowerCase())||S.keywords.some(B=>B.toLowerCase().includes(R.toLowerCase())),D=y==="all"||S.category===y;return re&&D}),Z=()=>{d(!0),w(0),t==null||t()},$=()=>{E<bt.length-1?w(E+1):d(!1)},O=()=>{E>0&&w(E-1)},z=S=>{switch(S){case"workflow":return"primary";case"features":return"secondary";case"best-practices":return"success";case"troubleshooting":return"error";default:return"default"}},J=S=>{switch(S){case"workflow":return e.jsx(Wr,{});case"features":return e.jsx(pt,{});case"best-practices":return e.jsx(Le,{});case"troubleshooting":return e.jsx(Je,{});default:return e.jsx(pt,{})}};return e.jsxs(e.Fragment,{children:[e.jsx(sr,{color:"primary","aria-label":"help",sx:{position:"fixed",bottom:16,right:16,zIndex:1e3},onClick:()=>s(!0),children:e.jsx(ts,{})}),e.jsxs(rs,{anchor:"right",open:i,onClose:()=>s(!1),sx:{"& .MuiDrawer-paper":{width:400,padding:2}},children:[e.jsxs(n,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsx(r,{variant:"h6",children:"MTR Help & Support"}),e.jsx(xe,{onClick:()=>s(!1),children:e.jsx(Dt,{})})]}),e.jsxs(n,{sx:{mb:2},children:[e.jsx(N,{fullWidth:!0,variant:"contained",startIcon:e.jsx(Rs,{}),onClick:Z,sx:{mb:1},children:"Start Guided Tour"}),e.jsx(N,{fullWidth:!0,variant:"outlined",startIcon:e.jsx(ss,{}),onClick:()=>f(!0),children:"View User Guide"})]}),e.jsx(Ct,{sx:{mb:2}}),g>0&&e.jsxs(n,{sx:{mb:2},children:[e.jsx(r,{variant:"subtitle2",gutterBottom:!0,children:"Current Step Help"}),e.jsx(n,{sx:{p:2,bgcolor:"primary.light",borderRadius:1},children:e.jsx(r,{variant:"body2",color:"primary.contrastText",children:((V=bt[g-1])==null?void 0:V.content)||"Complete this step to continue with your MTR."})})]}),e.jsxs(n,{sx:{mb:2},children:[e.jsx("input",{type:"text",placeholder:"Search help topics...",value:R,onChange:S=>u(S.target.value),style:{width:"100%",padding:"8px",border:"1px solid #ccc",borderRadius:"4px",marginBottom:"8px"}}),e.jsx(n,{sx:{display:"flex",gap:1,flexWrap:"wrap"},children:["all","workflow","features","best-practices","troubleshooting"].map(S=>e.jsx(K,{label:S.replace("-"," "),variant:y===S?"filled":"outlined",size:"small",onClick:()=>M(S)},S))})]}),e.jsx(n,{sx:{flexGrow:1,overflow:"auto"},children:ee.map(S=>e.jsxs(it,{children:[e.jsx(at,{expandIcon:e.jsx(Qe,{}),children:e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:1},children:[J(S.category),e.jsx(r,{variant:"subtitle2",children:S.title}),e.jsx(K,{label:S.category.replace("-"," "),size:"small",color:z(S.category)})]})}),e.jsx(ot,{children:e.jsx(r,{variant:"body2",children:S.content})})]},S.id))})]}),e.jsxs(Fe,{open:j,onClose:()=>d(!1),maxWidth:"md",fullWidth:!0,children:[e.jsxs(ze,{children:["MTR Guided Tour - Step ",E+1," of ",bt.length]}),e.jsx(qe,{children:e.jsx(or,{activeStep:E,orientation:"vertical",children:bt.map((S,re)=>e.jsxs(lr,{children:[e.jsx(cr,{children:S.title}),e.jsxs(hr,{children:[e.jsx(r,{children:S.content}),S.action&&e.jsx(n,{sx:{mt:1},children:e.jsx(K,{label:S.action,color:"primary",size:"small"})})]})]},re))})}),e.jsxs(Be,{children:[e.jsx(N,{onClick:()=>d(!1),children:"Skip Tour"}),e.jsx(N,{onClick:O,disabled:E===0,children:"Previous"}),e.jsx(N,{onClick:$,variant:"contained",children:E===bt.length-1?"Finish":"Next"})]})]}),e.jsxs(Fe,{open:x,onClose:()=>f(!1),maxWidth:"lg",fullWidth:!0,children:[e.jsx(ze,{children:"MTR User Guide"}),e.jsxs(qe,{children:[e.jsx(r,{variant:"h6",gutterBottom:!0,children:"Quick Reference Guide"}),e.jsxs(it,{children:[e.jsx(at,{expandIcon:e.jsx(Qe,{}),children:e.jsx(r,{variant:"subtitle1",children:"MTR Workflow Overview"})}),e.jsx(ot,{children:e.jsxs(Xe,{children:[e.jsxs(De,{children:[e.jsx(Ve,{children:e.jsx(Le,{color:"primary"})}),e.jsx(Ie,{primary:"1. Patient Selection",secondary:"Search and select appropriate patients for MTR"})]}),e.jsxs(De,{children:[e.jsx(Ve,{children:e.jsx(Le,{color:"primary"})}),e.jsx(Ie,{primary:"2. Medication History",secondary:"Collect comprehensive medication information"})]}),e.jsxs(De,{children:[e.jsx(Ve,{children:e.jsx(Le,{color:"primary"})}),e.jsx(Ie,{primary:"3. Therapy Assessment",secondary:"Identify drug-related problems and assess therapy"})]}),e.jsxs(De,{children:[e.jsx(Ve,{children:e.jsx(Le,{color:"primary"})}),e.jsx(Ie,{primary:"4. Plan Development",secondary:"Create evidence-based recommendations"})]}),e.jsxs(De,{children:[e.jsx(Ve,{children:e.jsx(Le,{color:"primary"})}),e.jsx(Ie,{primary:"5. Interventions",secondary:"Document actions and track outcomes"})]}),e.jsxs(De,{children:[e.jsx(Ve,{children:e.jsx(Le,{color:"primary"})}),e.jsx(Ie,{primary:"6. Follow-Up",secondary:"Schedule monitoring and continuity of care"})]})]})})]}),e.jsxs(it,{children:[e.jsx(at,{expandIcon:e.jsx(Qe,{}),children:e.jsx(r,{variant:"subtitle1",children:"Best Practices"})}),e.jsxs(ot,{children:[e.jsx(r,{variant:"body2",paragraph:!0,children:"• Always verify medication information with multiple sources"}),e.jsx(r,{variant:"body2",paragraph:!0,children:"• Focus on clinically significant drug-related problems"}),e.jsx(r,{variant:"body2",paragraph:!0,children:"• Provide clear, evidence-based recommendations"}),e.jsx(r,{variant:"body2",paragraph:!0,children:"• Document thoroughly for regulatory compliance"}),e.jsx(r,{variant:"body2",paragraph:!0,children:"• Follow up on all interventions appropriately"})]})]}),e.jsxs(it,{children:[e.jsx(at,{expandIcon:e.jsx(Qe,{}),children:e.jsx(r,{variant:"subtitle1",children:"Keyboard Shortcuts"})}),e.jsxs(ot,{children:[e.jsxs(r,{variant:"body2",paragraph:!0,children:["• ",e.jsx("strong",{children:"Ctrl + S:"})," Save current progress"]}),e.jsxs(r,{variant:"body2",paragraph:!0,children:["• ",e.jsx("strong",{children:"Ctrl + N:"})," Start new MTR session"]}),e.jsxs(r,{variant:"body2",paragraph:!0,children:["• ",e.jsx("strong",{children:"Ctrl + F:"})," Search patients or medications"]}),e.jsxs(r,{variant:"body2",paragraph:!0,children:["• ",e.jsx("strong",{children:"Tab:"})," Navigate between form fields"]}),e.jsxs(r,{variant:"body2",paragraph:!0,children:["• ",e.jsx("strong",{children:"Esc:"})," Close dialogs or cancel actions"]})]})]})]}),e.jsxs(Be,{children:[e.jsx(N,{onClick:()=>f(!1),children:"Close"}),e.jsx(N,{variant:"contained",onClick:()=>window.open("/docs/MTR_USER_GUIDE.md","_blank"),children:"View Full Guide"})]})]})]})},Ar=g=>({_id:g._id,firstName:g.firstName,lastName:g.lastName,email:g.email,phone:g.phone||"",dateOfBirth:g.dob||"",address:{street:g.address||"",state:g.state||""},allergies:[],createdAt:g.createdAt,updatedAt:g.updatedAt}),He=[{id:0,label:"Patient Selection",description:"Select or create a patient for medication therapy review",component:_r,validationRequired:!0},{id:1,label:"Medication History",description:"Collect comprehensive medication history and current regimen",component:Zs,validationRequired:!0},{id:2,label:"Therapy Assessment",description:"Assess therapy for drug-related problems and interactions",component:nn,validationRequired:!0},{id:3,label:"Plan Development",description:"Develop therapy recommendations and monitoring plans",component:dn,validationRequired:!0},{id:4,label:"Interventions",description:"Document interventions and track outcomes",component:pn,validationRequired:!1},{id:5,label:"Follow-Up",description:"Schedule follow-up activities and monitoring",component:jn,validationRequired:!1}],bn=({patientId:g,reviewId:t,onComplete:i,onCancel:s})=>{var st,nt,yt;const[j,d]=ns(),{isMobile:x,isTablet:f,isSmallMobile:R,getSpacing:u}=Bt(),[y]=p.useState(!0),[M,E]=p.useState(null),[w,ee]=p.useState(!1),[Z,$]=p.useState(!1),[O,z]=p.useState(""),[J,V]=p.useState("info"),[S,re]=p.useState(!1),{currentReview:D,currentStep:B,selectedPatient:I,medications:ie,identifiedProblems:te,interventions:fe,loading:W,errors:Se,goToStep:l,completeStep:Q,saveReview:ue,completeReview:me,cancelReview:Me,createReview:je,loadReview:ve,loadInProgressReview:Ne,getCompletionPercentage:Pe,canCompleteReview:be,getCurrentStepName:ne,getNextStep:Te,clearErrors:o,selectPatient:v,setMedications:_,addProblem:pe,createPlan:We,checkPermissions:ke}=Ee(),m=p.useCallback(async()=>{if(!y){console.log("Auto-save disabled");return}if(!D){console.error("Auto-save skipped: No current review");return}if(W.saveReview){console.log("Auto-save skipped: Save already in progress");return}if(!D._id||D._id.trim()===""){console.error("Auto-save skipped: Review ID is missing or invalid",{hasReview:!!D,reviewId:D._id,reviewKeys:Object.keys(D||{})});return}try{console.log("Auto-saving review with ID:",D._id),await ue(),E(new Date),console.log("Auto-save completed successfully")}catch(T){console.error("Auto-save failed:",T)}},[y,D,W.saveReview,ue]);p.useEffect(()=>{if(!y)return;const T=setInterval(m,3e4);return()=>clearInterval(T)},[m,y]),p.useEffect(()=>{const T=()=>{},F=()=>{};return window.addEventListener("online",T),window.addEventListener("offline",F),()=>{window.removeEventListener("online",T),window.removeEventListener("offline",F)}},[]),p.useEffect(()=>{(async()=>{if(!await ke()){z("You do not have permission to access MTR reviews. Please contact your administrator."),V("error"),$(!0);return}})()},[ke]),p.useEffect(()=>{(async()=>{if(await ke())try{if(t){console.log("Loading existing review with ID:",t),await ve(t);const{currentReview:H}=Ee.getState();console.log("Loaded review:",H!=null&&H._id?"ID present":"ID missing",H?JSON.stringify({id:H._id}):"No review")}else if(g){console.log("Checking for in-progress review for patient:",g);const H=await Ne(g);if(H)console.log("In-progress review found with ID:",H._id);else{console.log("No in-progress review found, creating new one for patient:",g),await je(g);const{currentReview:ye}=Ee.getState();console.log("Created review:",ye!=null&&ye._id?"ID present":"ID missing",ye?JSON.stringify({id:ye._id}):"No review")}}}catch(H){console.error("Error initializing MTR session:",H),z(`Failed to initialize MTR session: ${H instanceof Error?H.message:"Unknown error"}`),V("error"),$(!0)}})()},[t,g,ve,je,Ne,ke]),p.useEffect(()=>{if(!D)return;const T=j.get("step"),F=T?parseInt(T,10):null;if(console.log("URL sync effect - currentStep:",B,"urlStep:",F),F!==B){console.log("Updating URL to step:",B);const H=new URLSearchParams(j);H.set("step",B.toString()),d(H,{replace:!0})}},[B,D,j,d]),p.useEffect(()=>{if(!D){console.log("Auto-save skipped: No current review");return}if(D.status==="completed"){console.log("Auto-save skipped: Review already completed");return}console.log("Setting up auto-save for review:",JSON.stringify({id:D._id,status:D.status}));const T=setInterval(async()=>{try{const{currentReview:F}=Ee.getState();if(!F){console.error("Auto-save skipped: No current review available");return}if(!F._id||F._id.trim()===""){console.error("Auto-save skipped: Review ID is missing or invalid",{hasReview:!!F,reviewId:F._id,reviewKeys:Object.keys(F||{})});return}console.log("Auto-saving review with ID:",F._id),await ue(),console.log("Auto-save completed")}catch(F){console.error("Auto-save failed:",F)}},3e4);return()=>clearInterval(T)},[D,ue]),p.useEffect(()=>{const T=F=>{if(!D){console.log("No review to save before unload");return}if(!y){console.log("Auto-save disabled, skipping save before unload");return}if(!D._id){console.error("Cannot save before unload - Review ID is missing");return}console.log("Attempting to save review before unload:",D._id),m();const H="You have unsaved changes. Are you sure you want to leave?";return F.returnValue=H,H};return window.addEventListener("beforeunload",T),()=>window.removeEventListener("beforeunload",T)},[D,y,m]);const h=async()=>{var H;let T=!1,F="";switch(B){case 0:I||(T=!0,F="Please select a patient first");break}if(T){z(F),V("warning"),$(!0);return}try{if(await Q(B,{completedAt:new Date().toISOString(),stepName:((H=He[B])==null?void 0:H.label)||"Unknown Step"}),B<He.length-1){const ye=B+1;l(ye)}z("Step completed successfully"),V("success"),$(!0)}catch(ye){console.error("Error completing step:",ye),z("Failed to complete step"),V("error"),$(!0)}},a=()=>{if(B>0){const T=B-1;l(T)}},b=T=>{const F=Te();T<=(F??He.length-1)&&l(T)},G=async()=>{try{if(!D){z("Cannot save - No active review"),V("error"),$(!0);return}if(!D._id){z("Cannot save - Review ID is missing"),V("error"),$(!0),console.error("Cannot save review - ID is missing",D);return}console.log("🔍 Manual save triggered - Current review state:",{id:D._id,status:D.status,stepsCompleted:D.steps?Object.entries(D.steps).map(([T,F])=>({step:T,completed:F.completed})):"No steps",canComplete:be(),loadingSave:W.saveReview}),await ue(),E(new Date),z("Review saved successfully"),V("success"),$(!0)}catch(T){console.error("Save error:",T),z(`Failed to save review: ${T instanceof Error?T.message:"Unknown error"}`),V("error"),$(!0)}},we=async()=>{if(!be()){z("Please complete all required steps before finishing the review"),V("warning"),$(!0);return}if(!D){z("Cannot complete - No active review"),V("error"),$(!0);return}let T=D;if(console.log("Current review for completion:",{hasReview:!!D,reviewId:D==null?void 0:D._id,steps:!!(D!=null&&D.steps),urlReviewId:t}),(!D._id||D._id==="")&&D.steps){z("Attempting to recover review ID..."),V("info"),$(!0),console.warn("Review missing ID but has data - attempting recovery",D);try{const{currentReview:F}=Ee.getState();if(F&&F._id)console.log("Found review ID in store:",F._id),T=F;else if(t){console.log("Attempting to reload review using URL ID:",t);try{await ve(t);const{currentReview:H}=Ee.getState();if(H&&H._id)console.log("Successfully reloaded review with ID:",H._id),T=H;else{console.error("Failed to reload review with valid ID"),z("Cannot complete - Unable to recover review ID"),V("error"),$(!0);return}}catch(H){console.error("Error reloading review:",H),z("Cannot complete - Failed to reload review"),V("error"),$(!0);return}}else{console.error("Could not recover review ID from store or URL"),z("Cannot complete - Review ID is missing and cannot be recovered"),V("error"),$(!0);return}}catch(F){console.error("Error trying to recover review ID:",F),z("Cannot complete - Error during recovery attempt"),V("error"),$(!0);return}}try{if(!T._id)if(console.error("Cannot complete review - ID is missing",T),t)console.log("Last resort recovery: Using reviewId from URL params:",t),T._id=t,console.log("Updated reviewToComplete with URL ID:",T);else{z("Cannot complete - Review ID is still missing after recovery attempts"),V("error"),$(!0);return}if(console.log("Saving review before completing with ID:",T._id),await ue(),console.log("Completing review with ID:",T._id),await me(T._id))z("MTR completed successfully"),V("success"),$(!0),i&&i(T._id);else throw new Error("Complete operation did not return expected result")}catch(F){console.error("Failed to complete review:",F),z(`Failed to complete review: ${F instanceof Error?F.message:"Unknown error"}`),V("error"),$(!0)}},Ue=()=>{ee(!0)},gt=async()=>{try{await Me(),ee(!1),s&&s()}catch{z("Failed to cancel review"),V("error"),$(!0)}},ft=p.useCallback(T=>{_(T)},[_]),k=p.useCallback(T=>{v(Ar(T))},[v]),q=p.useCallback(T=>{T.forEach(F=>pe(F))},[pe]),he=p.useCallback(T=>{We(T)},[We]),Ae=p.useCallback(T=>{console.log("Intervention recorded:",T)},[]),Ze=p.useCallback(T=>{console.log("Follow-up scheduled:",T)},[]),c=()=>{const T=He[B];if(!T)return null;const F=T.component,H={onNext:h,onBack:B>0?a:void 0};switch(B){case 0:return e.jsx(F,{...H,onPatientSelect:k,selectedPatient:I||void 0});case 1:return e.jsx(F,{...H,patientId:I==null?void 0:I._id,onMedicationsUpdate:ft});case 2:return e.jsx(F,{...H,patientId:I==null?void 0:I._id,medications:ie,patientInfo:I?{age:0,gender:"unknown",conditions:[],allergies:[]}:void 0,onProblemsIdentified:q});case 3:return e.jsx(F,{...H,patientId:I==null?void 0:I._id,problems:te,onPlanCreated:he});case 4:return e.jsx(F,{...H,reviewId:D==null?void 0:D._id,patientId:I==null?void 0:I._id,onInterventionRecorded:Ae});case 5:return e.jsx(F,{...H,reviewId:D==null?void 0:D._id,patientId:I==null?void 0:I._id,interventions:fe,onFollowUpScheduled:Ze});default:return null}},C=T=>{if(!D||!D.steps)return"pending";const F=["patientSelection","medicationHistory","therapyAssessment","planDevelopment","interventions","followUp"];try{const H=F[T],ye=D.steps[H];return ye!=null&&ye.completed?"completed":T===B?"active":T<B?"completed":"pending"}catch(H){return console.error("Error determining step status:",H),"pending"}},A=Pe();if(W.createReview||W.loadReview)return e.jsx(Ye,{maxWidth:"lg",sx:{py:4},children:e.jsxs(n,{sx:{display:"flex",flexDirection:"column",alignItems:"center",gap:2},children:[e.jsx(rt,{sx:{width:"100%",maxWidth:400}}),e.jsx(r,{variant:"body1",color:"text.secondary",children:W.createReview?"Creating MTR session...":"Loading MTR session..."})]})});if(Se.createReview||Se.loadReview)return e.jsx(Ye,{maxWidth:"lg",sx:{py:4},children:e.jsx(ge,{severity:"error",action:e.jsx(N,{color:"inherit",size:"small",onClick:()=>o(),children:"Retry"}),children:Se.createReview||Se.loadReview})});if(!D)return e.jsxs(Ye,{maxWidth:"lg",sx:{py:4},children:[e.jsx(r,{variant:"h5",sx:{mb:3,fontWeight:600},children:"Start New Medication Therapy Review"}),e.jsx(se,{children:e.jsx(ae,{sx:{p:3},children:e.jsx(_r,{onPatientSelect:T=>{console.log("Patient selected:",T),v(Ar(T)),je(T._id)},onNext:()=>{console.log("Moving to next step"),l(1)},selectedPatient:I?{...I,pharmacyId:"default-pharmacy",mrn:I._id,dob:I.dateOfBirth,address:((st=I.address)==null?void 0:st.street)||"",state:((nt=I.address)==null?void 0:nt.state)||void 0}:null})})})]});const Y=()=>e.jsx(ws,{anchor:"bottom",open:S,onClose:()=>re(!1),onOpen:()=>re(!0),disableSwipeToOpen:!1,PaperProps:{sx:{borderTopLeftRadius:16,borderTopRightRadius:16,maxHeight:"70vh"}},children:e.jsxs(n,{sx:{p:2},children:[e.jsx(r,{variant:"h6",sx:{mb:2,textAlign:"center"},children:"MTR Steps"}),e.jsx(Xe,{children:He.map((T,F)=>{const H=C(F),ye=F<=(Te()??He.length-1);return e.jsxs(De,{component:"div",onClick:()=>{ye&&(b(F),re(!1))},sx:{cursor:ye?"pointer":"default",borderRadius:1,mb:1,bgcolor:H==="active"?"primary.50":H==="completed"?"success.50":"transparent"},children:[e.jsx(Ve,{children:H==="completed"?e.jsx(gr,{color:"success"}):H==="active"?e.jsx(r,{variant:"body2",sx:{width:24,height:24,borderRadius:"50%",bgcolor:"primary.main",color:"white",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"0.75rem"},children:F+1}):e.jsx(r,{variant:"body2",sx:{width:24,height:24,borderRadius:"50%",border:1,borderColor:"grey.300",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"0.75rem"},children:F+1})}),e.jsx(Ie,{primary:T.label,secondary:T.description,primaryTypographyProps:{fontWeight:H==="active"?600:400}})]},T.id)})})]})});return e.jsxs(Lr,{children:[e.jsx(fn,{position:"top",showDetails:!x}),x&&e.jsx(is,{position:"sticky",elevation:1,children:e.jsxs(as,{children:[e.jsx(xe,{edge:"start",color:"inherit",onClick:()=>re(!0),sx:{mr:2},children:e.jsx(_t,{})}),e.jsxs(n,{sx:{flexGrow:1},children:[e.jsxs(r,{variant:"h6",noWrap:!0,children:["MTR - Step ",B+1]}),e.jsx(r,{variant:"caption",sx:{opacity:.8},children:(yt=He[B])==null?void 0:yt.label})]}),e.jsx(K,{label:`${Math.round(A)}%`,size:"small",sx:{bgcolor:"rgba(255,255,255,0.2)",color:"white"}})]})}),e.jsxs(Ye,{maxWidth:"lg",sx:{py:x?1:2,px:x?1:3},children:[!x&&e.jsxs(oe,{sx:{p:u(2,3,3),mb:u(2,3,3)},children:[e.jsxs(n,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:2,flexDirection:f?"column":"row",gap:f?2:0},children:[e.jsxs(n,{sx:{textAlign:f?"center":"left"},children:[e.jsx(r,{variant:f?"h5":"h4",sx:{fontWeight:600,mb:1},children:"Medication Therapy Review"}),e.jsxs(r,{variant:"body1",color:"text.secondary",children:[D.reviewNumber," • ",ne()]}),I&&e.jsxs(r,{variant:"body2",color:"text.secondary",sx:{mt:.5},children:["Patient: ",I.firstName," ",I.lastName," (ID: ",I._id,")"]})]}),e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap",justifyContent:f?"center":"flex-end"},children:[e.jsx(K,{label:`${Math.round(A)}% Complete`,color:A===100?"success":"primary",variant:"outlined"}),D&&D.status&&e.jsx(K,{label:D.status.replace("_"," ").toUpperCase(),color:D.status==="completed"?"success":"default",size:"small"})]})]}),e.jsx(n,{sx:{mb:2},children:e.jsx(rt,{variant:"determinate",value:A,sx:{height:8,borderRadius:4,bgcolor:"grey.200","& .MuiLinearProgress-bar":{borderRadius:4}}})}),M&&e.jsxs(r,{variant:"caption",color:"text.secondary",children:["Last saved: ",M.toLocaleTimeString()]})]}),e.jsxs(n,{sx:{display:"flex",gap:u(1,2,3),flexDirection:x?"column":"row"},children:[!x&&e.jsx(oe,{sx:{p:u(1,2,2),minWidth:f?280:300,maxWidth:f?320:350,height:"fit-content",position:"sticky",top:20},children:e.jsx(or,{activeStep:B,orientation:"vertical",sx:{"& .MuiStepLabel-root":{cursor:"pointer"}},children:He.map((T,F)=>{const H=C(F),ye=F<=(Te()??He.length-1);return e.jsxs(lr,{completed:H==="completed",children:[e.jsxs(cr,{onClick:()=>ye&&b(F),sx:{cursor:ye?"pointer":"default",opacity:ye?1:.6},StepIconProps:{sx:{color:H==="completed"?"success.main":H==="active"?"primary.main":"grey.400"}},children:[e.jsx(r,{variant:"body2",sx:{fontWeight:H==="active"?600:400},children:T.label}),e.jsx(r,{variant:"caption",color:"text.secondary",children:T.description})]}),e.jsx(hr,{children:e.jsx(n,{sx:{py:1},children:e.jsx(r,{variant:"caption",color:"text.secondary",children:T.description})})})]},T.id)})})}),e.jsx(n,{sx:{flexGrow:1,minHeight:x?"auto":600,width:x?"100%":"auto"},children:e.jsx(oe,{sx:{p:u(1,2,3),minHeight:x?"auto":"100%",borderRadius:x?2:1},children:c()})})]}),x&&Y(),e.jsx(oe,{sx:{p:u(1,2,2),mt:u(2,3,3),position:x?"sticky":"static",bottom:x?0:"auto",zIndex:x?1e3:"auto",borderRadius:x?"16px 16px 0 0":1},children:e.jsxs(n,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",flexDirection:x?"column":"row",gap:x?2:0},children:[e.jsxs(n,{sx:{display:"flex",gap:1,width:x?"100%":"auto",justifyContent:x?"center":"flex-start"},children:[e.jsx(N,{variant:"outlined",onClick:Ue,disabled:W.cancelReview,size:x?"large":"medium",sx:{minWidth:x?120:"auto"},children:"Cancel"}),e.jsx(N,{variant:"outlined",startIcon:e.jsx(rr,{}),onClick:G,disabled:W.saveReview,size:x?"large":"medium",sx:{minWidth:x?120:"auto"},children:W.saveReview?"Saving...":"Save"})]}),e.jsxs(n,{sx:{display:"flex",gap:1,width:x?"100%":"auto",justifyContent:x?"center":"flex-end"},children:[e.jsx(N,{variant:"outlined",startIcon:e.jsx(Ps,{}),onClick:a,disabled:B===0,size:x?"large":"medium",sx:{minWidth:x?120:"auto"},children:"Back"}),B<He.length-1?e.jsx(N,{variant:"contained",endIcon:e.jsx(zt,{}),onClick:h,disabled:W.completeStep,size:x?"large":"medium",sx:{minWidth:x?140:"auto"},children:"Next"}):e.jsx(N,{variant:"contained",color:"success",startIcon:e.jsx(gr,{}),onClick:we,disabled:!be()||W.completeReview,size:x?"large":"medium",sx:{minWidth:x?140:"auto"},children:W.completeReview?"Completing...":"Complete Review"})]})]})}),x&&e.jsxs(e.Fragment,{children:[e.jsx(sr,{color:"primary",sx:{position:"fixed",bottom:80,right:16,zIndex:1e3},onClick:G,disabled:W.saveReview,size:"medium",children:e.jsx(rr,{})}),e.jsx(sr,{color:"secondary",sx:{position:"fixed",bottom:140,right:16,zIndex:1e3},onClick:()=>re(!0),size:"small",children:e.jsx(_t,{})})]}),e.jsxs(Fe,{open:w,onClose:()=>ee(!1),maxWidth:"sm",fullWidth:!0,fullScreen:R,children:[e.jsx(ze,{children:"Cancel MTR Session?"}),e.jsx(qe,{children:e.jsx(r,{children:"Are you sure you want to cancel this MTR session? Any unsaved changes will be lost."})}),e.jsxs(Be,{sx:{flexDirection:x?"column":"row",gap:x?1:0,p:x?2:1},children:[e.jsx(N,{onClick:()=>ee(!1),fullWidth:x,size:x?"large":"medium",children:"Continue Working"}),e.jsx(N,{onClick:gt,color:"error",variant:"contained",fullWidth:x,size:x?"large":"medium",children:"Cancel Session"})]})]}),e.jsx(Tr,{open:Z,autoHideDuration:6e3,onClose:()=>$(!1),anchorOrigin:{vertical:x?"top":"bottom",horizontal:x?"center":"left"},sx:{...x&&{top:80}},children:e.jsx(ge,{onClose:()=>$(!1),severity:J,sx:{width:"100%",...x&&{borderRadius:2}},children:O})}),e.jsx(vn,{currentStep:B+1,onStartTour:()=>{l(0)}}),B>=0&&B<He.length&&e.jsx(n,{sx:{position:"fixed",bottom:80,left:16,width:300,zIndex:999,display:{xs:"none",md:"block"}},children:e.jsx(Cs,{step:B+1})})]})]})},wn=()=>{var Z,$;const g=kr(),{reviewId:t}=Pr(),{currentReview:i,selectedPatient:s,identifiedProblems:j,therapyPlan:d,interventions:x,followUps:f,loading:R,errors:u,loadReview:y}=Ee();p.useEffect(()=>{t&&t!==(i==null?void 0:i._id)&&y(t)},[t,i==null?void 0:i._id,y]);const M=()=>{g("/pharmacy/medication-therapy")},E=()=>{g("/pharmacy/medication-therapy/new")},w=()=>{window.print()},ee=()=>{console.log("Download MTR report")};return R.loadReview?e.jsx(Ye,{maxWidth:"lg",sx:{py:4},children:e.jsx(r,{children:"Loading MTR summary..."})}):u.general||!i?e.jsxs(Ye,{maxWidth:"lg",sx:{py:4},children:[e.jsx(ge,{severity:"error",children:u.general||"MTR session not found"}),e.jsx(N,{startIcon:e.jsx(nr,{}),onClick:M,sx:{mt:2},children:"Back to Overview"})]}):e.jsxs(Ye,{maxWidth:"lg",sx:{py:4},children:[e.jsxs(tr,{"aria-label":"breadcrumb",separator:e.jsx(zt,{fontSize:"small"}),sx:{mb:3},children:[e.jsx(ut,{component:ht,to:"/dashboard",color:"inherit",children:"Dashboard"}),e.jsx(ut,{component:ht,to:"/pharmacy/medication-therapy",color:"inherit",children:"Medication Therapy Review"}),e.jsxs(r,{color:"textPrimary",children:["Summary - Review #",i.reviewNumber]})]}),e.jsxs(n,{sx:{mb:4,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs(n,{children:[e.jsx(r,{variant:"h4",gutterBottom:!0,children:"MTR Summary"}),e.jsxs(r,{variant:"subtitle1",color:"textSecondary",children:[s&&`${s.firstName} ${s.lastName}`," ","• Review #",i.reviewNumber," • Completed on"," ",new Date(i.completedAt||"").toLocaleDateString()]})]}),e.jsxs(n,{sx:{display:"flex",gap:1},children:[e.jsx(N,{startIcon:e.jsx(Ds,{}),onClick:w,variant:"outlined",children:"Print"}),e.jsx(N,{startIcon:e.jsx(Is,{}),onClick:ee,variant:"outlined",children:"Download"})]})]}),i&&i.status&&e.jsx(n,{sx:{mb:3},children:e.jsx(K,{icon:e.jsx(Le,{}),label:`Status: ${i.status.replace("_"," ").toUpperCase()}`,color:"success",variant:"outlined",size:"large"})}),e.jsxs(vt,{container:!0,spacing:3,children:[e.jsx(vt,{item:!0,xs:12,md:6,children:e.jsx(se,{children:e.jsxs(ae,{children:[e.jsx(r,{variant:"h6",gutterBottom:!0,children:"Review Overview"}),e.jsxs(Xe,{dense:!0,children:[e.jsxs(De,{children:[e.jsx(Ve,{children:e.jsx(Ot,{})}),e.jsx(Ie,{primary:"Review Type",secondary:((Z=i.reviewType)==null?void 0:Z.replace("_"," ").toUpperCase())||"Standard"})]}),e.jsxs(De,{children:[e.jsx(Ve,{children:e.jsx(dr,{})}),e.jsx(Ie,{primary:"Duration",secondary:i.startedAt&&i.completedAt?`${Math.round((new Date(i.completedAt).getTime()-new Date(i.startedAt).getTime())/(1e3*60))} minutes`:"N/A"})]}),e.jsxs(De,{children:[e.jsx(Ve,{children:e.jsx(Ms,{})}),e.jsx(Ie,{primary:"Medications Reviewed",secondary:`${(($=i.medications)==null?void 0:$.length)||0} medications`})]})]})]})})}),e.jsx(vt,{item:!0,xs:12,md:6,children:e.jsx(se,{children:e.jsxs(ae,{children:[e.jsx(r,{variant:"h6",gutterBottom:!0,children:"Clinical Outcomes"}),e.jsxs(Xe,{dense:!0,children:[e.jsx(De,{children:e.jsx(Ie,{primary:"Problems Identified",secondary:`${(j==null?void 0:j.length)||0} drug therapy problems`})}),e.jsx(De,{children:e.jsx(Ie,{primary:"Interventions Made",secondary:`${(x==null?void 0:x.length)||0} pharmacist interventions`})}),e.jsx(De,{children:e.jsx(Ie,{primary:"Follow-ups Scheduled",secondary:`${(f==null?void 0:f.length)||0} follow-up activities`})}),e.jsx(De,{children:e.jsx(Ie,{primary:"Next Review Date",secondary:i.nextReviewDate?new Date(i.nextReviewDate).toLocaleDateString():"Not scheduled"})})]})]})})}),j&&j.length>0&&e.jsx(vt,{item:!0,xs:12,children:e.jsx(se,{children:e.jsxs(ae,{children:[e.jsx(r,{variant:"h6",gutterBottom:!0,children:"Identified Drug Therapy Problems"}),e.jsx(Ct,{sx:{mb:2}}),j.map((O,z)=>{var J,V;return e.jsxs(oe,{sx:{p:2,mb:2},children:[e.jsxs(n,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:1},children:[e.jsxs(r,{variant:"subtitle1",fontWeight:"bold",children:[(J=O.category)==null?void 0:J.replace("_"," ").toUpperCase()," -"," ",O.subcategory]}),e.jsx(K,{label:O.severity,color:O.severity==="critical"?"error":O.severity==="major"?"warning":O.severity==="moderate"?"info":"default",size:"small"})]}),e.jsx(r,{variant:"body2",color:"textSecondary",paragraph:!0,children:O.description}),e.jsxs(r,{variant:"body2",children:[e.jsx("strong",{children:"Clinical Significance:"})," ",O.clinicalSignificance]}),e.jsxs(r,{variant:"body2",children:[e.jsx("strong",{children:"Status:"})," ",(V=O.status)==null?void 0:V.replace("_"," ").toUpperCase()]})]},O._id||z)})]})})}),d&&e.jsx(vt,{item:!0,xs:12,children:e.jsx(se,{children:e.jsxs(ae,{children:[e.jsx(r,{variant:"h6",gutterBottom:!0,children:"Therapy Plan & Recommendations"}),e.jsx(Ct,{sx:{mb:2}}),d.recommendations&&d.recommendations.length>0&&e.jsxs(n,{sx:{mb:3},children:[e.jsx(r,{variant:"subtitle1",fontWeight:"bold",gutterBottom:!0,children:"Recommendations"}),d.recommendations.map((O,z)=>{var J;return e.jsxs(oe,{sx:{p:2,mb:1},children:[e.jsxs(n,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx(r,{variant:"body1",fontWeight:"medium",children:(J=O.type)==null?void 0:J.replace("_"," ").toUpperCase()}),e.jsx(K,{label:O.priority,color:O.priority==="high"?"error":O.priority==="medium"?"warning":"default",size:"small"})]}),e.jsx(r,{variant:"body2",sx:{mt:1},children:O.rationale}),O.expectedOutcome&&e.jsxs(r,{variant:"body2",color:"textSecondary",sx:{mt:1},children:[e.jsx("strong",{children:"Expected Outcome:"})," ",O.expectedOutcome]})]},z)})]}),d.counselingPoints&&d.counselingPoints.length>0&&e.jsxs(n,{sx:{mb:3},children:[e.jsx(r,{variant:"subtitle1",fontWeight:"bold",gutterBottom:!0,children:"Patient Counseling Points"}),e.jsx(Xe,{dense:!0,children:d.counselingPoints.map((O,z)=>e.jsx(De,{children:e.jsx(Ie,{primary:O})},z))})]}),d.pharmacistNotes&&e.jsxs(n,{children:[e.jsx(r,{variant:"subtitle1",fontWeight:"bold",gutterBottom:!0,children:"Pharmacist Notes"}),e.jsx(r,{variant:"body2",children:d.pharmacistNotes})]})]})})})]}),e.jsxs(n,{sx:{mt:4,display:"flex",gap:2,justifyContent:"center"},children:[e.jsx(N,{startIcon:e.jsx(nr,{}),onClick:M,variant:"outlined",size:"large",children:"Back to Overview"}),e.jsx(N,{onClick:E,variant:"contained",size:"large",children:"Start New MTR"})]})]})},mi=()=>{const g=kr(),{reviewId:t,patientId:i}=Pr(),s=window.location.pathname.includes("/summary"),{currentReview:j,selectedPatient:d,errors:x,loadReview:f,createReview:R,clearStore:u}=Ee(),[y,M]=p.useState(!1),[E,w]=p.useState(!1);p.useEffect(()=>((async()=>{if(t){w(!0);try{await f(t),M(!0)}catch(O){console.error("Failed to load MTR session:",O)}finally{w(!1)}}else if(i){w(!0);try{await R(i),M(!0)}catch(O){console.error("Failed to create MTR session:",O)}finally{w(!1)}}else M(!0)})(),()=>{!t&&!i&&!window.location.pathname.includes("/medication-therapy")&&u()}),[t,i,f,R,u]);const ee=$=>{g(`/pharmacy/medication-therapy/${$}/summary`)},Z=()=>{g("/pharmacy/medication-therapy")};return E?e.jsxs(Ye,{maxWidth:"lg",sx:{py:4},children:[e.jsxs(tr,{"aria-label":"breadcrumb",separator:e.jsx(zt,{fontSize:"small"}),sx:{mb:3},children:[e.jsx(ut,{component:ht,to:"/dashboard",color:"inherit",children:"Dashboard"}),e.jsx(ut,{component:ht,to:"/pharmacy/medication-therapy",color:"inherit",children:"Medication Therapy Review"}),e.jsx(r,{color:"textPrimary",children:"Loading..."})]}),e.jsxs(n,{sx:{mb:4},children:[e.jsx(Qt,{variant:"text",width:"60%",height:40}),e.jsx(Qt,{variant:"text",width:"40%",height:24,sx:{mt:1}})]}),e.jsx(Qt,{variant:"rectangular",height:400})]}):s&&t?e.jsx(wn,{}):y?e.jsx(Lr,{children:e.jsxs(Ye,{maxWidth:"xl",sx:{py:2},children:[e.jsxs(tr,{"aria-label":"breadcrumb",separator:e.jsx(zt,{fontSize:"small"}),sx:{mb:3},children:[e.jsx(ut,{component:ht,to:"/dashboard",color:"inherit",children:"Dashboard"}),e.jsx(ut,{component:ht,to:"/pharmacy/medication-therapy",color:"inherit",children:"Medication Therapy Review"}),d&&e.jsxs(r,{color:"textPrimary",children:[d.firstName," ",d.lastName]}),j&&e.jsxs(r,{color:"textPrimary",children:["Review #",j.reviewNumber]})]}),e.jsxs(n,{sx:{mb:3,display:"flex",alignItems:"center",gap:2},children:[e.jsx(N,{startIcon:e.jsx(nr,{}),onClick:Z,variant:"outlined",size:"sm",children:"Back to Overview"}),j&&j.status&&e.jsx(K,{label:`Status: ${j.status.replace("_"," ").toUpperCase()}`,color:j.status==="completed"?"success":"primary",variant:"outlined"})]}),x.general&&e.jsx(ge,{severity:"error",sx:{mb:3},children:x.general}),e.jsx(bn,{patientId:i,reviewId:t,onComplete:ee,onCancel:Z})]})}):e.jsx(Ye,{maxWidth:"lg",sx:{py:4},children:e.jsx(ge,{severity:"warning",children:"MTR session initialization failed. Please refresh the page."})})};export{mi as default};
