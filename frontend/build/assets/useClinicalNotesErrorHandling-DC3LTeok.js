import{r as l,j as s,B as O,Q as L,D as N,b8 as B,l as V,T as A,L as _,n as z,ar as W,w as H,p as G,aa as U,h as R,R as $,aX as Y,aW as q,aR as J,aS as Q,aT as X,a5 as Z,aU as K,bl as ee,ba as b}from"./index-B_pWc9hu.js";import{A as te}from"./ArrowBack-bh5q612l.js";import{H as se}from"./Home-C8eDz3RN.js";import{E as re}from"./ExpandLess-CfW7CJI2.js";import{B as ae}from"./BugReport-CefgtFkV.js";class he extends l.Component{constructor(){super(...arguments),this.retryCount=0,this.maxRetries=3,this.state={hasError:!1,errorId:"",showDetails:!1,showReportDialog:!1,reportDescription:"",isReporting:!1},this.logErrorToService=(e,t)=>{const a={errorId:this.state.errorId,message:e.message,stack:e.stack,componentStack:t.componentStack,context:this.props.context||"clinical-notes",timestamp:new Date().toISOString(),userAgent:navigator.userAgent,url:window.location.href,retryCount:this.retryCount};console.error("Clinical Notes Error:",a)},this.handleRetry=()=>{this.retryCount<this.maxRetries?(this.retryCount++,this.setState({hasError:!1,error:void 0,errorInfo:void 0,showDetails:!1})):this.handleReload()},this.handleReload=()=>{window.location.reload()},this.handleGoHome=()=>{window.location.href="/dashboard"},this.handleGoBack=()=>{window.history.back()},this.handleReportError=async()=>{var e,t,a;this.setState({isReporting:!0});try{const o={errorId:this.state.errorId,description:this.state.reportDescription,error:(e=this.state.error)==null?void 0:e.message,stack:(t=this.state.error)==null?void 0:t.stack,componentStack:(a=this.state.errorInfo)==null?void 0:a.componentStack,context:this.props.context||"clinical-notes",timestamp:new Date().toISOString(),userAgent:navigator.userAgent,url:window.location.href};console.log("Error report submitted:",o),this.setState({showReportDialog:!1,reportDescription:"",isReporting:!1}),alert("Error report submitted successfully. Thank you for helping us improve!")}catch(o){console.error("Failed to submit error report:",o),this.setState({isReporting:!1}),alert("Failed to submit error report. Please try again later.")}},this.getRecoveryInstructions=()=>{const e=this.state.error;return e?e.message.includes("ChunkLoadError")||e.message.includes("Loading chunk")?["This appears to be a loading issue","Clear your browser cache and cookies","Refresh the page","If the problem persists, try using an incognito/private window"]:e.message.includes("Network")||e.message.includes("fetch")?["Check your internet connection","Try refreshing the page","If you're on a corporate network, contact your IT department","Try again in a few minutes"]:e.message.includes("Permission")||e.message.includes("Unauthorized")?["You may not have permission to access this feature","Try logging out and logging back in","Contact your administrator if the problem persists"]:["Try the action again","Refresh the page if the problem persists","Clear your browser cache if needed","Contact support if the issue continues"]:["Try refreshing the page"]}}static getDerivedStateFromError(e){const t=`CN_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;return{hasError:!0,error:e,errorId:t}}componentDidCatch(e,t){console.error("ClinicalNotesErrorBoundary caught an error:",e,t),this.setState({error:e,errorInfo:t}),this.props.onError&&this.props.onError(e,t),this.logErrorToService(e,t)}render(){var e,t,a;if(this.state.hasError){if(this.props.fallback)return this.props.fallback;const o=this.getRecoveryInstructions(),i=this.retryCount<this.maxRetries;return s.jsx(O,{sx:{display:"flex",alignItems:"center",justifyContent:"center",minHeight:"400px",p:3,bgcolor:"background.default"},children:s.jsxs(L,{sx:{p:4,maxWidth:600,width:"100%"},children:[s.jsxs(N,{severity:"error",sx:{mb:3},children:[s.jsx(B,{children:s.jsxs(O,{sx:{display:"flex",alignItems:"center",gap:1},children:["Clinical Notes Error",s.jsx(V,{label:`ID: ${this.state.errorId}`,size:"small",variant:"outlined"})]})}),s.jsxs(A,{variant:"body2",sx:{mt:1},children:["An error occurred while loading the clinical notes module.",i?" You can try again or ":" Please ","follow the recovery steps below."]})]}),s.jsxs(O,{sx:{mb:3},children:[s.jsx(A,{variant:"h6",gutterBottom:!0,children:"Recovery Steps:"}),s.jsx(_,{dense:!0,children:o.map((h,E)=>s.jsxs(z,{sx:{py:.25,pl:0},children:[s.jsx(W,{sx:{minWidth:24},children:s.jsx(H,{fontSize:"small",color:"primary"})}),s.jsx(G,{primary:h,primaryTypographyProps:{variant:"body2"}})]},E))})]}),s.jsxs(U,{direction:"row",spacing:2,sx:{mb:3},children:[i&&s.jsxs(R,{variant:"contained",startIcon:s.jsx($,{}),onClick:this.handleRetry,children:["Try Again (",this.maxRetries-this.retryCount," attempts left)"]}),s.jsx(R,{variant:"outlined",startIcon:s.jsx($,{}),onClick:this.handleReload,children:"Reload Page"}),s.jsx(R,{variant:"outlined",startIcon:s.jsx(te,{}),onClick:this.handleGoBack,children:"Go Back"}),s.jsx(R,{variant:"outlined",startIcon:s.jsx(se,{}),onClick:this.handleGoHome,children:"Dashboard"})]}),s.jsxs(O,{sx:{mb:2},children:[s.jsxs(R,{size:"small",startIcon:this.state.showDetails?s.jsx(re,{}):s.jsx(Y,{}),onClick:()=>this.setState({showDetails:!this.state.showDetails}),children:[this.state.showDetails?"Hide":"Show"," Technical Details"]}),s.jsx(R,{size:"small",startIcon:s.jsx(ae,{}),onClick:()=>this.setState({showReportDialog:!0}),sx:{ml:2},children:"Report Issue"})]}),s.jsx(q,{in:this.state.showDetails,children:s.jsx(L,{sx:{p:2,bgcolor:"grey.50",border:"1px solid",borderColor:"grey.200"},children:s.jsxs(A,{variant:"body2",component:"pre",sx:{whiteSpace:"pre-wrap",wordBreak:"break-word",fontSize:"0.75rem",fontFamily:"monospace",maxHeight:300,overflow:"auto"},children:[s.jsx("strong",{children:"Error ID:"})," ",this.state.errorId,`
`,s.jsx("strong",{children:"Message:"})," ",(e=this.state.error)==null?void 0:e.message,`
`,s.jsx("strong",{children:"Context:"})," ",this.props.context||"clinical-notes",`
`,s.jsx("strong",{children:"Retry Count:"})," ",this.retryCount,`
`,s.jsx("strong",{children:"Timestamp:"})," ",new Date().toISOString(),((t=this.state.error)==null?void 0:t.stack)&&s.jsxs(s.Fragment,{children:[`

`,s.jsx("strong",{children:"Stack Trace:"}),`
`,this.state.error.stack]}),((a=this.state.errorInfo)==null?void 0:a.componentStack)&&s.jsxs(s.Fragment,{children:[`

`,s.jsx("strong",{children:"Component Stack:"}),`
`,this.state.errorInfo.componentStack]})]})})}),s.jsxs(J,{open:this.state.showReportDialog,onClose:()=>this.setState({showReportDialog:!1}),maxWidth:"sm",fullWidth:!0,children:[s.jsx(Q,{children:"Report Error"}),s.jsxs(X,{children:[s.jsx(A,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Help us improve by describing what you were doing when this error occurred. This information will be sent to our development team."}),s.jsx(Z,{fullWidth:!0,multiline:!0,rows:4,label:"Describe what happened",value:this.state.reportDescription,onChange:h=>this.setState({reportDescription:h.target.value}),placeholder:"I was trying to create a new clinical note when...",sx:{mb:2}}),s.jsx(N,{severity:"info",sx:{mb:2},children:s.jsxs(A,{variant:"body2",children:[s.jsx("strong",{children:"Error ID:"})," ",this.state.errorId,s.jsx("br",{}),"This ID will be included in your report for tracking purposes."]})})]}),s.jsxs(K,{children:[s.jsx(R,{onClick:()=>this.setState({showReportDialog:!1}),disabled:this.state.isReporting,children:"Cancel"}),s.jsx(R,{variant:"contained",startIcon:this.state.isReporting?s.jsx(CircularProgress,{size:16}):s.jsx(ee,{}),onClick:this.handleReportError,disabled:!this.state.reportDescription.trim()||this.state.isReporting,children:this.state.isReporting?"Sending...":"Send Report"})]})]})]})})}return this.props.children}}class F{static classifyError(e){var a,o,i,h;const t=new Date().toISOString();return this.isNetworkError(e)?{type:"NETWORK_ERROR",message:"Network connection failed. Please check your internet connection.",severity:"high",recoveryAction:"check_network",timestamp:t,details:{originalError:e.message}}:this.isValidationError(e)?{type:"VALIDATION_ERROR",message:"Please check your input and try again.",severity:"low",recoveryAction:"validate_input",timestamp:t,details:this.extractValidationDetails(e)}:this.isPermissionError(e)?{type:"PERMISSION_ERROR",message:"You do not have permission to perform this action.",severity:"medium",recoveryAction:"check_permissions",timestamp:t,details:{statusCode:(a=e.response)==null?void 0:a.status}}:this.isServerError(e)?{type:"SERVER_ERROR",message:"Server error occurred. Please try again later.",severity:"high",recoveryAction:"retry",timestamp:t,details:{statusCode:(o=e.response)==null?void 0:o.status,serverMessage:(h=(i=e.response)==null?void 0:i.data)==null?void 0:h.message}}:{type:"UNKNOWN_ERROR",message:"An unexpected error occurred. Please try again.",severity:"medium",recoveryAction:"retry",timestamp:t,details:{originalError:e.message||String(e)}}}static isNetworkError(e){return!e.response||e.code==="NETWORK_ERROR"||e.message==="Network Error"||e.code==="ECONNABORTED"}static isValidationError(e){var t,a,o,i;return((t=e.response)==null?void 0:t.status)===400||((a=e.response)==null?void 0:a.status)===422||((i=(o=e.response)==null?void 0:o.data)==null?void 0:i.errors)&&Array.isArray(e.response.data.errors)}static isPermissionError(e){var t,a;return((t=e.response)==null?void 0:t.status)===401||((a=e.response)==null?void 0:a.status)===403}static isServerError(e){var t;return((t=e.response)==null?void 0:t.status)>=500}static extractValidationDetails(e){var a,o,i,h;const t={};return(o=(a=e.response)==null?void 0:a.data)!=null&&o.errors&&(t.validationErrors=e.response.data.errors),(h=(i=e.response)==null?void 0:i.data)!=null&&h.message&&(t.serverMessage=e.response.data.message),t}}class j{constructor(){this.errorLog=[],this.retryAttempts=new Map}static getInstance(){return j.instance||(j.instance=new j),j.instance}handleError(e,t="unknown",a={}){const{showToast:o=!0,logError:i=!0,trackMetrics:h=!0,autoRetry:E=!1,maxRetries:k=3,retryDelay:x=1e3}=a,f=F.classifyError(e);return f.details={...f.details,context:t},i&&this.logError(f,t),h&&this.trackErrorMetrics(f,t),o&&this.showErrorToast(f),E&&this.shouldAutoRetry(f,t,k)&&this.scheduleRetry(e,t,a,x),f}logError(e,t){console.error(`[${e.severity.toUpperCase()}] ${e.type} in ${t}:`,{message:e.message,details:e.details,timestamp:e.timestamp,technicalMessage:e.technicalMessage,stack:e.stack}),this.errorLog.push(e),this.errorLog.length>100&&(this.errorLog=this.errorLog.slice(-100))}trackErrorMetrics(e,t){const a={errorType:e.type,severity:e.severity,context:t,timestamp:e.timestamp,userAgent:navigator.userAgent,url:window.location.href};console.debug("Error metrics:",a)}showErrorToast(e){const t={position:"top-right",autoClose:this.getToastDuration(e.severity),hideProgressBar:!1,closeOnClick:!0,pauseOnHover:!0,draggable:!0};switch(e.severity){case"critical":case"high":b.error(e.message,t);break;case"medium":b.warn(e.message,t);break;case"low":b.info(e.message,t);break}}shouldAutoRetry(e,t,a){const o=`${t}_${e.type}`,i=this.retryAttempts.get(o)||0;return e.recoveryAction==="retry"&&i<a&&e.severity!=="critical"}scheduleRetry(e,t,a,o){const i=`${t}_${F.classifyError(e).type}`,h=this.retryAttempts.get(i)||0;this.retryAttempts.set(i,h+1),setTimeout(()=>{console.log(`Auto-retrying ${t} (attempt ${h+1})`)},o*Math.pow(2,h))}getToastDuration(e){switch(e){case"critical":return 1e4;case"high":return 7e3;case"medium":return 5e3;case"low":return 3e3;default:return 5e3}}getRecoveryInstructions(e){switch(e.recoveryAction){case"retry":return["Wait a moment and try again","Check your internet connection","If the problem persists, contact support"];case"refresh":return["Refresh the page and try again","Make sure you have the latest data","Clear your browser cache if needed"];case"validate_input":return["Check your input for errors","Make sure all required fields are filled","Verify the data format is correct"];case"check_permissions":return["Contact your administrator for access","Make sure you have the required permissions","Try logging out and back in"];case"check_network":return["Check your internet connection","Try refreshing the page","Contact IT support if connection issues persist"];case"contact_support":return["Contact technical support","Provide the error details and timestamp","Include steps to reproduce the issue"];default:return["Try the action again","If the problem persists, contact support"]}}clearRetryAttempts(e){Array.from(this.retryAttempts.keys()).filter(a=>a.startsWith(e)).forEach(a=>this.retryAttempts.delete(a))}getErrorLog(){return[...this.errorLog]}clearErrorLog(){this.errorLog=[]}exportErrorLog(){return JSON.stringify(this.errorLog,null,2)}}const oe=j.getInstance(),de=()=>{const[u,e]=l.useState(new Map),[t,a]=l.useState(new Map),[o,i]=l.useState(new Set),h=l.useCallback((r,c,n={},g={})=>{const{autoRetry:d=!1,maxRetries:w=3,retryDelay:I=1e3,showToast:m=!0,onRetry:y,onMaxRetriesReached:S}=g,D={...oe.handleError(r,`clinical-notes-${c}`,{showToast:!1,logError:!0,trackMetrics:!0,autoRetry:!1}),context:"clinical-notes",operation:c,noteId:n.noteId,patientId:n.patientId,retryable:E(r,c)},P=`${c}-${n.noteId||n.patientId||"global"}-${Date.now()}`;if(e(M=>new Map(M).set(P,D)),m&&x(D),d&&D.retryable&&y){const M=t.get(P)||0;M<w?k(P,y,M,I,w,S):S&&S(D)}return D},[t]),E=(r,c)=>{var n,g,d,w,I,m;return r.code==="NETWORK_ERROR"||r.message==="Network Error"||((n=r.response)==null?void 0:n.status)>=500||r.code==="ECONNABORTED"?!0:(c==="delete"&&((g=r.response)==null?void 0:g.status)===404||((d=r.response)==null?void 0:d.status)===400||((w=r.response)==null?void 0:w.status)===422||((I=r.response)==null?void 0:I.status)===401||((m=r.response)==null?void 0:m.status)===403,!1)},k=l.useCallback((r,c,n,g,d,w)=>{const I=g*Math.pow(2,n);a(m=>new Map(m).set(r,n+1)),i(m=>new Set(m).add(r)),setTimeout(async()=>{try{await c(),e(m=>{const y=new Map(m);return y.delete(r),y}),a(m=>{const y=new Map(m);return y.delete(r),y}),b.success("Operation completed successfully after retry")}catch{const y=n+1;if(y>=d){const S=u.get(r);S&&w&&w(S),b.error(`Failed after ${d} attempts. Please try again manually.`)}else k(r,c,y,g,d,w)}finally{i(m=>{const y=new Set(m);return y.delete(r),y})}},I)},[u]),x=r=>{const c=()=>{switch(r.operation){case"create":return"Failed to create clinical note. Please check your input and try again.";case"update":return"Failed to update clinical note. Your changes may not have been saved.";case"delete":return"Failed to delete clinical note. Please try again.";case"fetch":return"Failed to load clinical notes. Please refresh the page.";case"search":return"Search failed. Please try with different criteria.";case"upload":return"File upload failed. Please check the file and try again.";case"sync":return"Sync failed. Changes will be retried when connection is restored.";default:return r.message||"An error occurred with clinical notes."}},n={duration:r.severity==="critical"?1e4:5e3};switch(r.severity){case"critical":case"high":b.error(c(),n);break;case"medium":b(c(),{...n,icon:"⚠️"});break;case"low":b(c(),{...n,icon:"ℹ️"});break}},f=l.useCallback(async(r,c)=>{const n=u.get(r);if(n){i(g=>new Set(g).add(r));try{await c(),e(g=>{const d=new Map(g);return d.delete(r),d}),b.success("Operation completed successfully")}catch{const d={...n,timestamp:new Date().toISOString(),details:{...n.details,retryAttempt:(t.get(r)||0)+1}};e(w=>new Map(w).set(r,d)),x(d)}finally{i(g=>{const d=new Set(g);return d.delete(r),d})}}},[u,t]),p=l.useCallback(r=>{e(c=>{const n=new Map(c);return n.delete(r),n}),a(c=>{const n=new Map(c);return n.delete(r),n})},[]),v=l.useCallback(()=>{e(new Map),a(new Map),i(new Set)},[]),T=l.useCallback(r=>{const c=Array.from(u.values());return r?c.filter(n=>!(r.operation&&n.operation!==r.operation||r.noteId&&n.noteId!==r.noteId||r.patientId&&n.patientId!==r.patientId)):c},[u]),C=l.useCallback(r=>o.has(r),[o]);return{handleError:h,retryOperation:f,clearError:p,clearAllErrors:v,getErrors:T,isOperationRecovering:C,hasErrors:u.size>0,errorCount:u.size}},pe=()=>{const[u,e]=l.useState(!1),[t,a]=l.useState(null),o=l.useRef(null),i=l.useCallback(async(h,E=1e3)=>{const k=Date.now();if(u)throw new Error("Operation already in progress. Please wait.");if(t&&k-t<E)throw new Error(`Please wait ${Math.ceil((E-(k-t))/1e3)} seconds before trying again.`);if(o.current)throw new Error("Another operation is in progress. Please wait.");e(!0),a(k);try{const x=h();return o.current=x,await x}finally{e(!1),o.current=null}},[u,t]);return{isSubmitting:u,lastSubmissionTime:t,preventDuplicateSubmission:i}},ge=()=>{const[u,e]=l.useState(new Map),[t,a]=l.useState(!1),o=l.useRef(new Map),i=l.useCallback((p,v,T,C=300)=>{const r=o.current.get(p);r&&clearTimeout(r);const c=setTimeout(()=>{a(!0);try{const n=T(v);e(g=>{const d=new Map(g);return n?d.set(p,n):d.delete(p),d})}catch(n){console.error(`Validation error for field ${p}:`,n)}finally{a(!1)}},C);o.current.set(p,c)},[]),h=l.useCallback(p=>{e(T=>{const C=new Map(T);return C.delete(p),C});const v=o.current.get(p);v&&(clearTimeout(v),o.current.delete(p))},[]),E=l.useCallback(()=>{e(new Map),o.current.forEach(p=>clearTimeout(p)),o.current.clear()},[]),k=l.useCallback(p=>u.get(p)||null,[u]),x=u.size>0,f=l.useCallback(p=>u.has(p),[u]);return l.useEffect(()=>()=>{o.current.forEach(p=>clearTimeout(p))},[]),{validateField:i,clearFieldValidation:h,clearAllValidation:E,getFieldError:k,hasFieldError:f,hasErrors:x,isValidating:t,errorCount:u.size}};export{he as C,pe as a,ge as b,de as u};
